<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport"
        content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Wind Rose | WR</title>
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#000000">

    <style>
        /* --- THEME: WIND ROSE (WR) --- */
        :root {
            --bg-core: #000000;
            --bg-grad: radial-gradient(circle at 50% 30%, #1a1a2e 0%, #000000 70%);
            --glass-base: rgba(255, 255, 255, 0.05);
            --glass-border: rgba(255, 255, 255, 0.1);
            --glass-shine: rgba(255, 255, 255, 0.15);
            --blur-val: 20px;
            --neon-p: #d946ef;
            /* Discovery/Wonder */
            --neon-b: #60a5fa;
            /* Geomag/Earth */
            --neon-r: #f43f5e;
            /* Whispers/Myth */
            --neon-g: #34d399;
            /* Safe */
            --text-1: #ffffff;
            --text-2: #94a3b8;
            --text-3: #64748b;
            --font-ui: -apple-system, BlinkMacSystemFont, "SF Pro Display", "Inter", sans-serif;
            --font-mono: "SF Mono", "Menlo", monospace;
            --ease-out: cubic-bezier(0.215, 0.61, 0.355, 1);
        }

        * {
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            margin: 0;
            padding: 0;
            background: var(--bg-core);
            background-image: var(--bg-grad);
            color: var(--text-1);
            font-family: var(--font-ui);
            height: 100vh;
            width: 100vw;
            overflow: hidden;
            /* Lock scroll */
            display: flex;
            flex-direction: column;
            touch-action: none;
            /* Prevent browser gestures */
            overscroll-behavior: none;
            /* Prevent bounce */
            user-select: none;
            -webkit-user-select: none;
            /* Prevent text selection */
        }

        /* --- OVERLAY (MINIMAL) --- */
        #overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #000;
            z-index: 9999;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            transition: opacity 0.8s ease;
        }

        #overlay.hidden {
            opacity: 0;
            pointer-events: none;
        }

        .logo-box {
            text-align: center;
            margin-bottom: 40px;
            animation: breathe 4s infinite ease-in-out;
        }

        .logo-main {
            font-size: 24px;
            font-weight: 200;
            letter-spacing: 6px;
            text-transform: uppercase;
            color: #fff;
            margin-bottom: 8px;
        }

        .logo-sub {
            font-size: 10px;
            color: #666;
            letter-spacing: 4px;
            font-family: var(--font-mono);
        }

        .loader {
            width: 30px;
            height: 30px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-top-color: #fff;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 60px;
        }

        #btn-init {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            color: #fff;
            padding: 14px 40px;
            border-radius: 100px;
            font-size: 11px;
            letter-spacing: 3px;
            cursor: pointer;
            transition: all 0.4s ease;
            backdrop-filter: blur(10px);
            text-transform: uppercase;
        }

        #btn-init:hover {
            background: rgba(255, 255, 255, 0.15);
            transform: scale(1.02);
            border-color: rgba(255, 255, 255, 0.3);
        }

        #btn-init:active {
            transform: scale(0.98);
        }

        #btn-init.disabled {
            opacity: 0.3;
            pointer-events: none;
        }

        #sys-details {
            position: absolute;
            bottom: 40px;
            font-family: var(--font-mono);
            font-size: 9px;
            color: #333;
            text-align: center;
            transition: opacity 0.3s;
            cursor: pointer;
            letter-spacing: 1px;
        }

        #sys-details:hover,
        #sys-details.visible {
            opacity: 1;
            color: #666;
        }

        .sys-row {
            display: flex;
            align-items: center;
            gap: 8px;
            margin: 4px 0;
            justify-content: center;
        }

        .status-dot {
            width: 4px;
            height: 4px;
            border-radius: 50%;
            background: #333;
        }

        .status-dot.ok {
            background: #0f0;
            box-shadow: 0 0 5px #0f0;
        }

        .status-dot.wait {
            background: #fc0;
        }

        .status-dot.err {
            background: #f00;
        }

        @keyframes breathe {

            0%,
            100% {
                opacity: 0.7;
            }

            50% {
                opacity: 1;
                text-shadow: 0 0 15px rgba(255, 255, 255, 0.2);
            }
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        /* --- APP UI --- */
        #app {
            position: relative;
            z-index: 10;
            flex: 1;
            display: flex;
            flex-direction: column;
            padding: env(safe-area-inset-top) 16px calc(env(safe-area-inset-bottom) + 16px) 16px;
            gap: 12px;
            opacity: 0;
            transition: opacity 1s ease;
        }

        #app.visible {
            opacity: 1;
        }

        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            height: 44px;
            font-family: var(--font-mono);
            font-size: 10px;
            color: var(--text-3);
        }

        .h-center {
            font-size: 12px;
            letter-spacing: 2px;
            color: var(--text-1);
            font-weight: 700;
        }

        /* DECK */
        .compass-deck {
            margin-top: auto;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .card {
            background: var(--glass-base);
            backdrop-filter: blur(var(--blur-val));
            -webkit-backdrop-filter: blur(var(--blur-val));
            border: 1px solid var(--glass-border);
            border-radius: 20px;
            padding: 20px;
            min-height: 120px;
            position: relative;
            overflow: hidden;
            transition: 0.3s;
        }

        .card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            bottom: 0;
            width: 2px;
            background: var(--text-3);
        }

        .card.wonder::before {
            background: var(--neon-p);
        }

        .card.myth::before {
            background: var(--neon-r);
        }

        .card-head {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
        }

        #c-meta {
            font-size: 9px;
            letter-spacing: 1px;
            color: var(--neon-p);
            font-weight: 700;
            text-transform: uppercase;
        }

        #c-title {
            margin: 0;
            font-size: 18px;
            font-weight: 600;
            color: #fff;
            letter-spacing: 0.5px;
        }

        #c-desc {
            font-size: 13px;
            color: var(--text-2);
            line-height: 1.5;
            margin-top: 4px;
        }

        #c-facts {
            margin-top: 8px;
            font-size: 11px;
            color: var(--text-3);
            list-style: none;
            padding: 0;
        }

        #c-facts li::before {
            content: '• ';
            color: var(--glass-border);
        }

        #c-quote {
            margin-top: 12px;
            padding-top: 8px;
            border-top: 1px solid var(--glass-border);
            font-style: italic;
            font-size: 11px;
            color: var(--text-3);
        }

        .action-btn {
            margin-top: 12px;
            width: 100%;
            padding: 10px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid var(--glass-border);
            border-radius: 12px;
            color: var(--text-2);
            font-size: 11px;
            letter-spacing: 1px;
            cursor: pointer;
        }

        .action-btn:active {
            background: rgba(255, 255, 255, 0.1);
        }

        /* ORB */
        .orb-container {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            perspective: 1000px;
        }

        .orb {
            width: 260px;
            height: 260px;
            position: relative;
            transform-style: preserve-3d;
        }

        .orb-ring {
            position: absolute;
            inset: 0;
            border-radius: 50%;
            border: 1px solid rgba(255, 255, 255, 0.08);
            box-shadow: 0 0 30px rgba(0, 0, 0, 0.5), inset 0 0 30px rgba(0, 0, 0, 0.5);
            transition: transform 0.1s linear;
            will-change: transform;
        }

        .orb-ring.jitter {
            border-color: rgba(244, 63, 94, 0.3);
            box-shadow: 0 0 30px rgba(244, 63, 94, 0.1);
        }

        /* TICKS */
        .ticks-major {
            position: absolute;
            inset: -5px;
            border-radius: 50%;
            background: conic-gradient(from 0deg, var(--text-3) 0deg 1deg, transparent 1deg 29deg, var(--text-3) 30deg 31deg, transparent 31deg 360deg);
            mask: radial-gradient(transparent 68%, black 69%);
            -webkit-mask: radial-gradient(transparent 68%, black 69%);
        }

        .ticks-minor {
            position: absolute;
            inset: 0;
            border-radius: 50%;
            background: repeating-conic-gradient(rgba(255, 255, 255, 0.1) 0deg 1deg, transparent 1deg 5deg);
            mask: radial-gradient(transparent 68%, black 69%);
            -webkit-mask: radial-gradient(transparent 68%, black 69%);
        }

        .cardinal {
            position: absolute;
            font-size: 12px;
            font-weight: 700;
            color: var(--text-3);
        }

        .c-n {
            top: 10px;
            left: 50%;
            transform: translateX(-50%);
            color: var(--neon-b);
        }

        .c-e {
            right: 14px;
            top: 50%;
            transform: translateY(-50%);
        }

        .c-s {
            bottom: 10px;
            left: 50%;
            transform: translateX(-50%);
        }

        .c-w {
            left: 14px;
        }

        .h-center {
            font-size: 12px;
            letter-spacing: 2px;
            color: var(--text-1);
            font-weight: 700;
        }

        /* DECK */
        .compass-deck {
            margin-top: auto;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .card {
            background: var(--glass-base);
            backdrop-filter: blur(var(--blur-val));
            -webkit-backdrop-filter: blur(var(--blur-val));
            border: 1px solid var(--glass-border);
            border-radius: 20px;
            padding: 20px;
            min-height: 120px;
            position: relative;
            overflow: hidden;
            transition: 0.3s;
        }

        .card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            bottom: 0;
            width: 2px;
            background: var(--text-3);
        }

        .card.wonder::before {
            background: var(--neon-p);
        }

        .card.myth::before {
            background: var(--neon-r);
        }

        .card-head {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
        }

        #c-meta {
            font-size: 9px;
            letter-spacing: 1px;
            color: var(--neon-p);
            font-weight: 700;
            text-transform: uppercase;
        }

        #c-title {
            margin: 0;
            font-size: 18px;
            font-weight: 600;
            color: #fff;
            letter-spacing: 0.5px;
        }

        #c-desc {
            font-size: 13px;
            color: var(--text-2);
            line-height: 1.5;
            margin-top: 4px;
        }

        #c-facts {
            margin-top: 8px;
            font-size: 11px;
            color: var(--text-3);
            list-style: none;
            padding: 0;
        }

        #c-facts li::before {
            content: '• ';
            color: var(--glass-border);
        }

        #c-quote {
            margin-top: 12px;
            padding-top: 8px;
            border-top: 1px solid var(--glass-border);
            font-style: italic;
            font-size: 11px;
            color: var(--text-3);
        }

        .action-btn {
            margin-top: 12px;
            width: 100%;
            padding: 10px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid var(--glass-border);
            border-radius: 12px;
            color: var(--text-2);
            font-size: 11px;
            letter-spacing: 1px;
            cursor: pointer;
        }

        .action-btn:active {
            background: rgba(255, 255, 255, 0.1);
        }

        /* ORB */
        .orb-container {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            perspective: 1000px;
        }

        .orb {
            width: 260px;
            height: 260px;
            position: relative;
            transform-style: preserve-3d;
        }

        .orb-ring {
            position: absolute;
            inset: 0;
            border-radius: 50%;
            border: 1px solid rgba(255, 255, 255, 0.08);
            box-shadow: 0 0 30px rgba(0, 0, 0, 0.5), inset 0 0 30px rgba(0, 0, 0, 0.5);
            transition: transform 0.1s linear;
            will-change: transform;
        }

        .orb-ring.jitter {
            border-color: rgba(244, 63, 94, 0.3);
            box-shadow: 0 0 30px rgba(244, 63, 94, 0.1);
        }

        /* TICKS */
        .ticks-major {
            position: absolute;
            inset: -5px;
            border-radius: 50%;
            background: conic-gradient(from 0deg, var(--text-3) 0deg 1deg, transparent 1deg 29deg, var(--text-3) 30deg 31deg, transparent 31deg 360deg);
            mask: radial-gradient(transparent 68%, black 69%);
            -webkit-mask: radial-gradient(transparent 68%, black 69%);
        }

        .ticks-minor {
            position: absolute;
            inset: 0;
            border-radius: 50%;
            background: repeating-conic-gradient(rgba(255, 255, 255, 0.1) 0deg 1deg, transparent 1deg 5deg);
            mask: radial-gradient(transparent 68%, black 69%);
            -webkit-mask: radial-gradient(transparent 68%, black 69%);
        }

        .cardinal {
            position: absolute;
            font-size: 12px;
            font-weight: 700;
            color: var(--text-3);
        }

        .c-n {
            top: 10px;
            left: 50%;
            transform: translateX(-50%);
            color: var(--neon-b);
        }

        .c-e {
            right: 14px;
            top: 50%;
            transform: translateY(-50%);
        }

        .c-s {
            bottom: 10px;
            left: 50%;
            transform: translateX(-50%);
        }

        .c-w {
            left: 14px;
            top: 50%;
            transform: translateY(-50%);
        }

        /* NEEDLES */
        .needle-n {
            position: absolute;
            top: 50%;
            left: 50%;
            width: 2px;
            height: 45%;
            background: var(--neon-b);
            margin-left: -1px;
            margin-top: -45%;
            transform-origin: bottom center;
            box-shadow: 0 0 8px var(--neon-b);
            transition: transform 0.4s cubic-bezier(0.2, 0.8, 0.2, 1);
        }

        .needle-s {
            position: absolute;
            top: 50%;
            left: 50%;
            width: 2px;
            height: 40%;
            background: #fbbf24;
            margin-left: -1px;
            margin-top: -40%;
            transform-origin: bottom center;
            box-shadow: 0 0 8px #fbbf24;
            transform: translate(-50%, -50%);
            text-align: center;
            z-index: 5;
        }

        .val {
            font-size: 32px;
            font-weight: 700;
            letter-spacing: -1px;
            line-height: 1;
        }

        .label {
            font-size: 9px;
            color: var(--text-3);
            letter-spacing: 2px;
            margin-top: 4px;
        }

        /* DOCK */
        .dock {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 8px;
            background: rgba(0, 0, 0, 0.3);
            padding: 6px;
            border-radius: 24px;
            border: 1px solid var(--glass-border);
        }

        .dock-btn {
            background: transparent;
            border: none;
            color: var(--text-3);
            padding: 12px;
            border-radius: 18px;
            font-size: 10px;
            font-weight: 700;
            cursor: pointer;
            transition: 0.2s;
            letter-spacing: 1px;
        }

        .dock-btn.active {
            background: var(--glass-border);
            color: #fff;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
        }

        footer {
            display: flex;
            justify-content: space-between;
            font-family: var(--font-mono);
            font-size: 9px;
            color: var(--text-3);
            padding: 0 8px;
        }

        #lang-tog {
            cursor: pointer;
            padding: 2px 6px;
            border: 1px solid var(--glass-border);
            border-radius: 4px;
        }

        /* GHOST UI */
        #ghost-ui {
            position: absolute;
            inset: 0;
            pointer-events: none;
        }

        .radar-circle {
            position: absolute;
            bottom: 0;
            right: 0;
            width: 60px;
            height: 60px;
            border: 1px solid rgba(244, 63, 94, 0.3);
            border-radius: 50%;
            background: rgba(0, 0, 0, 0.2);
            overflow: hidden;
        }

        .radar-circle::after {
            content: '';
            position: absolute;
            inset: 0;
            background: conic-gradient(from 0deg, transparent 0deg, rgba(244, 63, 94, 0.5) 30deg, transparent 30.1deg);
            animation: sweep 2s linear infinite;
            border-radius: 50%;
        }

        @keyframes sweep {
            to {
                transform: rotate(360deg);
            }
        }

        /* MODAL */
        .modal {
            position: fixed;
            inset: 0;
            z-index: 100;
            background: rgba(0, 0, 0, 0.9);
            backdrop-filter: blur(10px);
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            pointer-events: none;
            transition: 0.3s;
        }

        .modal.show {
            opacity: 1;
            pointer-events: auto;
        }

        .modal-box {
            width: 85%;
            max-width: 320px;
            padding: 24px;
            border: 1px solid var(--glass-border);
            border-radius: 24px;
            background: rgba(20, 20, 25, 0.9);
        }
    </style>
</head>

<body>

    <!-- OVERLAY: MINIMAL -->
    <div id="overlay">
        <div class="logo-box">
            <div class="logo-main">Wind Rose</div>
            <div class="logo-sub">WR // SYSTEM</div>
        </div>

        <div class="loader"></div>

        <button id="btn-init" onclick="app.init()">ENTER WIND ROSE</button>

        <!-- Hidden Diagnostics -->
        <div id="sys-details" onclick="this.classList.toggle('visible')">
            <div>DIAGNOSTICS</div>
            <div class="sys-row"><span>GPS</span>
                <div id="chk-gps" class="status-dot"></div>
            </div>
            <div class="sys-row"><span>GYRO</span>
                <div id="chk-gyro" class="status-dot"></div>
            </div>
            <div class="sys-row"><span>MAG</span>
                <div id="chk-mag" class="status-dot"></div>
            </div>
        </div>
    </div>

    <!-- APP -->
    <div id="app">
        <header>
            <div class="h-left">WR-02</div>
            <div class="h-center">WIND ROSE</div>
            <div class="h-right" id="clock">00:00</div>
        </header>

        <div class="compass-deck">
            <div id="main-card" class="card wonder">
                <div class="card-head">
                    <span id="c-meta">TARGET LOCK</span>
                    <div class="sig-bar"></div>
                </div>
                <h2 id="c-title">DISCOVERY</h2>
                <p id="c-desc">Scanning for local anomalies...</p>
                <ul id="c-facts"></ul>
                <div id="c-quote"></div>

                <!-- Ghost UI -->
                <div id="ghost-ui" style="display:none;">
                    <div class="radar-circle"></div>
                </div>

                <button id="btn-legend" class="action-btn" style="display:none;" onclick="app.showLegend()">READ
                    SIGNAL</button>
                <button id="btn-next" class="action-btn" onclick="app.nextTarget()">NEXT TARGET</button>
            </div>
        </div>

        <div class="orb-container">
            <div class="orb">
                <div class="orb-ring" id="orb-ring">
                    <div class="ticks-major"></div>
                    <div class="ticks-minor"></div>
                    <div class="cardinal c-n">N</div>
                    <div class="cardinal c-e">E</div>
                    <div class="cardinal c-s">S</div>
                    <div class="cardinal c-w">W</div>
                </div>
                <div class="needle-n" id="n-north"></div>
                <div class="needle-s" id="n-sun"></div>
                <div class="needle-w" id="n-wonder"></div>
                <div class="center-hud">
                    <div class="val" id="val-head">000°</div>
                    <div class="label">HEADING</div>
                </div>
            </div>
        </div>

        <div class="dock">
            <button class="dock-btn active" onclick="app.setMode('wonder')">DISCOVERY</button>
            <button class="dock-btn" onclick="app.setMode('earth')">GEOMAG</button>
            <button class="dock-btn" onclick="app.setMode('myth')">WHISPERS</button>
        </div>

        <footer>
            <div class="f-row">
                <span>LAT: <span id="val-lat">--.----</span></span>
                <span>LON: <span id="val-lon">--.----</span></span>
            </div>
            <div class="f-row">
                <span>ACC: <span id="val-acc">--</span>m</span>
                <span id="lang-tog" onclick="app.toggleLang()">EN</span>
            </div>
        </footer>
    </div>

    <!-- LEGEND MODAL -->
    <div id="modal-legend" class="modal">
        <div class="modal-box">
            <div style="display:flex; justify-content:space-between; margin-bottom:12px;">
                <span style="font-size:10px; color:var(--neon-r); letter-spacing:1px; font-weight:700;">WHISPER
                    LOG</span>
                <span style="cursor:pointer; font-size:16px;" onclick="app.closeLegend()">×</span>
            </div>
            <h3 id="leg-title" style="margin:0 0 8px 0; color:#fff; font-size:16px;"></h3>
            <p id="leg-body" style="color:var(--text-2); font-size:12px; line-height:1.6;"></p>
        </div>
    </div>

    <!-- CALIBRATION -->
    <div id="calib-overlay"
        style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.85); z-index:9000; align-items:center; justify-content:center; flex-direction:column;">
        <div
            style="width:60px; height:30px; border:2px solid var(--neon-p); border-radius:15px; animation:spin 2s infinite linear; margin-bottom:16px;">
        </div>
        <div style="font-weight:700; color:#fff; letter-spacing:2px;">CALIBRATION</div>
        <div style="font-size:10px; color:#888; margin-top:4px;">Wave device in Figure-8</div>
    </div>

    <script>
        // --- DATA ---
        const DICT = {
            en: {
                mode_wonder: "DISCOVERY",
                mode_earth: "GEOMAG",
                mode_myth: "WHISPERS",
                myth_flavor: "Listening to the wind...",
                legend_btn: "READ SIGNAL",
                omen_0: "Signal: Stable",
                omen_1: "Signal: Unsettled",
                omen_2: "Signal: DISTORTED",
                omen_3: "Signal: CRITICAL"
            },
            th: {
                mode_wonder: "สำรวจ",
                mode_earth: "แม่เหล็กโลก",
                mode_myth: "เสียงกระซิบ",
                legend_btn: "อ่านสัญญาณ",
                myth_flavor: "กำลังฟังเสียงสายลม...",
                omen_0: "สัญญาณ: ปกติ",
                omen_1: "สัญญาณ: แปรปรวน",
                omen_2: "สัญญาณ: บิดเบี้ยว",
                omen_3: "สัญญาณ: อันตราย"
            }
        };

        const WONDERS = [
            {
                n: { en: "Great Pyramid", th: "มหาพีระมิดกีซา" }, lat: 29.9792, lon: 31.1342,
                d: { en: "Ancient tomb aligned to true north.", th: "สุสานโบราณที่หันทิศเหนือจริงเป๊ะ" },
                f: { en: ["Built ~2560 BC", "2.3M stone blocks"], th: ["สร้างเมื่อ 2560 ปีก่อน ค.ศ.", "หิน 2.3 ล้านก้อน"] },
                q: { en: "Man fears Time, Time fears the Pyramids.", th: "มนุษย์กลัวเวลา แต่เวลากลัวพีระมิด" }
            },
            {
                n: { en: "Machu Picchu", th: "มาชูปิกชู" }, lat: -13.1631, lon: -72.5450,
                d: { en: "Inca city in the clouds.", th: "นครอินคาลอยฟ้าในม่านเมฆ" },
                f: { en: ["Hidden for centuries", "No mortar used"], th: ["ซ่อนเร้นนับศตวรรษ", "ไม่ใช้ปูนก่อสร้าง"] },
                q: { en: "The hitching post of the sun.", th: "เสาที่ผูกดวงอาทิตย์ไว้กับโลก" }
            },
            {
                n: { en: "Stonehenge", th: "สโตนเฮนจ์" }, lat: 51.1789, lon: -1.8262,
                d: { en: "Prehistoric stone circle.", th: "วงล้อมหินปริศนายุคก่อนประวัติศาสตร์" },
                f: { en: ["Solar alignment", "Stones from Wales"], th: ["ตรงกับแนวสุริยะ", "หินมาจากเวลส์"] },
                q: { en: "A calendar of stone and shadow.", th: "ปฏิทินแห่งหินและเงา" }
            },
            {
                n: { en: "Angkor Wat", th: "นครวัด" }, lat: 13.4125, lon: 103.8670,
                d: { en: "Largest religious monument.", th: "ศาสนสถานตระการตาแห่งเขมร" },
                f: { en: ["Hindu then Buddhist", "Moat represents ocean"], th: ["ฮินดูสู่พุทธ", "คูน้ำแทนมหาสมุทร"] },
                q: { en: "Heaven on Earth.", th: "สวรรค์บนดินที่สาบสูญ" }
            },
            {
                n: { en: "Bermuda Triangle", th: "สามเหลี่ยมเบอร์มิวดา" }, lat: 25.0000, lon: -71.0000,
                d: { en: "The Devil's Triangle.", th: "น่านน้ำอาถรรพ์ที่เรือหายสาบสูญ" },
                f: { en: ["Magnetic anomalies", "Methane hydrates"], th: ["สนามแม่เหล็กแปรปรวน", "ก๊าซมีเทนใต้ทะเล"] },
                q: { en: "Compass spins wild here.", th: "เข็มทิศหมุนวนอย่างบ้าคลั่ง" }
            }
        ];

        const FOLK_DB = [
            { lat: 13.7, lon: 100.5, r: 50, en: { t: "The Palace Giants", b: "At night, the guardian giants shift their stance." }, th: { t: "ยักษ์วัดพระแก้ว", b: "ตกดึกยักษ์ทวารบาลจะขยับเปลี่ยนท่าแก้เมื่อย" } },
            { lat: 18.7, lon: 98.9, r: 50, en: { t: "Doi Suthep Guardian", b: "A hermit spirit walks the pilgrim path." }, th: { t: "ปู่แสะย่าแสะ", b: "วิญญาณบรรพชนยังคงเดินตรวจตราป่าเขา" } },
            { lat: 0, lon: 0, r: 99999, en: { t: "The Crossroads", b: "Spirits gather where paths meet. Don't whistle at night." }, th: { t: "ทางสามแพร่ง", b: "วิญญาณมักชุมนุมตรงทางแยก อย่าผิวปากตอนกลางคืน" } }
        ];

        // --- CELESTIAL MATH ---
        const SunCalc = {
            getPosition: (date, lat, lon) => {
                const PI = Math.PI, sin = Math.sin, cos = Math.cos, tan = Math.tan, asin = Math.asin, atan2 = Math.atan2;
                const rad = PI / 180;
                const dayMs = 1000 * 60 * 60 * 24;
                const J1970 = 2440588, J2000 = 2451545;

                function toJulian(date) { return date.valueOf() / dayMs - 0.5 + J1970; }
                function toDays(date) { return toJulian(date) - J2000; }

                const d = toDays(date);
                const lw = rad * -lon, phi = rad * lat;
                const M = rad * (357.5291 + 0.98560028 * d);
                const C = rad * (1.9148 * sin(M) + 0.0200 * sin(2 * M) + 0.0003 * sin(3 * M));
                const L = rad * (280.4665 + 360.9856235 * d) + C; // Ecliptic long
                const D = asin(sin(rad * 23.4397) * sin(L)); // Declination

                const th = rad * (6.697375 + 0.065709824279 * d + 1.0027379 * (date.getUTCHours() + date.getUTCMinutes() / 60 + date.getUTCSeconds() / 3600));
                const H_real = th + lw - atan2(sin(L) * cos(rad * 23.4397), cos(L));

                const az = atan2(sin(H_real), cos(H_real) * sin(phi) - tan(D) * cos(phi));
                return (az * 180 / PI + 180) % 360;
            }
        };

        // --- SENSOR ENGINE ---
        class SensorEngine {
            constructor() {
                this.head = 0;
                this.tilt = { beta: 0, gamma: 0 };
                this.gps = { lat: null, lon: null };
                this.magVar = 0;
                this.acc = 0;
                this.jitter = 0;
                this.history = [];
                this.listeners = {};
            }

            async init() {
                // Update UI to Waiting
                document.getElementById('chk-gps').className = 'status-dot wait';
                document.getElementById('chk-gyro').className = 'status-dot wait';
                document.getElementById('chk-mag').className = 'status-dot wait';

                // 1. GPS
                if ('geolocation' in navigator) {
                    navigator.geolocation.watchPosition(
                        p => {
                            this.gps = { lat: p.coords.latitude, lon: p.coords.longitude };
                            document.getElementById('chk-gps').className = 'status-dot ok';
                            this.emit('gps');
                        },
                        e => {
                            console.warn('GPS Error', e);
                            document.getElementById('chk-gps').className = 'status-dot err';
                        },
                        { enableHighAccuracy: true }
                    );
                }

                // 2. COMPASS
                const isIOS = typeof DeviceOrientationEvent !== 'undefined' && typeof DeviceOrientationEvent.requestPermission === 'function';

                if (isIOS) {
                    // iOS requires explicit trigger, handled in requestPerms
                    document.getElementById('chk-gyro').className = 'status-dot wait';
                } else {
                    // Android: Priority deviceorientationabsolute
                    if ('ondeviceorientationabsolute' in window) {
                        window.addEventListener('deviceorientationabsolute', e => this.handleAndroid(e, true));
                        document.getElementById('chk-gyro').className = 'status-dot ok';
                        document.getElementById('chk-mag').className = 'status-dot ok';
                    } else {
                        window.addEventListener('deviceorientation', e => this.handleAndroid(e, false));
                        document.getElementById('chk-gyro').className = 'status-dot ok';
                        document.getElementById('chk-mag').className = 'status-dot wait';
                    }
                }
            }

            async requestPerms() {
                const isIOS = typeof DeviceOrientationEvent !== 'undefined' && typeof DeviceOrientationEvent.requestPermission === 'function';
                if (isIOS) {
                    try {
                        const perm = await DeviceOrientationEvent.requestPermission();
                        if (perm === 'granted') {
                            window.addEventListener('deviceorientation', e => this.handleIOS(e));
                            document.getElementById('chk-gyro').className = 'status-dot ok';
                            document.getElementById('chk-mag').className = 'status-dot ok';
                        } else {
                            alert("Permission Denied");
                            document.getElementById('chk-gyro').className = 'status-dot err';
                        }
                    } catch (e) { console.error(e); }
                }
            }

            handleIOS(e) {
                if (e.webkitCompassHeading) {
                    this.head = e.webkitCompassHeading;
                    this.acc = e.webkitCompassAccuracy || 0;
                    this.tilt = { beta: e.beta, gamma: e.gamma };
                    this.updateJitter(this.head);
                    this.emit('heading');
                }
            }

            handleAndroid(e, isAbs) {
                let alpha = e.alpha;
                let beta = e.beta;
                let gamma = e.gamma;

                if (!isAbs && !e.absolute) {
                    this.acc = -1; // Unreliable
                } else {
                    this.acc = e.absolute ? 10 : 50;
                }

                // Screen Orientation
                const screenOr = window.screen.orientation ? window.screen.orientation.angle : window.orientation || 0;
                let compass = alpha;
                if (isAbs) compass = 360 - alpha;
                compass -= screenOr;
                compass = (compass + 360) % 360;

                this.head = compass;
                this.tilt = { beta, gamma };
                this.updateJitter(this.head);
                this.emit('heading');
            }

            updateJitter(val) {
                this.history.push(val);
                if (this.history.length > 10) this.history.shift();
                if (this.history.length > 2) {
                    const mean = this.history.reduce((a, b) => a + b, 0) / this.history.length;
                    const v = this.history.reduce((a, b) => {
                        let d = Math.abs(b - mean);
                        if (d > 180) d = 360 - d;
                        return a + d * d;
                    }, 0) / this.history.length;
                    this.jitter = Math.sqrt(v);
                    this.magVar = this.jitter;
                }
            }

            on(ev, cb) { this.listeners[ev] = cb; }
            emit(ev) { if (this.listeners[ev]) this.listeners[ev](); }
        }

        // --- APP LOGIC ---
        class App {
            constructor() {
                this.lang = localStorage.getItem('wr_lang') || 'en';
                this.mode = 'wonder';
                this.targetIdx = 0;
                this.smoothHead = 0;
                this.quest = null;

                // Prevent Zoom & Scroll
                document.addEventListener('gesturestart', function (e) { e.preventDefault(); });
                document.addEventListener('dblclick', function (e) { e.preventDefault(); }, { passive: false });
                document.addEventListener('touchmove', function (e) { if (e.scale !== 1) e.preventDefault(); }, { passive: false });

                this.sensor = new SensorEngine();
                this.sensor.init();

                this.initQuest();

                setInterval(() => this.updateClock(), 1000);
                this.updateClock();
                this.updateTexts();
            }

            initQuest() {
                // Random Quest
                const qId = localStorage.getItem('wr_quest_id');
                if (qId) {
                    this.targetIdx = parseInt(qId);
                } else {
                    const rnd = Math.floor(Math.random() * WONDERS.length);
                    this.targetIdx = rnd;
                    localStorage.setItem('wr_quest_id', rnd);
                }
            }

            async init() {
                try {
                    if (document.documentElement.requestFullscreen) {
                        document.documentElement.requestFullscreen().catch(e => console.log("Fullscreen denied"));
                    }

                    await this.sensor.requestPerms();

                    document.getElementById('overlay').classList.add('hidden');
                    document.getElementById('app').classList.add('visible');

                    this.sensor.on('gps', () => this.onGPS());
                    this.sensor.on('heading', () => this.onHeading());

                    this.loop();
                    this.updateTexts();
                    this.setMode('wonder');
                } catch (e) {
                    alert("Sensors Blocked. Please allow permissions.");
                }
            }

            setMode(m) {
                this.mode = m;
                document.querySelectorAll('.dock-btn').forEach(b => b.classList.remove('active'));
                // Manual active state
                const btns = document.querySelectorAll('.dock-btn');
                if (m === 'wonder') btns[0].classList.add('active');
                if (m === 'earth') btns[1].classList.add('active');
                if (m === 'myth') btns[2].classList.add('active');

                const card = document.getElementById('main-card');
                const ghost = document.getElementById('ghost-ui');
                const nWonder = document.getElementById('n-wonder');
                const nSun = document.getElementById('n-sun');
                const btnLegend = document.getElementById('btn-legend');
                const btnNext = document.getElementById('btn-next');

                card.className = `card ${m}`;
                ghost.style.display = 'none';
                nWonder.style.opacity = 0;
                nSun.style.opacity = 0;
                btnLegend.style.display = 'none';
                btnNext.style.display = 'block';

                // Haptic
                if (navigator.vibrate) navigator.vibrate(50);

                if (m === 'wonder') {
                    nWonder.style.opacity = 1;
                    this.updateCard();
                } else if (m === 'earth') {
                    document.getElementById('c-title').innerText = this.t('mode_earth');
                    document.getElementById('c-meta').innerText = "SOLAR TRACKING";
                    document.getElementById('c-desc').innerText = "Tracking Solar Azimuth & Magnetic North.";
                    document.getElementById('c-facts').innerHTML = "";
                    document.getElementById('c-quote').innerText = "";
                    nSun.style.opacity = 1;
                } else if (m === 'myth') {
                    ghost.style.display = 'block';
                    document.getElementById('c-title').innerText = this.t('mode_myth');
                    document.getElementById('c-meta').innerText = "ANOMALY DETECTOR";
                    document.getElementById('c-facts').innerHTML = "";
                    document.getElementById('c-quote').innerText = this.t('myth_flavor');
                    btnLegend.style.display = 'block';
                    btnNext.style.display = 'none';
                }
            }

            updateCard() {
                if (this.mode !== 'wonder') return;
                const w = WONDERS[this.targetIdx];
                const d = this.sensor.gps.lat ? this.dist(this.sensor.gps.lat, this.sensor.gps.lon, w.lat, w.lon) : 0;

                document.getElementById('c-title').innerText = w.n[this.lang];
                document.getElementById('c-meta').innerText = d.toFixed(0) + " KM";
                document.getElementById('c-desc').innerText = w.d[this.lang];
                document.getElementById('c-facts').innerHTML = w.f[this.lang].map(f => `<li>${f}</li>`).join('');
                document.getElementById('c-quote').innerText = `"${w.q[this.lang]}"`;
            }

            onHeading() {
                // Calibration
                const calib = document.getElementById('calib-overlay');
                if (this.sensor.acc !== -1 && this.sensor.acc < 15) calib.style.display = 'flex';
                else calib.style.display = 'none';

                document.getElementById('val-acc').innerText = `±${Math.round(this.sensor.acc)}°`;
                document.getElementById('val-lat').innerText = this.sensor.gps.lat ? this.sensor.gps.lat.toFixed(4) : '--.--';
                document.getElementById('val-lon').innerText = this.sensor.gps.lon ? this.sensor.gps.lon.toFixed(4) : '--.--';

                // Jitter
                const ring = document.getElementById('orb-ring');
                if (this.sensor.jitter > 5) ring.classList.add('jitter');
                else ring.classList.remove('jitter');
            }

            loop() {
                requestAnimationFrame(() => this.loop());

                // Smooth Heading
                let h = this.sensor.head;
                let diff = h - this.smoothHead;
                if (diff > 180) diff -= 360;
                if (diff < -180) diff += 360;
                this.smoothHead += diff * 0.15;

                document.getElementById('orb-ring').style.transform = `rotate(${-this.smoothHead}deg)`;
                document.getElementById('val-head').innerText = Math.round(this.sensor.head).toString().padStart(3, '0') + "°";

                // Needles
                if (this.mode === 'wonder') {
                    const w = WONDERS[this.targetIdx];
                    if (this.sensor.gps.lat) {
                        const bear = this.bearing(this.sensor.gps.lat, this.sensor.gps.lon, w.lat, w.lon);
                        document.getElementById('n-wonder').style.transform = `rotate(${bear}deg)`;
                    }
                } else if (this.mode === 'earth') {
                    if (this.sensor.gps.lat) {
                        const sunAz = SunCalc.getPosition(new Date(), this.sensor.gps.lat, this.sensor.gps.lon);
                        document.getElementById('n-sun').style.transform = `rotate(${sunAz}deg)`;
                    }
                } else if (this.mode === 'myth') {
                    const noise = (Math.random() - 0.5) * this.sensor.magVar * 5;
                    document.getElementById('n-wonder').style.transform = `rotate(${this.sensor.head + noise}deg)`;

                    // Omen Text Update
                    const lvl = Math.min(3, Math.floor(this.sensor.magVar));
                    document.getElementById('c-desc').innerText = this.t('omen_' + lvl);
                    document.getElementById('c-desc').style.color = lvl > 1 ? 'var(--neon-r)' : 'var(--text-2)';
                }
            }

            // Utils
            t(k) { return DICT[this.lang][k] || k; }

            toggleLang() {
                this.lang = this.lang === 'en' ? 'th' : 'en';
                localStorage.setItem('wr_lang', this.lang);
                this.updateTexts();
            }

            updateTexts() {
                document.getElementById('lang-tog').innerText = this.lang.toUpperCase();
                if (this.mode === 'wonder') this.updateCard();
                if (this.mode === 'myth') {
                    document.getElementById('c-title').innerText = this.t('mode_myth');
                    document.getElementById('c-quote').innerText = this.t('myth_flavor');
                    document.getElementById('btn-legend').innerText = this.t('legend_btn');
                }
                // Dock buttons
                const btns = document.querySelectorAll('.dock-btn');
                btns[0].innerText = this.t('mode_wonder');
                btns[1].innerText = this.t('mode_earth');
                btns[2].innerText = this.t('mode_myth');
            }

            updateClock() {
                const now = new Date();
                document.getElementById('clock').innerText = now.getHours().toString().padStart(2, '0') + ":" + now.getMinutes().toString().padStart(2, '0');
            }

            nextTarget() {
                this.targetIdx = (this.targetIdx + 1) % WONDERS.length;
                localStorage.setItem('wr_quest_id', this.targetIdx);
                if (navigator.vibrate) navigator.vibrate(20);
                this.updateCard();
            }

            onGPS() {
                if (this.mode === 'wonder') this.findNearest();
            }

            findNearest() {
                if (!this.sensor.gps.lat) return;
                let min = Infinity;
                WONDERS.forEach((w, i) => {
                    const d = this.dist(this.sensor.gps.lat, this.sensor.gps.lon, w.lat, w.lon);
                    if (d < min) { min = d; this.targetIdx = i; }
                });
                this.updateCard();
            }

            showLegend() {
                if (!this.sensor.gps.lat) return;
                let min = Infinity; let story = FOLK_DB[2];
                FOLK_DB.forEach(s => {
                    const d = this.dist(this.sensor.gps.lat, this.sensor.gps.lon, s.lat, s.lon);
                    if (d < min) { min = d; story = s; }
                });
                document.getElementById('leg-title').innerText = story[this.lang].t;
                document.getElementById('leg-body').innerText = story[this.lang].b;
                document.getElementById('modal-legend').classList.add('show');
            }

            closeLegend() {
                document.getElementById('modal-legend').classList.remove('show');
            }

            dist(lat1, lon1, lat2, lon2) {
                const R = 6371;
                const dLat = (lat2 - lat1) * Math.PI / 180;
                const dLon = (lon2 - lon1) * Math.PI / 180;
                const a = Math.sin(dLat / 2) ** 2 + Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) * Math.sin(dLon / 2) ** 2;
                return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
            }

            bearing(lat1, lon1, lat2, lon2) {
                const y = Math.sin((lon2 - lon1) * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180);
                const x = Math.cos(lat1 * Math.PI / 180) * Math.sin(lat2 * Math.PI / 180) - Math.sin(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) * Math.cos((lon2 - lon1) * Math.PI / 180);
                return (Math.atan2(y, x) * 180 / Math.PI + 360) % 360;
            }
        }

        const app = new App();
    </script>
</body>

</html>
