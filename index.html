<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport"
        content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>MAGIC COMPASS | MK-II</title>
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#050508">

    <style>
        /* --- THEME: PURPLE NEON GLASS MK-II --- */
        :root {
            --bg-core: #050508;
            --bg-grad: radial-gradient(circle at 50% 20%, #1e1b4b 0%, #0f0c29 50%, #020204 100%);
            --glass-base: rgba(255, 255, 255, 0.03);
            --glass-border: rgba(255, 255, 255, 0.08);
            --glass-shine: rgba(255, 255, 255, 0.15);
            --blur-val: 24px;
            --neon-p: #d946ef;
            /* Purple */
            --neon-b: #60a5fa;
            /* Blue */
            --neon-r: #f43f5e;
            /* Rose/Alert */
            --neon-g: #34d399;
            /* Green/Safe */
            --text-1: #ffffff;
            --text-2: #94a3b8;
            --text-3: #64748b;
            --font-ui: -apple-system, BlinkMacSystemFont, "SF Pro Display", "Inter", sans-serif;
            --font-mono: "SF Mono", "Menlo", monospace;
            --ease-out: cubic-bezier(0.215, 0.61, 0.355, 1);
        }

        * {
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
            user-select: none;
        }

        body {
            margin: 0;
            background: var(--bg-core);
            background-image: var(--bg-grad);
            color: var(--text-1);
            font-family: var(--font-ui);
            height: 100vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        /* FX */
        .bg-orb {
            position: absolute;
            border-radius: 50%;
            filter: blur(80px);
            opacity: 0.3;
            z-index: 0;
            animation: float 20s infinite alternate ease-in-out;
        }

        .orb-1 {
            width: 300px;
            height: 300px;
            background: var(--neon-p);
            top: -10%;
            left: -20%;
        }

        .orb-2 {
            width: 250px;
            height: 250px;
            background: var(--neon-b);
            bottom: 5%;
            right: -10%;
            animation-delay: -5s;
        }

        @keyframes float {
            0% {
                transform: translate(0, 0);
            }

            100% {
                transform: translate(20px, 30px);
            }
        }

        /* UI COMPONENTS */
        .glass {
            background: var(--glass-base);
            backdrop-filter: blur(var(--blur-val));
            -webkit-backdrop-filter: blur(var(--blur-val));
            border: 1px solid var(--glass-border);
            border-radius: 20px;
        }

        .flex-row {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .flex-col {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .mono {
            font-family: var(--font-mono);
            letter-spacing: -0.5px;
        }

        .hidden {
            display: none !important;
        }

        .btn {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid var(--glass-border);
            color: var(--text-2);
            padding: 10px 16px;
            border-radius: 14px;
            font-size: 0.85rem;
            cursor: pointer;
            transition: 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
        }

        .btn:active {
            transform: scale(0.96);
            background: var(--glass-shine);
        }

        .btn.active {
            border-color: var(--neon-p);
            color: #fff;
            background: rgba(217, 70, 239, 0.15);
            box-shadow: 0 0 15px rgba(217, 70, 239, 0.2);
        }

        /* APP LAYOUT */
        #app {
            position: relative;
            z-index: 10;
            flex: 1;
            display: flex;
            flex-direction: column;
            padding: env(safe-area-inset-top) 16px calc(env(safe-area-inset-bottom) + 16px) 16px;
            gap: 12px;
        }

        /* HEADER */
        .header {
            justify-content: space-between;
            height: 44px;
        }

        .brand {
            font-weight: 800;
            letter-spacing: 2px;
            font-size: 0.9rem;
            color: var(--text-2);
        }

        .badge {
            font-size: 0.65rem;
            padding: 4px 8px;
            border-radius: 12px;
            background: rgba(0, 0, 0, 0.4);
            border: 1px solid var(--glass-border);
            color: var(--text-3);
        }

        .badge.ok {
            border-color: var(--neon-g);
            color: var(--neon-g);
        }

        .badge.warn {
            border-color: var(--neon-r);
            color: var(--neon-r);
            animation: pulse-warn 2s infinite;
        }

        @keyframes pulse-warn {
            0% {
                opacity: 1;
            }

            50% {
                opacity: 0.5;
            }

            100% {
                opacity: 1;
            }
        }

        /* COMPASS ORB MK-II */
        .stage {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            position: relative;
            perspective: 1000px;
        }

        .orb-container {
            position: relative;
            width: 280px;
            height: 280px;
            transform-style: preserve-3d;
        }

        .orb-ring {
            position: absolute;
            inset: 0;
            border-radius: 50%;
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 0 40px rgba(139, 92, 246, 0.1), inset 0 0 40px rgba(0, 0, 0, 0.5);
            transition: transform 0.1s linear;
            /* JS driven smoothing */
            will-change: transform;
        }

        /* Ticks */
        .ticks-major {
            position: absolute;
            inset: -10px;
            border-radius: 50%;
            background: conic-gradient(from 0deg, var(--text-2) 0deg 1deg, transparent 1deg 29deg, var(--text-2) 30deg 31deg, transparent 31deg 360deg);
            mask: radial-gradient(transparent 65%, black 66%);
            -webkit-mask: radial-gradient(transparent 65%, black 66%);
        }

        .ticks-minor {
            position: absolute;
            inset: 0;
            border-radius: 50%;
            background: repeating-conic-gradient(rgba(255, 255, 255, 0.15) 0deg 1deg, transparent 1deg 5deg);
            mask: radial-gradient(transparent 68%, black 69%);
            -webkit-mask: radial-gradient(transparent 68%, black 69%);
        }

        /* Lens Layers */
        .lens-1 {
            position: absolute;
            inset: 10px;
            border-radius: 50%;
            border: 1px solid rgba(255, 255, 255, 0.05);
            background: radial-gradient(circle at 30% 30%, rgba(255, 255, 255, 0.05), transparent 60%);
        }

        .lens-2 {
            position: absolute;
            inset: 30px;
            border-radius: 50%;
            border: 1px solid rgba(255, 255, 255, 0.03);
        }

        /* Cardinals */
        .cardinal {
            position: absolute;
            font-weight: 700;
            font-size: 0.85rem;
            color: var(--text-3);
        }

        .c-n {
            top: 12px;
            left: 50%;
            transform: translateX(-50%);
            color: var(--neon-p);
            text-shadow: 0 0 10px var(--neon-p);
        }

        .c-e {
            right: 16px;
            top: 50%;
            transform: translateY(-50%);
        }

        .c-s {
            bottom: 12px;
            left: 50%;
            transform: translateX(-50%);
        }

        .c-w {
            left: 16px;
            top: 50%;
            transform: translateY(-50%);
        }

        /* Needles */
        .needle-layer {
            position: absolute;
            inset: 0;
            pointer-events: none;
            z-index: 2;
        }

        .needle {
            position: absolute;
            top: 50%;
            left: 50%;
            transform-origin: bottom center;
            transition: transform 0.4s var(--ease-out);
            will-change: transform;
        }

        /* Wonder Needle */
        .n-wonder {
            width: 4px;
            height: 42%;
            margin-left: -2px;
            margin-top: -42%;
            background: linear-gradient(to top, transparent, var(--neon-p));
            border-radius: 4px;
            box-shadow: 0 -4px 12px var(--neon-p);
            z-index: 10;
        }

        .n-wonder::after {
            content: '';
            position: absolute;
            top: -6px;
            left: -3px;
            border-left: 5px solid transparent;
            border-right: 5px solid transparent;
            border-bottom: 8px solid #fff;
        }

        /* North Needle */
        .n-north {
            width: 2px;
            height: 46%;
            margin-left: -1px;
            margin-top: -46%;
            background: var(--neon-b);
            opacity: 0.8;
        }

        /* Center HUD */
        .center-hud {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
            z-index: 5;
        }

        .val-head {
            font-size: 2.4rem;
            font-weight: 800;
            letter-spacing: -1px;
            line-height: 1;
            text-shadow: 0 4px 12px rgba(0, 0, 0, 0.5);
        }

        .lbl-head {
            font-size: 0.65rem;
            color: var(--text-3);
            letter-spacing: 2px;
            margin-top: 4px;
        }

        /* GHOST MONITOR (Myth Mode) */
        .ghost-ui {
            position: absolute;
            inset: -20px;
            pointer-events: none;
            display: none;
        }

        .radar-sweep {
            position: absolute;
            bottom: 0;
            right: 0;
            width: 80px;
            height: 80px;
            border-radius: 50%;
            border: 1px solid rgba(244, 63, 94, 0.3);
            background: rgba(0, 0, 0, 0.2);
            overflow: hidden;
        }

        .sweep-line {
            position: absolute;
            inset: 0;
            background: conic-gradient(from 0deg, transparent 0deg, rgba(244, 63, 94, 0.4) 30deg, transparent 30.1deg);
            animation: sweep 2s linear infinite;
            border-radius: 50%;
        }

        .scope-line {
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100px;
            height: 40px;
            opacity: 0.7;
        }

        @keyframes sweep {
            to {
                transform: rotate(360deg);
            }
        }

        /* INFO DECK */
        .deck {
            margin-top: auto;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .card {
            padding: 16px;
            min-height: 110px;
            position: relative;
            overflow: hidden;
            transition: 0.3s;
        }

        .card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            bottom: 0;
            width: 3px;
            background: var(--text-3);
        }

        .card.wonder::before {
            background: var(--neon-p);
        }

        .card.myth::before {
            background: var(--neon-r);
        }

        .c-title {
            font-size: 1.1rem;
            font-weight: 700;
            color: #fff;
            margin-bottom: 4px;
            line-height: 1.2;
        }

        .c-meta {
            font-size: 0.75rem;
            color: var(--neon-p);
            font-weight: 600;
            margin-bottom: 8px;
        }

        .c-body {
            font-size: 0.85rem;
            color: var(--text-2);
            line-height: 1.5;
        }

        .c-quote {
            font-style: italic;
            color: var(--text-3);
            font-size: 0.8rem;
            margin-top: 8px;
            padding-top: 6px;
            border-top: 1px solid var(--glass-border);
        }

        /* CONTROLS */
        .dock {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 6px;
            background: rgba(0, 0, 0, 0.3);
            padding: 4px;
            border-radius: 20px;
            border: 1px solid var(--glass-border);
        }

        .dock-btn {
            background: transparent;
            border: none;
            color: var(--text-3);
            padding: 12px;
            border-radius: 16px;
            font-size: 0.75rem;
            font-weight: 700;
            cursor: pointer;
            transition: 0.2s;
        }

        .dock-btn.active {
            background: var(--glass-border);
            color: #fff;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
        }

        /* MODALS */
        .modal {
            position: fixed;
            inset: 0;
            z-index: 100;
            background: rgba(0, 0, 0, 0.85);
            backdrop-filter: blur(12px);
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
            opacity: 0;
            pointer-events: none;
            transition: 0.3s;
        }

        .modal.show {
            opacity: 1;
            pointer-events: auto;
        }

        .modal-box {
            width: 100%;
            max-width: 360px;
            padding: 24px;
            max-height: 80vh;
            overflow-y: auto;
        }

        /* CALIBRATION OVERLAY */
        #calib-overlay {
            position: absolute;
            inset: 0;
            background: rgba(0, 0, 0, 0.8);
            z-index: 50;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
            display: none;
        }

        .fig-8 {
            width: 60px;
            height: 30px;
            border: 2px solid var(--neon-p);
            border-radius: 15px;
            animation: spin8 2s infinite linear;
            margin-bottom: 16px;
        }

        @keyframes spin8 {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }
    </style>
</head>

<body>

    <div class="bg-orb orb-1"></div>
    <div class="bg-orb orb-2"></div>

    <!-- PERMISSION WALL -->
    <div id="perm-wall" class="modal show">
        <div class="glass modal-box" style="text-align:center;">
            <h1 style="margin:0 0 10px 0; font-size:1.5rem;" class="brand">MAGIC COMPASS <span
                    style="color:var(--neon-p)">MK-II</span></h1>
            <p style="color:var(--text-2); font-size:0.9rem; margin-bottom:20px;" data-t="perm_desc">Access sensors to
                unlock the grid.</p>
            <button class="btn active" style="width:100%; justify-content:center;" onclick="app.init()">
                <span data-t="btn_start">INITIALIZE SYSTEM</span>
            </button>
        </div>
    </div>

    <!-- CALIBRATION OVERLAY -->
    <div id="calib-overlay">
        <div class="fig-8"></div>
        <div style="font-weight:700; color:#fff;">CALIBRATION REQUIRED</div>
        <div style="font-size:0.8rem; color:var(--text-2); margin-top:4px;">Wave device in Figure-8</div>
    </div>

    <!-- MAIN APP -->
    <div id="app" class="hidden">

        <!-- HEADER -->
        <div class="flex-row header">
            <div class="brand"><span style="color:var(--neon-p)">✦</span> MK-II</div>
            <div class="flex-row">
                <button class="badge" id="btn-lang" onclick="app.toggleLang()">EN</button>
                <div class="badge" id="gps-badge" data-t="gps_wait">GPS WAIT</div>
                <div class="badge" id="acc-badge">±0°</div>
            </div>
        </div>

        <!-- STAGE -->
        <div class="stage">
            <div class="orb-container">
                <div class="orb-ring" id="orb-ring">
                    <div class="ticks-major"></div>
                    <div class="ticks-minor"></div>
                    <div class="lens-1"></div>
                    <div class="lens-2"></div>
                    <div class="cardinal c-n">N</div>
                    <div class="cardinal c-e">E</div>
                    <div class="cardinal c-s">S</div>
                    <div class="cardinal c-w">W</div>
                </div>

                <div class="needle-layer">
                    <div class="needle n-wonder" id="n-wonder"></div>
                    <div class="needle n-north" id="n-north"></div>
                </div>

                <div class="center-hud">
                    <div class="val-head mono" id="val-head">000°</div>
                    <div class="lbl-head" id="lbl-head">HEADING</div>
                </div>

                <!-- MYTH MODE UI -->
                <div class="ghost-ui" id="ghost-ui">
                    <div class="radar-sweep">
                        <div class="sweep-line"></div>
                    </div>
                    <canvas class="scope-line" id="scope-cvs"></canvas>
                </div>
            </div>
        </div>

        <!-- DECK -->
        <div class="deck">
            <!-- INFO CARD -->
            <div class="glass card wonder" id="main-card">
                <div class="c-title" id="c-title">Loading...</div>
                <div class="c-meta mono" id="c-meta">-- km</div>
                <div class="c-body">
                    <div id="c-desc">...</div>
                    <div class="c-quote" id="c-quote"></div>
                </div>
                <!-- Action Buttons -->
                <div class="flex-row" style="margin-top:12px;">
                    <button class="btn" id="btn-legend" onclick="app.showLegend()"
                        style="display:none; flex:1; border-color:var(--neon-r);">
                        <span data-t="btn_legend">Read Legend</span>
                    </button>
                    <button class="btn" id="btn-next" onclick="app.nextTarget()" style="flex:1;">
                        <span data-t="btn_next">Next Target</span>
                    </button>
                </div>
            </div>

            <!-- DOCK -->
            <div class="dock">
                <button class="dock-btn active" onclick="app.setMode('wonder')" data-t="mode_wonder">WONDER</button>
                <button class="dock-btn" onclick="app.setMode('earth')" data-t="mode_earth">EARTH</button>
                <button class="dock-btn" onclick="app.setMode('myth')" data-t="mode_myth">MYTH</button>
            </div>
        </div>
    </div>

    <!-- LEGEND MODAL -->
    <div id="modal-legend" class="modal">
        <div class="glass modal-box">
            <div class="flex-row" style="justify-content:space-between; margin-bottom:12px;">
                <div class="badge warn">LOCAL LEGEND</div>
                <div style="font-size:1.2rem; cursor:pointer;" onclick="app.closeLegend()">×</div>
            </div>
            <h2 id="leg-title" style="margin:0 0 8px 0; color:#fff;"></h2>
            <p id="leg-body" style="color:var(--text-2); line-height:1.6; font-size:0.9rem; white-space:pre-line;"></p>
        </div>
    </div>

    <script>
        /**
         * MAGIC COMPASS MK-II
         * Engineering: Sensor Fusion, Tilt Compensation, Offline AI
         */

        // --- 1. LOCALIZATION & DATA ---
        const DICT = {
            en: {
                perm_desc: "Compass MK-II requires sensor access for precision tracking.",
                btn_start: "INITIALIZE SYSTEM",
                gps_wait: "GPS WAIT",
                gps_ok: "GPS LOCK",
                mode_wonder: "WONDER",
                mode_earth: "EARTH",
                mode_myth: "MYTH",
                btn_next: "Next Target",
                btn_legend: "Read Local Legend",
                lbl_head: "HEADING",
                lbl_var: "VARIANCE",
                calib: "CALIBRATE",
                lore_def: "Scanning archives...",
                omen_0: "Atmosphere: Stable",
                omen_1: "Atmosphere: Unsettled",
                omen_2: "Atmosphere: DISTORTED",
                omen_3: "Atmosphere: CRITICAL",
                myth_flavor: "The veil is thin here."
            },
            th: {
                perm_desc: "Compass MK-II ต้องการเข้าถึงเซนเซอร์เพื่อความแม่นยำ",
                btn_start: "เริ่มระบบ",
                gps_wait: "รอ GPS",
                gps_ok: "GPS พร้อม",
                mode_wonder: "สิ่งมหัศจรรย์",
                mode_earth: "แม่เหล็กโลก",
                mode_myth: "เรื่องลี้ลับ",
                btn_next: "เปลี่ยนเป้าหมาย",
                btn_legend: "อ่านตำนาน",
                lbl_head: "ทิศหัวเครื่อง",
                lbl_var: "ความผันผวน",
                calib: "ปรับเทียบ",
                lore_def: "กำลังค้นข้อมูล...",
                omen_0: "บรรยากาศ: ปกติ",
                omen_1: "บรรยากาศ: แปรปรวน",
                omen_2: "บรรยากาศ: บิดเบี้ยว",
                omen_3: "บรรยากาศ: อันตราย",
                myth_flavor: "ม่านมิติที่นี่บางเบาเหลือเกิน"
            }
        };

        const WONDERS = [
            {
                n: { en: "Great Pyramid", th: "มหาพีระมิดกีซา" }, lat: 29.9792, lon: 31.1342,
                d: { en: "Ancient tomb aligned to true north.", th: "สุสานโบราณที่หันทิศเหนือจริงเป๊ะ" },
                q: { en: "Man fears Time, Time fears the Pyramids.", th: "มนุษย์กลัวเวลา แต่เวลากลัวพีระมิด" }
            },
            {
                n: { en: "Machu Picchu", th: "มาชูปิกชู" }, lat: -13.1631, lon: -72.5450,
                d: { en: "Inca city in the clouds.", th: "นครอินคาลอยฟ้าในม่านเมฆ" },
                q: { en: "The hitching post of the sun.", th: "เสาที่ผูกดวงอาทิตย์ไว้กับโลก" }
            },
            {
                n: { en: "Stonehenge", th: "สโตนเฮนจ์" }, lat: 51.1789, lon: -1.8262,
                d: { en: "Prehistoric stone circle.", th: "วงล้อมหินปริศนายุคก่อนประวัติศาสตร์" },
                q: { en: "A calendar of stone and shadow.", th: "ปฏิทินแห่งหินและเงา" }
            },
            {
                n: { en: "Angkor Wat", th: "นครวัด" }, lat: 13.4125, lon: 103.8670,
                d: { en: "Largest religious monument.", th: "ศาสนสถานตระการตาแห่งเขมร" },
                q: { en: "Heaven on Earth.", th: "สวรรค์บนดินที่สาบสูญ" }
            },
            {
                n: { en: "Bermuda Triangle", th: "สามเหลี่ยมเบอร์มิวดา" }, lat: 25.0000, lon: -71.0000,
                d: { en: "The Devil's Triangle.", th: "น่านน้ำอาถรรพ์ที่เรือหายสาบสูญ" },
                q: { en: "Compass spins wild here.", th: "เข็มทิศหมุนวนอย่างบ้าคลั่ง" }
            }
        ];

        const FOLK_DB = [
            { lat: 13.7, lon: 100.5, r: 50, en: { t: "The Palace Giants", b: "At night, the guardian giants shift their stance." }, th: { t: "ยักษ์วัดพระแก้ว", b: "ตกดึกยักษ์ทวารบาลจะขยับเปลี่ยนท่าแก้เมื่อย" } },
            { lat: 18.7, lon: 98.9, r: 50, en: { t: "Doi Suthep Guardian", b: "A hermit spirit walks the pilgrim path." }, th: { t: "ปู่แสะย่าแสะ", b: "วิญญาณบรรพชนยังคงเดินตรวจตราป่าเขา" } },
            { lat: 0, lon: 0, r: 99999, en: { t: "The Crossroads", b: "Spirits gather where paths meet. Don't whistle at night." }, th: { t: "ทางสามแพร่ง", b: "วิญญาณมักชุมนุมตรงทางแยก อย่าผิวปากตอนกลางคืน" } }
        ];

        // --- 2. SENSOR FUSION ENGINE ---
        class SensorEngine {
            constructor() {
                this.head = 0; // Fused Heading
                this.rawAlpha = 0;
                this.tilt = { beta: 0, gamma: 0 };
                this.gps = { lat: null, lon: null };
                this.magVar = 0; // Magnetic Variance (Anomaly)
                this.acc = 0; // Accuracy (0-360)
                this.os = 'unknown';
                this.listeners = {};
            }

            async init() {
                // 1. GPS
                if ('geolocation' in navigator) {
                    navigator.geolocation.watchPosition(
                        p => {
                            this.gps = { lat: p.coords.latitude, lon: p.coords.longitude };
                            this.emit('gps');
                        },
                        e => console.warn('GPS Error', e),
                        { enableHighAccuracy: true }
                    );
                }

                // 2. COMPASS
                // Detect OS
                const isIOS = typeof DeviceOrientationEvent !== 'undefined' && typeof DeviceOrientationEvent.requestPermission === 'function';
                this.os = isIOS ? 'ios' : 'android';

                if (isIOS) {
                    const perm = await DeviceOrientationEvent.requestPermission();
                    if (perm === 'granted') {
                        window.addEventListener('deviceorientation', e => this.handleIOS(e));
                    }
                } else {
                    // Android: Try Absolute first
                    if ('ondeviceorientationabsolute' in window) {
                        window.addEventListener('deviceorientationabsolute', e => this.handleAndroid(e, true));
                    } else {
                        window.addEventListener('deviceorientation', e => this.handleAndroid(e, false));
                    }
                }
            }

            handleIOS(e) {
                // iOS Webkit Heading is usually accurate and tilt-compensated by OS
                if (e.webkitCompassHeading) {
                    this.head = e.webkitCompassHeading;
                    this.acc = e.webkitCompassAccuracy || 0;
                    this.tilt = { beta: e.beta, gamma: e.gamma };
                    this.emit('heading');
                }
            }

            handleAndroid(e, isAbs) {
                let alpha = e.alpha;
                // Android Alpha is 0=North (if absolute) or 0=Start
                // We need to correct for screen orientation
                if (e.webkitCompassHeading) {
                    // Some Android browsers support this too
                    this.head = e.webkitCompassHeading;
                } else {
                    // Manual Tilt Compensation (Simplified)
                    // Real fusion is complex, but for Compass UI, we prioritize stability
                    // If absolute, alpha is North. If not, it's relative.
                    if (!isAbs) {
                        // Fallback: Just use raw alpha, maybe drift
                        this.acc = -1; // Unknown accuracy
                    } else {
                        this.acc = e.absolute ? 10 : 50;
                    }

                    // Basic Orientation Comp
                    const screenOr = window.screen.orientation ? window.screen.orientation.angle : window.orientation || 0;
                    this.head = (360 - alpha - screenOr) % 360;
                    if (this.head < 0) this.head += 360;
                }

                this.tilt = { beta: e.beta, gamma: e.gamma };
                this.emit('heading');

                // Mag Simulation for Android (if no raw mag sensor API used for simplicity in single file)
                // We calculate variance based on jitter of alpha
                this.calcVariance(e.alpha);
            }

            calcVariance(val) {
                // Simple jitter detector
                if (!this.lastVal) this.lastVal = val;
                const delta = Math.abs(val - this.lastVal);
                this.magVar = this.magVar * 0.9 + delta * 0.1;
                this.lastVal = val;
            }

            on(ev, cb) { this.listeners[ev] = cb; }
            emit(ev) { if (this.listeners[ev]) this.listeners[ev](); }
        }

        // --- 3. APP LOGIC ---
        class App {
            constructor() {
                this.lang = localStorage.getItem('lang') || 'en';
                this.mode = 'wonder';
                this.sensor = new SensorEngine();
                this.targetIdx = 0;
                this.smoothHead = 0;
                this.smoothTarget = 0;

                // Scope Canvas
                this.scopeCtx = document.getElementById('scope-cvs').getContext('2d');
                this.scopeData = new Array(50).fill(0);
            }

            async init() {
                try {
                    await this.sensor.init();
                    document.getElementById('perm-wall').classList.remove('show');
                    document.getElementById('app').classList.remove('hidden');
                    this.sensor.on('gps', () => this.onGPS());
                    this.sensor.on('heading', () => this.onHeading());
                    this.loop();
                    this.updateTexts();
                } catch (e) {
                    alert("Sensors Blocked. Please allow permissions.");
                }
            }

            toggleLang() {
                this.lang = this.lang === 'en' ? 'th' : 'en';
                localStorage.setItem('lang', this.lang);
                document.getElementById('btn-lang').innerText = this.lang.toUpperCase();
                this.updateTexts();
                this.updateCard();
            }

            t(key) { return DICT[this.lang][key] || key; }

            updateTexts() {
                document.querySelectorAll('[data-t]').forEach(el => {
                    el.innerText = this.t(el.dataset.t);
                });
            }

            setMode(m) {
                this.mode = m;
                document.querySelectorAll('.dock-btn').forEach(b => b.classList.remove('active'));
                event.target.classList.add('active');

                const card = document.getElementById('main-card');
                const ghost = document.getElementById('ghost-ui');
                const nWonder = document.getElementById('n-wonder');
                const nNorth = document.getElementById('n-north');
                const btnLegend = document.getElementById('btn-legend');
                const btnNext = document.getElementById('btn-next');

                card.className = `glass card ${m}`;
                ghost.style.display = 'none';
                nWonder.style.opacity = 1;
                btnLegend.style.display = 'none';
                btnNext.style.display = 'block';

                if (m === 'wonder') {
                    this.updateCard();
                } else if (m === 'earth') {
                    document.getElementById('c-title').innerText = this.t('mode_earth');
                    document.getElementById('c-meta').innerText = "MAGNETIC FIELD";
                    document.getElementById('c-desc').innerText = "Tracking True North vs Magnetic North.";
                    document.getElementById('c-quote').innerText = "";
                    nWonder.style.opacity = 0; // Hide wonder needle
                } else if (m === 'myth') {
                    ghost.style.display = 'block';
                    document.getElementById('c-title').innerText = this.t('mode_myth');
                    document.getElementById('c-meta').innerText = "ANOMALY DETECTOR";
                    document.getElementById('c-quote').innerText = this.t('myth_flavor');
                    btnLegend.style.display = 'block';
                    btnNext.style.display = 'none';
                }
            }

            onGPS() {
                document.getElementById('gps-badge').innerText = this.t('gps_ok');
                document.getElementById('gps-badge').classList.add('ok');
                if (this.mode === 'wonder') this.findNearest();
            }

            findNearest() {
                if (!this.sensor.gps.lat) return;
                let min = Infinity;
                WONDERS.forEach((w, i) => {
                    const d = this.dist(this.sensor.gps.lat, this.sensor.gps.lon, w.lat, w.lon);
                    if (d < min) { min = d; this.targetIdx = i; }
                });
                this.updateCard();
            }

            updateCard() {
                if (this.mode !== 'wonder') return;
                const w = WONDERS[this.targetIdx];
                const d = this.sensor.gps.lat ? this.dist(this.sensor.gps.lat, this.sensor.gps.lon, w.lat, w.lon) : 0;

                document.getElementById('c-title').innerText = w.n[this.lang];
                document.getElementById('c-meta').innerText = d.toFixed(0) + " KM";
                document.getElementById('c-desc').innerText = w.d[this.lang];
                document.getElementById('c-quote').innerText = `"${w.q[this.lang]}"`;
            }

            nextTarget() {
                this.targetIdx = (this.targetIdx + 1) % WONDERS.length;
                this.updateCard();
            }

            onHeading() {
                // Calibration Check
                const calib = document.getElementById('calib-overlay');
                if (this.sensor.acc !== -1 && this.sensor.acc < 15) { // Low accuracy
                    calib.style.display = 'flex';
                } else {
                    calib.style.display = 'none';
                }

                document.getElementById('acc-badge').innerText = `±${Math.round(this.sensor.acc)}°`;
            }

            loop() {
                requestAnimationFrame(() => this.loop());

                // 1. Smooth Heading (LPF)
                let h = this.sensor.head;
                let diff = h - this.smoothHead;
                if (diff > 180) diff -= 360;
                if (diff < -180) diff += 360;
                this.smoothHead += diff * 0.15; // Smooth factor

                // 2. Rotate Ring (Opposite to heading)
                const ring = document.getElementById('orb-ring');
                ring.style.transform = `rotate(${-this.smoothHead}deg)`;

                // 3. Update HUD
                document.getElementById('val-head').innerText = Math.round(this.sensor.head).toString().padStart(3, '0') + "°";

                // 4. Target Needle
                if (this.mode === 'wonder') {
                    const w = WONDERS[this.targetIdx];
                    if (this.sensor.gps.lat) {
                        const bear = this.bearing(this.sensor.gps.lat, this.sensor.gps.lon, w.lat, w.lon);
                        // Needle rotation relative to Ring (which is at -Head)
                        // Actually, if Ring rotates -Head, North is at Top.
                        // So Needle just needs to point to Bearing relative to North.
                        // So Needle Rotation = Bearing.
                        // Wait, if Ring is rotated -Head, then 0deg on Ring is North.
                        // So we just rotate Needle to Bearing.
                        document.getElementById('n-wonder').style.transform = `rotate(${bear}deg)`;
                    }
                } else if (this.mode === 'myth') {
                    // Glitchy Needle
                    const noise = (Math.random() - 0.5) * this.sensor.magVar * 5;
                    document.getElementById('n-wonder').style.transform = `rotate(${this.sensor.head + noise}deg)`;
                    this.updateScope();
                }
            }

            updateScope() {
                // Draw Sparkline
                this.scopeData.push(this.sensor.magVar);
                this.scopeData.shift();

                const ctx = this.scopeCtx;
                const w = ctx.canvas.width = 100;
                const h = ctx.canvas.height = 40;

                ctx.clearRect(0, 0, w, h);
                ctx.beginPath();
                ctx.strokeStyle = '#f43f5e';
                ctx.lineWidth = 2;

                this.scopeData.forEach((v, i) => {
                    const x = (i / 50) * w;
                    const y = h - (v * 5);
                    if (i === 0) ctx.moveTo(x, y); else ctx.lineTo(x, y);
                });
                ctx.stroke();

                // Omen Text
                const lvl = Math.min(3, Math.floor(this.sensor.magVar));
                if (this.mode === 'myth') {
                    document.getElementById('c-desc').innerText = this.t('omen_' + lvl);
                    document.getElementById('c-desc').style.color = lvl > 1 ? 'var(--neon-r)' : 'var(--text-2)';
                }
            }

            // --- MATH UTILS ---
            dist(lat1, lon1, lat2, lon2) {
                const R = 6371;
                const dLat = (lat2 - lat1) * Math.PI / 180;
                const dLon = (lon2 - lon1) * Math.PI / 180;
                const a = Math.sin(dLat / 2) ** 2 + Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) * Math.sin(dLon / 2) ** 2;
                return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
            }

            bearing(lat1, lon1, lat2, lon2) {
                const y = Math.sin((lon2 - lon1) * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180);
                const x = Math.cos(lat1 * Math.PI / 180) * Math.sin(lat2 * Math.PI / 180) - Math.sin(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) * Math.cos((lon2 - lon1) * Math.PI / 180);
                return (Math.atan2(y, x) * 180 / Math.PI + 360) % 360;
            }

            showLegend() {
                // Find nearest folk story
                if (!this.sensor.gps.lat) return;
                let min = Infinity; let story = FOLK_DB[2]; // Default
                FOLK_DB.forEach(s => {
                    const d = this.dist(this.sensor.gps.lat, this.sensor.gps.lon, s.lat, s.lon);
                    if (d < min) { min = d; story = s; }
                });

                document.getElementById('leg-title').innerText = story[this.lang].t;
                document.getElementById('leg-body').innerText = story[this.lang].b;
                document.getElementById('modal-legend').classList.add('show');
            }

            closeLegend() {
                document.getElementById('modal-legend').classList.remove('show');
            }
        }

        const app = new App();
    </script>
</body>

</html>
