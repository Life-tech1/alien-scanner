<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>OMEGA: MILITARY OS (iOS FIX)</title>
    
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/coco-ssd"></script>

    <style>
        :root {
            --hud-primary: #00ff41; /* Terminal Green */
            --hud-warning: #ffcc00;
            --hud-danger: #ff0000;
            --bg-color: #000000;
            --glass-panel: rgba(0, 20, 0, 0.85);
        }

        * { box-sizing: border-box; user-select: none; -webkit-touch-callout: none; }

        body {
            margin: 0; overflow: hidden; background: var(--bg-color);
            font-family: 'Courier New', Courier, monospace;
            color: var(--hud-primary);
            width: 100vw; height: 100vh;
        }

        /* LAYOUT */
        #viewport { position: relative; width: 100%; height: 100%; }
        #camera-feed {
            position: absolute; width: 100%; height: 100%; object-fit: cover;
            z-index: 0; filter: contrast(1.1) brightness(0.8) grayscale(0.2);
        }
        #hud-canvas { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 10; }
        
        #ui-layer {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            z-index: 20; pointer-events: none; display: flex; flex-direction: column; justify-content: space-between; padding: 10px;
            padding-top: max(20px, env(safe-area-inset-top));
        }

        .panel {
            background: var(--glass-panel); border: 1px solid var(--hud-primary);
            padding: 8px; font-size: 10px; width: fit-content;
            box-shadow: 0 0 10px rgba(0, 255, 65, 0.2);
        }
        .top-bar { display: flex; justify-content: space-between; width: 100%; }

        /* CROSSHAIR */
        #crosshair {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            width: 40px; height: 40px; border: 1px solid rgba(0, 255, 65, 0.5); z-index: 15; pointer-events: none;
        }
        #crosshair::after {
            content: ''; position: absolute; top: 50%; left: 50%; width: 4px; height: 4px; background: var(--hud-primary); transform: translate(-50%, -50%);
        }

        /* BOOT SCREEN */
        #boot-screen {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: #000; z-index: 999; color: var(--hud-primary);
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            font-size: 12px;
        }
        .log-scroll {
            width: 300px; height: 150px; overflow-y: auto;
            border: 1px solid #333; padding: 10px; margin-bottom: 20px;
            font-family: monospace; text-align: left;
        }
        #btn-init {
            background: #003300; color: var(--hud-primary); border: 2px solid var(--hud-primary);
            padding: 15px 40px; cursor: pointer; font-family: monospace; font-weight: bold;
            text-transform: uppercase; letter-spacing: 2px; transition: all 0.2s;
            box-shadow: 0 0 20px var(--hud-primary);
        }
        #btn-init:active { background: var(--hud-primary); color: #000; }
    </style>
</head>
<body>

    <div id="viewport">
        <video id="camera-feed" autoplay playsinline muted></video>
        <canvas id="hud-canvas"></canvas>
        <div id="crosshair"></div>

        <div id="ui-layer">
            <div class="top-bar">
                <div class="panel">
                    <div>CPU: <span id="val-cpu">0</span>ms</div>
                    <div>FPS: <span id="val-fps">0</span></div>
                </div>
                <div class="panel" style="text-align: right;">
                    <div>PITCH: <span id="val-pitch">0</span>°</div>
                    <div>ROLL: <span id="val-roll">0</span>°</div>
                    <div>G: <span id="val-g">1.0</span></div>
                </div>
            </div>
            <div style="align-self: center; margin-bottom: 20px;" class="panel">
                <div>TARGET: <span id="target-data" style="color: var(--hud-warning);">SCANNING...</span></div>
            </div>
        </div>
    </div>

    <div id="boot-screen">
        <div style="font-size: 24px; font-weight: bold; margin-bottom: 10px;">OMEGA OS</div>
        <div style="margin-bottom: 10px; opacity: 0.7;">iOS COMPATIBLE KERNEL</div>
        <div class="log-scroll" id="boot-log"></div>
        <button id="btn-init">INITIATE SEQUENCE</button>
    </div>

<script>
// --- UTILS ---
const Logger = {
    el: document.getElementById('boot-log'),
    log(msg) {
        const line = document.createElement('div');
        line.innerText = `> ${msg}`;
        this.el.appendChild(line);
        this.el.scrollTop = this.el.scrollHeight;
    }
};

// --- 1. SENSORS (iOS FIX APPLIED) ---
class AvionicsSystem {
    constructor() {
        this.pitch = 0; this.roll = 0;
        this.gForce = 1.0;
    }

    // Requires DIRECT user gesture
    async requestAccess() {
        if (typeof DeviceOrientationEvent.requestPermission === 'function') {
            try {
                const permission = await DeviceOrientationEvent.requestPermission();
                if (permission === 'granted') {
                    Logger.log("ACCESS GRANTED: GYROSCOPE");
                    this.startListeners();
                    return true;
                } else {
                    Logger.log("ACCESS DENIED: GYROSCOPE");
                    alert("Permission Denied. Please restart and allow sensors.");
                    return false;
                }
            } catch (e) {
                Logger.log("ERROR: " + e);
                return false;
            }
        } else {
            // Non-iOS 13+ devices
            this.startListeners();
            return true;
        }
    }

    startListeners() {
        window.addEventListener('deviceorientation', (e) => {
            this.pitch = e.beta || 0;
            this.roll = e.gamma || 0;
        });
        window.addEventListener('devicemotion', (e) => {
            const acc = e.accelerationIncludingGravity;
            if(acc) {
                const x = acc.x || 0; const y = acc.y || 0; const z = acc.z || 0;
                this.gForce = Math.sqrt(x*x + y*y + z*z) / 9.8;
            }
        });
    }
}

// --- 2. AI ENGINE ---
class NeuralEngine {
    constructor() { this.model = null; this.lastTime = 0; }
    async init() {
        Logger.log("LOADING NEURAL NET...");
        await tf.setBackend('webgl');
        this.model = await cocoSsd.load();
        Logger.log("NEURAL NET READY");
    }
    async predict(video) {
        if(!this.model || video.readyState !== 4) return [];
        const start = performance.now();
        const res = await this.model.detect(video, 5, 0.5);
        this.lastTime = Math.floor(performance.now() - start);
        return res;
    }
}

// --- 3. HUD ---
class HUD {
    constructor() {
        this.canvas = document.getElementById('hud-canvas');
        this.ctx = this.canvas.getContext('2d');
        this.resize();
        window.addEventListener('resize', () => this.resize());
    }
    resize() {
        this.canvas.width = window.innerWidth;
        this.canvas.height = window.innerHeight;
        this.w = this.canvas.width;
        this.h = this.canvas.height;
    }
    clear() { this.ctx.clearRect(0, 0, this.w, this.h); }
    
    drawHorizon(pitch, roll) {
        const ctx = this.ctx;
        ctx.save();
        ctx.translate(this.w/2, this.h/2);
        ctx.rotate(roll * Math.PI / 180);
        ctx.translate(0, pitch * 4);
        
        ctx.strokeStyle = 'rgba(0, 255, 65, 0.4)';
        ctx.lineWidth = 2;
        ctx.beginPath(); ctx.moveTo(-300, 0); ctx.lineTo(300, 0); ctx.stroke();
        
        // Ladder
        for(let i=-4; i<=4; i++) {
            if(i===0) continue;
            const y = i * 40;
            ctx.beginPath(); ctx.moveTo(-50, y); ctx.lineTo(50, y); ctx.stroke();
        }
        ctx.restore();
    }

    drawBox(p) {
        const ctx = this.ctx;
        const [x, y, w, h] = p.bbox;
        const color = p.class === 'person' ? '#ff0000' : '#00ff41';
        
        ctx.strokeStyle = color; ctx.lineWidth = 2;
        ctx.beginPath();
        // Brackets
        const L = 20;
        ctx.moveTo(x, y+L); ctx.lineTo(x, y); ctx.lineTo(x+L, y);
        ctx.moveTo(x+w-L, y); ctx.lineTo(x+w, y); ctx.lineTo(x+w, y+L);
        ctx.moveTo(x, y+h-L); ctx.lineTo(x, y+h); ctx.lineTo(x+L, y+h);
        ctx.moveTo(x+w-L, y+h); ctx.lineTo(x+w, y+h); ctx.lineTo(x+w, y+h-L);
        ctx.stroke();

        ctx.fillStyle = color; ctx.font = "10px monospace";
        ctx.fillText(`${p.class.toUpperCase()} ${Math.round(p.score*100)}%`, x+5, y-5);
    }
}

// --- MAIN ---
const App = {
    avionics: new AvionicsSystem(),
    neural: new NeuralEngine(),
    hud: new HUD(),
    video: document.getElementById('camera-feed'),
    
    async start() {
        try {
            // 1. IMPORTANT: Request Sensors FIRST (Must be direct response to click)
            const sensorAuth = await this.avionics.requestAccess();
            if(!sensorAuth) return;

            // 2. Camera
            Logger.log("ACCESSING OPTICAL SENSORS...");
            const stream = await navigator.mediaDevices.getUserMedia({ 
                video: { facingMode: 'environment' }, audio: false 
            });
            this.video.srcObject = stream;
            
            // 3. AI
            await this.neural.init();

            // 4. Launch
            document.getElementById('boot-screen').style.display = 'none';
            this.loop();

        } catch(e) {
            Logger.log("CRITICAL FAILURE: " + e);
            alert("Error: " + e.message);
        }
    },

    loop() {
        requestAnimationFrame(() => this.loop());
        
        // Logic
        this.neural.predict(this.video).then(preds => {
            this.hud.clear();
            this.hud.drawHorizon(this.avionics.pitch, this.avionics.roll);
            
            let targetTxt = "NO TARGET";
            let targetColor = "#ffcc00";

            preds.forEach(p => {
                this.hud.drawBox(p);
                if(p.score > 0.6) {
                    targetTxt = `LOCKED: ${p.class.toUpperCase()}`;
                    targetColor = "#00ff41";
                }
            });

            // UI Update
            document.getElementById('target-data').innerText = targetTxt;
            document.getElementById('target-data').style.color = targetColor;
            document.getElementById('val-cpu').innerText = this.neural.lastTime;
            document.getElementById('val-pitch').innerText = this.avionics.pitch.toFixed(0);
            document.getElementById('val-roll').innerText = this.avionics.roll.toFixed(0);
            document.getElementById('val-g').innerText = this.avionics.gForce.toFixed(2);
        });
    }
};

// CLICK TRIGGER
document.getElementById('btn-init').addEventListener('click', () => {
    App.start();
});

Logger.log("SYSTEM STANDBY...");
Logger.log("WAITING FOR USER INPUT...");

</script>
</body>
</html>
