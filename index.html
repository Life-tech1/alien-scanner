<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>WIND ROSE | WR</title>
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#000000">
    <meta name="description" content="Wind Rose: The Treasure Seekerâ€™s Compass">

    <style>
        /* ------------------------------------------------------------------
           CORE: RESET & SYSTEM
           ------------------------------------------------------------------ */
        :root {
            --bg-core: #000000;
            --bg-grad: radial-gradient(circle at 50% 30%, #1c1c2e 0%, #000000 80%);
            
            /* Glass System */
            --glass-surf: rgba(255, 255, 255, 0.06);
            --glass-border: rgba(255, 255, 255, 0.1);
            --blur-val: 24px;

            /* WR Palette */
            --wr-p: #d946ef; --wr-b: #60a5fa; --wr-y: #fbbf24; 
            --wr-r: #f43f5e; --wr-g: #34d399;
            
            --font-main: -apple-system, BlinkMacSystemFont, "SF Pro Display", "Inter", sans-serif;
            --font-mono: "SF Mono", "Menlo", monospace;

            --safe-top: env(safe-area-inset-top, 20px);
            --safe-bot: env(safe-area-inset-bottom, 20px);
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

        html, body {
            margin: 0; padding: 0;
            background: var(--bg-core); background-image: var(--bg-grad);
            color: #fff; font-family: var(--font-main);
            height: 100%; width: 100%; overflow: hidden; 
            touch-action: none; overscroll-behavior: none;
            user-select: none; -webkit-user-select: none;
            display: flex; flex-direction: column;
        }

        /* ------------------------------------------------------------------
           A) APPLE-MINIMAL STARTUP OVERLAY
           ------------------------------------------------------------------ */
        #overlay {
            position: fixed; inset: 0; z-index: 999;
            background: #000; /* Pure black base */
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            transition: opacity 0.8s cubic-bezier(0.25, 1, 0.5, 1);
        }
        #overlay::after {
            content:''; position: absolute; inset: 0;
            background: radial-gradient(circle, rgba(255,255,255,0.05) 0%, transparent 60%);
            pointer-events: none;
        }
        #overlay.fade-out { opacity: 0; pointer-events: none; }

        /* The Core Brand Mark */
        .brand-core {
            position: relative; width: 120px; height: 120px;
            display: flex; align-items: center; justify-content: center;
            margin-bottom: 20px; pointer-events: none;
        }
        
        /* The "W" */
        .hero-w {
            font-family: var(--font-main); font-weight: 200; font-size: 4rem;
            color: #fff; letter-spacing: -2px; z-index: 2;
            opacity: 0; animation: fadeInLogo 1.5s ease-out forwards 0.2s;
        }

        /* The Minimal Spinner Ring */
        .loader-ring {
            position: absolute; inset: 0; border-radius: 50%;
            border: 1px solid rgba(255,255,255,0.1);
            border-top-color: #fff;
            animation: spin 1.5s linear infinite;
            opacity: 0; animation: spin 1.5s linear infinite, fadeIn 1s ease-out forwards;
        }

        /* Tap Hint Text */
        #tap-hint {
            font-family: var(--font-mono); font-size: 0.75rem; letter-spacing: 2px;
            color: rgba(255,255,255,0.7); text-transform: uppercase;
            opacity: 0; animation: fadeIn 1s ease-out forwards 0.5s, breathe 3s infinite ease-in-out;
            pointer-events: none;
        }

        /* Invisible Full-Screen Trigger Button */
        #btn-init {
            position: absolute; inset: 0; width: 100%; height: 100%;
            background: transparent; border: none; cursor: pointer;
            z-index: 1000; outline: none;
            /* No display:none, just transparent */
        }

        /* Hidden Diagnostics (Must exist for JS) */
        .sys-hidden { display: none; }

        @keyframes spin { to { transform: rotate(360deg); } }
        @keyframes fadeInLogo { from { opacity: 0; transform: scale(0.9); } to { opacity: 1; transform: scale(1); } }
        @keyframes fadeIn { to { opacity: 1; } }
        @keyframes breathe { 0%, 100% { opacity: 0.5; } 50% { opacity: 0.9; } }

        /* ------------------------------------------------------------------
           B) ONBOARDING & MODALS
           ------------------------------------------------------------------ */
        .modal-wrap {
            position: fixed; inset: 0; z-index: 200; background: rgba(0,0,0,0.85);
            backdrop-filter: blur(16px); -webkit-backdrop-filter: blur(16px);
            display: flex; align-items: center; justify-content: center;
            padding: 24px; opacity: 0; pointer-events: none; transition: 0.4s var(--ease-out);
        }
        .modal-wrap.show { opacity: 1; pointer-events: auto; }

        .glass-modal {
            width: 100%; max-width: 380px; background: var(--glass-surf);
            border: 1px solid var(--glass-border); border-radius: 32px;
            padding: 32px 24px; text-align: center;
            box-shadow: 0 20px 50px rgba(0,0,0,0.6);
            transform: scale(0.95); transition: transform 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        .modal-wrap.show .glass-modal { transform: scale(1); }

        .ob-icon { font-size: 2.5rem; margin-bottom: 16px; display: block; text-shadow: 0 0 20px var(--wr-p); }
        .ob-title { font-size: 1.3rem; font-weight: 700; color: #fff; margin-bottom: 12px; line-height: 1.3; }
        .ob-body { font-size: 0.95rem; color: var(--text-2); line-height: 1.6; margin-bottom: 24px; white-space: pre-line; }
        .ob-note { font-size: 0.75rem; color: #666; border-top: 1px solid rgba(255,255,255,0.1); padding-top: 12px; margin-bottom: 24px; }
        
        .btn-action {
            background: #fff; color: #000; border: none;
            padding: 14px 32px; border-radius: 30px; font-size: 1rem; font-weight: 600;
            cursor: pointer; width: 100%; transition: transform 0.2s, opacity 0.2s;
        }
        .btn-action:active { transform: scale(0.97); opacity: 0.9; }

        /* Toast Hint */
        .hint-toast {
            position: fixed; bottom: 120px; left: 50%; transform: translateX(-50%) translateY(20px);
            background: rgba(20, 20, 30, 0.9); border: 1px solid var(--wr-p);
            color: #fff; padding: 10px 20px; border-radius: 30px; font-size: 0.85rem;
            opacity: 0; pointer-events: none; transition: 0.5s; z-index: 150;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5); display: flex; align-items: center; gap: 8px;
        }
        .hint-toast.show { opacity: 1; transform: translateX(-50%) translateY(0); }

        /* ------------------------------------------------------------------
           MAIN HUD (GLASS SCI-FI) - PRESENCE
           ------------------------------------------------------------------ */
        .scanlines {
            position: fixed; inset: 0; pointer-events: none; z-index: 10; 
            background: linear-gradient(to bottom, rgba(255,255,255,0), rgba(255,255,255,0) 50%, rgba(0,0,0,0.1) 50%, rgba(0,0,0,0.1));
            background-size: 100% 4px; opacity: 0; transition: opacity 2s;
        }
        
        #app {
            position: relative; z-index: 20; flex: 1;
            display: flex; flex-direction: column;
            padding: var(--safe-top) 16px calc(var(--safe-bot) + 12px) 16px;
            gap: 12px; opacity: 0; transition: opacity 1.5s ease;
        }
        #app.visible { opacity: 1; }
        body.active .scanlines { opacity: 0.15; }

        /* ... [Existing HUD Styles Preserved] ... */
        .glass-panel { background: var(--glass-surf); backdrop-filter: blur(var(--blur-val)); -webkit-backdrop-filter: blur(var(--blur-val)); border: 1px solid var(--glass-border); border-radius: 24px; box-shadow: 0 10px 30px rgba(0,0,0,0.5); }
        .header { display: flex; justify-content: space-between; align-items: center; height: 44px; }
        .brand { font-weight: 700; letter-spacing: 2px; font-size: 0.8rem; color: #aaa; }
        .badge { font-size: 0.65rem; padding: 4px 10px; border-radius: 12px; background: rgba(255,255,255,0.1); color: #888; }
        .badge.active { color: var(--wr-g); border: 1px solid var(--wr-g); background: rgba(52, 211, 153, 0.1); }
        .stage { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; position: relative; }
        .orb-ring { width: 280px; height: 280px; border-radius: 50%; position: relative; box-shadow: 0 0 60px rgba(217, 70, 239, 0.1), inset 0 0 40px rgba(0,0,0,0.8); border: 1px solid rgba(255,255,255,0.08); will-change: transform; }
        .ticks { position: absolute; inset: -10px; border-radius: 50%; background: repeating-conic-gradient(rgba(255,255,255,0.2) 0deg 1deg, transparent 1deg 10deg); mask: radial-gradient(transparent 65%, black 66%); -webkit-mask: radial-gradient(transparent 65%, black 66%); }
        .cardinals { position: absolute; inset: 10px; pointer-events: none; }
        .card { position: absolute; font-weight: 700; font-size: 0.8rem; color: #666; }
        .c-n { top: 0; left: 50%; transform: translateX(-50%); color: var(--wr-r); }
        .c-e { top: 50%; right: 0; transform: translateY(-50%); }
        .c-s { bottom: 0; left: 50%; transform: translateX(-50%); }
        .c-w { top: 50%; left: 0; transform: translateY(-50%); }
        .needle-layer { position: absolute; inset: 0; pointer-events: none; }
        .ndl { position: absolute; top: 50%; left: 50%; transform-origin: bottom center; transition: opacity 0.3s; will-change: transform; }
        .n-main { width: 6px; height: 42%; margin-left: -3px; margin-top: -42%; background: linear-gradient(to top, transparent, var(--wr-p)); border-radius: 4px; z-index: 3; box-shadow: 0 -5px 15px var(--wr-p); }
        .n-sun { width: 2px; height: 48%; margin-left: -1px; margin-top: -48%; background: var(--wr-y); z-index: 2; opacity: 0.8; box-shadow: 0 0 8px var(--wr-y); }
        .n-true { width: 2px; height: 48%; background: var(--wr-b); margin-left: -1px; margin-top: -48%; opacity: 0.8; }
        .hud-val { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); text-align: center; pointer-events: none; }
        .h-deg { font-size: 2.5rem; font-weight: 800; letter-spacing: -1px; line-height: 1; }
        .h-lbl { font-size: 0.6rem; color: #666; letter-spacing: 2px; margin-top: 4px; }
        .deck { display: flex; flex-direction: column; gap: 10px; margin-top: auto; perspective: 1000px; }
        .info-card { padding: 20px; min-height: 120px; position: relative; overflow: hidden; }
        .info-card::before { content:''; position: absolute; top:0; left:0; bottom:0; width: 3px; background: var(--wr-p); }
        .ic-head { display: flex; justify-content: space-between; align-items: baseline; margin-bottom: 8px; }
        .ic-title { font-size: 1.1rem; font-weight: 700; color: #fff; }
        .ic-meta { font-size: 0.8rem; font-family: var(--font-mono); color: var(--wr-p); }
        .ic-body { font-size: 0.85rem; color: #aaa; line-height: 1.5; }
        .ic-quote { font-style: italic; color: #666; margin-top: 8px; font-size: 0.8rem; border-top: 1px solid rgba(255,255,255,0.1); padding-top: 6px; }
        .radar-box { position: absolute; bottom: -20px; right: -20px; width: 140px; height: 140px; display: none; }
        .radar-sweep { width: 100%; height: 100%; border-radius: 50%; border: 1px solid rgba(255,255,255,0.1); background: conic-gradient(from 0deg, transparent 0deg, rgba(217, 70, 239, 0.2) 60deg, transparent 60.1deg); animation: sweep 3s linear infinite; }
        .blip { position: absolute; width: 5px; height: 5px; background: #fff; border-radius: 50%; box-shadow: 0 0 8px var(--wr-r); opacity: 0; animation: blip 2s ease-out; }
        .btn-row { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 8px; margin-top: 5px; }
        .btn { background: rgba(255,255,255,0.05); border: 1px solid var(--glass-border); color: #aaa; padding: 12px; border-radius: 16px; font-size: 0.8rem; display: flex; align-items: center; justify-content: center; gap: 6px; cursor: pointer; touch-action: manipulation; }
        .btn:active { background: rgba(255,255,255,0.15); transform: scale(0.98); }
        .btn.active { border-color: var(--wr-p); color: #fff; background: rgba(217, 70, 239, 0.1); }
        .dock { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 6px; background: rgba(0,0,0,0.6); padding: 5px; border-radius: 24px; border: 1px solid var(--glass-border); }
        .dock-item { background: transparent; border: none; color: #666; padding: 10px; border-radius: 20px; font-size: 0.7rem; font-weight: 700; cursor: pointer; touch-action: manipulation; }
        .dock-item.active { background: rgba(255,255,255,0.1); color: #fff; }
        .modal-box { width: 100%; max-width: 400px; padding: 24px; max-height: 80vh; overflow-y: auto; }
        .m-title { font-size: 1.2rem; font-weight: 700; color: #fff; margin-bottom: 12px; }
        .warn-toast { position: absolute; bottom: 25%; left: 50%; transform: translateX(-50%); background: rgba(244, 63, 94, 0.2); border: 1px solid var(--wr-r); color: var(--wr-r); padding: 6px 12px; border-radius: 20px; font-size: 0.7rem; pointer-events: none; opacity: 0; transition: opacity 0.3s; }
        .warn-toast.show { opacity: 1; animation: pulse 1s infinite; }
        @keyframes pulse { 50% { opacity: 0.5; } }

        /* --- WIKI LORE STYLES (PATCHED) --- */
        #btn-lore {
            display: none; /* Auto-toggled by JS */
            margin-top: 12px; width: 100%;
            background: rgba(217, 70, 239, 0.1); border: 1px solid rgba(217, 70, 239, 0.3);
            color: var(--wr-p); font-size: 0.75rem; font-weight: 700;
            padding: 10px 0; border-radius: 16px; cursor: pointer;
            text-transform: uppercase; letter-spacing: 1px;
            transition: 0.3s ease;
        }
        #btn-lore:active { background: var(--wr-p); color: #000; }
        
        /* Wiki Modal */
        .lore-container { text-align: left; padding-bottom: 20px; }
        .lore-thumb {
            width: 100%; height: 160px; object-fit: cover; border-radius: 12px;
            margin-bottom: 16px; border: 1px solid rgba(255,255,255,0.1);
            display: none; /* Hidden by default */
        }
        .lore-thumb.active { display: block; }
        .lore-hero { font-size: 1.3rem; font-weight: 800; color: #fff; margin-bottom: 4px; letter-spacing: -0.5px; }
        .lore-p { color: #ccc; font-size: 0.95rem; line-height: 1.6; white-space: pre-line; margin-bottom: 16px; }
        
        .wiki-src { 
            display: block; font-size: 0.75rem; color: #666; margin-top: 10px; 
            text-decoration: none; border-top: 1px solid rgba(255,255,255,0.1); padding-top: 10px;
        }
        .wiki-src span { color: var(--wr-b); text-decoration: underline; }

        .lore-close-btn {
            width: 100%; padding: 14px; border-radius: 20px;
            background: rgba(255,255,255,0.1); border: none; color: #fff;
            font-weight: 600; cursor: pointer; margin-top: 12px;
        }
        
        /* Spinner for Wiki */
        .wiki-loader {
            display: none; justify-content: center; align-items: center; padding: 40px;
        }
        .wiki-loader.show { display: flex; }
        .wl-spin {
            width: 24px; height: 24px; border: 2px solid rgba(255,255,255,0.1);
            border-top-color: var(--wr-p); border-radius: 50%;
            animation: spin 1s linear infinite;
        }

    </style>
</head>
<body>

    <div class="bg-orb orb-1"></div>
    <div class="bg-orb orb-2"></div>
    <div class="scanlines"></div>

    <!-- A) MINIMAL STARTUP OVERLAY -->
    <div id="overlay">
        <div class="brand-core">
            <div class="loader-ring"></div>
            <div class="hero-w">W</div>
        </div>
        
        <!-- Tap Hint (Language Auto-detects) -->
        <div id="tap-hint" data-t="tap_start">TAP TO START</div>

        <!-- Hidden Diagnostics (ID Preserved for JS) -->
        <div class="sys-hidden">
            <span id="chk-gps"></span>
            <span id="chk-gyro"></span>
            <span id="chk-mag"></span>
        </div>

        <!-- Invisible Full-Screen Trigger -->
        <button id="btn-init"></button>
    </div>

    <!-- B) ONBOARDING MODAL -->
    <div id="modal-onboard" class="modal-wrap">
        <div class="glass-modal">
            <span class="ob-icon">ðŸ§­</span>
            <div class="ob-title" data-t="ob_title">Wind Rose</div>
            <div class="ob-body" data-t="ob_body">Loading...</div>
            <div class="ob-note" data-t="ob_note">...</div>
            <button class="btn-action" onclick="app.finishOnboarding()" data-t="ob_btn">Let's Go</button>
        </div>
    </div>

    <!-- MAIN HUD -->
    <div id="app">
        <div class="header">
            <div class="brand">WR // MK-III</div>
            <div class="flex-row">
                <div class="badge" onclick="app.toggleLang()" style="cursor:pointer" id="lbl-lang">EN</div>
                <div class="badge" id="gps-badge">GPS WAIT</div>
                <div style="cursor:pointer; opacity:0.7" onclick="app.toggleSettings()">âš™</div>
            </div>
        </div>

        <div class="stage">
            <div class="orb-ring" id="ring">
                <div class="ticks"></div>
                <div class="cardinals">
                    <div class="card c-n">N</div><div class="card c-e">E</div>
                    <div class="card c-s">S</div><div class="card c-w">W</div>
                </div>
                <div class="needle-layer">
                    <div class="ndl n-main" id="n-main"></div>
                    <div class="ndl n-sun" id="n-sun"></div>
                    <div class="ndl n-true" id="n-true"></div>
                </div>
                <div class="hud-val">
                    <div class="h-deg" id="val-head">000Â°</div>
                    <div class="h-lbl" id="lbl-sub">HEADING</div>
                </div>
            </div>
            <div class="warn-toast" id="warn-ui">CALIBRATE</div>
            <div class="radar-box" id="radar-ui"><div class="radar-sweep"></div></div>
        </div>

        <div class="deck">
            <div class="glass-panel info-card" id="main-card">
                <div class="ic-head">
                    <div class="ic-title" id="c-title">Ready</div>
                    <div class="ic-meta" id="c-dist">--</div>
                </div>
                <div class="ic-body">
                    <div id="c-body">Select a mode to begin.</div>
                    <ul class="c-facts" id="c-facts"></ul>
                    <div class="ic-quote" id="c-quote"></div>
                    
                    <!-- NEW LORE BUTTON (PATCH) -->
                    <button id="btn-lore" onclick="app.openLore()" data-t="btn_read_lore">ðŸ“œ READ LEGEND</button>
                </div>
            </div>

            <div class="btn-row" id="ctrls">
                <button class="btn active" id="btn-auto" onclick="app.toggleAuto()"><span>âŸ³</span> <span id="txt-auto">Auto</span></button>
                <button class="btn" onclick="app.nextTarget()"><span>â†’</span> <span id="txt-next">Next</span></button>
                <button class="btn" onclick="app.openMap()"><span>â†—</span> <span id="txt-map">Map</span></button>
            </div>

            <div class="dock">
                <button class="dock-item active" onclick="app.setMode('disc')" id="m-disc">DISCOVERY</button>
                <button class="dock-item" onclick="app.setMode('geo')" id="m-geo">GEOMAG</button>
                <button class="dock-item" onclick="app.setMode('whis')" id="m-whis">WHISPERS</button>
            </div>
        </div>
    </div>

    <!-- OTHER MODALS -->
    <div id="modal-set" class="modal-wrap">
        <div class="glass-panel modal-box">
            <div class="m-title">SETTINGS</div>
            <button class="btn" style="width:100%; margin-bottom:10px;" onclick="app.resetView()">RESET VIEW</button>
            <button class="btn" style="width:100%; margin-top:20px; border-color:var(--wr-r); color:var(--wr-r)" onclick="app.toggleSettings()">CLOSE</button>
        </div>
    </div>

    <!-- NEW WIKI LORE MODAL (PATCH) -->
    <div id="modal-lore" class="modal-wrap">
        <div class="glass-panel modal-box" style="max-width:450px;">
            <div class="wiki-loader" id="l-spin"><div class="wl-spin"></div></div>
            <div class="lore-container" id="l-content" style="display:none">
                <img id="l-thumb" class="lore-thumb" alt="Wiki Thumb">
                <div class="lore-hero" id="l-title">Title</div>
                <div class="lore-p" id="l-text">...</div>
                <a href="#" target="_blank" class="wiki-src" id="l-src">Source: Wikipedia <span>(Read Full)</span></a>
            </div>
            <button class="lore-close-btn" onclick="app.closeLore()" data-t="btn_close">CLOSE</button>
        </div>
    </div>

    <!-- HINT TOAST -->
    <div class="hint-toast" id="hint-toast">
        <span>ðŸ‘»</span> <span data-t="hint_myth">Tap Myth for legends</span>
    </div>

<script>
/**
 * WIND ROSE (WR) | MK-III PRODUCTION
 * Apple-Minimal Startup & Onboarding
 */

/* --- 0. GESTURE CONTROL --- */
document.addEventListener('gesturestart', e => e.preventDefault());
let lastTouch = 0;
document.addEventListener('touchend', e => {
    const now = Date.now(); if (now - lastTouch <= 300) e.preventDefault(); lastTouch = now;
}, {passive: false});
document.body.addEventListener('touchmove', e => { if(e.scale !== 1) e.preventDefault(); }, {passive: false});

/* --- 1. I18N DICTIONARY --- */
const DICT = {
    en: {
        gps_wait:"GPS WAIT", gps_lock:"GPS LOCK",
        m_disc:"DISCOVERY", m_geo:"GEOMAG", m_whis:"WHISPERS",
        t_auto:"Auto", t_man:"Manual", t_next:"Next", t_map:"Map",
        lore_load:"Accessing Wind Rose Archives...",
        lbl_head:"HEADING", lbl_var:"VARIANCE",
        warn_cal:"CALIBRATE 8", warn_tilt:"HOLD FLAT",
        sun_track:"Sun Tracker Active",
        err_mag:"Mag Sensor Offline",
        omen_q:"SIGNAL SILENT", omen_r:"ETHER RIPPLE", omen_d:"DISTORTION", omen_p:"HIGH ANOMALY",
        flav_q:"The wind is quiet here.", flav_a:"Shadows move on their own.",
        read_btn:"Tap to Read Legend",
        tap_start: "Tap to Start",
        // Onboarding
        ob_title: "Wind Rose â€” The Treasure Seekerâ€™s Compass",
        ob_body: "A Jack-Sparrow-style compass.\nIt points toward the nearest of the 7 Wonders, right from where you stand.\nTurn slowlyâ€¦ and follow the needle.",
        ob_note: "If the needle drifts, do a gentle figure-8 calibration.\nMyth mode is storytelling/ARG, not scientific proof.",
        ob_btn: "Let's Go",
        hint_myth: "Tap 'WHISPERS' to hear local legends",
        // Wiki Keys
        btn_read_lore: "ðŸ“œ READ LORE",
        btn_close: "CLOSE",
        wiki_offline_lbl: "Offline Summary"
    },
    th: {
        gps_wait:"à¸£à¸­ GPS...", gps_lock:"GPS à¸žà¸£à¹‰à¸­à¸¡",
        m_disc:"à¸„à¹‰à¸™à¸žà¸š", m_geo:"à¹à¸¡à¹ˆà¹€à¸«à¸¥à¹‡à¸", m_whis:"à¹€à¸£à¸·à¹ˆà¸­à¸‡à¹€à¸¥à¹ˆà¸²",
        t_auto:"à¸­à¸­à¹‚à¸•à¹‰", t_man:"à¸—à¸³à¹€à¸­à¸‡", t_next:"à¸–à¸±à¸”à¹„à¸›", t_map:"à¹à¸œà¸™à¸—à¸µà¹ˆ",
        lore_load:"à¸à¸³à¸¥à¸±à¸‡à¸„à¹‰à¸™à¸‚à¹‰à¸­à¸¡à¸¹à¸¥...",
        lbl_head:"à¸—à¸´à¸¨à¸«à¸±à¸§à¹€à¸„à¸£à¸·à¹ˆà¸­à¸‡", lbl_var:"à¸„à¸§à¸²à¸¡à¸œà¸±à¸™à¸œà¸§à¸™",
        warn_cal:"à¸«à¸¡à¸¸à¸™à¹€à¸¥à¸‚ 8", warn_tilt:"à¸§à¸²à¸‡à¹€à¸„à¸£à¸·à¹ˆà¸­à¸‡à¸£à¸²à¸š",
        sun_track:"à¸•à¸´à¸”à¸•à¸²à¸¡à¸”à¸§à¸‡à¸­à¸²à¸—à¸´à¸•à¸¢à¹Œ",
        err_mag:"à¹„à¸¡à¹ˆà¸žà¸šà¹€à¸‹à¸™à¹€à¸‹à¸­à¸£à¹Œ",
        omen_q:"à¸ªà¸±à¸à¸à¸²à¸“à¸ªà¸‡à¸š", omen_r:"à¸„à¸¥à¸·à¹ˆà¸™à¸£à¸šà¸à¸§à¸™", omen_d:"à¸¡à¸´à¸•à¸´à¸šà¸´à¸”à¹€à¸šà¸·à¸­à¸™", omen_p:"à¸­à¸²à¸–à¸£à¸£à¸žà¹Œà¸£à¸¸à¸™à¹à¸£à¸‡",
        flav_q:"à¸¥à¸¡à¸žà¸±à¸”à¹€à¸­à¸·à¹ˆà¸­à¸¢à¹† à¹„à¸£à¹‰à¸ªà¸´à¹ˆà¸‡à¸œà¸´à¸”à¸›à¸à¸•à¸´", flav_a:"à¹€à¸‡à¸²à¹„à¸¡à¹‰à¹„à¸«à¸§à¹€à¸­à¸™à¸œà¸´à¸”à¸˜à¸£à¸£à¸¡à¸Šà¸²à¸•à¸´",
        read_btn:"à¸­à¹ˆà¸²à¸™à¸•à¸³à¸™à¸²à¸™",
        tap_start: "à¹à¸•à¸°à¹€à¸žà¸·à¹ˆà¸­à¹€à¸£à¸´à¹ˆà¸¡",
        // Onboarding
        ob_title: "Wind Rose â€” à¹€à¸‚à¹‡à¸¡à¸—à¸´à¸¨à¸™à¸±à¸à¸¥à¹ˆà¸²à¸‚à¸¸à¸¡à¸—à¸£à¸±à¸žà¸¢à¹Œ",
        ob_body: "à¸™à¸µà¹ˆà¸„à¸·à¸­à¹€à¸‚à¹‡à¸¡à¸—à¸´à¸¨à¹à¸šà¸š Jack Sparrow\nà¸¡à¸±à¸™à¸ˆà¸°à¸Šà¸µà¹‰à¹„à¸›à¸¢à¸±à¸‡à¸—à¸´à¸¨à¸‚à¸­à¸‡ 7 à¸ªà¸´à¹ˆà¸‡à¸¡à¸«à¸±à¸¨à¸ˆà¸£à¸£à¸¢à¹Œà¸‚à¸­à¸‡à¹‚à¸¥à¸ à¸—à¸µà¹ˆà¸­à¸¢à¸¹à¹ˆà¹ƒà¸à¸¥à¹‰à¸„à¸¸à¸“à¸—à¸µà¹ˆà¸ªà¸¸à¸”à¹ƒà¸™à¸•à¸­à¸™à¸™à¸µà¹‰\nà¸«à¸¡à¸¸à¸™à¸•à¸±à¸§à¸Šà¹‰à¸²à¹† à¹à¸¥à¹‰à¸§à¹€à¸”à¸´à¸™à¸•à¸²à¸¡à¹€à¸‚à¹‡à¸¡à¹„à¸”à¹‰à¹€à¸¥à¸¢",
        ob_note: "à¸–à¹‰à¸²à¹€à¸‚à¹‡à¸¡à¸ªà¹ˆà¸²à¸¢ à¸¥à¸­à¸‡à¸«à¸¡à¸¸à¸™à¸¡à¸·à¸­à¸–à¸·à¸­à¹€à¸›à¹‡à¸™à¸£à¸¹à¸›à¹€à¸¥à¸‚ 8 à¹€à¸žà¸·à¹ˆà¸­à¸ˆà¸¹à¸™\nà¹‚à¸«à¸¡à¸”à¸•à¸³à¸™à¸²à¸™à¸„à¸·à¸­à¸›à¸£à¸°à¸ªà¸šà¸à¸²à¸£à¸“à¹Œ/ARG à¹„à¸¡à¹ˆà¹ƒà¸Šà¹ˆà¸à¸²à¸£à¸žà¸´à¸ªà¸¹à¸ˆà¸™à¹Œà¸§à¸´à¸—à¸¢à¸²à¸¨à¸²à¸ªà¸•à¸£à¹Œ",
        ob_btn: "à¹€à¸‚à¹‰à¸²à¹ƒà¸ˆà¹à¸¥à¹‰à¸§",
        hint_myth: "à¹à¸•à¸° 'à¹€à¸£à¸·à¹ˆà¸­à¸‡à¹€à¸¥à¹ˆà¸²' à¹€à¸žà¸·à¹ˆà¸­à¸Ÿà¸±à¸‡à¸•à¸³à¸™à¸²à¸™à¹ƒà¸à¸¥à¹‰à¸•à¸±à¸§",
        // Wiki Keys
        btn_read_lore: "ðŸ“œ à¸­à¹ˆà¸²à¸™à¹€à¸£à¸·à¹ˆà¸­à¸‡à¹€à¸¥à¹ˆà¸²",
        btn_close: "à¸›à¸´à¸”",
        wiki_offline_lbl: "à¸ªà¸£à¸¸à¸›à¹à¸šà¸šà¸­à¸­à¸Ÿà¹„à¸¥à¸™à¹Œ"
    }
};

/* --- 2. DATA & WIKI MAPPING --- */
const WONDERS = [
    {n:"Great Pyramid", lat:29.9792, lon:31.1342, en:{s:"Ancient Wonder", f:["Built 2560 BC", "True North aligned"], m:"A power plant?"}, th:{s:"à¸ªà¸´à¹ˆà¸‡à¸¡à¸«à¸±à¸¨à¸ˆà¸£à¸£à¸¢à¹Œà¹‚à¸šà¸£à¸²à¸“", f:["à¸ªà¸£à¹‰à¸²à¸‡ 2560 BC", "à¸«à¸±à¸™à¸—à¸´à¸¨à¹€à¸«à¸™à¸·à¸­à¸ˆà¸£à¸´à¸‡"], m:"à¹‚à¸£à¸‡à¹„à¸Ÿà¸Ÿà¹‰à¸²à¹‚à¸šà¸£à¸²à¸“?"}},
    {n:"Stonehenge", lat:51.1789, lon:-1.8262, en:{s:"Stone Ring", f:["Solar aligned", "Heavy stones"], m:"Merlin's magic."}, th:{s:"à¸§à¸‡à¸¥à¹‰à¸­à¸¡à¸«à¸´à¸™", f:["à¹à¸™à¸§à¹à¸ªà¸‡à¸­à¸²à¸—à¸´à¸•à¸¢à¹Œ", "à¸«à¸´à¸™à¸«à¸™à¸±à¸à¸¡à¸²à¸"], m:"à¹€à¸§à¸—à¸¡à¸™à¸•à¸£à¹Œà¹€à¸¡à¸­à¸£à¹Œà¸¥à¸´à¸™"}},
    {n:"Great Wall", lat:40.4319, lon:116.5704, en:{s:"Stone Dragon", f:["21,196 km long", "Ancient defense"], m:"Bones in mortar."}, th:{s:"à¸à¸³à¹à¸žà¸‡à¹€à¸¡à¸·à¸­à¸‡à¸ˆà¸µà¸™", f:["à¸¢à¸²à¸§ 2 à¸«à¸¡à¸·à¹ˆà¸™à¹‚à¸¥", "à¸›à¹‰à¸­à¸‡à¸à¸±à¸™à¸‚à¹‰à¸²à¸¨à¸¶à¸"], m:"à¸à¸£à¸°à¸”à¸¹à¸à¸„à¸™à¹ƒà¸™à¸›à¸¹à¸™"}},
    {n:"Taj Mahal", lat:27.1751, lon:78.0421, en:{s:"Marble Love", f:["Mausoleum", "Changes color"], m:"Black twin planned."}, th:{s:"à¸­à¸™à¸¸à¸ªà¸£à¸“à¹Œà¸£à¸±à¸", f:["à¸ªà¸¸à¸ªà¸²à¸™à¸«à¸´à¸™à¸­à¹ˆà¸­à¸™", "à¹€à¸›à¸¥à¸µà¹ˆà¸¢à¸™à¸ªà¸µà¹„à¸”à¹‰"], m:"à¸ˆà¸°à¸¡à¸µà¹à¸à¸”à¸ªà¸µà¸”à¸³"}}
];

// Wikipedia Slugs (Title must match API)
const WIKI_SLUGS = {
    "Great Pyramid": { en: "Great_Pyramid_of_Giza", th: "à¸¡à¸«à¸²à¸žà¸µà¸£à¸°à¸¡à¸´à¸”à¹à¸«à¹ˆà¸‡à¸à¸´à¸‹à¹ˆà¸²" },
    "Stonehenge": { en: "Stonehenge", th: "à¸ªà¹‚à¸•à¸™à¹€à¸®à¸™à¸ˆà¹Œ" },
    "Great Wall": { en: "Great_Wall_of_China", th: "à¸à¸³à¹à¸žà¸‡à¹€à¸¡à¸·à¸­à¸‡à¸ˆà¸µà¸™" },
    "Taj Mahal": { en: "Taj_Mahal", th: "à¸—à¸±à¸Šà¸¡à¸²à¸®à¸²à¸¥" }
};

// Hardcoded Fallback for Offline/Fail
const OFFLINE_LORE = {
    "Great Pyramid": { en: "The Great Pyramid of Giza is the oldest of the Seven Wonders of the Ancient World. It was built as a tomb for the Fourth Dynasty Egyptian pharaoh Khufu.", th: "à¸¡à¸«à¸²à¸žà¸µà¸£à¸°à¸¡à¸´à¸”à¹à¸«à¹ˆà¸‡à¸à¸´à¸‹à¹ˆà¸² à¹€à¸›à¹‡à¸™à¸ªà¸´à¹ˆà¸‡à¸¡à¸«à¸±à¸¨à¸ˆà¸£à¸£à¸¢à¹Œà¸—à¸µà¹ˆà¹€à¸à¹ˆà¸²à¹à¸à¹ˆà¸—à¸µà¹ˆà¸ªà¸¸à¸”à¹ƒà¸™à¸šà¸£à¸£à¸”à¸² 7 à¸ªà¸´à¹ˆà¸‡à¸¡à¸«à¸±à¸¨à¸ˆà¸£à¸£à¸¢à¹Œà¸‚à¸­à¸‡à¹‚à¸¥à¸à¸¢à¸¸à¸„à¹‚à¸šà¸£à¸²à¸“ à¸ªà¸£à¹‰à¸²à¸‡à¸‚à¸¶à¹‰à¸™à¹€à¸žà¸·à¹ˆà¸­à¹€à¸›à¹‡à¸™à¸ªà¸¸à¸ªà¸²à¸™à¸‚à¸­à¸‡à¸Ÿà¸²à¹‚à¸£à¸«à¹Œà¸„à¸¹à¸Ÿà¸¹à¹à¸«à¹ˆà¸‡à¸£à¸²à¸Šà¸§à¸‡à¸¨à¹Œà¸—à¸µà¹ˆ 4" },
    "Stonehenge": { en: "Stonehenge is a prehistoric monument on Salisbury Plain in Wiltshire, England. It consists of an outer ring of vertical sarsen standing stones.", th: "à¸ªà¹‚à¸•à¸™à¹€à¸®à¸™à¸ˆà¹Œà¹€à¸›à¹‡à¸™à¸­à¸™à¸¸à¸ªà¸£à¸“à¹Œà¸ªà¸–à¸²à¸™à¸¢à¸¸à¸„à¸à¹ˆà¸­à¸™à¸›à¸£à¸°à¸§à¸±à¸•à¸´à¸¨à¸²à¸ªà¸•à¸£à¹Œ à¸à¸¥à¸²à¸‡à¸—à¸¸à¹ˆà¸‡à¸£à¸²à¸šà¸‹à¸­à¸¥à¸ªà¹Œà¸šà¸£à¸µà¹ƒà¸™à¸­à¸±à¸‡à¸à¸¤à¸© à¸›à¸£à¸°à¸à¸­à¸šà¸”à¹‰à¸§à¸¢à¹à¸—à¹ˆà¸‡à¸«à¸´à¸™à¸‚à¸™à¸²à¸”à¸¡à¸«à¸¶à¸¡à¸²à¹€à¸£à¸µà¸¢à¸‡à¸à¸±à¸™à¹€à¸›à¹‡à¸™à¸§à¸‡à¸à¸¥à¸¡" },
    "Great Wall": { en: "The Great Wall of China is a series of fortifications that were built across the historical northern borders of ancient Chinese states and Imperial China.", th: "à¸à¸³à¹à¸žà¸‡à¹€à¸¡à¸·à¸­à¸‡à¸ˆà¸µà¸™à¹€à¸›à¹‡à¸™à¸Šà¸¸à¸”à¸‚à¸­à¸‡à¸›à¹‰à¸­à¸¡à¸›à¸£à¸²à¸à¸²à¸£à¸—à¸µà¹ˆà¸ªà¸£à¹‰à¸²à¸‡à¸‚à¸¶à¹‰à¸™à¸•à¸²à¸¡à¹à¸™à¸§à¸žà¸£à¸¡à¹à¸”à¸™à¸—à¸²à¸‡à¹€à¸«à¸™à¸·à¸­à¸‚à¸­à¸‡à¸ˆà¸µà¸™à¹‚à¸šà¸£à¸²à¸“ à¹€à¸žà¸·à¹ˆà¸­à¸›à¹‰à¸­à¸‡à¸à¸±à¸™à¸à¸²à¸£à¸£à¸¸à¸à¸£à¸²à¸™à¸ˆà¸²à¸à¸à¸¥à¸¸à¹ˆà¸¡à¸Šà¸™à¹€à¸œà¹ˆà¸²à¹€à¸£à¹ˆà¸£à¹ˆà¸­à¸™" },
    "Taj Mahal": { en: "The Taj Mahal is an ivory-white marble mausoleum on the right bank of the river Yamuna in Agra, India. It was commissioned in 1631 by Shah Jahan.", th: "à¸—à¸±à¸Šà¸¡à¸²à¸®à¸²à¸¥à¹€à¸›à¹‡à¸™à¸ªà¸¸à¸ªà¸²à¸™à¸«à¸´à¸™à¸­à¹ˆà¸­à¸™à¸ªà¸µà¸‚à¸²à¸§à¸‡à¸²à¸Šà¹‰à¸²à¸‡ à¸•à¸±à¹‰à¸‡à¸­à¸¢à¸¹à¹ˆà¸£à¸´à¸¡à¸à¸±à¹ˆà¸‡à¸‚à¸§à¸²à¸‚à¸­à¸‡à¹à¸¡à¹ˆà¸™à¹‰à¸³à¸¢à¸¡à¸¸à¸™à¸²à¹ƒà¸™à¹€à¸¡à¸·à¸­à¸‡à¸­à¸²à¸à¸£à¸² à¸­à¸´à¸™à¹€à¸”à¸µà¸¢ à¸ªà¸£à¹‰à¸²à¸‡à¸‚à¸¶à¹‰à¸™à¹‚à¸”à¸¢à¸ˆà¸±à¸à¸£à¸žà¸£à¸£à¸”à¸´à¸Šà¸²à¸«à¹Œà¸Šà¸°à¸®à¸±à¸™à¹€à¸žà¸·à¹ˆà¸­à¹€à¸›à¹‡à¸™à¸­à¸™à¸¸à¸ªà¸£à¸“à¹Œà¹à¸«à¹ˆà¸‡à¸„à¸§à¸²à¸¡à¸£à¸±à¸" }
};

/* --- 3. CORE CLASSES --- */
class I18n {
    constructor() {
        this.lang = localStorage.getItem('wr_lang') || (navigator.language.startsWith('th') ? 'th' : 'en');
    }
    t(key) { return DICT[this.lang][key] || key; }
    toggle() {
        this.lang = this.lang === 'en' ? 'th' : 'en';
        localStorage.setItem('wr_lang', this.lang);
        return this.lang;
    }
    apply() {
        document.getElementById('lbl-lang').innerText = this.lang.toUpperCase();
        document.querySelectorAll('[data-t]').forEach(el => el.innerText = this.t(el.dataset.t));
    }
}

const MathU = {
    rad: d => d * Math.PI / 180,
    deg: r => r * 180 / Math.PI,
    bearing: (lat1,l1,lat2,l2) => {
        const y=Math.sin(MathU.rad(l2-l1))*Math.cos(MathU.rad(lat2));
        const x=Math.cos(MathU.rad(lat1))*Math.sin(MathU.rad(lat2))-Math.sin(MathU.rad(lat1))*Math.cos(MathU.rad(lat2))*Math.cos(MathU.rad(l2-l1));
        return (MathU.deg(Math.atan2(y,x))+360)%360;
    },
    lerp: (c,t,f) => { let d=t-c; if(d>180)d-=360; if(d<-180)d+=360; return c+d*f; },
    dist: (lat1,l1,lat2,l2) => {
        const R=6371, dLa=MathU.rad(lat2-lat1), dLo=MathU.rad(l2-l1);
        const a=Math.sin(dLa/2)**2+Math.cos(MathU.rad(lat1))*Math.cos(MathU.rad(lat2))*Math.sin(dLo/2)**2;
        return R*2*Math.atan2(Math.sqrt(a),Math.sqrt(1-a));
    }
};

class Sensor {
    constructor() { this.head=0; this.raw=0; this.gps=null; this.tiltBad=false; this.cbs={}; }
    init() {
        return new Promise(async (res, rej) => {
            // GPS
            if(navigator.geolocation) navigator.geolocation.watchPosition(p=>{this.gps=p.coords; this.emit('gps');}, e=>{}, {enableHighAccuracy:true});
            // Orientation
            if(window.DeviceOrientationEvent?.requestPermission) {
                try {
                    const r = await DeviceOrientationEvent.requestPermission();
                    if(r==='granted') { window.addEventListener('deviceorientation', e=>this.iOS(e)); res(); }
                    else rej();
                } catch { rej(); }
            } else {
                // Android auto-start
                const h = e => this.droid(e, e.absolute);
                if('ondeviceorientationabsolute' in window) window.addEventListener('deviceorientationabsolute', e=>h(e,true));
                else window.addEventListener('deviceorientation', e=>h(e,false));
                res();
            }
        });
    }
    iOS(e) { if(e.webkitCompassHeading) { this.raw=(e.webkitCompassHeading+(window.screen.orientation?.angle||0))%360; this.tiltBad=Math.abs(e.beta)>50; } }
    droid(e, abs) { if(e.alpha!=null) { this.raw=(abs ? 360-e.alpha : 360-e.alpha)%360; this.tiltBad=Math.abs(e.beta)>50; } }
    update() { this.head = MathU.lerp(this.head, this.raw, 0.1); return this.head; }
    emit(e){if(this.cbs[e])this.cbs[e]();} on(e,f){this.cbs[e]=f;}
}

class App {
    constructor() {
        this.i18n = new I18n(); this.sensor = new Sensor();
        this.state = { idx:0, auto:true, heading:0, mode:'disc' };
        this.els = {
            ring: document.getElementById('ring'), val: document.getElementById('val-head'),
            nMain: document.getElementById('n-main'), nSun: document.getElementById('n-sun'),
            radar: document.getElementById('radar-ui'), deck: document.getElementById('main-card'),
            btnLore: document.getElementById('btn-lore')
        };
        this.i18n.apply();
        
        // Trigger Button
        const btn = document.getElementById('btn-init');
        btn.addEventListener('click', () => this.start());
    }

    async start() {
        try {
            document.getElementById('tap-hint').style.opacity = 0;
            await this.sensor.init();
            this.transitionToHUD();
            this.sensor.on('gps', () => {
                document.getElementById('gps-badge').innerText = this.i18n.t('gps_lock');
                document.getElementById('gps-badge').classList.add('active');
                if(this.state.auto) this.findNearest();
            });
            this.loop();
        } catch { alert("Sensors blocked."); }
    }

    transitionToHUD() {
        const ov = document.getElementById('overlay');
        ov.classList.add('fade-out');
        setTimeout(() => {
            ov.style.display = 'none';
            document.getElementById('app').classList.add('visible');
            document.body.classList.add('active'); 
            this.checkFirstRun();
        }, 1000);
    }

    checkFirstRun() {
        if (!localStorage.getItem('WR_FIRST_RUN_DONE')) {
            setTimeout(() => {
                document.getElementById('modal-onboard').classList.add('show');
            }, 500);
        }
    }

    finishOnboarding() {
        localStorage.setItem('WR_FIRST_RUN_DONE', 'true');
        document.getElementById('modal-onboard').classList.remove('show');
        setTimeout(() => {
            const t = document.getElementById('hint-toast');
            t.classList.add('show');
            setTimeout(() => t.classList.remove('show'), 4000);
        }, 1000);
    }

    loop() {
        requestAnimationFrame(() => this.loop());
        const h = this.sensor.update();
        this.els.ring.style.transform = `rotate(${-h}deg)`;
        this.els.val.innerText = Math.round(h).toString().padStart(3,'0') + "Â°";
        
        if(this.state.mode === 'disc' && this.sensor.gps) {
            const w = WONDERS[this.state.idx];
            const b = MathU.bearing(this.sensor.gps.latitude, this.sensor.gps.longitude, w.lat, w.lon);
            this.els.nMain.style.transform = `translateX(-50%) rotate(${b}deg)`;
        } else if (this.state.mode === 'geo') {
            const now = new Date();
            const az = (now.getHours()-12)*15 + 180; 
            this.els.nSun.style.transform = `translateX(-50%) rotate(${az}deg)`;
        } else if (this.state.mode === 'whis') {
            const wander = Math.sin(Date.now()/500) * 15;
            this.els.nMain.style.transform = `translateX(-50%) rotate(${h + wander}deg)`;
        }
    }

    // Logic
    findNearest() {
        if(!this.sensor.gps) return;
        let min=Infinity, idx=0;
        WONDERS.forEach((w,i)=>{ const d=MathU.dist(this.sensor.gps.latitude,this.sensor.gps.longitude,w.lat,w.lon); if(d<min){min=d;idx=i;} });
        if(this.state.idx!=idx) { this.state.idx=idx; this.updCard(); }
    }
    
    updCard() {
        const w = WONDERS[this.state.idx];
        const i = w[this.i18n.lang];
        document.getElementById('c-title').innerText = w.n;
        document.getElementById('c-body').innerText = i.s;
        document.getElementById('c-facts').innerHTML = i.f.map(x=>`<li>${x}</li>`).join('');
        
        // Show/Hide Lore Button
        this.els.btnLore.style.display = this.state.mode === 'disc' ? 'block' : 'none';

        if(this.sensor.gps) {
            const d = MathU.dist(this.sensor.gps.latitude,this.sensor.gps.longitude,w.lat,w.lon);
            document.getElementById('c-dist').innerText = d<1?(d*1000).toFixed(0)+"m":d.toFixed(0)+"km";
        }
    }

    toggleLang() { 
        this.i18n.toggle(); 
        this.i18n.apply(); 
        this.updCard(); 
    }

    setMode(m) {
        this.state.mode = m;
        document.querySelectorAll('.dock-item').forEach(b => b.classList.remove('active'));
        document.getElementById('m-'+m).classList.add('active');
        this.els.nMain.style.display = m=='geo'?'none':'block';
        this.els.nSun.style.display = m=='geo'?'block':'none';
        this.els.radar.style.display = m=='whis'?'block':'none';
        
        if(m=='disc') {
            this.updCard();
        } else {
            this.els.btnLore.style.display = 'none';
            if(m=='geo') { 
                document.getElementById('c-title').innerText="GEOMAG"; 
                document.getElementById('c-body').innerText=this.i18n.t('sun_track'); 
            } else { 
                document.getElementById('c-title').innerText="WHISPERS"; 
                document.getElementById('c-body').innerText=this.i18n.t('flav_a'); 
            }
        }
    }

    toggleAuto() { this.state.auto = !this.state.auto; if(this.state.auto) this.findNearest(); }
    nextTarget() { this.state.auto = false; this.state.idx = (this.state.idx+1)%WONDERS.length; this.updCard(); }
    toggleSettings() { document.getElementById('modal-set').classList.toggle('show'); }
    resetView() { document.body.style.zoom=1.0; window.scrollTo(0,0); this.toggleSettings(); }
    openMap() { const w=WONDERS[this.state.idx]; window.open(`https://maps.google.com/?q=${w.lat},${w.lon}`); }

    /* --- WIKI FETCH & MODAL LOGIC (PATCH) --- */
    openLore() {
        document.getElementById('modal-lore').classList.add('show');
        this.fetchWiki();
    }
    
    closeLore() {
        document.getElementById('modal-lore').classList.remove('show');
    }

    async fetchWiki() {
        const wName = WONDERS[this.state.idx].n;
        const lang = this.i18n.lang;
        const slug = WIKI_SLUGS[wName][lang];
        const cacheKey = `WR_WIKI_${lang}_${slug}`;

        const uiLoader = document.getElementById('l-spin');
        const uiContent = document.getElementById('l-content');
        const uiTitle = document.getElementById('l-title');
        const uiText = document.getElementById('l-text');
        const uiThumb = document.getElementById('l-thumb');
        const uiSrc = document.getElementById('l-src');

        // Reset UI
        uiContent.style.display = 'none';
        uiLoader.classList.add('show');
        uiThumb.classList.remove('active');

        // 1. Try Cache
        const cached = localStorage.getItem(cacheKey);
        if (cached) {
            this.renderWiki(JSON.parse(cached));
            uiLoader.classList.remove('show');
            uiContent.style.display = 'block';
            // Stale-while-revalidate: Fetch in background
            this.doFetch(slug, lang, cacheKey, false);
        } else {
            // 2. Fetch Fresh
            const success = await this.doFetch(slug, lang, cacheKey, true);
            if (!success) {
                // 3. Fallback
                this.renderFallback(wName, lang);
            }
        }
    }

    async doFetch(slug, lang, cacheKey, renderImmediately) {
        try {
            const url = `https://${lang}.wikipedia.org/api/rest_v1/page/summary/${slug}`;
            const res = await fetch(url);
            if (!res.ok) throw new Error('Wiki Fail');
            const data = await res.json();
            
            // Save & Render
            localStorage.setItem(cacheKey, JSON.stringify(data));
            if (renderImmediately) {
                this.renderWiki(data);
                document.getElementById('l-spin').classList.remove('show');
                document.getElementById('l-content').style.display = 'block';
            }
            return true;
        } catch (e) {
            console.warn(e);
            return false;
        }
    }

    renderWiki(data) {
        document.getElementById('l-title').innerText = data.title;
        document.getElementById('l-text').innerText = data.extract;
        
        const uiThumb = document.getElementById('l-thumb');
        if(data.thumbnail && data.thumbnail.source) {
            uiThumb.src = data.thumbnail.source;
            uiThumb.classList.add('active');
        } else {
            uiThumb.classList.remove('active');
        }

        const uiSrc = document.getElementById('l-src');
        uiSrc.href = data.content_urls.desktop.page;
        uiSrc.innerHTML = `Source: Wikipedia (${this.i18n.lang.toUpperCase()})`;
    }

    renderFallback(wName, lang) {
        document.getElementById('l-spin').classList.remove('show');
        document.getElementById('l-content').style.display = 'block';
        document.getElementById('l-thumb').classList.remove('active');
        
        const fb = OFFLINE_LORE[wName][lang];
        document.getElementById('l-title').innerText = WONDERS[this.state.idx].n;
        document.getElementById('l-text').innerText = fb;
        document.getElementById('l-src').innerHTML = `<i>${this.i18n.t('wiki_offline_lbl')}</i>`;
        document.getElementById('l-src').href = "#";
    }
}

const app = new App();

</script>
</body>
</html>```
