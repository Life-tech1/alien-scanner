<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Find My</title>
    
    <!-- Dependencies -->
    <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />

    <style>
        /* 
         * APPLE ULTRA MINIMAL DESIGN SYSTEM 
         * iOS 18 Style Guide 
         */
        :root {
            --bg: #000000;
            --card-bg: rgba(28, 28, 30, 0.85);
            --text-primary: #FFFFFF;
            --text-secondary: #8E8E93;
            --accent: #30D158; /* iOS Green */
            --danger: #FF453A;
            --blur: blur(25px);
            --font-stack: -apple-system, BlinkMacSystemFont, "SF Pro Display", "SF Pro Text", "Helvetica Neue", sans-serif;
            --safe-top: env(safe-area-inset-top);
            --safe-bottom: env(safe-area-inset-bottom);
            --ease-spring: cubic-bezier(0.25, 0.1, 0.25, 1);
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; user-select: none; }
        
        body {
            margin: 0; padding: 0;
            background: var(--bg);
            color: var(--text-primary);
            font-family: var(--font-stack);
            overflow: hidden;
            height: 100vh;
            display: flex; flex-direction: column;
        }

        /* --- LAYER 1: MAP VIEW --- */
        #map-container {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            z-index: 1;
            filter: grayscale(100%) brightness(0.6); /* Minimal dark map */
            transition: transform 0.5s var(--ease-spring);
        }
        
        /* Custom Pin */
        .memoji-pin {
            width: 40px; height: 40px;
            background: #1c1c1e; border: 2px solid var(--text-primary);
            border-radius: 50%;
            box-shadow: 0 4px 10px rgba(0,0,0,0.3);
            display: flex; align-items: center; justify-content: center;
            font-size: 20px;
        }

        /* --- LAYER 2: CAMERA AR VIEW --- */
        #ar-container {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: #000;
            z-index: 2;
            opacity: 0; pointer-events: none;
            transition: opacity 0.4s ease;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
        }
        
        video {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            object-fit: cover; opacity: 0.7;
        }

        /* --- UI: BOTTOM CARD (HOME) --- */
        #device-card {
            position: absolute; bottom: 20px; left: 16px; right: 16px;
            background: var(--card-bg);
            backdrop-filter: var(--blur); -webkit-backdrop-filter: var(--blur);
            border-radius: 24px;
            padding: 24px;
            padding-bottom: calc(24px + var(--safe-bottom));
            z-index: 10;
            transform: translateY(0);
            transition: transform 0.5s var(--ease-spring);
            border: 1px solid rgba(255,255,255,0.08);
            box-shadow: 0 10px 40px rgba(0,0,0,0.4);
        }

        .card-header { display: flex; align-items: center; margin-bottom: 24px; }
        .icon-box {
            width: 48px; height: 48px;
            background: #2C2C2E; border-radius: 12px;
            display: flex; align-items: center; justify-content: center;
            font-size: 24px; margin-right: 16px;
        }
        .text-group h1 { font-size: 19px; font-weight: 600; margin: 0; letter-spacing: -0.5px; }
        .text-group p { font-size: 13px; color: var(--text-secondary); margin: 4px 0 0 0; }
        .battery-pill { margin-left: auto; font-size: 12px; font-weight: 500; color: var(--text-secondary); display: flex; align-items: center; gap: 4px; }
        
        .btn-main {
            width: 100%; height: 50px;
            background: var(--accent); color: #000;
            border: none; border-radius: 25px;
            font-size: 17px; font-weight: 600;
            cursor: pointer;
            display: flex; align-items: center; justify-content: center; gap: 8px;
            transition: transform 0.1s;
        }
        .btn-main:active { transform: scale(0.96); opacity: 0.9; }

        /* --- UI: PRECISION FINDING HUD --- */
        #hud-layer {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            z-index: 20; pointer-events: none;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            opacity: 0; transition: opacity 0.3s;
        }

        .close-btn {
            position: absolute; top: calc(20px + var(--safe-top)); left: 20px;
            width: 40px; height: 40px;
            background: rgba(40,40,40,0.8);
            backdrop-filter: blur(10px);
            border-radius: 50%; border: none;
            color: white; font-size: 20px;
            display: flex; align-items: center; justify-content: center;
            pointer-events: auto; cursor: pointer;
        }

        /* The Minimal Arrow */
        .arrow-wrapper {
            width: 200px; height: 200px;
            display: flex; align-items: center; justify-content: center;
            margin-bottom: 20px;
            will-change: transform;
        }
        
        .arrow-svg {
            width: 100px; height: 100px;
            filter: drop-shadow(0 0 15px rgba(255,255,255,0.1));
        }

        .distance-label {
            font-size: 64px; font-weight: 700;
            letter-spacing: -2px;
            font-variant-numeric: tabular-nums;
            margin-bottom: 0;
            text-shadow: 0 4px 20px rgba(0,0,0,0.5);
        }
        
        .unit-label {
            font-size: 19px; font-weight: 500;
            color: rgba(255,255,255,0.6);
            margin-top: -5px;
        }

        /* Pulse Animation */
        .pulse {
            position: absolute; top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            width: 300px; height: 300px;
            border-radius: 50%;
            border: 1px solid rgba(255,255,255,0.1);
            opacity: 0;
        }
        
        @keyframes ripple {
            0% { transform: translate(-50%, -50%) scale(0.5); opacity: 0.5; }
            100% { transform: translate(-50%, -50%) scale(1.2); opacity: 0; }
        }

        /* STATE: PRECISION MODE ACTIVE */
        body.mode-ar #map-container { transform: scale(0.9); opacity: 0; }
        body.mode-ar #ar-container { opacity: 1; pointer-events: auto; }
        body.mode-ar #device-card { transform: translateY(120%); }
        body.mode-ar #hud-layer { opacity: 1; }

    </style>
</head>
<body>

    <!-- 1. MAP LAYER -->
    <div id="map-container"></div>

    <!-- 2. AR CAMERA LAYER -->
    <div id="ar-container">
        <video id="camera-feed" autoplay playsinline muted></video>
    </div>

    <!-- 3. PRECISION HUD -->
    <div id="hud-layer">
        <button class="close-btn" onclick="app.stopFinding()">âœ•</button>
        
        <div class="pulse" id="pulse-ring"></div>

        <div class="arrow-wrapper" id="arrow-el">
            <svg class="arrow-svg" viewBox="0 0 100 100" fill="none">
                <path d="M50 0 L90 100 L50 85 L10 100 Z" fill="white"/>
            </svg>
        </div>

        <div class="distance-label" id="dist-el">0.0</div>
        <div class="unit-label">meters</div>
    </div>

    <!-- 4. BOTTOM SHEET -->
    <div id="device-card">
        <div class="card-header">
            <div class="icon-box">ðŸŽ’</div>
            <div class="text-group">
                <h1>Omega Backpack</h1>
                <p>124 W 24th St â€¢ 2 min ago</p>
            </div>
            <div class="battery-pill">
                <span>84%</span> 
                <svg width="18" height="10" viewBox="0 0 24 12" fill="none" stroke="currentColor" stroke-width="2">
                    <rect x="1" y="1" width="20" height="10" rx="2" />
                    <path d="M22 4V8" stroke-linecap="round"/>
                </svg>
            </div>
        </div>
        <button class="btn-main" onclick="app.startFinding()">
            <svg width="20" height="20" fill="currentColor" viewBox="0 0 24 24"><path d="M12 2L15 9L22 12L15 15L12 22L9 15L2 12L9 9L12 2Z"/></svg>
            Find Nearby
        </button>
    </div>

<script>
/**
 * OMEGA FINDER X-PRO | ULTRA MINIMAL CORE
 * Includes: EKF Sensor Fusion, AR Logic, UI Controller
 */

// --- UTILS ---
const toRad = x => x * Math.PI / 180;
const toDeg = x => x * 180 / Math.PI;

// --- 1D KALMAN FILTER (For Smoothing GPS) ---
class KalmanFilter {
    constructor(R = 1, Q = 0.1) {
        this.x = 0; // State
        this.P = 0; // Uncertainty
        this.R = R; // Measurement Noise (GPS Accuracy)
        this.Q = Q; // Process Noise (Movement)
    }
    update(measurement, accuracy) {
        // Adapt R based on GPS reported accuracy
        let R_adaptive = accuracy ? accuracy * accuracy : this.R;
        
        // Prediction
        this.P = this.P + this.Q;
        
        // Update
        const K = this.P / (this.P + R_adaptive);
        this.x = this.x + K * (measurement - this.x);
        this.P = (1 - K) * this.P;
        
        return this.x;
    }
}

// --- APP ENGINE ---
class OmegaSystem {
    constructor() {
        this.socket = io('http://localhost:3000'); // Optional Backend
        
        // State
        this.myPos = { lat: 0, lng: 0, heading: 0 };
        this.targetPos = { lat: 40.748817, lng: -73.985428 }; // Default: Empire State
        this.isTracking = false;

        // Filters
        this.kfLat = new KalmanFilter();
        this.kfLng = new KalmanFilter();

        // UI Refs
        this.ui = {
            arrow: document.getElementById('arrow-el'),
            dist: document.getElementById('dist-el'),
            pulse: document.getElementById('pulse-ring')
        };

        this.initMap();
        this.simMovement(); // Remove in prod
    }

    // --- MAP INITIALIZATION ---
    initMap() {
        this.map = L.map('map-container', { zoomControl: false, attributionControl: false })
            .setView([51.505, -0.09], 13);
        
        // Dark Minimal Tiles (CartoDB Dark Matter)
        L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
            maxZoom: 19
        }).addTo(this.map);

        this.marker = L.marker([0,0]).addTo(this.map);
    }

    // --- CORE: START AR MODE ---
    async startFinding() {
        // 1. Permission (iOS 13+)
        if (typeof DeviceOrientationEvent.requestPermission === 'function') {
            const resp = await DeviceOrientationEvent.requestPermission();
            if (resp !== 'granted') return alert('Compass Required');
        }

        // 2. Camera
        try {
            const stream = await navigator.mediaDevices.getUserMedia({ 
                video: { facingMode: 'environment' } 
            });
            document.getElementById('camera-feed').srcObject = stream;
        } catch(e) { console.log('Camera error (Desktop?)'); }

        // 3. Sensors
        this.watchId = navigator.geolocation.watchPosition(
            p => this.handleGPS(p), 
            e => console.error(e), 
            { enableHighAccuracy: true, maximumAge: 0 }
        );

        window.addEventListener('deviceorientation', this.handleCompass);

        // 4. UI Transition
        document.body.classList.add('mode-ar');
        this.isTracking = true;
        this.renderLoop();
    }

    stopFinding() {
        document.body.classList.remove('mode-ar');
        this.isTracking = false;
        navigator.geolocation.clearWatch(this.watchId);
        window.removeEventListener('deviceorientation', this.handleCompass);
    }

    // --- SENSOR LOGIC ---
    handleGPS(pos) {
        const { latitude, longitude, accuracy } = pos.coords;
        
        // Apply Kalman Filter
        this.myPos.lat = this.kfLat.update(latitude, accuracy);
        this.myPos.lng = this.kfLng.update(longitude, accuracy);

        // Update Map (Hidden but running)
        this.marker.setLatLng([this.myPos.lat, this.myPos.lng]);
    }

    handleCompass = (e) => {
        // webkitCompassHeading (iOS) || alpha (Android)
        let heading = e.webkitCompassHeading || (360 - e.alpha);
        this.myPos.heading = heading || 0;
    }

    // --- PHYSICS & RENDERING LOOP ---
    renderLoop() {
        if (!this.isTracking) return;

        // 1. Math: Distance & Bearing
        const dLat = toRad(this.targetPos.lat - this.myPos.lat);
        const dLng = toRad(this.targetPos.lng - this.myPos.lng);
        const lat1 = toRad(this.myPos.lat);
        const lat2 = toRad(this.targetPos.lat);

        // Haversine Distance
        const a = Math.sin(dLat/2)**2 + Math.cos(lat1)*Math.cos(lat2)*Math.sin(dLng/2)**2;
        const distMeters = 6371e3 * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));

        // Bearing
        const y = Math.sin(dLng) * Math.cos(lat2);
        const x = Math.cos(lat1)*Math.sin(lat2) - Math.sin(lat1)*Math.cos(lat2)*Math.cos(dLng);
        const bearing = (toDeg(Math.atan2(y, x)) + 360) % 360;

        // 2. AR Logic: Relative Rotation
        // "Where is target" minus "Where am I looking"
        let relativeRot = bearing - this.myPos.heading;
        
        // Shortest path interpolation (-180 to 180)
        while (relativeRot < -180) relativeRot += 360;
        while (relativeRot > 180) relativeRot -= 360;

        // 3. Update UI
        this.ui.arrow.style.transform = `rotate(${relativeRot}deg)`;
        this.ui.dist.innerText = distMeters.toFixed(1);

        // 4. Color & Haptic Logic
        if (distMeters < 5) {
            this.ui.arrow.style.filter = "drop-shadow(0 0 20px #30D158)";
            this.ui.pulse.style.animation = "ripple 1s infinite";
            if(Math.random() > 0.95) navigator.vibrate?.(10);
        } else {
            this.ui.arrow.style.filter = "drop-shadow(0 0 15px rgba(255,255,255,0.2))";
            this.ui.pulse.style.animation = "none";
        }

        requestAnimationFrame(() => this.renderLoop());
    }

    // --- SIMULATE TARGET (FOR DEMO) ---
    simMovement() {
        // Fake target walking around 
        setInterval(() => {
            if(!this.isTracking) return;
            this.targetPos.lat += (Math.random() - 0.5) * 0.00005;
            this.targetPos.lng += (Math.random() - 0.5) * 0.00005;
        }, 1000);
    }
}

// Start System
window.app = new OmegaSystem();

</script>
</body>
</html>
