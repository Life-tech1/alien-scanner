<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>TACTICAL RESEARCH UNIT | GOD MODE</title>
    
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/coco-ssd"></script>
    <link href="https://fonts.googleapis.com/css2?family=Share+Tech+Mono&display=swap" rel="stylesheet">

    <style>
        :root {
            --hud: #00ff41; /* Standard Green */
            --warn: #ffcc00;
            --alert: #ff3333;
            --bg: rgba(0, 20, 5, 0.6);
            --glass: rgba(255, 255, 255, 0.1);
            --font: 'Share Tech Mono', monospace;
        }

        * { box-sizing: border-box; user-select: none; }
        body { margin: 0; background: #000; overflow: hidden; font-family: var(--font); color: var(--hud); width: 100vw; height: 100vh; }

        /* LAYERS */
        #video-feed { position: absolute; top: 0; left: 0; width: 100%; height: 100%; object-fit: cover; z-index: 0; }
        #hud-layer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 1; }
        #ui-layer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 2; pointer-events: none; display: flex; flex-direction: column; justify-content: space-between; padding: 10px; }

        /* UI COMPONENTS */
        .top-bar { display: flex; justify-content: space-between; align-items: flex-start; background: linear-gradient(to bottom, rgba(0,0,0,0.8), transparent); padding-bottom: 20px; }
        
        .panel {
            background: var(--bg); border: 1px solid var(--hud);
            padding: 5px 10px; backdrop-filter: blur(4px);
            pointer-events: auto; margin-bottom: 5px;
        }

        .data-row { display: flex; justify-content: space-between; font-size: 12px; margin-bottom: 2px; gap: 15px; }
        .val { font-weight: bold; color: #fff; }
        .label { color: rgba(0, 255, 65, 0.7); }

        /* COMPASS STRIP */
        .compass-container {
            position: absolute; top: 60px; left: 50%; transform: translateX(-50%);
            width: 300px; height: 30px; overflow: hidden;
            border-left: 1px solid var(--hud); border-right: 1px solid var(--hud);
            background: rgba(0,0,0,0.3);
        }
        #compass-strip {
            position: absolute; left: 0; top: 5px;
            white-space: nowrap; font-size: 14px; transition: left 0.1s linear;
        }
        .center-mark {
            position: absolute; left: 50%; top: 0; transform: translateX(-50%);
            width: 0; height: 10px; border-left: 2px solid var(--alert); z-index: 10;
        }

        /* HISTOGRAM */
        .histogram-box {
            position: absolute; bottom: 100px; right: 10px;
            width: 120px; height: 60px;
            background: rgba(0,0,0,0.5); border: 1px solid var(--hud);
        }
        #histo-canvas { width: 100%; height: 100%; opacity: 0.8; }

        /* LOADING */
        #loader {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: #000; z-index: 99; display: flex; flex-direction: column;
            align-items: center; justify-content: center;
        }
        .scan-line {
            width: 100%; height: 2px; background: var(--hud);
            position: absolute; top: 0; animation: scan 2s linear infinite;
        }
        @keyframes scan { 0% {top:0} 100% {top:100%} }

        button {
            background: transparent; border: 1px solid var(--hud); color: var(--hud);
            padding: 10px 20px; font-family: var(--font); font-size: 16px;
            cursor: pointer; text-transform: uppercase; margin-top: 20px;
        }
        button:hover { background: var(--hud); color: #000; }

    </style>
</head>
<body>

    <div id="loader">
        <div class="scan-line"></div>
        <h1 style="letter-spacing: 5px;">TACTICAL LAB</h1>
        <p>LOADING NEURAL NET & PHYSICS ENGINE...</p>
        <button id="btn-start" style="display:none;">INITIALIZE</button>
    </div>

    <video id="video-feed" playsinline muted autoplay></video>
    <canvas id="hud-layer"></canvas>

    <div id="ui-layer">
        <div class="top-bar">
            <div class="panel">
                <div class="data-row"><span class="label">SYS TIME</span><span class="val" id="clock">--:--:--</span></div>
                <div class="data-row"><span class="label">GPS LOC</span><span class="val" id="gps">ACQUIRING...</span></div>
            </div>
            <div class="panel" style="text-align:right;">
                <div class="data-row"><span class="label">HEADING</span><span class="val" id="val-head">0° N</span></div>
                <div class="data-row"><span class="label">PITCH</span><span class="val" id="val-pitch">0°</span></div>
            </div>
        </div>

        <div class="compass-container">
            <div class="center-mark"></div>
            <div id="compass-strip">
                N . . . 15 . . . 30 . . . 45 . . . 60 . . . 75 . . . E . . . 105 . . . 120 . . . 135 . . . 150 . . . 165 . . . S . . . 195 . . . 210 . . . 225 . . . 240 . . . 255 . . . W . . . 285 . . . 300 . . . 315 . . . 330 . . . 345 . . . N . . . 15 . . . 30
            </div>
        </div>

        <div class="histogram-box">
            <canvas id="histo-canvas"></canvas>
            <div style="position:absolute; top:2px; left:2px; font-size:8px; background:#000;">EXPOSURE</div>
        </div>

        <div style="margin-top: auto; display: flex; justify-content: space-between; align-items: flex-end;">
            <div class="panel">
                <div style="font-size:10px; color:#aaa; margin-bottom:2px;">TARGET TELEMETRY</div>
                <div class="data-row"><span class="label">TARGET</span><span class="val" id="tgt-name">NONE</span></div>
                <div class="data-row"><span class="label">CONFIDENCE</span><span class="val" id="tgt-conf">0%</span></div>
                <div class="data-row" style="border-top:1px solid #444; padding-top:2px; margin-top:2px;">
                    <span class="label" style="color:var(--alert);">EST. DIST</span>
                    <span class="val" style="color:var(--alert); font-size:14px;" id="tgt-dist">-- M</span>
                </div>
            </div>
            
            <div class="panel" style="text-align:right;">
                <div class="data-row"><span class="label">G-FORCE</span><span class="val" id="val-g">1.00 G</span></div>
                <div class="data-row"><span class="label">LIGHT</span><span class="val" id="val-lux">-- LX</span></div>
            </div>
        </div>
    </div>

    <script>
        /* * TACTICAL RESEARCH UNIT (TRU)
         * Integrates: AI Ranging, Magnetometer, Histogram, Physics
         */

        // --- CONFIG ---
        const CONFIG = {
            lerp: 0.2,
            focalLengthApprox: 600, // Arbitrary focal length for phone camera estimation
            avgHumanHeight: 1.7, // meters
            histSkip: 5, // Calculate histogram every X frames (Performance)
        };

        const state = {
            w: 0, h: 0,
            model: null,
            tracking: {},
            compass: 0,
            pitch: 0,
            frameCount: 0
        };

        // --- DOM ---
        const vid = document.getElementById('video-feed');
        const cvs = document.getElementById('hud-layer');
        const ctx = cvs.getContext('2d');
        const histCvs = document.getElementById('histo-canvas');
        const histCtx = histCvs.getContext('2d');

        // --- INIT ---
        (async function init() {
            try {
                state.model = await cocoSsd.load();
                document.querySelector('#loader p').innerText = "SYSTEM READY";
                const btn = document.getElementById('btn-start');
                btn.style.display = 'block';
                btn.onclick = startSystem;
            } catch(e) { alert("AI Error: " + e); }
        })();

        async function startSystem() {
            document.getElementById('loader').style.display = 'none';
            
            // Camera
            const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' }, audio: false });
            vid.srcObject = stream;
            vid.onloadedmetadata = () => {
                resize();
                vid.play();
                loop();
                predict();
            };

            // Sensors
            if (window.DeviceOrientationEvent) {
                window.addEventListener('deviceorientation', (e) => {
                    // Compass (Alpha) & Pitch (Beta)
                    if(e.webkitCompassHeading) {
                        state.compass = e.webkitCompassHeading; // iOS
                    } else if (e.alpha) {
                        state.compass = 360 - e.alpha; // Android
                    }
                    state.pitch = e.beta;
                    
                    updateCompassUI();
                });
            }
            
            if (window.DeviceMotionEvent) {
                window.addEventListener('devicemotion', (e) => {
                    const acc = e.accelerationIncludingGravity;
                    if(acc) {
                        const g = Math.sqrt(acc.x**2 + acc.y**2 + acc.z**2) / 9.8;
                        document.getElementById('val-g').innerText = g.toFixed(2) + " G";
                    }
                });
            }

            // GPS
            if (navigator.geolocation) {
                navigator.geolocation.watchPosition(pos => {
                    document.getElementById('gps').innerText = `${pos.coords.latitude.toFixed(4)}, ${pos.coords.longitude.toFixed(4)}`;
                });
            }
        }

        function resize() {
            state.w = window.innerWidth;
            state.h = window.innerHeight;
            cvs.width = state.w; cvs.height = state.h;
            // Hidden canvas for pixel reading
            state.tempCvs = document.createElement('canvas');
            state.tempCvs.width = 100; state.tempCvs.height = 100; // Small for performance
            state.tempCtx = state.tempCvs.getContext('2d');
        }
        window.onresize = resize;

        // --- AI LOOP ---
        async function predict() {
            const preds = await state.model.detect(vid);
            
            // Tracking & Smoothing Logic
            const activeLabels = new Set();
            
            preds.forEach(p => {
                if (p.score < 0.6) return;
                const id = p.class;
                activeLabels.add(id);

                if (!state.tracking[id]) {
                    state.tracking[id] = { ...p, bbox: [...p.bbox] };
                } else {
                    // Lerp smooth
                    const t = state.tracking[id];
                    t.bbox[0] += (p.bbox[0] - t.bbox[0]) * CONFIG.lerp;
                    t.bbox[1] += (p.bbox[1] - t.bbox[1]) * CONFIG.lerp;
                    t.bbox[2] += (p.bbox[2] - t.bbox[2]) * CONFIG.lerp;
                    t.bbox[3] += (p.bbox[3] - t.bbox[3]) * CONFIG.lerp;
                    t.score = p.score;
                }
            });

            // Cleanup lost objects
            for (let key in state.tracking) {
                if (!activeLabels.has(key)) delete state.tracking[key];
            }

            requestAnimationFrame(predict);
        }

        // --- RENDER LOOP ---
        function loop() {
            ctx.clearRect(0, 0, state.w, state.h);
            state.frameCount++;

            // 1. Draw Tracking & Rangefinding
            drawHUD();

            // 2. Calculate Histogram (Every X frames)
            if (state.frameCount % CONFIG.histSkip === 0) {
                calcHistogram();
            }

            // 3. Clock
            document.getElementById('clock').innerText = new Date().toLocaleTimeString();

            requestAnimationFrame(loop);
        }

        function drawHUD() {
            // Draw Crosshair
            const cx = state.w / 2;
            const cy = state.h / 2;
            ctx.strokeStyle = "rgba(255, 255, 255, 0.3)";
            ctx.lineWidth = 1;
            ctx.beginPath();
            ctx.moveTo(cx-20, cy); ctx.lineTo(cx+20, cy);
            ctx.moveTo(cx, cy-20); ctx.lineTo(cx, cy+20);
            ctx.stroke();

            // Draw Objects
            let nearestDist = 9999;
            let primaryTarget = null;

            for (let key in state.tracking) {
                const obj = state.tracking[key];
                const rect = scaleRect(obj.bbox);
                
                // Draw Box
                ctx.strokeStyle = "#00ff41";
                ctx.lineWidth = 2;
                ctx.strokeRect(rect.x, rect.y, rect.w, rect.h);
                
                // Corners
                ctx.strokeStyle = "#fff";
                ctx.strokeRect(rect.x-2, rect.y-2, 10, 1); ctx.strokeRect(rect.x-2, rect.y-2, 1, 10);

                // RANGEFINDING CALCULATION
                // Distance = (RealHeight * Focal) / ImageHeight
                // We assume mostly humans (1.7m) or standard objects.
                // This is an estimation!
                let dist = 0;
                if (key === 'person') {
                    dist = (CONFIG.avgHumanHeight * CONFIG.focalLengthApprox) / (rect.h / state.h * 100); // Simplified scaling
                } else {
                    // Fallback generic size 1m
                    dist = (1.0 * CONFIG.focalLengthApprox) / (rect.h / state.h * 100);
                }

                // Text Label
                ctx.fillStyle = "#00ff41";
                ctx.font = "12px Share Tech Mono";
                ctx.fillText(`${key.toUpperCase()} ${(obj.score*100).toFixed(0)}%`, rect.x, rect.y - 15);
                ctx.fillStyle = "#ffcc00";
                ctx.fillText(`RNG: ${dist.toFixed(1)}m`, rect.x, rect.y - 5);

                // Update Telemetry Panel with Center-most object
                const distToCenter = Math.hypot(cx - (rect.x+rect.w/2), cy - (rect.y+rect.h/2));
                if (distToCenter < nearestDist) {
                    nearestDist = distToCenter;
                    primaryTarget = { key, score: obj.score, dist };
                }
            }

            if (primaryTarget) {
                document.getElementById('tgt-name').innerText = primaryTarget.key.toUpperCase();
                document.getElementById('tgt-conf').innerText = (primaryTarget.score*100).toFixed(0) + "%";
                document.getElementById('tgt-dist').innerText = primaryTarget.dist.toFixed(1) + " M";
            } else {
                document.getElementById('tgt-name').innerText = "SCANNING";
                document.getElementById('tgt-dist').innerText = "-- M";
            }
        }

        function calcHistogram() {
            // Draw video to temp canvas
            state.tempCtx.drawImage(vid, 0, 0, 100, 100);
            const frame = state.tempCtx.getImageData(0, 0, 100, 100);
            const data = frame.data;
            
            // Reset bins
            const bins = new Array(256).fill(0);
            let totalBrightness = 0;

            for (let i = 0; i < data.length; i += 4) {
                // Luminance
                const lum = 0.299*data[i] + 0.587*data[i+1] + 0.114*data[i+2];
                bins[Math.floor(lum)]++;
                totalBrightness += lum;
            }

            // Draw Histogram
            histCtx.clearRect(0, 0, histCvs.width, histCvs.height);
            histCtx.fillStyle = "rgba(0, 255, 65, 0.6)";
            
            const maxVal = Math.max(...bins);
            const barW = histCvs.width / 256;
            
            for (let i = 0; i < 256; i++) {
                const h = (bins[i] / maxVal) * histCvs.height;
                histCtx.fillRect(i * barW, histCvs.height - h, barW, h);
            }

            // Lux Est
            const avgLux = totalBrightness / (100*100);
            document.getElementById('val-lux').innerText = avgLux.toFixed(0) + " LX";
        }

        function updateCompassUI() {
            const strip = document.getElementById('compass-strip');
            // Pixel width of strip is approx 600px for 360 degrees? 
            // Simplification: Shift pixels based on degree
            // Need infinite loop visual logic, but simple offset works for now
            const offset = -(state.compass * 2); // 2px per degree
            strip.style.left = `calc(50% + ${offset}px)`;
            
            document.getElementById('val-head').innerText = state.compass.toFixed(0) + "°";
            document.getElementById('val-pitch').innerText = state.pitch ? state.pitch.toFixed(0) + "°" : "0°";
        }

        function scaleRect(bbox) {
            // Scale video coords to canvas
            const vidW = vid.videoWidth;
            const vidH = vid.videoHeight;
            const scale = Math.max(state.w / vidW, state.h / vidH);
            const x = bbox[0] * scale + (state.w - vidW * scale) / 2;
            const y = bbox[1] * scale + (state.h - vidH * scale) / 2;
            return { x, y, w: bbox[2] * scale, h: bbox[3] * scale };
        }
    </script>
</body>
</html>
