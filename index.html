<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>MAGIC WONDER COMPASS | PROD-BUILD</title>
    <meta name="description" content="High-precision Sci-Fi Compass with Sensor Fusion">
    <meta name="theme-color" content="#000000">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

    <style>
        /* ------------------------------------------------------------------
           CSS: SCI-FI HUD / RESPONSIVE DESIGN
           ------------------------------------------------------------------ */
        :root {
            --c-bg: #050505;
            --c-primary: #00f0ff; /* Cyan */
            --c-accent: #ff003c;  /* Red/Pink */
            --c-warn: #ffcc00;    /* Amber */
            --c-ghost: #b829ff;   /* Purple for Anomaly */
            --c-dim: #444;
            --c-glass: rgba(0, 20, 30, 0.8);
            --font-hud: 'Courier New', Courier, monospace;
            --ease-out: cubic-bezier(0.215, 0.61, 0.355, 1);
        }

        * { box-sizing: border-box; user-select: none; -webkit-tap-highlight-color: transparent; }
        
        body {
            margin: 0; padding: 0;
            background-color: var(--c-bg);
            color: var(--c-primary);
            font-family: var(--font-hud);
            overflow: hidden;
            height: 100vh;
            width: 100vw;
            display: flex;
            flex-direction: column;
        }

        /* UTILS */
        .hidden { display: none !important; }
        .blink { animation: blink 1s infinite; }
        @keyframes blink { 50% { opacity: 0.3; } }
        
        /* SCANLINES */
        .scanlines {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: linear-gradient(to bottom, rgba(255,255,255,0), rgba(255,255,255,0) 50%, rgba(0,0,0,0.1) 50%, rgba(0,0,0,0.1));
            background-size: 100% 4px;
            pointer-events: none;
            z-index: 10;
            opacity: 0.3;
        }

        /* INITIAL PERMISSION OVERLAY */
        #overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.95);
            z-index: 100;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
            padding: 20px;
        }
        
        h1 { font-size: 1.5rem; margin-bottom: 0.5rem; letter-spacing: 2px; color: var(--c-primary); text-shadow: 0 0 10px var(--c-primary); }
        p { font-size: 0.9rem; color: #aaa; max-width: 400px; line-height: 1.4; }

        button.btn-sci-fi {
            background: transparent;
            border: 1px solid var(--c-primary);
            color: var(--c-primary);
            padding: 15px 30px;
            font-family: var(--font-hud);
            font-size: 1rem;
            font-weight: bold;
            cursor: pointer;
            margin-top: 20px;
            text-transform: uppercase;
            box-shadow: 0 0 10px rgba(0, 240, 255, 0.2);
            transition: all 0.2s;
        }
        button.btn-sci-fi:active { background: var(--c-primary); color: #000; }

        /* MAIN HUD */
        #hud-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            position: relative;
            padding: 10px;
        }

        /* TOP BAR: GPS & STATUS */
        .status-bar {
            display: flex;
            justify-content: space-between;
            font-size: 0.7rem;
            border-bottom: 1px solid var(--c-dim);
            padding-bottom: 5px;
            margin-bottom: 10px;
        }
        .gps-box { color: var(--c-warn); }
        .accuracy-box { color: #aaa; }

        /* COMPASS AREA */
        .compass-stage {
            flex: 1;
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
            perspective: 1000px;
        }

        .compass-ring {
            width: 80vw; height: 80vw;
            max-width: 400px; max-height: 400px;
            border: 2px solid var(--c-dim);
            border-radius: 50%;
            position: relative;
            box-shadow: 0 0 20px rgba(0, 240, 255, 0.1);
            transition: transform 0.1s var(--ease-out);
        }

        .cardinal {
            position: absolute;
            font-weight: bold;
            font-size: 1.2rem;
        }
        .n { top: 10px; left: 50%; transform: translateX(-50%); color: var(--c-accent); }
        .s { bottom: 10px; left: 50%; transform: translateX(-50%); }
        .e { right: 15px; top: 50%; transform: translateY(-50%); }
        .w { left: 15px; top: 50%; transform: translateY(-50%); }

        /* NEEDLES */
        .needle-container {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            pointer-events: none;
        }
        
        .needle {
            position: absolute;
            top: 50%; left: 50%;
            width: 4px; height: 45%;
            transform-origin: bottom center;
            /* Transform will be applied by JS */
            transition: transform 0.3s var(--ease-out);
            box-shadow: 0 0 5px currentColor;
            z-index: 2;
        }

        /* MODE STYLES */
        /* Wonder Mode */
        .needle.wonder { background: var(--c-primary); height: 40%; margin-top: -40%; margin-left: -2px; border-radius: 2px; }
        .needle.wonder::after { content: ''; position: absolute; top: -10px; left: -6px; border-left: 8px solid transparent; border-right: 8px solid transparent; border-bottom: 15px solid var(--c-primary); }

        /* Magnetic Mode */
        .needle.north { background: var(--c-accent); height: 42%; margin-top: -42%; margin-left: -2px; display: none; }
        .needle.mag { background: var(--c-dim); width: 2px; height: 35%; margin-top: -35%; margin-left: -1px; display: none; }

        /* Anomaly Mode */
        .needle.anomaly { background: var(--c-ghost); height: 38%; margin-top: -38%; margin-left: -2px; display: none; }
        
        /* CENTER HUD DATA */
        .center-data {
            position: absolute; top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
            background: rgba(0,0,0,0.8);
            padding: 5px;
            border: 1px solid var(--c-dim);
            border-radius: 4px;
            z-index: 5;
        }
        .heading-val { font-size: 2rem; font-weight: bold; display: block; }
        .heading-label { font-size: 0.6rem; color: #888; letter-spacing: 1px; }

        /* BOTTOM PANELS */
        .info-panel {
            min-height: 120px;
            background: var(--c-glass);
            border: 1px solid var(--c-dim);
            margin-top: 10px;
            padding: 15px;
            font-size: 0.9rem;
            display: flex;
            flex-direction: column;
            justify-content: space-around;
        }
        
        .target-name { color: var(--c-primary); font-weight: bold; font-size: 1.1rem; margin-bottom: 5px; border-bottom: 1px dashed var(--c-dim); padding-bottom: 5px;}
        .metric-row { display: flex; justify-content: space-between; margin-bottom: 4px; }
        .metric-val { font-weight: bold; }

        /* CONTROLS */
        .controls {
            display: flex;
            gap: 5px;
            margin-top: 10px;
            overflow-x: auto;
            padding-bottom: 5px;
        }
        .mode-btn {
            flex: 1;
            background: #111;
            border: 1px solid var(--c-dim);
            color: #888;
            padding: 10px 5px;
            font-size: 0.7rem;
            font-family: var(--font-hud);
            cursor: pointer;
            white-space: nowrap;
        }
        .mode-btn.active { border-color: var(--c-primary); color: var(--c-primary); background: rgba(0, 240, 255, 0.1); }
        
        .settings-btn { width: 40px; display: flex; align-items: center; justify-content: center; font-size: 1.2rem; }

        /* ANOMALY GLITCH FX */
        .glitch-mode .compass-ring { border-color: var(--c-ghost); box-shadow: 0 0 15px var(--c-ghost); }
        .glitch-mode .heading-val { text-shadow: 2px 0 var(--c-ghost), -2px 0 var(--c-warn); }
        
        /* MODAL */
        .modal {
            position: fixed; top:0; left:0; width:100%; height:100%;
            background: rgba(0,0,0,0.9);
            z-index: 200;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        .modal-content {
            width: 85%; max-width: 400px;
            background: #111; border: 1px solid var(--c-primary);
            padding: 20px;
        }
        .modal input, .modal select {
            width: 100%; padding: 10px; background: #222; border: 1px solid #444; color: #fff;
            margin-bottom: 10px; font-family: var(--font-hud);
        }
        .modal h2 { margin-top: 0; color: var(--c-primary); border-bottom: 1px solid var(--c-dim); padding-bottom: 10px;}
        .close-modal { float: right; cursor: pointer; color: var(--c-warn); }

    </style>
</head>
<body>

    <!-- SCANLINE OVERLAY -->
    <div class="scanlines"></div>

    <!-- PERMISSION & STARTUP -->
    <div id="overlay">
        <h1>MAGIC WONDER COMPASS</h1>
        <p>SYSTEM: READY</p>
        <p>MODULES: GPS | GYRO | MAGNETOMETER</p>
        <p style="color: var(--c-warn); margin-top:20px; font-size: 0.8rem;">
            REQUIRES SENSOR PERMISSIONS<br>WORKS BEST OUTDOORS
        </p>
        <button id="btn-start" class="btn-sci-fi">INITIALIZE SYSTEM</button>
    </div>

    <!-- MAIN UI -->
    <div id="hud-container" class="hidden">
        
        <!-- STATUS BAR -->
        <div class="status-bar">
            <span id="gps-status" class="gps-box blink">ACQUIRING GPS...</span>
            <span id="gps-coords">--.---, --.---</span>
            <span id="gps-acc" class="accuracy-box">Â±--m</span>
        </div>

        <!-- COMPASS -->
        <div class="compass-stage" id="compass-stage">
            <div class="compass-ring" id="compass-ring">
                <div class="cardinal n">N</div>
                <div class="cardinal e">E</div>
                <div class="cardinal s">S</div>
                <div class="cardinal w">W</div>
                
                <!-- Needles -->
                <div class="needle-container">
                    <div id="needle-wonder" class="needle wonder"></div>
                    <div id="needle-north" class="needle north"></div> <!-- True North -->
                    <div id="needle-mag" class="needle mag"></div> <!-- Mag North -->
                    <div id="needle-anomaly" class="needle anomaly"></div>
                </div>

                <!-- Center Data -->
                <div class="center-data">
                    <span class="heading-val" id="disp-heading">000Â°</span>
                    <span class="heading-label">HEADING</span>
                </div>
            </div>
        </div>

        <!-- INFO PANEL -->
        <div class="info-panel" id="info-panel">
            <div class="target-name" id="disp-target">SELECT TARGET</div>
            <div class="metric-row">
                <span>BEARING</span>
                <span class="metric-val" id="disp-bearing">---Â°</span>
            </div>
            <div class="metric-row">
                <span>DISTANCE</span>
                <span class="metric-val" id="disp-dist">--- km</span>
            </div>
            <div class="metric-row" id="extra-metric-row">
                <span id="extra-label">STATUS</span>
                <span class="metric-val" id="extra-val">STANDBY</span>
            </div>
        </div>

        <!-- CONTROLS -->
        <div class="controls">
            <button class="mode-btn active" onclick="app.setMode('wonder')">WONDER</button>
            <button class="mode-btn" onclick="app.setMode('magnetic')">EARTH MAG</button>
            <button class="mode-btn" onclick="app.setMode('anomaly')">ANOMALY</button>
            <button class="mode-btn settings-btn" onclick="app.toggleSettings()">âš™</button>
        </div>
    </div>

    <!-- SETTINGS / TARGET MODAL -->
    <div id="modal-settings" class="modal hidden">
        <div class="modal-content">
            <span class="close-modal" onclick="app.toggleSettings()">[X]</span>
            <h2>CONFIGURATION</h2>
            
            <!-- WONDER MODE SETTINGS -->
            <div id="opt-wonder">
                <label>TARGET DESTINATION</label>
                <select id="sel-target" onchange="app.changeTarget(this.value)"></select>
                
                <div style="margin-top:15px; border-top: 1px solid #333; padding-top:10px;">
                    <label style="color:#888; font-size:0.8rem;">ADD CUSTOM TARGET</label>
                    <input type="text" id="inp-name" placeholder="Name (e.g. Base)">
                    <input type="number" id="inp-lat" placeholder="Latitude">
                    <input type="number" id="inp-lon" placeholder="Longitude">
                    <button class="btn-sci-fi" style="width:100%; padding:10px; margin-top:5px; font-size:0.8rem;" onclick="app.addCustomTarget()">SAVE TARGET</button>
                </div>
            </div>

            <!-- MAGNETIC MODE SETTINGS -->
            <div id="opt-magnetic" class="hidden">
                <label>MAGNETIC DECLINATION (Â°)</label>
                <input type="number" id="inp-declination" value="0" onchange="app.updateDeclination(this.value)">
                <p style="font-size:0.7rem; color:#666;">Positive for East, Negative for West. Check NOAA or local maps.</p>
            </div>

            <!-- ANOMALY MODE SETTINGS -->
            <div id="opt-anomaly" class="hidden">
                <label>SENSITIVITY</label>
                <input type="range" min="1" max="10" value="5" style="width:100%">
                <p style="font-size:0.7rem; color:var(--c-ghost);">"Myths are just unmeasured science."</p>
            </div>
        </div>
    </div>

<script>
/**
 * MAGIC WONDER COMPASS - SINGLE FILE PRODUCTION BUILD
 * Architect: Senior Mobile Engineer
 * Stack: Vanilla JS (ES6+), no deps.
 */

// --- DATA: WONDERS OF THE WORLD ---
const DEFAULT_WONDERS = [
    { name: "Great Pyramid of Giza", lat: 29.9792, lon: 31.1342, tag: "Ancient" },
    { name: "Great Wall of China", lat: 40.4319, lon: 116.5704, tag: "New7" },
    { name: "Petra", lat: 30.3285, lon: 35.4444, tag: "New7" },
    { name: "Colosseum", lat: 41.8902, lon: 12.4922, tag: "New7" },
    { name: "Chichen Itza", lat: 20.6843, lon: -88.5678, tag: "New7" },
    { name: "Machu Picchu", lat: -13.1631, lon: -72.5450, tag: "New7" },
    { name: "Taj Mahal", lat: 27.1751, lon: 78.0421, tag: "New7" },
    { name: "Christ the Redeemer", lat: -22.9519, lon: -43.2105, tag: "New7" }
];

// --- MODULE: MATH UTILS ---
const MathUtils = {
    toRad: (deg) => deg * Math.PI / 180,
    toDeg: (rad) => rad * 180 / Math.PI,
    
    // Haversine Distance (km)
    getDistance: (lat1, lon1, lat2, lon2) => {
        const R = 6371; // Radius of earth in km
        const dLat = MathUtils.toRad(lat2 - lat1);
        const dLon = MathUtils.toRad(lon2 - lon1);
        const a = 
            Math.sin(dLat/2) * Math.sin(dLat/2) +
            Math.cos(MathUtils.toRad(lat1)) * Math.cos(MathUtils.toRad(lat2)) * 
            Math.sin(dLon/2) * Math.sin(dLon/2);
        const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
        return R * c;
    },

    // Initial Bearing (Degrees 0-360)
    getBearing: (lat1, lon1, lat2, lon2) => {
        const y = Math.sin(MathUtils.toRad(lon2 - lon1)) * Math.cos(MathUtils.toRad(lat2));
        const x = Math.cos(MathUtils.toRad(lat1)) * Math.sin(MathUtils.toRad(lat2)) -
                Math.sin(MathUtils.toRad(lat1)) * Math.cos(MathUtils.toRad(lat2)) * Math.cos(MathUtils.toRad(lon2 - lon1));
        const brng = MathUtils.toDeg(Math.atan2(y, x));
        return (brng + 360) % 360;
    },

    // Smooth angle interpolation (handles 359->1 wrap)
    lerpAngle: (current, target, factor) => {
        let delta = target - current;
        if (delta > 180) delta -= 360;
        if (delta < -180) delta += 360;
        return current + delta * factor;
    },

    // Format numbers nicely
    formatDist: (km) => {
        if (km < 1) return (km * 1000).toFixed(0) + " m";
        return km.toFixed(1) + " km";
    }
};

// --- MODULE: SENSOR ENGINE ---
class SensorEngine {
    constructor() {
        this.heading = 0; // 0 = True North (approx)
        this.gps = { lat: null, lon: null, acc: null };
        this.magField = null; // Microteslas if available
        this.hasMagSensor = false;
        this.listeners = [];
    }

    async init() {
        // 1. GPS
        if ("geolocation" in navigator) {
            navigator.geolocation.watchPosition(
                (pos) => {
                    this.gps.lat = pos.coords.latitude;
                    this.gps.lon = pos.coords.longitude;
                    this.gps.acc = pos.coords.accuracy;
                    this.emit('gps', this.gps);
                },
                (err) => console.warn("GPS Error", err),
                { enableHighAccuracy: true, maximumAge: 0, timeout: 5000 }
            );
        }

        // 2. Orientation (The messy part)
        if (typeof DeviceOrientationEvent !== 'undefined' && typeof DeviceOrientationEvent.requestPermission === 'function') {
            // iOS 13+
            try {
                const response = await DeviceOrientationEvent.requestPermission();
                if (response === 'granted') {
                    window.addEventListener('deviceorientation', (e) => this.handleOrientation(e));
                }
            } catch (e) {
                alert("Permission needed for compass.");
            }
        } else {
            // Android / Old iOS
            if ('ondeviceorientationabsolute' in window) {
                window.addEventListener('deviceorientationabsolute', (e) => this.handleOrientation(e));
            } else {
                window.addEventListener('deviceorientation', (e) => this.handleOrientation(e));
            }
        }

        // 3. Magnetometer (Generic Sensor API - Android mainly)
        try {
            // @ts-ignore
            if (typeof Magnetometer !== "undefined") {
                // @ts-ignore
                const mag = new Magnetometer({ frequency: 10 });
                mag.addEventListener("reading", () => {
                    this.hasMagSensor = true;
                    // Calculate total field strength
                    this.magField = Math.sqrt(mag.x**2 + mag.y**2 + mag.z**2);
                    this.emit('magnetometer', { field: this.magField, x: mag.x, y: mag.y, z: mag.z });
                });
                mag.start();
            }
        } catch (e) {
            console.log("Magnetometer API not supported or denied.");
        }
    }

    handleOrientation(e) {
        let heading = 0;
        
        if (e.webkitCompassHeading) {
            // iOS
            heading = e.webkitCompassHeading;
        } else if (e.alpha !== null) {
            // Android absolute or relative
            // Note: For true 'absolute' north on Android, alpha needs specific calculation if deviceorientationabsolute is used.
            // Simply: alpha counts 0 as North usually in absolute mode.
            // But usually, we need to correct for phone rotation (beta/gamma).
            // For simplicity in this single-file MVP, we assume standard alpha usage but invert it for CSS rotation logic.
            heading = 360 - e.alpha; 
        }

        // Simple Low Pass Filter applied in Renderer, here just store raw
        this.heading = heading; 
    }

    on(event, callback) {
        if (!this.listeners[event]) this.listeners[event] = [];
        this.listeners[event].push(callback);
    }

    emit(event, data) {
        if (this.listeners[event]) this.listeners[event].forEach(cb => cb(data));
    }
}

// --- MODULE: APPLICATION STATE & LOGIC ---
class MagicCompassApp {
    constructor() {
        this.sensor = new SensorEngine();
        this.mode = 'wonder'; // wonder, magnetic, anomaly
        
        // State
        this.currentHeading = 0; // Smoothed
        this.target = DEFAULT_WONDERS[0];
        this.customTargets = JSON.parse(localStorage.getItem('custom_targets') || '[]');
        this.declination = parseFloat(localStorage.getItem('declination') || '0');
        
        // Anomaly Simulation
        this.anomalyBearing = 0;
        this.anomalySeeds = { t: 0, val: 0 };

        // DOM Elements
        this.els = {
            ring: document.getElementById('compass-ring'),
            needles: {
                wonder: document.getElementById('needle-wonder'),
                north: document.getElementById('needle-north'),
                mag: document.getElementById('needle-mag'),
                anomaly: document.getElementById('needle-anomaly')
            },
            text: {
                heading: document.getElementById('disp-heading'),
                target: document.getElementById('disp-target'),
                bearing: document.getElementById('disp-bearing'),
                dist: document.getElementById('disp-dist'),
                gpsStatus: document.getElementById('gps-status'),
                gpsCoords: document.getElementById('gps-coords'),
                gpsAcc: document.getElementById('gps-acc'),
                extraLabel: document.getElementById('extra-label'),
                extraVal: document.getElementById('extra-val')
            },
            opts: {
                wonder: document.getElementById('opt-wonder'),
                mag: document.getElementById('opt-magnetic'),
                anom: document.getElementById('opt-anomaly')
            }
        };

        this.loadTargets();
    }

    async start() {
        document.getElementById('overlay').style.display = 'none';
        document.getElementById('hud-container').classList.remove('hidden');
        await this.sensor.init();
        
        // Animation Loop
        const loop = () => {
            this.update();
            requestAnimationFrame(loop);
        };
        requestAnimationFrame(loop);
    }

    loadTargets() {
        const sel = document.getElementById('sel-target');
        sel.innerHTML = '';
        const all = [...DEFAULT_WONDERS, ...this.customTargets];
        all.forEach((t, i) => {
            const opt = document.createElement('option');
            opt.value = i;
            opt.text = t.name;
            sel.appendChild(opt);
        });
        this.target = all[0];
    }

    addCustomTarget() {
        const name = document.getElementById('inp-name').value;
        const lat = parseFloat(document.getElementById('inp-lat').value);
        const lon = parseFloat(document.getElementById('inp-lon').value);
        
        if (name && !isNaN(lat) && !isNaN(lon)) {
            this.customTargets.push({ name, lat, lon, tag: 'Custom' });
            localStorage.setItem('custom_targets', JSON.stringify(this.customTargets));
            this.loadTargets();
            alert('Target saved!');
            // Select the new one
            const sel = document.getElementById('sel-target');
            sel.value = sel.options.length - 1;
            this.changeTarget(sel.value);
            this.toggleSettings();
        } else {
            alert('Invalid Input');
        }
    }

    changeTarget(index) {
        const all = [...DEFAULT_WONDERS, ...this.customTargets];
        this.target = all[index];
        this.els.text.target.innerText = this.target.name.toUpperCase();
    }

    setMode(m) {
        this.mode = m;
        document.querySelectorAll('.mode-btn').forEach(b => b.classList.remove('active'));
        // Find button by simple text matching or onclick logic (simplified here)
        const buttons = document.querySelectorAll('.mode-btn');
        if(m === 'wonder') buttons[0].classList.add('active');
        if(m === 'magnetic') buttons[1].classList.add('active');
        if(m === 'anomaly') buttons[2].classList.add('active');

        // Hide all needles first
        Object.values(this.els.needles).forEach(n => n.style.display = 'none');

        // Toggle settings view
        this.els.opts.wonder.classList.add('hidden');
        this.els.opts.mag.classList.add('hidden');
        this.els.opts.anom.classList.add('hidden');
        document.body.classList.remove('glitch-mode');

        if (m === 'wonder') {
            this.els.needles.wonder.style.display = 'block';
            this.els.opts.wonder.classList.remove('hidden');
            this.els.text.extraLabel.innerText = "TYPE";
            this.els.text.extraVal.innerText = this.target.tag || "WONDER";
        } else if (m === 'magnetic') {
            this.els.needles.north.style.display = 'block';
            this.els.needles.mag.style.display = 'block';
            this.els.opts.mag.classList.remove('hidden');
            this.els.text.target.innerText = "MAGNETIC ANALYSIS";
            this.els.text.extraLabel.innerText = "FIELD";
        } else if (m === 'anomaly') {
            this.els.needles.anomaly.style.display = 'block';
            this.els.opts.anom.classList.remove('hidden');
            this.els.text.target.innerText = "ANOMALY SCANNER";
            this.els.text.extraLabel.innerText = "VOLATILITY";
            document.body.classList.add('glitch-mode');
        }
    }

    updateDeclination(val) {
        this.declination = parseFloat(val);
        localStorage.setItem('declination', val);
    }

    toggleSettings() {
        const m = document.getElementById('modal-settings');
        m.classList.toggle('hidden');
    }

    // --- CORE RENDER LOOP ---
    update() {
        // 1. Process GPS
        const { lat, lon, acc } = this.sensor.gps;
        if (lat) {
            this.els.text.gpsStatus.innerText = "GPS LOCKED";
            this.els.text.gpsStatus.classList.remove('blink');
            this.els.text.gpsStatus.style.color = "var(--c-primary)";
            this.els.text.gpsCoords.innerText = `${lat.toFixed(4)}, ${lon.toFixed(4)}`;
            this.els.text.gpsAcc.innerText = `Â±${Math.round(acc)}m`;
        }

        // 2. Process Heading (Smoothing)
        // Note: In real HUDs, usually the RING rotates and needle is fixed up, OR Ring fixed and needle rotates.
        // Req: "Needle points to target".
        // Implementation: The Compass Ring stays fixed to Phone (N is up). Needles rotate.
        // Actually, standard is: Compass Card rotates so 'N' matches North. Needles point to target relative to Card.
        // Let's do: Phone Top is 12 o'clock.
        // Ring Rotates so 'N' points to Magnetic North.
        // Target Needle points to Target Bearing.
        
        let rawHeading = this.sensor.heading; 
        // If rawHeading is 0, it means Top of phone is pointing North.
        // We need to rotate the Ring by -heading to make 'N' align with North?
        // Yes. If I face East (90deg), 'N' should be at my left (-90deg).
        
        this.currentHeading = MathUtils.lerpAngle(this.currentHeading, rawHeading, 0.1);
        this.els.text.heading.innerText = Math.round(this.currentHeading).toString().padStart(3, '0') + "Â°";

        const ringRot = -this.currentHeading;
        this.els.ring.style.transform = `rotate(${ringRot}deg)`;

        // 3. Mode Logic
        if (this.mode === 'wonder' && lat) {
            const bearing = MathUtils.getBearing(lat, lon, this.target.lat, this.target.lon);
            const dist = MathUtils.getDistance(lat, lon, this.target.lat, this.target.lon);
            
            this.els.text.bearing.innerText = Math.round(bearing) + "Â°";
            this.els.text.dist.innerText = MathUtils.formatDist(dist);

            // Needle rotation:
            // The ring is already rotated by -heading (so N is North).
            // We just need to rotate the needle to the Bearing relative to the Ring (which represents World Frame).
            // So simply rotate needle to 'bearing'.
            this.els.needles.wonder.style.transform = `translateX(-50%) rotate(${bearing}deg)`;

        } else if (this.mode === 'magnetic') {
            // True North Needle (Green/Red)
            // Since Ring 'N' is based on sensor (Magnetic North usually), 
            // True North is Offset by -Declination.
            // Wait, if sensor gives Magnetic North, then Ring N is Mag North. 
            // True North is at: -Declination (if Declination is East positive).
            // Example: Declination 10deg East. Mag North is 0. True North is -10.
            
            // Mag Needle (Ghostly) -> Points to 0 (The 'N' on the ring)
            this.els.needles.mag.style.transform = `translateX(-50%) rotate(0deg)`;

            // True North Needle
            // If Declination is +deg (East), True North is "Left" of Mag North? 
            // No. Mag North is West of True North. So True North is +offset?
            // Let's simplify: Input declination corrects Mag to True. 
            // If user inputs declination, we offset the 'True North' needle relative to the 'N' mark.
            // If Declination is +10 (East), it means MN is 10 deg East of TN. So TN is -10 deg from MN.
            const trueNorthAngle = -this.declination; 
            this.els.needles.north.style.transform = `translateX(-50%) rotate(${trueNorthAngle}deg)`;

            this.els.text.dist.innerText = "---";
            this.els.text.bearing.innerText = `MAG: 0Â° / TRUE: ${-trueNorthAngle}Â°`;
            
            if (this.sensor.hasMagSensor) {
                this.els.text.extraVal.innerText = this.sensor.magField.toFixed(1) + " ÂµT";
            } else {
                this.els.text.extraVal.innerText = "UNAVAILABLE";
            }

        } else if (this.mode === 'anomaly') {
            // Procedural Anomaly Logic
            const time = Date.now() / 1000;
            
            // Calculate "Anomaly Level"
            let noise = 0;
            if (this.sensor.hasMagSensor) {
                // Use real fluctuation
                // A simple high-pass filter effect
                noise = (Math.sin(time * 5) * 0.5 + 0.5) * (this.sensor.magField % 10); 
            } else {
                // Fake based on Lat/Lon + Time
                const locHash = lat ? (lat+lon) : 0;
                noise = Math.sin(time * 2 + locHash * 100) * Math.cos(time * 3);
            }

            // Generate a wandering target
            // Determine a pseudo-random bearing based on perlin-ish noise
            this.anomalySeeds.t += 0.01;
            const randomAngle = (Math.sin(this.anomalySeeds.t) * 180) + (Math.cos(this.anomalySeeds.t * 0.3) * 90);
            this.anomalyBearing = MathUtils.lerpAngle(this.anomalyBearing, randomAngle, 0.02);

            this.els.needles.anomaly.style.transform = `translateX(-50%) rotate(${this.anomalyBearing}deg)`;
            
            // Update UI Text
            const volatility = Math.abs(noise * 10).toFixed(0) + "%";
            this.els.text.extraVal.innerText = volatility;
            this.els.text.bearing.innerText = "ERR: " + Math.round(randomAngle) + "Â°";
            
            // Glitch effect on distance
            if (Math.random() > 0.9) {
                this.els.text.dist.innerText = "ðŸ‘» DETECTED";
            } else {
                this.els.text.dist.innerText = "SCANNING...";
            }
        }
    }
}

// --- INITIALIZATION ---
const app = new MagicCompassApp();

document.getElementById('btn-start').addEventListener('click', () => {
    app.start();
});

</script>
</body>
</html>
