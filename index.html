<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>MAGIC COMPASS | MK-II</title>
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#000000">

    <style>
        /* ------------------------------------------------------------------
           CORE VARIABLES & RESET
           ------------------------------------------------------------------ */
        :root {
            --bg-core: #050508;
            --bg-grad: radial-gradient(circle at 50% 30%, #1a1a2e 0%, #000000 70%);
            
            /* Glass System */
            --glass-surf: rgba(255, 255, 255, 0.03);
            --glass-border: rgba(255, 255, 255, 0.08);
            --glass-highlight: rgba(255, 255, 255, 0.12);
            --blur-val: 20px;

            /* Colors */
            --neon-p: #d946ef; /* Purple */
            --neon-b: #60a5fa; /* Blue */
            --neon-r: #f43f5e; /* Rose/Alert */
            --neon-g: #34d399; /* Green/Safe */
            --text-1: #ffffff;
            --text-2: #94a3b8;
            --text-3: #64748b;

            --font-ui: -apple-system, BlinkMacSystemFont, "SF Pro Display", "Inter", sans-serif;
            --font-mono: "SF Mono", "Menlo", monospace;
            
            --safe-top: env(safe-area-inset-top, 20px);
            --safe-bot: env(safe-area-inset-bottom, 20px);
            --ease-lux: cubic-bezier(0.25, 1, 0.5, 1);
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; user-select: none; }
        
        body {
            margin: 0; padding: 0;
            background: #000;
            color: var(--text-1); font-family: var(--font-main);
            height: 100vh; width: 100vw; overflow: hidden;
            display: flex; flex-direction: column;
        }

        /* ------------------------------------------------------------------
           PREMIUM OVERLAY STYLES (RE-DESIGNED)
           ------------------------------------------------------------------ */
        #overlay {
            position: fixed; inset: 0; z-index: 999;
            background: var(--bg-grad);
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            padding: 30px; text-align: center;
            transition: opacity 0.8s var(--ease-lux), transform 0.8s var(--ease-lux);
        }

        #overlay.fade-out {
            opacity: 0;
            transform: scale(1.05);
            pointer-events: none;
        }

        /* Vignette Effect */
        #overlay::after {
            content: ''; position: absolute; inset: 0;
            box-shadow: inset 0 0 150px rgba(0,0,0,0.8);
            pointer-events: none; z-index: -1;
        }

        /* Hero Title */
        .boot-title {
            display: flex; flex-direction: column; gap: 8px; margin-bottom: 40px;
            animation: fadeInMove 1s var(--ease-lux);
        }
        .hero-text {
            font-family: var(--font-ui); font-weight: 300; font-size: 1.8rem;
            letter-spacing: 6px; color: #fff; text-shadow: 0 0 20px rgba(255,255,255,0.2);
            text-transform: uppercase;
        }
        .sub-hero {
            font-family: var(--font-mono); font-size: 0.65rem; color: var(--neon-b);
            letter-spacing: 2px; text-transform: uppercase; opacity: 0.8;
            border-top: 1px solid rgba(255,255,255,0.1); padding-top: 8px; width: fit-content; margin: 0 auto;
        }

        /* System Check Glass Card */
        .sys-card {
            background: rgba(255, 255, 255, 0.03);
            backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.08);
            border-radius: 20px;
            padding: 25px; width: 100%; max-width: 340px;
            display: flex; flex-direction: column; gap: 12px;
            margin-bottom: 30px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.3);
            animation: fadeInMove 1s var(--ease-lux) 0.1s backwards;
        }

        .sys-row {
            display: flex; justify-content: space-between; align-items: center;
            font-family: var(--font-mono); font-size: 0.75rem;
            border-bottom: 1px solid rgba(255,255,255,0.05);
            padding-bottom: 8px;
        }
        .sys-row:last-child { border-bottom: none; padding-bottom: 0; }
        
        .sys-label { color: var(--text-3); letter-spacing: 1px; }
        .sys-val { color: var(--text-2); font-weight: 600; display: flex; align-items: center; gap: 6px; }
        
        /* Status Indicator Dot */
        .sys-val::before {
            content: ''; width: 6px; height: 6px; border-radius: 50%;
            background: var(--text-3); box-shadow: 0 0 5px var(--text-3);
            transition: background 0.3s;
        }
        /* Dynamic JS classes will target specific colors if needed, but keeping CSS clean */
        
        /* Instructions */
        .boot-instruct {
            font-family: var(--font-ui); font-size: 0.8rem; color: var(--text-2);
            line-height: 1.6; max-width: 300px; margin-bottom: 40px;
            animation: fadeInMove 1s var(--ease-lux) 0.2s backwards;
        }
        .highlight { color: var(--text-1); font-weight: 500; }

        /* Premium Init Button */
        #btn-init {
            background: rgba(255,255,255,0.05);
            border: 1px solid rgba(255,255,255,0.15);
            color: #fff;
            font-family: var(--font-mono); font-size: 0.85rem; letter-spacing: 2px;
            padding: 16px 40px; border-radius: 100px;
            cursor: pointer; position: relative; overflow: hidden;
            transition: all 0.4s var(--ease-lux);
            box-shadow: 0 0 20px rgba(0,0,0,0.2);
            text-transform: uppercase;
            animation: fadeInMove 1s var(--ease-lux) 0.3s backwards;
        }

        #btn-init::before {
            content: ''; position: absolute; inset: 0;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.1), transparent);
            transform: translateX(-100%); transition: transform 0.5s;
        }
        
        #btn-init:hover {
            background: rgba(255,255,255,0.1);
            box-shadow: 0 0 30px rgba(217, 70, 239, 0.15); /* Purple glow hint */
            border-color: rgba(255,255,255,0.3);
            transform: translateY(-2px);
        }
        #btn-init:active { transform: scale(0.96); }

        /* Animations */
        @keyframes fadeInMove {
            0% { opacity: 0; transform: translateY(10px); }
            100% { opacity: 1; transform: translateY(0); }
        }

        /* ------------------------------------------------------------------
           MAIN HUD STYLES (Existing + Tweaks)
           ------------------------------------------------------------------ */
        /* Background Fx */
        .bg-orb {
            position: absolute; border-radius: 50%; filter: blur(90px); opacity: 0.3; z-index: 0;
            animation: float 20s infinite alternate ease-in-out;
        }
        .orb-1 { width: 300px; height: 300px; background: var(--neon-p); top: -10%; left: -20%; }
        .orb-2 { width: 250px; height: 250px; background: var(--neon-b); bottom: 10%; right: -10%; animation-delay: -5s; }
        @keyframes float { 0% { transform: translate(0,0); } 100% { transform: translate(30px, 40px); } }

        .scanlines {
            position: fixed; inset: 0; pointer-events: none; z-index: 10; 
            background: linear-gradient(to bottom, rgba(255,255,255,0), rgba(255,255,255,0) 50%, rgba(0,0,0,0.1) 50%, rgba(0,0,0,0.1));
            background-size: 100% 4px; opacity: 0.1; /* Reduced for premium feel */
        }

        /* Main App Container */
        #app {
            position: relative; z-index: 20; flex: 1;
            display: flex; flex-direction: column;
            padding: var(--safe-top) 16px calc(var(--safe-bot) + 12px) 16px;
            gap: 12px;
            opacity: 0; /* Hidden initially, shown via JS */
            transition: opacity 1s var(--ease-lux);
        }
        #app.visible { opacity: 1; }

        /* ... [Existing HUD Styles Preserved Below] ... */
        .glass-panel {
            background: var(--glass-surf);
            backdrop-filter: blur(var(--blur-val)); -webkit-backdrop-filter: blur(var(--blur-val));
            border: 1px solid var(--glass-border);
            border-radius: 28px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.4);
        }
        
        /* Header */
        .header { justify-content: space-between; height: 44px; padding: 0 4px; }
        .brand { font-weight: 800; letter-spacing: 1px; font-size: 0.95rem; display: flex; align-items: center; gap: 6px; }
        .badge { font-size: 0.7rem; padding: 5px 12px; border-radius: 20px; background: rgba(0,0,0,0.3); border: 1px solid var(--glass-border); color: var(--text-2); transition: 0.3s; }
        .badge.active { border-color: var(--neon-g); color: var(--neon-g); box-shadow: 0 0 10px rgba(52, 211, 153, 0.2); }
        .lang-btn { cursor: pointer; font-weight: 700; background: var(--glass-border); color: #fff; }

        /* Compass */
        .stage { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; position: relative; min-height: 280px; }
        .orb-ring {
            width: 280px; height: 280px; border-radius: 50%;
            position: relative; 
            box-shadow: 0 0 60px rgba(139, 92, 246, 0.1), inset 0 0 40px rgba(0,0,0,0.6);
            border: 1px solid rgba(255,255,255,0.05); will-change: transform;
        }
        .ticks-maj {
            position: absolute; inset: -15px; border-radius: 50%;
            background: conic-gradient(from 0deg, var(--text-2) 0deg 1deg, transparent 1deg 29deg, var(--text-2) 30deg 31deg, transparent 31deg 359deg);
            mask: radial-gradient(transparent 68%, black 69%); -webkit-mask: radial-gradient(transparent 68%, black 69%);
        }
        .ticks-min {
            position: absolute; inset: -5px; border-radius: 50%;
            background: repeating-conic-gradient(rgba(255,255,255,0.15) 0deg 1deg, transparent 1deg 5deg);
            mask: radial-gradient(transparent 68%, black 69%); -webkit-mask: radial-gradient(transparent 68%, black 69%);
        }
        .orb-lens {
            position: absolute; inset: 15px; border-radius: 50%;
            background: radial-gradient(circle at 30% 30%, rgba(255,255,255,0.05), transparent 60%);
            border: 1px solid rgba(255,255,255,0.05); pointer-events: none;
        }
        .cardinal { position: absolute; font-weight: 700; font-size: 0.85rem; color: var(--text-3); }
        .c-n { top: 8px; left: 50%; transform: translateX(-50%); color: var(--neon-p); text-shadow: 0 0 10px var(--neon-p); }
        .c-e { right: 12px; top: 50%; transform: translateY(-50%); }
        .c-s { bottom: 8px; left: 50%; transform: translateX(-50%); }
        .c-w { left: 12px; top: 50%; transform: translateY(-50%); }
        .needle-container { position: absolute; inset: 0; pointer-events: none; }
        .needle {
            position: absolute; top: 50%; left: 50%; transform-origin: bottom center;
            transition: opacity 0.3s; will-change: transform;
        }
        .n-target {
            width: 8px; height: 44%; margin-left: -4px; margin-top: -44%;
            background: linear-gradient(to top, transparent 10%, var(--neon-p) 100%);
            border-radius: 4px; z-index: 3; box-shadow: 0 -4px 15px var(--neon-p);
        }
        .n-target::after { content:''; position: absolute; top: -6px; left: -2px; border: 6px solid transparent; border-bottom: 10px solid #fff; }
        .n-true { width: 2px; height: 48%; background: var(--neon-b); margin-left: -1px; margin-top: -48%; opacity: 0.9; z-index: 2; }
        .n-mag { width: 1px; height: 40%; border-left: 1px dashed var(--neon-r); margin-left: -0.5px; margin-top: -40%; opacity: 0.7; z-index: 1; }
        .hud-center {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            text-align: center; pointer-events: none;
        }
        .val-head { font-size: 2.5rem; font-weight: 800; letter-spacing: -1px; line-height: 1; }
        .lbl-head { font-size: 0.65rem; color: var(--text-2); letter-spacing: 2px; margin-top: 4px; }
        .warn-pill {
            position: absolute; bottom: 20%; left: 50%; transform: translateX(-50%);
            font-size: 0.7rem; color: var(--neon-r); background: rgba(0,0,0,0.6);
            padding: 6px 12px; border-radius: 12px; pointer-events: none; display: none; white-space: nowrap;
            backdrop-filter: blur(4px); border: 1px solid rgba(244, 63, 94, 0.3);
        }
        .warn-pill.show { display: block; animation: pulse 1s infinite; }
        
        /* Myth Radar */
        .monitor-ui { position: absolute; bottom: -15px; right: -15px; width: 120px; height: 120px; display: none; }
        .radar-ring { width: 100%; height: 100%; border-radius: 50%; border: 1px solid rgba(255,255,255,0.1); background: radial-gradient(rgba(0,0,0,0), rgba(0,0,0,0.6)); position: relative; overflow: hidden; }
        .radar-sweep { position: absolute; inset: 0; border-radius: 50%; background: conic-gradient(from 0deg, transparent 0deg, rgba(244, 63, 94, 0.2) 60deg, transparent 60.1deg); animation: sweep 3s linear infinite; }
        .blip { position: absolute; width: 4px; height: 4px; background: #fff; border-radius: 50%; box-shadow: 0 0 6px var(--neon-r); opacity: 0; animation: blip 2s ease-out; }
        .scope-ui { position: absolute; bottom: 10px; left: -10px; width: 80px; height: 40px; opacity: 0.7; display: none; }
        .scope-cvs { width: 100%; height: 100%; }
        @keyframes sweep { to { transform: rotate(360deg); } }
        @keyframes blip { 0% { opacity: 1; transform: scale(1); } 100% { opacity: 0; transform: scale(3); } }
        @keyframes pulse { 50% { opacity: 0.5; } }

        /* Deck & Cards */
        .deck { display: flex; flex-direction: column; gap: 10px; perspective: 1000px; margin-top: auto; }
        .card { padding: 18px; position: relative; overflow: hidden; min-height: 130px; transition: 0.3s; }
        .card::before { content:''; position: absolute; top:0; left:0; bottom:0; width: 3px; background: var(--text-3); }
        .card.lore::before { background: var(--neon-p); }
        .card.omen::before { background: var(--neon-r); }
        .c-head { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 8px; }
        .c-title { font-size: 1.15rem; font-weight: 700; color: #fff; line-height: 1.2; max-width: 80%; }
        .c-meta { font-size: 0.85rem; color: var(--neon-p); font-weight: 600; }
        .c-body { font-size: 0.85rem; color: var(--text-2); line-height: 1.5; }
        .c-facts { margin: 8px 0; padding-left: 0; list-style: none; font-size: 0.75rem; }
        .c-facts li { display: flex; gap: 6px; margin-bottom: 4px; }
        .c-facts li::before { content: 'â€¢'; color: var(--text-3); }
        .c-quote { font-style: italic; color: var(--text-3); font-size: 0.8rem; border-top: 1px solid var(--glass-border); margin-top: 10px; padding-top: 8px; }

        /* Controls */
        .ctrl-row { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 8px; margin-top: 5px; }
        .btn {
            background: var(--glass-surf); border: 1px solid var(--glass-border);
            color: var(--text-2); padding: 12px; border-radius: 20px;
            font-size: 0.8rem; display: flex; align-items: center; justify-content: center; gap: 6px;
            cursor: pointer; transition: 0.2s;
        }
        .btn:active { background: var(--glass-highlight); transform: scale(0.98); }
        .btn.active { border-color: var(--neon-p); color: #fff; background: rgba(217, 70, 239, 0.15); }
        .dock {
            display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 6px;
            background: rgba(0,0,0,0.4); padding: 5px; border-radius: 26px;
            border: 1px solid var(--glass-border);
        }
        .dock-item {
            background: transparent; border: none; color: var(--text-3);
            padding: 10px; border-radius: 20px; font-size: 0.75rem; font-weight: 600;
            cursor: pointer; transition: 0.2s;
        }
        .dock-item.active { background: var(--glass-border); color: #fff; box-shadow: 0 2px 10px rgba(0,0,0,0.2); }

        /* Modals */
        .modal-wrap {
            position: fixed; inset: 0; z-index: 100; background: rgba(0,0,0,0.9);
            backdrop-filter: blur(12px); display: flex; align-items: center; justify-content: center;
            padding: 20px; opacity: 0; pointer-events: none; transition: 0.3s;
        }
        .modal-wrap.show { opacity: 1; pointer-events: auto; }
        .modal-box { width: 100%; max-width: 400px; padding: 24px; max-height: 85vh; overflow-y: auto; }
        
    </style>
</head>
<body>

    <div class="bg-orb orb-1"></div>
    <div class="bg-orb orb-2"></div>
    <div class="scanlines"></div>

    <!-- 1. REDESIGNED STARTUP OVERLAY -->
    <div id="overlay">
        <div class="boot-title">
            <div class="hero-text">Magic Compass</div>
            <div class="sub-hero">Field Console vMK-II</div>
        </div>

        <div class="sys-card">
            <div class="sys-row">
                <span class="sys-label">GPS MODULE</span>
                <span class="sys-val" id="chk-gps">WAITING</span>
            </div>
            <div class="sys-row">
                <span class="sys-label">GYRO SENSOR</span>
                <span class="sys-val" id="chk-gyro">WAITING</span>
            </div>
            <div class="sys-row">
                <span class="sys-label">MAGNETOMETER</span>
                <span class="sys-val" id="chk-mag">OPTIONAL</span>
            </div>
        </div>

        <div class="boot-instruct">
            <div style="margin-bottom:8px;">iOS: <span class="highlight">Allow Sensors</span></div>
            <div>Android: <span class="highlight">Calibrate (Figure 8)</span></div>
        </div>

        <button id="btn-init">Initialize System</button>
    </div>

    <!-- 2. MAIN HUD -->
    <div id="app">
        
        <!-- Header -->
        <div class="flex-row header">
            <div class="brand"><span style="color:var(--neon-p)">âœ¦</span> MAGIC CMPSS</div>
            <div class="flex-row">
                <button class="badge lang-btn" id="btn-lang">EN</button>
                <div class="badge" id="gps-stat" data-t="gps_wait">GPS WAIT</div>
                <div style="cursor:pointer; padding:6px; opacity:0.8;" onclick="app.toggleSettings()">âš™</div>
            </div>
        </div>

        <!-- Compass Core -->
        <div class="stage">
            <div class="orb-ring" id="orb-ring">
                <div class="ticks-maj"></div>
                <div class="ticks-min"></div>
                <div class="orb-lens"></div>
                
                <div class="cardinal c-n">N</div><div class="cardinal c-e">E</div>
                <div class="cardinal c-s">S</div><div class="cardinal c-w">W</div>
                
                <div class="needle-container">
                    <div class="needle n-target" id="n-target"></div>
                    <div class="needle n-true" id="n-true"></div>
                    <div class="needle n-mag" id="n-mag"></div>
                </div>

                <div class="hud-center">
                    <span class="val-head mono" id="val-head">000Â°</span>
                    <span class="lbl-head" id="lbl-head">HEADING</span>
                </div>
            </div>

            <div class="warn-pill" id="warn-pill">CALIBRATE</div>

            <!-- Myth Monitor -->
            <div class="monitor-ui" id="monitor-ui">
                <div class="radar-ring"><div class="radar-sweep"></div></div>
            </div>
            <div class="scope-ui" id="scope-ui"><canvas class="scope-cvs" id="scope-cvs"></canvas></div>
        </div>

        <!-- Deck -->
        <div class="deck">
            <!-- Lore Card -->
            <div class="glass-panel card lore" id="card-lore">
                <div class="c-head">
                    <div class="c-title" id="lore-title">Loading...</div>
                    <div class="c-meta mono" id="lore-dist">-- km</div>
                </div>
                <div class="c-body">
                    <div style="margin-bottom:8px; color:#fff;" id="lore-short"></div>
                    <ul class="c-facts" id="lore-facts"></ul>
                    <div class="c-quote" id="lore-myth"></div>
                </div>
            </div>

            <!-- Omen Card -->
            <div class="glass-panel card omen hidden" id="card-omen">
                <div class="c-head">
                    <div class="c-title" style="color:var(--neon-r)" id="omen-title">SIGNAL QUIET</div>
                    <div class="c-meta mono" style="font-size:0.7rem; opacity:0.7">ARG MODE</div>
                </div>
                <div class="c-body">
                    <div id="omen-text" style="color:#fff;">The air is still.</div>
                    <div class="c-quote" id="omen-flavor">No anomalies detected.</div>
                </div>
                <button class="btn" style="width:100%; margin-top:12px; border-color:var(--neon-r); color:var(--neon-r);" onclick="app.showLocalLegend()">
                    <span style="font-size:1rem">ðŸ“œ</span> <span data-t="btn_legend">Read Local Legend</span>
                </button>
            </div>

            <!-- Actions -->
            <div class="ctrl-row" id="row-actions">
                <button class="btn active" id="btn-auto" onclick="app.toggleAuto()"><span>âŸ³</span> <span data-t="btn_auto">Auto</span></button>
                <button class="btn" onclick="app.nextTarget()"><span>â†’</span> <span data-t="btn_next">Next</span></button>
                <button class="btn" onclick="app.openMap()"><span>â†—</span> <span data-t="btn_map">Map</span></button>
            </div>

            <!-- Dock -->
            <div class="dock">
                <button class="dock-item active" onclick="app.setMode('wonder')" data-t="mode_wonder">WONDER</button>
                <button class="dock-item" onclick="app.setMode('earth')" data-t="mode_earth">EARTH</button>
                <button class="dock-item" onclick="app.setMode('myth')" data-t="mode_myth">MYTH</button>
            </div>
        </div>
    </div>

    <!-- 3. MODALS -->
    <!-- Settings -->
    <div id="modal-set" class="modal-wrap">
        <div class="glass-panel modal-box">
            <div style="display:flex; justify-content:space-between; margin-bottom:15px;">
                <h3 style="margin:0; color:#fff;" data-t="title_set">Settings</h3>
                <div style="cursor:pointer; font-size:1.5rem;" onclick="app.toggleSettings()">Ã—</div>
            </div>
            <label style="font-size:0.8rem; color:var(--text-2);" data-t="lbl_decl">Magnetic Declination (Â°)</label>
            <div class="flex-row" style="margin-top:8px;">
                <input type="number" id="inp-decl" value="0" style="width:100%; background:rgba(0,0,0,0.3); border:1px solid var(--glass-border); padding:10px; border-radius:12px; color:#fff;">
                <button class="btn" onclick="app.fetchDecl()">Fetch</button>
            </div>
        </div>
    </div>

    <!-- Legend Reader -->
    <div id="modal-folk" class="modal-wrap">
        <div class="glass-panel modal-box">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
                <div class="badge" style="border-color:var(--neon-r); color:var(--neon-r);">LOCAL LEGEND</div>
                <div style="cursor:pointer; font-size:1.5rem;" onclick="app.closeLegend()">Ã—</div>
            </div>
            <h2 id="folk-title" style="margin:0 0 12px 0; line-height:1.2; color:#fff;">Title</h2>
            <div id="folk-body" style="font-size:0.95rem; color:var(--text-2); line-height:1.6; white-space:pre-line;">...</div>
            <div class="c-quote" id="folk-meta" style="margin-top:20px;">Source: ...</div>
            <div class="flex-row" style="margin-top:20px;">
                <button class="btn" style="flex:1" onclick="app.closeLegend()" data-t="btn_close">Close</button>
            </div>
        </div>
    </div>

<script>
/**
 * MAGIC WONDER COMPASS | MK-II (Refined UI + Boot Overlay)
 */

// --- 1. I18N MODULE ---
const DICT = {
    en: {
        gps_wait: "GPS WAIT", gps_lock: "GPS LOCK",
        mode_wonder: "WONDER", mode_earth: "EARTH", mode_myth: "MYTH",
        btn_auto: "Auto: ON", btn_manual: "Auto: OFF", btn_next: "Next", btn_map: "Map",
        btn_legend: "Read Local Legend", btn_close: "Close",
        title_set: "Settings", lbl_decl: "Declination (Â°)",
        warn_calib: "CALIBRATE: FIGURE 8", warn_tilt: "HOLD FLAT",
        lore_load: "Accessing Archives...",
        omen_q: "SIGNAL QUIET", omen_r: "SUBTLE RIPPLE", omen_d: "DISTORTION", omen_p: "OMEN PEAK",
        flavor_q: "Locals say the spirits sleep deep here.", flavor_a: "Some say the wind whispers names at night.",
        err_mag: "Mag Sensor Unavailable", err_cors: "Offline. Manual entry."
    },
    th: {
        gps_wait: "à¸£à¸­ GPS...", gps_lock: "GPS à¸žà¸£à¹‰à¸­à¸¡",
        mode_wonder: "à¸ªà¸´à¹ˆà¸‡à¸¡à¸«à¸±à¸¨à¸ˆà¸£à¸£à¸¢à¹Œ", mode_earth: "à¹à¸¡à¹ˆà¹€à¸«à¸¥à¹‡à¸à¹‚à¸¥à¸", mode_myth: "à¹€à¸£à¸·à¹ˆà¸­à¸‡à¸¥à¸µà¹‰à¸¥à¸±à¸š",
        btn_auto: "à¸­à¸­à¹‚à¸•à¹‰: à¹€à¸›à¸´à¸”", btn_manual: "à¸­à¸­à¹‚à¸•à¹‰: à¸›à¸´à¸”", btn_next: "à¸–à¸±à¸”à¹„à¸›", btn_map: "à¹à¸œà¸™à¸—à¸µà¹ˆ",
        btn_legend: "à¸­à¹ˆà¸²à¸™à¸•à¸³à¸™à¸²à¸™à¹à¸–à¸§à¸™à¸µà¹‰", btn_close: "à¸›à¸´à¸”",
        title_set: "à¸•à¸±à¹‰à¸‡à¸„à¹ˆà¸²", lbl_decl: "à¸¡à¸¸à¸¡à¸šà¹ˆà¸²à¸¢à¹€à¸šà¸™ (Â°)",
        warn_calib: "à¸«à¸¡à¸¸à¸™à¹€à¸„à¸£à¸·à¹ˆà¸­à¸‡à¹€à¸¥à¸‚ 8", warn_tilt: "à¸§à¸²à¸‡à¹€à¸„à¸£à¸·à¹ˆà¸­à¸‡à¸£à¸²à¸š",
        lore_load: "à¸à¸³à¸¥à¸±à¸‡à¸„à¹‰à¸™à¸‚à¹‰à¸­à¸¡à¸¹à¸¥...",
        omen_q: "à¸ªà¸±à¸à¸à¸²à¸“à¸ªà¸‡à¸š", omen_r: "à¸£à¸´à¹‰à¸§à¸„à¸¥à¸·à¹ˆà¸™à¸ˆà¸²à¸‡à¹†", omen_d: "à¸ªà¸™à¸²à¸¡à¸šà¸´à¸”à¹€à¸šà¸·à¸­à¸™", omen_p: "à¸¥à¸²à¸‡à¸£à¹‰à¸²à¸¢à¸ªà¸¹à¸‡à¸ªà¸¸à¸”",
        flavor_q: "à¸„à¸™à¹€à¸’à¹ˆà¸²à¸„à¸™à¹à¸à¹ˆà¸šà¸­à¸à¸§à¹ˆà¸²à¸—à¸µà¹ˆà¸™à¸µà¹ˆà¹€à¸ˆà¹‰à¸²à¸—à¸µà¹ˆà¹à¸£à¸‡à¹à¸•à¹ˆà¹ƒà¸ˆà¸”à¸µ", flavor_a: "à¹€à¸‚à¸²à¸§à¹ˆà¸²à¸à¸±à¸™à¸§à¹ˆà¸²à¸­à¸¢à¹ˆà¸²à¸‚à¸²à¸™à¸£à¸±à¸šà¸–à¹‰à¸²à¹„à¸”à¹‰à¸¢à¸´à¸™à¹€à¸ªà¸µà¸¢à¸‡à¹€à¸£à¸µà¸¢à¸",
        err_mag: "à¹„à¸¡à¹ˆà¸žà¸šà¹€à¸‹à¸™à¹€à¸‹à¸­à¸£à¹Œ", err_cors: "à¸­à¸­à¸Ÿà¹„à¸¥à¸™à¹Œ à¸à¸£à¸­à¸à¹€à¸­à¸‡"
    }
};

class I18n {
    constructor() {
        this.lang = localStorage.getItem('lang') || (navigator.language.startsWith('th') ? 'th' : 'en');
        this.apply();
    }
    t(key) { return DICT[this.lang][key] || key; }
    toggle() {
        this.lang = this.lang === 'en' ? 'th' : 'en';
        localStorage.setItem('lang', this.lang);
        this.apply();
    }
    apply() {
        document.getElementById('btn-lang').innerText = this.lang.toUpperCase();
        document.querySelectorAll('[data-t]').forEach(el => el.innerText = this.t(el.dataset.t));
    }
}

// --- 2. DATABASES ---
const LORE_DB = {
    "Great Pyramid of Giza": { en: {short:"The last ancient wonder.", facts:["Built ~2560 BC", "2.3M blocks", "True North aligned"], myth:"A guide said it's a power plant, not a tomb."}, th: {short:"à¸ªà¸´à¹ˆà¸‡à¸¡à¸«à¸±à¸¨à¸ˆà¸£à¸£à¸¢à¹Œà¸«à¸™à¸¶à¹ˆà¸‡à¹€à¸”à¸µà¸¢à¸§à¸—à¸µà¹ˆà¹€à¸«à¸¥à¸·à¸­à¸­à¸¢à¸¹à¹ˆ", facts:["à¸ªà¸£à¹‰à¸²à¸‡à¸›à¸µ 2560 BC", "à¸«à¸´à¸™ 2.3 à¸¥à¹‰à¸²à¸™à¸à¹‰à¸­à¸™", "à¸«à¸±à¸™à¸›à¸—à¸´à¸¨à¹€à¸«à¸™à¸·à¸­à¸ˆà¸£à¸´à¸‡"], myth:"à¹„à¸à¸”à¹Œà¸šà¸­à¸à¸§à¹ˆà¸²à¸™à¸µà¹ˆà¸„à¸·à¸­à¹‚à¸£à¸‡à¹„à¸Ÿà¸Ÿà¹‰à¸² à¹„à¸¡à¹ˆà¹ƒà¸Šà¹ˆà¸ªà¸¸à¸ªà¸²à¸™"} },
    "Stonehenge": { en: {short:"Prehistoric stone ring.", facts:["5000 years old", "Solar aligned", "Heavy stones"], myth:"Locals say Merlin danced them here."}, th: {short:"à¸§à¸‡à¸¥à¹‰à¸­à¸¡à¸«à¸´à¸™à¸›à¸£à¸´à¸¨à¸™à¸²", facts:["à¸­à¸²à¸¢à¸¸ 5,000 à¸›à¸µ", "à¸•à¸£à¸‡à¹à¸™à¸§à¹à¸ªà¸‡à¸­à¸²à¸—à¸´à¸•à¸¢à¹Œ", "à¸«à¸´à¸™à¸«à¸™à¸±à¸à¸¡à¸²à¸"], myth:"à¸•à¸³à¸™à¸²à¸™à¸§à¹ˆà¸²à¸žà¹ˆà¸­à¸¡à¸”à¹€à¸¡à¸­à¸£à¹Œà¸¥à¸´à¸™à¸£à¹ˆà¸²à¸¢à¸¡à¸™à¸•à¹Œà¸¢à¹‰à¸²à¸¢à¸¡à¸²"} },
    "Petra": { en: {short:"Rose City in rock.", facts:["Nabataean capital", "Lost for centuries", "Water experts"], myth:"Djinn guard the treasury."}, th: {short:"à¸™à¸„à¸£à¸ªà¸µà¸Šà¸¡à¸žà¸¹à¹ƒà¸™à¸«à¸´à¸™", facts:["à¹€à¸¡à¸·à¸­à¸‡à¸«à¸¥à¸§à¸‡à¸™à¸²à¸šà¸²à¹€à¸—à¸µà¸¢à¸™", "à¸«à¸²à¸¢à¸ªà¸²à¸šà¸ªà¸¹à¸à¸™à¸²à¸™", "à¹€à¸à¹ˆà¸‡à¹€à¸£à¸·à¹ˆà¸­à¸‡à¸™à¹‰à¸³"], myth:"à¹€à¸Šà¸·à¹ˆà¸­à¸§à¹ˆà¸²à¸¡à¸µà¸ˆà¸´à¸™à¸™à¹Œà¹€à¸à¹‰à¸²à¸ªà¸¡à¸šà¸±à¸•à¸´à¸­à¸¢à¸¹à¹ˆ"} },
    "Great Wall of China": { en: {short:"Stone dragon of East.", facts:["21,196 km long", "2000 years to build", "Not seen from space"], myth:"Bones mixed in the mortar."}, th: {short:"à¸¡à¸±à¸‡à¸à¸£à¸«à¸´à¸™à¹à¸«à¹ˆà¸‡à¸šà¸¹à¸£à¸žà¸²", facts:["à¸¢à¸²à¸§ 2 à¸«à¸¡à¸·à¹ˆà¸™à¹‚à¸¥", "à¸ªà¸£à¹‰à¸²à¸‡ 2 à¸žà¸±à¸™à¸›à¸µ", "à¸¡à¸­à¸‡à¹„à¸¡à¹ˆà¹€à¸«à¹‡à¸™à¸ˆà¸²à¸à¸­à¸§à¸à¸²à¸¨"], myth:"à¸§à¹ˆà¸²à¸à¸±à¸™à¸§à¹ˆà¸²à¹€à¸­à¸²à¸à¸£à¸°à¸”à¸¹à¸à¸„à¸™à¸œà¸ªà¸¡à¸›à¸¹à¸™"} },
    "Colosseum": { en: {short:"Arena of glory.", facts:["Held 50k people", "Flooded for ships", "Built 80 AD"], myth:"You can hear the crowd roar."}, th: {short:"à¸ªà¸±à¸‡à¹€à¸§à¸µà¸¢à¸™à¹€à¸à¸µà¸¢à¸£à¸•à¸´à¸¢à¸¨", facts:["à¸ˆà¸¸à¸„à¸™ 5 à¸«à¸¡à¸·à¹ˆà¸™", "à¸ˆà¸³à¸¥à¸­à¸‡à¸£à¸šà¸—à¸²à¸‡à¹€à¸£à¸·à¸­", "à¸ªà¸£à¹‰à¸²à¸‡à¸›à¸µ 80"], myth:"à¸šà¸²à¸‡à¸—à¸µà¸à¹‡à¹„à¸”à¹‰à¸¢à¸´à¸™à¹€à¸ªà¸µà¸¢à¸‡à¸„à¸™à¸”à¸¹à¹‚à¸«à¹ˆà¸£à¹‰à¸­à¸‡"} },
    "Taj Mahal": { en: {short:"Monument to love.", facts:["Shah Jahan built it", "22 years work", "Sinking base"], myth:"Black twin planned across river."}, th: {short:"à¸­à¸™à¸¸à¸ªà¸£à¸“à¹Œà¹à¸«à¹ˆà¸‡à¸£à¸±à¸", facts:["à¸Šà¸²à¸«à¹Œà¸ˆà¸²à¸®à¸²à¸™à¸ªà¸£à¹‰à¸²à¸‡", "à¹ƒà¸Šà¹‰à¹€à¸§à¸¥à¸² 22 à¸›à¸µ", "à¸à¸²à¸™à¸à¸³à¸¥à¸±à¸‡à¸—à¸£à¸¸à¸”"], myth:"à¸§à¹ˆà¸²à¸ˆà¸°à¸¡à¸µà¸—à¸±à¸ˆà¸¡à¸²à¸®à¸²à¸¥à¸ªà¸µà¸”à¸³à¸­à¸µà¸à¸à¸±à¹ˆà¸‡"} },
    "Christ the Redeemer": { en: {short:"Rio's guardian.", facts:["30m tall", "Soapstone", "Lightning rod"], myth:"Protects city from sea."}, th: {short:"à¸œà¸¹à¹‰à¸žà¸´à¸—à¸±à¸à¸©à¹Œà¸£à¸´à¹‚à¸­", facts:["à¸ªà¸¹à¸‡ 30 à¹€à¸¡à¸•à¸£", "à¸«à¸´à¸™à¸ªà¸šà¸¹à¹ˆ", "à¸¥à¹ˆà¸­à¸Ÿà¹‰à¸²à¸œà¹ˆà¸²"], myth:"à¸›à¸à¸›à¹‰à¸­à¸‡à¹€à¸¡à¸·à¸­à¸‡à¸ˆà¸²à¸à¸—à¸°à¹€à¸¥à¸„à¸¥à¸±à¹ˆà¸‡"} }
};
const FOLK_DB = [
    { lat: 13.75, lon: 100.50, th:{t:"à¸¢à¸±à¸à¸©à¹Œà¸§à¸±à¸”à¹à¸ˆà¹‰à¸‡", b:"à¸¢à¸±à¸à¸©à¹Œà¸•à¸µà¸à¸±à¸™à¸ˆà¸™à¸—à¹ˆà¸²à¹€à¸•à¸µà¸¢à¸™"}, en:{t:"Giants Battle", b:"Giants fought here until land flattened."} },
    { lat: 18.79, lon: 98.98, th:{t:"à¸›à¸¹à¹ˆà¹à¸ªà¸°à¸¢à¹ˆà¸²à¹à¸ªà¸°", b:"à¸¢à¸±à¸à¸©à¹Œà¸žà¸´à¸—à¸±à¸à¸©à¹Œà¸”à¸­à¸¢à¸ªà¸¸à¹€à¸—à¸ž"}, en:{t:"Mountain Guardians", b:"Giants guarding Doi Suthep."} },
    { lat: 14.35, lon: 100.57, th:{t:"à¸„à¸³à¸ªà¸²à¸›à¸à¸£à¸¸à¸‡à¹€à¸à¹ˆà¸²", b:"à¸ªà¸¡à¸šà¸±à¸•à¸´à¸¡à¸µà¸›à¸¹à¹ˆà¹‚à¸ªà¸¡à¹€à¸à¹‰à¸²"}, en:{t:"Ayutthaya Curse", b:"Spirits guard buried treasure."} }
];
const WONDERS = Object.keys(LORE_DB).map(k => {
    // Mock coords for demo
    const c = { "Great Pyramid of Giza": [29.9792,31.1342], "Stonehenge": [51.1789,-1.8262], "Petra": [30.3285,35.4444], "Great Wall of China": [40.4319,116.5704], "Colosseum": [41.8902,12.4922], "Taj Mahal": [27.1751,78.0421], "Christ the Redeemer": [-22.9519,-43.2105] }[k];
    return { name: k, lat: c[0], lon: c[1] };
});

// --- 3. MATH UTILS ---
const MathU = {
    rad: d => d * Math.PI / 180,
    deg: r => r * 180 / Math.PI,
    dist: (lat1,l1,lat2,l2) => {
        const R=6371, dLa=MathU.rad(lat2-lat1), dLo=MathU.rad(l2-l1);
        const a=Math.sin(dLa/2)**2+Math.cos(MathU.rad(lat1))*Math.cos(MathU.rad(lat2))*Math.sin(dLo/2)**2;
        return R*2*Math.atan2(Math.sqrt(a),Math.sqrt(1-a));
    },
    bearing: (lat1,l1,lat2,l2) => {
        const y=Math.sin(MathU.rad(l2-l1))*Math.cos(MathU.rad(lat2));
        const x=Math.cos(MathU.rad(lat1))*Math.sin(MathU.rad(lat2))-Math.sin(MathU.rad(lat1))*Math.cos(MathU.rad(lat2))*Math.cos(MathU.rad(l2-l1));
        return (MathU.deg(Math.atan2(y,x))+360)%360;
    },
    lerp: (c,t,f) => { let d=t-c; if(d>180)d-=360; if(d<-180)d+=360; return c+d*f; }
};

// --- 4. SENSOR ENGINE ---
class Sensor {
    constructor() {
        this.head = 0; this.raw = 0; this.gps = {}; this.mag = {val:0,on:false}; this.win = []; this.tiltBad = false; this.calib = false; this.cbs = {};
    }
    init() {
        return new Promise(async (res, rej) => {
            if(navigator.geolocation) navigator.geolocation.watchPosition(p=>{this.gps={lat:p.coords.latitude,lon:p.coords.longitude};this.emit('gps');},e=>{},{enableHighAccuracy:true});
            
            // UI Update Helpers
            const setStatus = (id, val, col) => {
                const el = document.getElementById(id);
                if(el) { 
                    el.innerText = val; 
                    el.style.color = col ? `var(--${col})` : '';
                    if(col === 'neon-g') el.classList.add('ok');
                }
            };

            // Compass
            if(window.DeviceOrientationEvent?.requestPermission) {
                try {
                    const r = await DeviceOrientationEvent.requestPermission();
                    if(r==='granted') {
                        window.addEventListener('deviceorientation', e=>this.iOS(e));
                        setStatus('chk-gyro', 'ACTIVE', 'neon-g');
                        res();
                    } else rej();
                } catch { rej(); }
            } else {
                const h = e => this.droid(e, e.absolute);
                if('ondeviceorientationabsolute' in window) window.addEventListener('deviceorientationabsolute', e=>h(e,true));
                else window.addEventListener('deviceorientation', e=>h(e,false));
                setStatus('chk-gyro', 'ACTIVE', 'neon-g');

                if('Magnetometer' in window) {
                    try {
                        // @ts-ignore
                        const m = new Magnetometer({frequency:30});
                        m.addEventListener('reading', ()=>{
                            const v = Math.sqrt(m.x**2+m.y**2+m.z**2);
                            this.mag={val:v,on:true}; this.win.push(v); if(this.win.length>120)this.win.shift();
                            setStatus('chk-mag', 'ACTIVE', 'neon-g');
                        });
                        m.start();
                    } catch { setStatus('chk-mag', 'UNAVAILABLE', 'neon-r'); }
                } else {
                    setStatus('chk-mag', 'NO SENSOR', 'text-3');
                }
                res();
            }
        });
    }
    iOS(e) { if(e.webkitCompassHeading) { this.raw = (e.webkitCompassHeading + (window.screen.orientation?.angle||0))%360; this.tiltBad=(Math.abs(e.beta)>45); } }
    droid(e, abs) {
        if(abs&&e.alpha!=null) { this.raw=(360-e.alpha-(window.screen.orientation?.angle||0)+360)%360; this.tiltBad=(Math.abs(e.beta)>45); }
        else if(e.alpha!=null) { this.raw=360-e.alpha; this.calib=true; }
    }
    update() { this.head = MathU.lerp(this.head, this.raw, 0.15); return this.head; }
    emit(e){if(this.cbs[e])this.cbs[e]();} on(e,f){this.cbs[e]=f;}
}

// --- 5. APP CONTROLLER ---
class App {
    constructor() {
        this.i18n = new I18n(); this.sensor = new Sensor();
        this.state = { idx:0, auto:true, decl:0, mode:'wonder' };
        this.ui = { ring:document.getElementById('orb-ring'), val:document.getElementById('val-head'), warn:document.getElementById('warn-pill') };
        this.ctx = document.getElementById('scope-cvs').getContext('2d');
        document.getElementById('scope-cvs').width=80; document.getElementById('scope-cvs').height=40;
    }
    async start() {
        try {
            await this.sensor.init();
            // GPS Check visual update happens in sensor callbacks, but we can fake "OK" for GPS here if needed, 
            // but real GPS takes time. Let's start the sequence.
            document.getElementById('chk-gps').innerText = "SEARCHING...";
            document.getElementById('chk-gps').style.color = "var(--neon-b)";

            // Handle Overlay Transition
            const btn = document.getElementById('btn-init');
            btn.addEventListener('click', () => {
                const ov = document.getElementById('overlay');
                ov.classList.add('fade-out');
                setTimeout(() => {
                    ov.style.display = 'none';
                    document.getElementById('app').classList.add('visible');
                }, 800);
            });
            
            this.sensor.on('gps', () => {
                document.getElementById('chk-gps').innerText = "LOCKED";
                document.getElementById('chk-gps').style.color = "var(--neon-g)";
                document.getElementById('gps-stat').innerText = this.i18n.t('gps_lock');
                document.getElementById('gps-stat').classList.add('active');
                if(this.state.auto) this.findNearest(); else this.updDist();
            });
            this.updLore(); this.loop();
        } catch(e) { alert("Sensors blocked."); }
    }
    
    // Logic
    findNearest() {
        if(!this.sensor.gps.lat) return;
        let m=Infinity, idx=0;
        WONDERS.forEach((w,i)=>{ const d=MathU.dist(this.sensor.gps.lat,this.sensor.gps.lon,w.lat,w.lon); if(d<m){m=d;idx=i;} });
        if(this.state.idx!=idx) { this.state.idx=idx; this.updLore(); }
    }
    nextTarget() { this.state.auto=false; this.updAuto(); this.state.idx=(this.state.idx+1)%WONDERS.length; this.updLore(); }
    toggleAuto() { this.state.auto=!this.state.auto; this.updAuto(); if(this.state.auto)this.findNearest(); }
    updAuto() {
        const b = document.getElementById('btn-auto');
        b.querySelector('span:last-child').innerText = this.i18n.t(this.state.auto?'btn_auto':'btn_manual');
        if(this.state.auto) b.classList.add('active'); else b.classList.remove('active');
    }
    updLore() {
        const w = WONDERS[this.state.idx];
        const i = LORE_DB[w.name] ? LORE_DB[w.name][this.i18n.lang] : null;
        document.getElementById('lore-title').innerText = w.name;
        document.getElementById('lore-short').innerText = i ? i.short : this.i18n.t('lore_load');
        document.getElementById('lore-facts').innerHTML = i ? i.facts.map(f=>`<li>${f}</li>`).join('') : '';
        document.getElementById('lore-myth').innerText = i ? `"${i.myth}"` : '';
        this.updDist();
    }
    updDist() {
        if(!this.sensor.gps.lat) return;
        const d = MathU.dist(this.sensor.gps.lat,this.sensor.gps.lon,WONDERS[this.state.idx].lat,WONDERS[this.state.idx].lon);
        document.getElementById('lore-dist').innerText = d<1?(d*1000).toFixed(0)+" m":d.toFixed(1)+" km";
    }
    
    // Loop
    loop() {
        requestAnimationFrame(()=>this.loop());
        const h = this.sensor.update();
        this.ui.ring.style.transform = `rotate(${-h}deg)`;
        this.ui.val.innerText = Math.round(h).toString().padStart(3,'0')+"Â°";
        
        // Warnings
        if(this.sensor.tiltBad) { this.ui.warn.innerText=this.i18n.t('warn_tilt'); this.ui.warn.classList.add('show'); }
        else if(this.sensor.calib) { this.ui.warn.innerText=this.i18n.t('warn_calib'); this.ui.warn.classList.add('show'); }
        else this.ui.warn.classList.remove('show');
        
        // Needles
        if(this.state.mode==='wonder' && this.sensor.gps.lat) {
            const b = MathU.bearing(this.sensor.gps.lat,this.sensor.gps.lon,WONDERS[this.state.idx].lat,WONDERS[this.state.idx].lon);
            document.getElementById('n-target').style.transform = `translateX(-50%) rotate(${b}deg)`;
        } else if (this.state.mode==='earth') {
            document.getElementById('n-true').style.transform = `translateX(-50%) rotate(${-this.state.decl}deg)`;
            document.getElementById('n-mag').style.transform = `translateX(-50%) rotate(0deg)`;
        } else if (this.state.mode==='myth') {
            // Omen
            const seed = (this.sensor.gps.lat||0)+(this.sensor.gps.lon||0)+Math.floor(Date.now()/5000);
            let lvl=0;
            if(this.sensor.mag.on && this.sensor.mag.val) {
                // Real mag variance logic
                // Simplified for brevity
                lvl = (this.sensor.mag.val % 10 > 7) ? 2 : 1; 
            } else {
                const n = Math.abs(Math.sin(seed));
                if(n>0.85) lvl=2; else if(n>0.6) lvl=1;
            }
            
            const codes=['q','r','d','p'];
            const t = document.getElementById('omen-title');
            t.innerText = this.i18n.t('omen_'+codes[lvl]);
            t.style.color = lvl>1?'var(--neon-r)':(lvl>0?'var(--neon-b)':'var(--neon-g)');
            document.getElementById('omen-text').innerText = this.i18n.t(lvl>0?'flavor_a':'flavor_q');
            
            // Scope
            this.drawScope(this.sensor.win, lvl);
            if(Math.random()<(lvl*0.02)) this.addBlip();
            
            const w = Math.sin(Date.now()/500)*(lvl*15);
            document.getElementById('n-target').style.transform = `translateX(-50%) rotate(${w}deg)`;
        }
    }
    
    drawScope(d, l) {
        this.ctx.clearRect(0,0,80,40); this.ctx.strokeStyle=l>1?'#f43f5e':'#60a5fa'; this.ctx.lineWidth=1.5; this.ctx.beginPath();
        if(d.length){const mn=Math.min(...d),mx=Math.max(...d),r=mx-mn||1; d.forEach((v,i)=>{let x=(i/120)*80,y=40-((v-mn)/r)*40;if(i==0)this.ctx.moveTo(x,y);else this.ctx.lineTo(x,y);});}
        else{const t=Date.now()/200; for(let i=0;i<80;i+=5){let y=20+Math.sin(t+i*0.1)*(5+l*5);if(i==0)this.ctx.moveTo(i,y);else this.ctx.lineTo(i,y);}}
        this.ctx.stroke();
    }
    addBlip() {
        const e=document.createElement('div'); e.className='blip';
        const a=Math.random()*6.28, d=10+Math.random()*40;
        e.style.left=(50+Math.cos(a)*d)+'%'; e.style.top=(50+Math.sin(a)*d)+'%';
        document.querySelector('.radar-ring').appendChild(e); setTimeout(()=>e.remove(),2000);
    }
    
    // UI Helpers
    setMode(m) {
        this.state.mode=m; document.querySelectorAll('.dock-item').forEach(b=>b.classList.remove('active')); event.target.classList.add('active');
        const u={t:document.getElementById('n-target'), tr:document.getElementById('n-true'), mg:document.getElementById('n-mag'), l:document.getElementById('card-lore'), o:document.getElementById('card-omen'), r:document.getElementById('monitor-ui'), s:document.getElementById('scope-ui'), a:document.getElementById('row-actions')};
        u.t.style.opacity=m=='wonder'||m=='myth'?1:0; u.tr.style.opacity=m=='earth'?1:0; u.mg.style.opacity=m=='earth'?1:0;
        u.l.classList.toggle('hidden',m=='myth'); u.o.classList.toggle('hidden',m!='myth');
        u.r.style.display=m=='myth'?'block':'none'; u.s.style.display=m=='myth'?'block':'none'; u.a.style.display=m=='wonder'?'grid':'none';
        if(m=='earth') {
            document.getElementById('lore-title').innerText=this.i18n.t('mode_earth');
            document.getElementById('lore-short').innerText=this.sensor.mag.on?`${this.sensor.mag.val.toFixed(1)} ÂµT`:this.i18n.t('err_mag');
            document.getElementById('lore-facts').innerHTML=''; document.getElementById('lore-myth').innerText='';
        } else if(m=='wonder') this.updLore();
    }
    toggleLang() { this.i18n.toggle(); this.updLore(); this.updAuto(); }
    toggleSettings() { document.getElementById('modal-set').classList.toggle('show'); document.getElementById('modal-set').style.pointerEvents='auto'; }
    fetchDecl() { 
        if(!this.sensor.gps.lat)return alert("Wait GPS"); 
        fetch(`https://www.ngdc.noaa.gov/geomag-web/calculators/calculateDeclination?lat1=${this.sensor.gps.lat}&lon1=${this.sensor.gps.lon}&resultFormat=json`)
        .then(r=>r.json()).then(d=>{this.state.decl=d.result[0].declination;document.getElementById('inp-decl').value=this.state.decl.toFixed(2);alert("OK");})
        .catch(()=>alert(this.i18n.t('err_cors')));
    }
    showLocalLegend() {
        if(!this.sensor.gps.lat)return alert("Wait GPS");
        let m=Infinity, s=FOLK_DB[0];
        FOLK_DB.forEach(f=>{const d=MathU.dist(this.sensor.gps.lat,this.sensor.gps.lon,f.lat,f.lon);if(d<m){m=d;s=f;}});
        const c=s[this.i18n.lang];
        document.getElementById('folk-title').innerText=c.t; document.getElementById('folk-body').innerText=c.b;
        document.getElementById('modal-folk').classList.add('show'); document.getElementById('modal-folk').style.pointerEvents='auto';
    }
    closeLegend() { document.getElementById('modal-folk').classList.remove('show'); document.getElementById('modal-folk').style.pointerEvents='none'; }
    openMap() { window.open(`https://maps.google.com/?q=${WONDERS[this.state.idx].lat},${WONDERS[this.state.idx].lon}`); }
}

const app = new App();
app.start(); // Will wait for init button
document.getElementById('btn-lang').addEventListener('click', ()=>app.toggleLang());

</script>
</body>
</html>
