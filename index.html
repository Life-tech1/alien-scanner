<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>OMEGA: IDENTITY TRACKER</title>
    
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@3.11.0"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/coco-ssd@2.2.2"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>

    <style>
        :root {
            --p: #00ff9d; --s: #008f7a; --a: #ff2a6d; --w: #ffae00;
            --bg: #000; --glass: rgba(0, 20, 10, 0.9);
            --font: 'Segoe UI', monospace;
        }
        body { margin: 0; overflow: hidden; background: var(--bg); color: var(--p); font-family: var(--font); user-select: none; }
        
        #viewport { position: relative; width: 100vw; height: 100vh; }
        #camera-feed { position: absolute; inset: 0; width: 100%; height: 100%; object-fit: cover; z-index: 0; opacity: 0.9; filter: contrast(1.1) brightness(0.9); }
        #layer-3d, #hud-canvas { position: absolute; inset: 0; z-index: 10; }
        #hud-canvas { cursor: crosshair; } /* Cursor เปลี่ยนเป็นเป้าเล็ง */

        /* UI Overlay */
        #ui-layer { position: absolute; inset: 0; z-index: 20; padding: 20px; pointer-events: none; display: flex; flex-direction: column; justify-content: space-between; }
        
        .panel {
            background: var(--glass); border-left: 4px solid var(--p); padding: 10px 15px;
            margin-bottom: 5px; backdrop-filter: blur(10px); pointer-events: auto;
            width: fit-content; border-radius: 4px; box-shadow: 0 5px 15px rgba(0,0,0,0.5);
        }
        .label { font-size: 9px; color: #00a8ff; font-weight: 900; letter-spacing: 2px; }
        .val { font-size: 14px; color: #fff; font-weight: bold; font-family: monospace; }

        /* Input Prompt (Custom Style) */
        #tag-input {
            display: none; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            background: rgba(0,0,0,0.9); border: 2px solid var(--p); padding: 20px; z-index: 100;
            text-align: center; border-radius: 10px; box-shadow: 0 0 30px var(--p);
        }
        #tag-input input { background: #222; border: 1px solid #555; color: white; padding: 10px; font-size: 16px; width: 200px; text-align: center; }
        #tag-input button { margin-top: 10px; background: var(--p); border: none; padding: 8px 20px; font-weight: bold; cursor: pointer; }

        /* Boot Screen */
        #boot { position: fixed; inset: 0; background: #000; z-index: 9999; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        #loader { width: 60px; height: 60px; border: 4px solid #111; border-top: 4px solid var(--p); border-radius: 50%; animation: spin 0.8s infinite; margin: 30px; }
        @keyframes spin { to { transform: rotate(360deg); } }
        button.start-btn { background: var(--p); border: none; padding: 15px 40px; font-weight: 900; cursor: pointer; letter-spacing: 2px; clip-path: polygon(10% 0, 100% 0, 100% 70%, 90% 100%, 0 100%, 0 30%); }
    </style>
</head>
<body>

    <div id="viewport">
        <video id="camera-feed" autoplay playsinline muted></video>
        <canvas id="layer-3d"></canvas>
        <canvas id="hud-canvas"></canvas>

        <!-- Custom Tag Input Modal -->
        <div id="tag-input">
            <div style="color:var(--p); margin-bottom:10px; font-weight:bold;">IDENTIFY TARGET</div>
            <input type="text" id="target-name" placeholder="Enter Name (e.g. Boss)">
            <br>
            <button onclick="OMEGA.confirmTag()">CONFIRM</button>
            <button onclick="OMEGA.cancelTag()" style="background:#333; color:#fff;">CANCEL</button>
        </div>

        <div id="ui-layer">
            <div style="display:flex; justify-content:space-between;">
                <div class="panel">
                    <div class="label">IDENTITY SYSTEM</div>
                    <div>STATUS: <span class="val" style="color:var(--p)">ACTIVE</span></div>
                    <div style="font-size:10px; color:#aaa;">CLICK BOX TO TAG NAME</div>
                </div>
                <div class="panel">
                    <div class="label">TARGETS</div>
                    <div>COUNT: <span id="count" class="val">0</span></div>
                </div>
            </div>
        </div>
    </div>

    <div id="boot">
        <h1 style="color:var(--p); letter-spacing: 8px; font-size: 32px;">OMEGA</h1>
        <div style="color:#666;">IDENTITY TRACKING MODULE</div>
        <div id="loader"></div>
        <button id="btn-start" class="start-btn" onclick="OMEGA.start()" style="display:none;">INITIALIZE</button>
    </div>

<script>
/**
 * OMEGA: IDENTITY EDITION
 * Features: Sticky Tracking + Manual Tagging System
 */

const CONFIG = {
    AI_CONF: 0.5,
    TRACK: { SMOOTH: 0.15, MAX_LOST: 30, MATCH_DIST: 150 } // หนึบมาก
};

const Vector = {
    dist: (a, b) => Math.hypot(a.x - b.x, a.y - b.y),
    lerp: (a, b, t) => a + (b - a) * t,
    getCenter: (box) => ({ x: box[0] + box[2]/2, y: box[1] + box[3]/2 })
};

// --- IDENTITY MANAGER (สมองจำชื่อ) ---
class IdentityManager {
    constructor() {
        this.identities = new Map(); // เก็บ ID -> Name
    }
    setName(trackId, name) {
        this.identities.set(trackId, name);
    }
    getName(trackId) {
        return this.identities.get(trackId) || null;
    }
}

// --- PREDICTIVE TRACKER (ตัวเดิมที่หนึบๆ) ---
class Tracker {
    constructor() {
        this.tracks = [];
        this.nextId = 1;
    }

    update(detections) {
        // 1. Predict
        this.tracks.forEach(t => {
            t.x += t.vx; t.y += t.vy; t.lost++;
        });

        // 2. Match
        detections.forEach(det => {
            const center = Vector.getCenter(det.bbox);
            let bestDist = CONFIG.TRACK.MATCH_DIST;
            let bestTrack = null;

            this.tracks.forEach(t => {
                const d = Vector.dist({x: t.x, y: t.y}, center);
                if (d < bestDist) { bestDist = d; bestTrack = t; }
            });

            if (bestTrack) {
                // Update Existing
                const newVx = center.x - bestTrack.x;
                const newVy = center.y - bestTrack.y;
                bestTrack.vx = Vector.lerp(bestTrack.vx, newVx, 0.4);
                bestTrack.vy = Vector.lerp(bestTrack.vy, newVy, 0.4);
                bestTrack.x = Vector.lerp(bestTrack.x, center.x, CONFIG.TRACK.SMOOTH);
                bestTrack.y = Vector.lerp(bestTrack.y, center.y, CONFIG.TRACK.SMOOTH);
                bestTrack.w = Vector.lerp(bestTrack.w, det.bbox[2], CONFIG.TRACK.SMOOTH);
                bestTrack.h = Vector.lerp(bestTrack.h, det.bbox[3], CONFIG.TRACK.SMOOTH);
                bestTrack.lost = 0;
                // Keep Identity if exists
            } else {
                // Create New
                this.tracks.push({
                    id: this.nextId++,
                    x: center.x, y: center.y,
                    w: det.bbox[2], h: det.bbox[3],
                    vx: 0, vy: 0,
                    class: det.class,
                    lost: 0
                });
            }
        });

        // 3. Prune
        this.tracks = this.tracks.filter(t => t.lost < CONFIG.TRACK.MAX_LOST);
        return this.tracks;
    }
}

// --- RENDERER ---
class HUD {
    constructor(sys) {
        this.sys = sys;
        this.canvas = document.getElementById('hud-canvas');
        this.ctx = this.canvas.getContext('2d');
        this.resize();
        
        // Event Listener for Tagging
        this.canvas.addEventListener('click', (e) => this.handleClick(e));
    }

    resize() {
        this.canvas.width = window.innerWidth;
        this.canvas.height = window.innerHeight;
    }

    handleClick(e) {
        const rect = this.canvas.getBoundingClientRect();
        const mx = e.clientX - rect.left;
        const my = e.clientY - rect.top;

        // Find clicked track
        // ต้องแปลงพิกัดเมาส์กลับไปหาพิกัดวิดีโอ
        const sx = this.canvas.width / this.sys.video.videoWidth;
        const sy = this.canvas.height / this.sys.video.videoHeight;

        let clickedTrack = null;
        this.sys.tracker.tracks.forEach(t => {
            const tx = (t.x - t.w/2) * sx;
            const ty = (t.y - t.h/2) * sy;
            const tw = t.w * sx;
            const th = t.h * sy;

            if(mx >= tx && mx <= tx+tw && my >= ty && my <= ty+th) {
                clickedTrack = t;
            }
        });

        if(clickedTrack) {
            this.sys.openTagModal(clickedTrack.id);
        }
    }

    render(video, tracks, identities) {
        this.ctx.clearRect(0, 0, this.canvas.width, this.canvas.height);
        
        const sx = this.canvas.width / video.videoWidth;
        const sy = this.canvas.height / video.videoHeight;

        tracks.forEach(t => {
            const x = (t.x - t.w/2) * sx;
            const y = (t.y - t.h/2) * sy;
            const w = t.w * sx;
            const h = t.h * sy;

            // Check for custom name
            const customName = identities.getName(t.id);
            const displayName = customName ? customName.toUpperCase() : t.class.toUpperCase();
            const isTagged = !!customName;

            // Style
            const color = isTagged ? '#00ff9d' : (t.class === 'person' ? '#ffae00' : '#00a8ff');
            this.ctx.strokeStyle = color;
            this.ctx.lineWidth = isTagged ? 3 : 2;
            this.ctx.shadowBlur = isTagged ? 10 : 0;
            this.ctx.shadowColor = color;

            // Draw Tech Corners
            this.ctx.beginPath();
            const L = w * 0.2;
            this.ctx.moveTo(x, y+L); this.ctx.lineTo(x, y); this.ctx.lineTo(x+L, y);
            this.ctx.moveTo(x+w-L, y); this.ctx.lineTo(x+w, y); this.ctx.lineTo(x+w, y+L);
            this.ctx.moveTo(x+w, y+h-L); this.ctx.lineTo(x+w, y+h); this.ctx.lineTo(x+w-L, y+h);
            this.ctx.moveTo(x+L, y+h); this.ctx.lineTo(x, y+h); this.ctx.lineTo(x, y+h-L);
            this.ctx.stroke();
            this.ctx.shadowBlur = 0;

            // Label Box
            this.ctx.fillStyle = color;
            this.ctx.fillRect(x, y-20, isTagged ? w : Math.min(w, 100), 20);
            
            // Text
            this.ctx.fillStyle = '#000';
            this.ctx.font = "bold 12px monospace";
            const label = isTagged ? `★ ${displayName}` : `ID_${t.id} ${displayName}`;
            this.ctx.fillText(label, x+5, y-6);

            // Tag Hint (ถ้ายังไม่ได้ Tag)
            if(!isTagged) {
                this.ctx.fillStyle = 'rgba(255,255,255,0.5)';
                this.ctx.fillText("[TAP TO TAG]", x, y+h+15);
            }
        });
    }
}

// --- MAIN SYSTEM ---
class System {
    constructor() {
        this.video = document.getElementById('camera-feed');
        this.tracker = new Tracker();
        this.identities = new IdentityManager();
        this.hud = new HUD(this);
        this.model = null;
        this.isRunning = false;
        this.pendingTagId = null;
        
        window.onresize = () => this.hud.resize();
    }

    async start() {
        document.getElementById('btn-start').innerText = "LOADING AI...";
        try {
            const stream = await navigator.mediaDevices.getUserMedia({
                video: { facingMode: 'environment', width: {ideal: 1280}, height: {ideal: 720} },
                audio: false
            });
            this.video.srcObject = stream;
            await new Promise(r => this.video.onloadedmetadata = () => { this.video.play(); r(); });

            this.model = await cocoSsd.load({base: 'lite_mobilenet_v2'});
            
            document.getElementById('boot').style.display = 'none';
            this.isRunning = true;
            this.loop();
        } catch(e) { alert("Error: " + e.message); }
    }

    async loop() {
        if(!this.isRunning) return;
        const detections = await this.model.detect(this.video, 20, CONFIG.AI_CONF);
        const tracks = this.tracker.update(detections);
        
        this.hud.render(this.video, tracks, this.identities);
        document.getElementById('count').innerText = tracks.length;
        
        requestAnimationFrame(() => this.loop());
    }

    // Tagging Logic
    openTagModal(trackId) {
        this.pendingTagId = trackId;
        const modal = document.getElementById('tag-input');
        const input = document.getElementById('target-name');
        
        // Check current name
        const currentName = this.identities.getName(trackId);
        input.value = currentName || '';
        
        modal.style.display = 'block';
        input.focus();
    }

    confirmTag() {
        const name = document.getElementById('target-name').value;
        if(this.pendingTagId && name) {
            this.identities.setName(this.pendingTagId, name);
        }
        this.cancelTag();
    }

    cancelTag() {
        document.getElementById('tag-input').style.display = 'none';
        this.pendingTagId = null;
    }
}

const OMEGA = new System();
document.getElementById('btn-start').style.display = 'block';

</script>
</body>
</html>
