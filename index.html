<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>RABROY ‚Äì Random Behavior Analyzer</title>
    <meta name="description" content="‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏û‡∏§‡∏ï‡∏¥‡∏Å‡∏£‡∏£‡∏°‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç‡∏î‡πâ‡∏ß‡∏¢‡∏´‡∏•‡∏±‡∏Å‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏™‡∏π‡∏á Chi-square, Runs Test ‡πÅ‡∏•‡∏∞ Autocorrelation">
    
    <style>
        /* --- 1. DESIGN TOKENS --- */
        :root {
            /* Palette: Apple/Scientific Pro */
            --bg-body: #F5F5F7;
            --bg-card: #FFFFFF;
            --bg-glass: rgba(255, 255, 255, 0.8);
            
            --text-primary: #1D1D1F;
            --text-secondary: #86868B;
            --text-tertiary: #C7C7CC;
            
            --accent: #0071E3;
            --accent-gradient: linear-gradient(135deg, #0077ED, #0071E3);
            --accent-glow: rgba(0, 113, 227, 0.3);
            
            --success-bg: #E4F9E8; --success-text: #178236;
            --warning-bg: #FFF4E5; --warning-text: #B45309;
            --danger-bg: #FEECEC; --danger-text: #CB2A2A;
            --neutral-bg: #F2F2F7; --neutral-text: #636366;

            --shadow-sm: 0 1px 3px rgba(0,0,0,0.05);
            --shadow-card: 0 4px 24px rgba(0,0,0,0.04), 0 1px 4px rgba(0,0,0,0.02);
            --shadow-float: 0 20px 40px rgba(0,0,0,0.08);

            --radius-l: 24px;
            --radius-m: 16px;
            --radius-s: 12px;
            --radius-pill: 999px;

            --font-stack: -apple-system, BlinkMacSystemFont, "SF Pro Text", "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            --font-mono: "SF Mono", "Menlo", "Monaco", "Courier New", monospace;
            --anim-smooth: cubic-bezier(0.25, 1, 0.5, 1);
        }

        * { box-sizing: border-box; margin: 0; padding: 0; -webkit-font-smoothing: antialiased; }

        body {
            font-family: var(--font-stack);
            background-color: var(--bg-body);
            color: var(--text-primary);
            line-height: 1.5;
            padding-bottom: 40px;
        }

        /* --- 2. LAYOUT & UTILS --- */
        .container {
            max-width: 960px;
            margin: 0 auto;
            padding: 40px 20px;
            opacity: 0;
            animation: fadeInPage 0.8s var(--anim-smooth) 0.5s forwards;
        }
        @keyframes fadeInPage { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        header { text-align: center; margin-bottom: 32px; }
        .badge-research {
            display: inline-flex; align-items: center; gap: 6px;
            background: #EAF2FF; color: var(--accent);
            font-size: 0.7rem; font-weight: 700;
            padding: 6px 12px; border-radius: var(--radius-pill);
            text-transform: uppercase; letter-spacing: 0.05em; margin-bottom: 12px;
        }
        h1 { font-size: 2.5rem; font-weight: 800; letter-spacing: -0.03em; margin-bottom: 8px; color: var(--text-primary); }
        .subtitle { font-size: 1.05rem; color: var(--text-secondary); max-width: 500px; margin: 0 auto; line-height: 1.6; }

        .grid-main {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 24px;
            margin-bottom: 24px;
        }
        .grid-full { grid-column: span 2; }
        
        @media (max-width: 768px) {
            .grid-main { grid-template-columns: 1fr; }
            .grid-full { grid-column: span 1; }
            h1 { font-size: 2rem; }
        }

        .card {
            background: var(--bg-card);
            border-radius: var(--radius-l);
            box-shadow: var(--shadow-card);
            border: 1px solid rgba(0,0,0,0.04);
            padding: 24px;
            position: relative;
            overflow: hidden;
            transition: transform 0.3s var(--anim-smooth), box-shadow 0.3s var(--anim-smooth);
        }

        /* --- 3. COMPONENT: VISUALIZER (NEW) --- */
        .visualizer-container {
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            height: 100%; min-height: 320px;
        }
        
        .dial-wrapper {
            position: relative;
            width: 200px; height: 200px;
            margin-bottom: 24px;
        }
        
        /* Rings */
        .ring-bg {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            border-radius: 50%; border: 8px solid var(--neutral-bg);
        }
        .ring-needle {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            border-radius: 50%;
            transition: transform 0.8s cubic-bezier(0.1, 1.2, 0.3, 1); /* Elastic ease */
        }
        .ring-needle::after {
            content: ''; position: absolute; top: 10px; left: 50%;
            width: 8px; height: 8px; background: var(--accent);
            border-radius: 50%; transform: translateX(-50%);
            box-shadow: 0 0 10px var(--accent);
        }
        
        /* Big Number */
        .viz-number {
            position: absolute; top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            font-size: 4.5rem; font-weight: 700;
            color: var(--text-primary);
            font-variant-numeric: tabular-nums;
            letter-spacing: -2px;
            line-height: 1;
        }
        .viz-label {
            position: absolute; top: 70%; left: 50%;
            transform: translateX(-50%);
            font-size: 0.75rem; font-weight: 600;
            color: var(--text-tertiary); text-transform: uppercase; letter-spacing: 1px;
            margin-top: 10px;
        }

        /* Mini History Tape */
        .mini-history {
            display: flex; gap: 8px; justify-content: center;
            margin-top: 16px; min-height: 24px;
            overflow: hidden;
        }
        .hist-dot {
            font-family: var(--font-mono); font-size: 0.8rem;
            color: var(--text-secondary); opacity: 0.5;
            transition: opacity 0.3s;
        }
        .hist-dot:first-child { opacity: 1; font-weight: 700; color: var(--text-primary); }

        /* Draw Button */
        .btn-draw {
            background: var(--bg-body); color: var(--text-primary);
            border: 1px solid rgba(0,0,0,0.05);
            padding: 12px 24px; border-radius: var(--radius-pill);
            font-weight: 600; font-size: 0.95rem; cursor: pointer;
            transition: all 0.2s; display: flex; align-items: center; gap: 8px;
            box-shadow: var(--shadow-sm);
        }
        .btn-draw:hover { transform: translateY(-1px); box-shadow: 0 4px 12px rgba(0,0,0,0.08); background: #fff; }
        .btn-draw:active { transform: translateY(0); }
        .btn-draw:disabled { opacity: 0.6; cursor: not-allowed; }

        /* --- 4. COMPONENT: SUMMARY & CONTROLS --- */
        .stat-grid {
            display: grid; grid-template-columns: 1fr 1fr; gap: 16px;
            margin-bottom: 24px;
        }
        .stat-box {
            background: var(--bg-body); padding: 16px; border-radius: var(--radius-m);
            text-align: center;
        }
        .stat-val { font-size: 1.5rem; font-weight: 700; color: var(--text-primary); margin-bottom: 4px; font-variant-numeric: tabular-nums; }
        .stat-lbl { font-size: 0.8rem; color: var(--text-secondary); text-transform: uppercase; }

        .control-panel { display: flex; flex-direction: column; gap: 12px; }
        .btn-primary {
            background: var(--accent-gradient); color: white;
            border: none; padding: 14px; border-radius: var(--radius-m);
            font-weight: 600; cursor: pointer;
            box-shadow: 0 4px 12px rgba(0, 113, 227, 0.3);
            transition: all 0.2s; position: relative; overflow: hidden;
        }
        .btn-primary:hover { box-shadow: 0 6px 16px rgba(0, 113, 227, 0.4); transform: scale(1.01); }
        .btn-primary:active { transform: scale(0.99); }
        .btn-primary:disabled { background: var(--text-tertiary); box-shadow: none; cursor: not-allowed; }

        .btn-secondary {
            background: white; color: var(--text-primary);
            border: 1px solid rgba(0,0,0,0.1); padding: 14px; border-radius: var(--radius-m);
            font-weight: 600; cursor: pointer; transition: all 0.2s;
        }
        .btn-secondary:hover { background: #F9F9F9; border-color: rgba(0,0,0,0.2); }

        /* Loading Spinner inside Button */
        .spinner {
            width: 16px; height: 16px; border: 2px solid rgba(255,255,255,0.3);
            border-top-color: #fff; border-radius: 50%;
            display: inline-block; animation: spin 0.8s linear infinite; margin-right: 8px; vertical-align: middle;
        }
        @keyframes spin { to { transform: rotate(360deg); } }

        /* --- 5. COMPONENT: ANALYSIS TABS --- */
        .tabs-container { margin-top: 8px; }
        .tabs-header {
            display: flex; background: var(--neutral-bg); padding: 4px;
            border-radius: var(--radius-m); margin-bottom: 24px;
        }
        .tab-btn {
            flex: 1; background: transparent; border: none; padding: 10px;
            border-radius: var(--radius-s); font-size: 0.9rem; font-weight: 600;
            color: var(--text-secondary); cursor: pointer; transition: all 0.2s;
        }
        .tab-btn.active { background: #fff; color: var(--text-primary); box-shadow: var(--shadow-sm); }

        .tab-panel { display: none; animation: slideUp 0.3s ease; }
        .tab-panel.active { display: block; }
        @keyframes slideUp { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* Stats Rows with Chips */
        .res-row {
            display: flex; justify-content: space-between; align-items: center;
            padding: 14px 0; border-bottom: 1px solid var(--neutral-bg);
        }
        .chip {
            font-size: 0.75rem; font-weight: 700; padding: 4px 10px;
            border-radius: 6px; text-transform: uppercase;
        }
        .chip.green { background: var(--success-bg); color: var(--success-text); }
        .chip.red { background: var(--danger-bg); color: var(--danger-text); }
        .chip.gray { background: var(--neutral-bg); color: var(--neutral-text); }
        
        .bar-container {
            display: flex; align-items: center; gap: 12px; margin-top: 8px;
        }
        .bar-bg { flex: 1; height: 6px; background: var(--neutral-bg); border-radius: 3px; overflow: hidden; }
        .bar-fill { height: 100%; background: var(--accent); border-radius: 3px; }

        /* --- 6. SPLASH SCREEN --- */
        #splash {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #fff; z-index: 9999;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            transition: opacity 0.5s;
        }
        .loader-svg { width: 60px; height: 60px; animation: spin 1s linear infinite; }
        .loader-circle { fill: none; stroke: var(--accent); stroke-width: 6; stroke-dasharray: 100; stroke-dashoffset: 50; }

        /* Footer */
        .footer-note {
            text-align: center; margin-top: 40px; font-size: 0.8rem; color: var(--text-tertiary);
        }
        
    </style>
</head>
<body>

    <!-- Splash Screen -->
    <div id="splash">
        <svg class="loader-svg" viewBox="0 0 50 50">
            <circle class="loader-circle" cx="25" cy="25" r="20"></circle>
        </svg>
        <div style="margin-top: 16px; font-weight: 600; color: var(--text-secondary);">RABROY</div>
    </div>

    <div class="container">
        <!-- Header -->
        <header>
            <div class="badge-research">
                <span>üî¨</span> Research & Education Only
            </div>
            <h1>RABROY</h1>
            <div class="subtitle">Random Behavior Analyzer<br>‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏û‡∏§‡∏ï‡∏¥‡∏Å‡∏£‡∏£‡∏°‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç‡∏î‡πâ‡∏ß‡∏¢‡∏´‡∏•‡∏±‡∏Å‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥</div>
        </header>

        <!-- Main Grid -->
        <div class="grid-main">
            
            <!-- 1. Live Random Visualizer -->
            <div class="card visualizer-container">
                <div style="width:100%; display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
                    <span style="font-weight:700; font-size:0.9rem; color:var(--text-primary);">Live Visualizer</span>
                    <span style="font-size:1.2rem;">üé≤</span>
                </div>

                <div class="dial-wrapper">
                    <div class="ring-bg"></div>
                    <div class="ring-needle" id="viz-needle"></div>
                    <div class="viz-number" id="viz-number">--</div>
                    <div class="viz-label">Current Draw</div>
                </div>

                <button class="btn-draw" id="btn-draw-single">
                    <span>Draw 1 Sample</span>
                </button>

                <div class="mini-history" id="mini-history">
                    <!-- History Dots -->
                </div>
            </div>

            <!-- 2. Dataset Summary & Controls -->
            <div class="card">
                <div style="margin-bottom: 20px;">
                    <h3 style="font-size:1.1rem; font-weight:700;">Dataset Overview</h3>
                    <div style="font-size:0.8rem; color:var(--text-secondary);">
                        Source: <span id="source-badge">Waiting for input...</span>
                    </div>
                </div>

                <div class="stat-grid">
                    <div class="stat-box">
                        <div class="stat-val" id="stat-total">-</div>
                        <div class="stat-lbl">Total Samples</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-val" id="stat-mean">-</div>
                        <div class="stat-lbl">Mean Value</div>
                    </div>
                </div>

                <div class="control-panel">
                    <button class="btn-secondary" id="btn-load-hist">
                        üìÇ ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏£‡∏¥‡∏á (Historical)
                    </button>
                    <button class="btn-primary" id="btn-sim">
                        ‚ö° ‡∏à‡∏≥‡∏•‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏™‡∏∏‡πà‡∏° (Simulation)
                    </button>
                </div>
                
                <div id="sim-progress" style="display:none; margin-top:12px; font-size:0.8rem; color:var(--text-secondary); text-align:center;">
                    Generating samples... <span id="sim-count">0</span>/1000
                </div>
            </div>

            <!-- 3. Analysis Tabs (Full Width) -->
            <div class="card grid-full">
                <div class="tabs-header">
                    <button class="tab-btn active" data-tab="chi">Chi-Square</button>
                    <button class="tab-btn" data-tab="runs">Runs Test</button>
                    <button class="tab-btn" data-tab="autocorr">Autocorr</button>
                    <button class="tab-btn" data-tab="bayes">Bayesian</button>
                </div>

                <!-- Tab: Chi-Square -->
                <div id="tab-chi" class="tab-panel active">
                    <div class="res-row">
                        <span>Chi-Square Value</span>
                        <span style="font-weight:700;" id="chi-val">-</span>
                    </div>
                    <div class="res-row">
                        <span>P-Value (Uniformity)</span>
                        <div style="text-align:right;">
                            <span id="chi-p" style="margin-right:8px; font-weight:700;">-</span>
                            <span id="chi-chip" class="chip gray">N/A</span>
                        </div>
                    </div>
                    <p style="margin-top:16px; font-size:0.9rem; color:var(--text-secondary);">
                        *‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏Å‡∏≤‡∏£‡∏Å‡∏£‡∏∞‡∏à‡∏≤‡∏¢‡∏ï‡∏±‡∏ß‡∏Ç‡∏≠‡∏á‡πÄ‡∏•‡∏Ç 0-99 ‡∏™‡∏°‡πà‡∏≥‡πÄ‡∏™‡∏°‡∏≠‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà (p > 0.05 ‡∏Ñ‡∏∑‡∏≠‡∏¢‡∏≠‡∏°‡∏£‡∏±‡∏ö‡πÑ‡∏î‡πâ‡∏ß‡πà‡∏≤‡∏™‡∏∏‡πà‡∏°‡∏à‡∏£‡∏¥‡∏á)
                    </p>
                </div>

                <!-- Tab: Runs Test -->
                <div id="tab-runs" class="tab-panel">
                    <div class="res-row">
                        <span>Z-Score (Runs)</span>
                        <div style="text-align:right;">
                            <span id="runs-z" style="margin-right:8px; font-weight:700;">-</span>
                            <span id="runs-chip" class="chip gray">N/A</span>
                        </div>
                    </div>
                    <div class="res-row">
                        <span>Number of Runs</span>
                        <span style="font-weight:700;" id="runs-count">-</span>
                    </div>
                    <p style="margin-top:16px; font-size:0.9rem; color:var(--text-secondary);">
                        *‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡∏™‡∏•‡∏±‡∏ö‡πÄ‡∏•‡∏Ç‡∏™‡∏π‡∏á/‡∏ï‡πà‡∏≥ (|Z| < 1.96 ‡πÅ‡∏õ‡∏•‡∏ß‡πà‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ Pattern ‡∏Å‡∏≤‡∏£‡πÄ‡∏Å‡∏≤‡∏∞‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏ó‡∏µ‡πà‡∏ú‡∏¥‡∏î‡∏õ‡∏Å‡∏ï‡∏¥)
                    </p>
                </div>

                <!-- Tab: Autocorr -->
                <div id="tab-autocorr" class="tab-panel">
                    <div style="text-align:center; padding:24px 0;">
                        <div style="font-size:3rem; font-weight:700; color:var(--text-primary);" id="auto-r">-</div>
                        <div style="font-size:0.9rem; color:var(--text-secondary); text-transform:uppercase;">Correlation (r‚ÇÅ)</div>
                        <div id="auto-chip" class="chip gray" style="display:inline-block; margin-top:8px;">N/A</div>
                    </div>
                    <p style="text-align:center; font-size:0.9rem; color:var(--text-secondary);">
                        ‡∏Ñ‡πà‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏Å‡∏•‡πâ 0 = ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏±‡∏°‡∏û‡∏±‡∏ô‡∏ò‡πå‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á‡∏á‡∏ß‡∏î‡∏Å‡πà‡∏≠‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏•‡∏∞‡∏á‡∏ß‡∏î‡∏ñ‡∏±‡∏î‡πÑ‡∏õ
                    </p>
                </div>

                <!-- Tab: Bayesian -->
                <div id="tab-bayes" class="tab-panel">
                    <div id="bayes-container" style="display:flex; flex-direction:column; gap:12px;">
                        <div style="text-align:center; color:var(--text-secondary); padding:20px;">No data available</div>
                    </div>
                    <p style="margin-top:16px; font-size:0.8rem; color:var(--text-tertiary); text-align:right;">
                        *Posterior Probability based on Dirichlet Prior (Œ±=1)
                    </p>
                </div>
            </div>

            <!-- 4. Insight Assistant -->
            <div class="card grid-full" style="background:#F0F8FF; border:1px solid #D1E9FF;">
                <div style="display:flex; gap:12px; margin-bottom:12px;">
                    <div style="width:32px; height:32px; background:white; border-radius:50%; display:flex; align-items:center; justify-content:center;">üß†</div>
                    <h3 style="font-size:1rem; font-weight:700; color:#004085; line-height:32px;">Insight Assistant</h3>
                </div>
                <ul id="ai-insights" style="list-style:none; padding-left:4px; color:#003060; font-size:0.95rem; line-height:1.6;">
                    <li>‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• Historical ‡∏´‡∏£‡∏∑‡∏≠‡∏ó‡∏≥‡∏Å‡∏≤‡∏£ Simulation ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏Å‡∏≤‡∏£‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå</li>
                </ul>
                <div style="margin-top:16px; pt:12px; border-top:1px solid rgba(0,0,0,0.05); font-size:0.75rem; color:#6C8CAF;">
                    Disclaimer: ‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå‡∏à‡∏≤‡∏Å‡∏Å‡∏≤‡∏£‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏ó‡∏≤‡∏á‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô ‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏ô‡∏≤‡∏¢‡∏ú‡∏•‡∏™‡∏•‡∏≤‡∏Å‡∏Å‡∏¥‡∏ô‡πÅ‡∏ö‡πà‡∏á‡∏£‡∏±‡∏ê‡∏ö‡∏≤‡∏•
                </div>
            </div>

        </div>

        <div class="footer-note">
            RABROY Lab ¬© 2025. Pure Mathematics & Statistics Application. No Gambling Advice.
        </div>
    </div>

<script>
    /**
     * --- PART 1: UI & VISUALIZER LOGIC ---
     */
    
    // Elements
    const el = {
        vizNumber: document.getElementById('viz-number'),
        vizNeedle: document.getElementById('viz-needle'),
        btnDraw: document.getElementById('btn-draw-single'),
        miniHistory: document.getElementById('mini-history'),
        
        // Summary
        statTotal: document.getElementById('stat-total'),
        statMean: document.getElementById('stat-mean'),
        sourceBadge: document.getElementById('source-badge'),
        btnSim: document.getElementById('btn-sim'),
        simProgress: document.getElementById('sim-progress'),
        simCount: document.getElementById('sim-count'),
        
        // Panels
        panels: {
            chi: document.getElementById('tab-chi'),
            runs: document.getElementById('tab-runs'),
            autocorr: document.getElementById('tab-autocorr'),
            bayes: document.getElementById('tab-bayes')
        },
        tabs: document.querySelectorAll('.tab-btn')
    };

    const state = {
        mainData: [], // For Analysis
        liveHistory: [] // For Visualizer only
    };

    // --- Visualizer Animation ---
    el.btnDraw.addEventListener('click', () => {
        animateVisualizer();
    });

    function animateVisualizer() {
        // Disable button
        el.btnDraw.disabled = true;
        
        let duration = 800; // ms
        let start = null;
        let finalNum = Math.floor(Math.random() * 100); // The result
        
        // Random spin offset (so needle spins a few times)
        let totalRotation = 360 * 3 + (finalNum * 3.6); 

        function step(timestamp) {
            if (!start) start = timestamp;
            const progress = timestamp - start;
            const pct = Math.min(progress / duration, 1);
            
            // Easing (Ease Out Cubic)
            const ease = 1 - Math.pow(1 - pct, 3);
            
            // 1. Slot Machine Numbers
            if (pct < 1) {
                el.vizNumber.textContent = Math.floor(Math.random() * 100).toString().padStart(2, '0');
                el.vizNumber.style.transform = `translate(-50%, -50%) scale(${1 + Math.sin(pct * 10)*0.05})`;
                el.vizNumber.style.filter = "blur(1px)";
            } else {
                el.vizNumber.textContent = finalNum.toString().padStart(2, '0');
                el.vizNumber.style.transform = "translate(-50%, -50%) scale(1)";
                el.vizNumber.style.filter = "none";
            }

            // 2. Needle Rotation
            const currentRot = totalRotation * ease;
            el.vizNeedle.style.transform = `rotate(${currentRot}deg)`;

            if (progress < duration) {
                requestAnimationFrame(step);
            } else {
                finishDraw(finalNum);
            }
        }
        
        requestAnimationFrame(step);
    }

    function finishDraw(num) {
        el.btnDraw.disabled = false;
        
        // Update Mini History
        state.liveHistory.unshift(num);
        if (state.liveHistory.length > 8) state.liveHistory.pop();
        
        renderMiniHistory();
    }

    function renderMiniHistory() {
        el.miniHistory.innerHTML = state.liveHistory
            .map(n => `<span class="hist-dot">${n.toString().padStart(2,'0')}</span>`)
            .join('');
    }

    // --- Tab Switching ---
    el.tabs.forEach(btn => {
        btn.addEventListener('click', () => {
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            document.querySelectorAll('.tab-panel').forEach(p => p.classList.remove('active'));
            
            btn.classList.add('active');
            el.panels[btn.dataset.tab].classList.add('active');
        });
    });

    /**
     * --- PART 2: DATA & SIMULATION LOGIC ---
     */
    
    // Load Historical
    document.getElementById('btn-load-hist').addEventListener('click', async () => {
        showSplash(true);
        try {
            const res = await fetch('thai_lotto_last2.json');
            if (!res.ok) throw new Error("File not found");
            const json = await res.json();
            const data = [];
            json.forEach(row => {
                const n = parseInt(row.last2);
                if (!isNaN(n)) data.unshift(n); // Oldest first
            });
            
            state.mainData = data;
            el.sourceBadge.textContent = "Historical Data (‡∏´‡∏ß‡∏¢‡∏à‡∏£‡∏¥‡∏á)";
            el.sourceBadge.style.color = "var(--accent)";
            analyzeData();
            
        } catch (e) {
            alert("‡πÑ‡∏°‡πà‡∏û‡∏ö‡πÑ‡∏ü‡∏•‡πå thai_lotto_last2.json");
        }
        setTimeout(() => hideSplash(), 500);
    });

    // Run Simulation (Chunked)
    el.btnSim.addEventListener('click', () => {
        const N = 1000;
        const chunkSize = 50;
        let generated = [];
        
        el.btnSim.disabled = true;
        el.btnSim.innerHTML = '<span class="spinner"></span> Generating...';
        el.simProgress.style.display = 'block';
        
        let count = 0;
        
        function generateChunk() {
            for (let i = 0; i < chunkSize; i++) {
                generated.push(Math.floor(Math.random() * 100));
            }
            count += chunkSize;
            el.simCount.textContent = count;
            
            if (count < N) {
                setTimeout(generateChunk, 10); // Yield to UI
            } else {
                // Done
                state.mainData = generated;
                el.sourceBadge.textContent = "Simulation (Random 1,000 samples)";
                el.sourceBadge.style.color = "var(--success-text)";
                
                el.btnSim.disabled = false;
                el.btnSim.innerHTML = '‚ö° ‡∏à‡∏≥‡∏•‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏™‡∏∏‡πà‡∏° (Simulation)';
                el.simProgress.style.display = 'none';
                
                analyzeData();
            }
        }
        
        generateChunk();
    });

    /**
     * --- PART 3: STATISTICS & MATH ENGINE ---
     */

    function analyzeData() {
        const data = state.mainData;
        const total = data.length;
        if (total === 0) return;

        // 1. Basic Stats
        el.statTotal.textContent = total.toLocaleString();
        const sum = data.reduce((a,b)=>a+b,0);
        el.statMean.textContent = (sum / total).toFixed(2);

        // 2. Chi-Square
        const counts = new Array(100).fill(0);
        data.forEach(n => counts[n]++);
        const expected = total / 100;
        let chi2 = 0;
        counts.forEach(o => chi2 += ((o - expected)**2)/expected);
        
        // Wilson-Hilferty approx for p-value (df=99)
        const zChi = Math.sqrt(2*chi2) - Math.sqrt(2*99 - 1);
        const pVal = 1 - normalCDF(zChi);
        
        document.getElementById('chi-val').textContent = chi2.toFixed(2);
        document.getElementById('chi-p').textContent = pVal.toFixed(4);
        
        const chiChip = document.getElementById('chi-chip');
        if (pVal > 0.05) {
            chiChip.className = "chip green"; chiChip.textContent = "Uniform-like";
        } else {
            chiChip.className = "chip red"; chiChip.textContent = "Non-Uniform";
        }

        // 3. Runs Test (Median = 49.5, split 0-49 vs 50-99)
        let n1=0, n0=0, runs=1;
        const bins = data.map(n => n >= 50 ? 1 : 0);
        for(let x of bins) x===1 ? n1++ : n0++;
        for(let i=1; i<total; i++) if(bins[i] !== bins[i-1]) runs++;
        
        const expRuns = 1 + (2*n1*n0)/total;
        const varRuns = (2*n1*n0*(2*n1*n0 - total)) / ((total*total)*(total-1));
        const zRuns = (runs - expRuns) / Math.sqrt(varRuns);
        
        document.getElementById('runs-z').textContent = zRuns.toFixed(2);
        document.getElementById('runs-count').textContent = runs;
        
        const runsChip = document.getElementById('runs-chip');
        if (Math.abs(zRuns) < 1.96) {
            runsChip.className = "chip green"; runsChip.textContent = "Random Seq";
        } else {
            runsChip.className = "chip red"; runsChip.textContent = "Pattern Detected";
        }

        // 4. Autocorrelation (Lag-1)
        const mean = sum/total;
        let num=0, den=0;
        for(let i=0; i<total-1; i++) num += (data[i]-mean)*(data[i+1]-mean);
        for(let i=0; i<total; i++) den += (data[i]-mean)**2;
        const r1 = num/den;
        
        document.getElementById('auto-r').textContent = r1.toFixed(3);
        const autoChip = document.getElementById('auto-chip');
        if (Math.abs(r1) < 0.1) {
            autoChip.className = "chip green"; autoChip.textContent = "No Correlation";
        } else {
            autoChip.className = "chip warning"; autoChip.style.background = "var(--warning-bg)"; 
            autoChip.style.color = "var(--warning-text)"; autoChip.textContent = "Slight Correlation";
        }

        // 5. Bayesian (Top 5)
        const alphaSum = 100 + total;
        const probs = counts.map((c, i) => ({ n: i, p: (1+c)/alphaSum }));
        probs.sort((a,b) => b.p - a.p);
        const top5 = probs.slice(0, 5);
        const maxP = top5[0].p;
        
        const bayesContainer = document.getElementById('bayes-container');
        bayesContainer.innerHTML = top5.map(item => {
            const pct = (item.p * 100).toFixed(2);
            const barW = (item.p / maxP) * 100;
            return `
                <div style="font-size:0.9rem;">
                    <div style="display:flex; justify-content:space-between; margin-bottom:2px;">
                        <span style="font-weight:600;">Number ${item.n.toString().padStart(2,'0')}</span>
                        <span>${pct}%</span>
                    </div>
                    <div class="bar-bg"><div class="bar-fill" style="width:${barW}%"></div></div>
                </div>
            `;
        }).join('');

        // 6. Generate Insights
        generateInsights(total, pVal, zRuns, r1);
    }

    function generateInsights(total, pVal, zRuns, r1) {
        const ul = document.getElementById('ai-insights');
        let html = "";
        
        // Volume
        if (total < 200) html += `<li>‚ö†Ô∏è ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ô‡πâ‡∏≠‡∏¢ (${total}) ‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå‡∏ó‡∏≤‡∏á‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡∏≠‡∏≤‡∏à‡∏Ñ‡∏•‡∏≤‡∏î‡πÄ‡∏Ñ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡∏™‡∏π‡∏á</li>`;
        else html += `<li>‚úÖ ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏û‡∏µ‡∏¢‡∏á‡∏û‡∏≠‡∏ï‡πà‡∏≠‡∏Å‡∏≤‡∏£‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå (${total} samples)</li>`;

        // Chi-Square
        if (pVal > 0.05) html += `<li>‚öñÔ∏è <strong>Chi-Square:</strong> ‡∏Å‡∏≤‡∏£‡∏Å‡∏£‡∏∞‡∏à‡∏≤‡∏¢‡∏ï‡∏±‡∏ß‡∏Ç‡∏≠‡∏á‡πÄ‡∏•‡∏Ç "‡∏™‡∏°‡∏î‡∏∏‡∏•‡∏î‡∏µ" (Uniform) ‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÄ‡∏•‡∏Ç‡πÑ‡∏´‡∏ô‡∏≠‡∏≠‡∏Å‡∏ö‡πà‡∏≠‡∏¢‡∏ú‡∏¥‡∏î‡∏õ‡∏Å‡∏ï‡∏¥‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏°‡∏µ‡∏ô‡∏±‡∏¢‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç</li>`;
        else html += `<li>üö© <strong>Chi-Square:</strong> ‡∏û‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡πÑ‡∏°‡πà‡∏™‡∏°‡πà‡∏≥‡πÄ‡∏™‡∏°‡∏≠‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏Å‡∏£‡∏∞‡∏à‡∏≤‡∏¢‡∏ï‡∏±‡∏ß (p=${pVal.toFixed(3)}) ‡∏°‡∏µ‡∏ö‡∏≤‡∏á‡πÄ‡∏•‡∏Ç‡∏≠‡∏≠‡∏Å‡∏ö‡πà‡∏≠‡∏¢/‡∏ô‡πâ‡∏≠‡∏¢‡∏Å‡∏ß‡πà‡∏≤‡∏õ‡∏Å‡∏ï‡∏¥</li>`;

        // Runs
        if (Math.abs(zRuns) < 1.96) html += `<li>üé≤ <strong>Runs Test:</strong> ‡∏Å‡∏≤‡∏£‡∏™‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡∏°‡∏≤‡∏Ç‡∏≠‡∏á‡πÄ‡∏•‡∏Ç‡∏™‡∏π‡∏á/‡∏ï‡πà‡∏≥ ‡πÄ‡∏õ‡πá‡∏ô‡∏ò‡∏£‡∏£‡∏°‡∏ä‡∏≤‡∏ï‡∏¥ ‡πÑ‡∏°‡πà‡∏°‡∏µ Pattern ‡∏Å‡∏≤‡∏£‡πÄ‡∏Å‡∏≤‡∏∞‡∏Å‡∏•‡∏∏‡πà‡∏°</li>`;
        else html += `<li>üìâ <strong>Runs Test:</strong> ‡∏û‡∏ö‡πÅ‡∏ô‡∏ß‡πÇ‡∏ô‡πâ‡∏°‡∏Å‡∏≤‡∏£‡πÄ‡∏Å‡∏≤‡∏∞‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏Ç‡∏≠‡∏á‡πÄ‡∏•‡∏Ç (Z=${zRuns.toFixed(2)}) ‡∏ã‡∏∂‡πà‡∏á‡∏≠‡∏≤‡∏à‡πÄ‡∏Å‡∏¥‡∏î‡∏à‡∏≤‡∏Å‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ö‡∏±‡∏á‡πÄ‡∏≠‡∏¥‡∏ç‡∏´‡∏£‡∏∑‡∏≠ Pattern ‡∏ö‡∏≤‡∏á‡∏≠‡∏¢‡πà‡∏≤‡∏á</li>`;

        ul.innerHTML = html;
    }

    // Helper: Normal CDF
    function normalCDF(x) {
        var t = 1 / (1 + .2316419 * Math.abs(x));
        var d = .3989423 * Math.exp(-x * x / 2);
        var prob = d * t * (.3193815 + t * (-.3565638 + t * (1.781478 + t * (-1.821256 + t * 1.330274))));
        if (x > 0) prob = 1 - prob;
        return prob;
    }

    // Splash Hiding
    function showSplash(loading) {
        document.getElementById('splash').style.opacity = 1;
        document.getElementById('splash').style.pointerEvents = 'all';
    }
    function hideSplash() {
        document.getElementById('splash').style.opacity = 0;
        document.getElementById('splash').style.pointerEvents = 'none';
    }

    // Init
    window.addEventListener('load', () => {
        setTimeout(hideSplash, 1500);
    });

</script>
</body>
</html>
