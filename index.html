<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>MAGIC COMPASS | MK-II</title>
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#050508">

    <style>
        /* ------------------------------------------------------------------
           THEME: PURPLE NEON GLASS (PREMIUM)
           ------------------------------------------------------------------ */
        :root {
            --bg-core: #050508;
            --bg-grad: radial-gradient(circle at 50% 15%, #2e1065 0%, #0f0c29 45%, #000000 100%);
            
            /* Glass System */
            --glass-surf: rgba(255, 255, 255, 0.03);
            --glass-border: rgba(255, 255, 255, 0.1);
            --glass-highlight: rgba(255, 255, 255, 0.15);
            --blur-val: 20px;

            /* Colors */
            --neon-p: #d946ef; /* Purple */
            --neon-b: #60a5fa; /* Blue */
            --neon-r: #f43f5e; /* Rose/Alert */
            --neon-g: #34d399; /* Emerald/Safe */
            --text-1: #ffffff;
            --text-2: #94a3b8;
            --text-3: #64748b;

            --font-main: -apple-system, BlinkMacSystemFont, "SF Pro Display", "Inter", sans-serif;
            --font-mono: "SF Mono", "Menlo", monospace;
            
            --safe-top: env(safe-area-inset-top, 20px);
            --safe-bot: env(safe-area-inset-bottom, 20px);
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; user-select: none; }
        
        body {
            margin: 0; padding: 0;
            background: var(--bg-core); background-image: var(--bg-grad);
            color: var(--text-1); font-family: var(--font-main);
            height: 100vh; width: 100vw; overflow: hidden;
            display: flex; flex-direction: column;
        }

        /* BACKGROUND & FX */
        .bg-orb {
            position: absolute; border-radius: 50%; filter: blur(90px); opacity: 0.3; z-index: 0;
            animation: float 20s infinite alternate ease-in-out;
        }
        .orb-1 { width: 300px; height: 300px; background: var(--neon-p); top: -10%; left: -20%; }
        .orb-2 { width: 250px; height: 250px; background: var(--neon-b); bottom: 10%; right: -10%; animation-delay: -5s; }
        @keyframes float { 0% { transform: translate(0,0); } 100% { transform: translate(30px, 40px); } }

        /* SCANLINES */
        .scanlines {
            position: fixed; inset: 0; pointer-events: none; z-index: 1; opacity: 0.3;
            background: linear-gradient(to bottom, rgba(255,255,255,0), rgba(255,255,255,0) 50%, rgba(0,0,0,0.1) 50%, rgba(0,0,0,0.1));
            background-size: 100% 4px;
        }

        /* UTILS */
        .hidden { display: none !important; }
        .glass-panel {
            background: var(--glass-surf);
            backdrop-filter: blur(var(--blur-val)); -webkit-backdrop-filter: blur(var(--blur-val));
            border: 1px solid var(--glass-border);
            border-radius: 28px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.4);
        }
        .flex-row { display: flex; align-items: center; gap: 8px; }
        .flex-col { display: flex; flex-direction: column; gap: 6px; }
        .mono { font-family: var(--font-mono); letter-spacing: -0.5px; }

        /* --- APP STRUCTURE --- */
        #app {
            position: relative; z-index: 10; flex: 1;
            display: flex; flex-direction: column;
            padding: var(--safe-top) 16px calc(var(--safe-bot) + 12px) 16px;
            gap: 12px;
        }

        /* HEADER */
        .header { justify-content: space-between; height: 44px; padding: 0 4px; }
        .brand { font-weight: 800; letter-spacing: 1px; font-size: 0.95rem; display: flex; align-items: center; gap: 6px; }
        .badge { font-size: 0.7rem; padding: 5px 12px; border-radius: 20px; background: rgba(0,0,0,0.3); border: 1px solid var(--glass-border); color: var(--text-2); transition: 0.3s; }
        .badge.active { border-color: var(--neon-g); color: var(--neon-g); box-shadow: 0 0 10px rgba(52, 211, 153, 0.2); }
        .badge.btn { cursor: pointer; font-weight: 700; background: var(--glass-border); color: #fff; }

        /* COMPASS ORB (PREMIUM) */
        .stage { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; position: relative; min-height: 280px; }
        
        .orb-ring {
            width: 280px; height: 280px; border-radius: 50%;
            position: relative; 
            box-shadow: 0 0 60px rgba(139, 92, 246, 0.1), inset 0 0 40px rgba(0,0,0,0.6);
            border: 1px solid rgba(255,255,255,0.05);
            /* Transform handles via JS for performance */
        }
        /* Ticks using Conic Gradients (Lightweight) */
        .orb-ticks-maj {
            position: absolute; inset: -15px; border-radius: 50%;
            background: conic-gradient(from 0deg, var(--text-2) 0deg 1deg, transparent 1deg 29deg, var(--text-2) 30deg 31deg, transparent 31deg 359deg);
            mask: radial-gradient(transparent 68%, black 69%); -webkit-mask: radial-gradient(transparent 68%, black 69%);
        }
        .orb-ticks-min {
            position: absolute; inset: -5px; border-radius: 50%;
            background: repeating-conic-gradient(rgba(255,255,255,0.15) 0deg 1deg, transparent 1deg 5deg);
            mask: radial-gradient(transparent 68%, black 69%); -webkit-mask: radial-gradient(transparent 68%, black 69%);
        }
        .orb-lens {
            position: absolute; inset: 15px; border-radius: 50%;
            background: radial-gradient(circle at 30% 30%, rgba(255,255,255,0.05), transparent 60%);
            border: 1px solid rgba(255,255,255,0.05); pointer-events: none;
        }

        /* Cardinals */
        .cardinal { position: absolute; font-weight: 700; font-size: 0.85rem; color: var(--text-3); }
        .c-n { top: 8px; left: 50%; transform: translateX(-50%); color: var(--neon-p); text-shadow: 0 0 10px var(--neon-p); }
        .c-e { right: 12px; top: 50%; transform: translateY(-50%); }
        .c-s { bottom: 8px; left: 50%; transform: translateX(-50%); }
        .c-w { left: 12px; top: 50%; transform: translateY(-50%); }

        /* Needles */
        .needle-stage { position: absolute; inset: 0; pointer-events: none; }
        .needle {
            position: absolute; top: 50%; left: 50%; transform-origin: bottom center;
            /* Transition handled in JS for sync, CSS for opacity only */
            transition: opacity 0.3s;
        }
        /* Wonder Needle (Crystal Arrow) */
        .n-target {
            width: 8px; height: 44%; margin-left: -4px; margin-top: -44%;
            background: linear-gradient(to top, transparent 10%, var(--neon-p) 100%);
            border-radius: 4px; z-index: 3; box-shadow: 0 -4px 15px var(--neon-p);
        }
        .n-target::after { content:''; position: absolute; top: -6px; left: -2px; border: 6px solid transparent; border-bottom: 10px solid #fff; }
        
        .n-true { width: 2px; height: 48%; background: var(--neon-b); margin-left: -1px; margin-top: -48%; opacity: 0.9; z-index: 2; }
        .n-mag { width: 1px; height: 40%; border-left: 1px dashed var(--neon-r); margin-left: -0.5px; margin-top: -40%; opacity: 0.7; z-index: 1; }

        /* HUD Data */
        .hud-center {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            text-align: center; pointer-events: none;
        }
        .val-head { font-size: 2.5rem; font-weight: 800; letter-spacing: -1px; line-height: 1; }
        .lbl-head { font-size: 0.65rem; color: var(--text-2); letter-spacing: 2px; margin-top: 4px; }
        
        /* Calibration Warning */
        .calib-warn {
            position: absolute; bottom: 20%; left: 50%; transform: translateX(-50%);
            font-size: 0.7rem; color: var(--neon-r); background: rgba(0,0,0,0.6);
            padding: 4px 10px; border-radius: 10px; pointer-events: none; display: none; white-space: nowrap;
        }
        .calib-warn.show { display: block; animation: pulse 1s infinite; }

        /* ANOMALY MONITOR (Myth Mode) */
        .monitor-ui { position: absolute; bottom: -15px; right: -15px; width: 110px; height: 110px; display: none; }
        .radar-ring { width: 100%; height: 100%; border-radius: 50%; border: 1px solid rgba(255,255,255,0.1); background: radial-gradient(rgba(0,0,0,0), rgba(0,0,0,0.6)); position: relative; overflow: hidden; }
        .radar-sweep { position: absolute; inset: 0; border-radius: 50%; background: conic-gradient(from 0deg, transparent 0deg, rgba(244, 63, 94, 0.2) 60deg, transparent 60.1deg); animation: sweep 3s linear infinite; }
        .blip { position: absolute; width: 4px; height: 4px; background: #fff; border-radius: 50%; box-shadow: 0 0 6px var(--neon-r); opacity: 0; animation: blip 2s ease-out; }
        .scope-cvs { position: absolute; bottom: 10px; left: -10px; width: 80px; height: 40px; opacity: 0.7; display: none; }
        
        @keyframes sweep { to { transform: rotate(360deg); } }
        @keyframes blip { 0% { opacity: 1; transform: scale(1); } 100% { opacity: 0; transform: scale(2.5); } }
        @keyframes pulse { 50% { opacity: 0.5; } }

        /* INFO DECK */
        .deck { display: flex; flex-direction: column; gap: 10px; perspective: 1000px; margin-top: auto; }
        
        /* CARD STYLES */
        .card { padding: 18px; position: relative; overflow: hidden; min-height: 130px; transition: 0.3s; }
        .card::before { content:''; position: absolute; top:0; left:0; bottom:0; width: 3px; background: var(--text-3); }
        .card.lore::before { background: var(--neon-p); }
        .card.omen::before { background: var(--neon-r); }
        
        .c-head { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 8px; }
        .c-title { font-size: 1.15rem; font-weight: 700; color: #fff; line-height: 1.2; max-width: 80%; }
        .c-meta { font-size: 0.85rem; color: var(--neon-p); font-weight: 600; }
        .c-body { font-size: 0.85rem; color: var(--text-2); line-height: 1.5; }
        .c-facts { margin: 8px 0; padding-left: 0; list-style: none; font-size: 0.75rem; }
        .c-facts li { display: flex; gap: 6px; margin-bottom: 4px; }
        .c-facts li::before { content: 'â€¢'; color: var(--text-3); }
        .c-quote { font-style: italic; color: var(--text-3); font-size: 0.8rem; border-top: 1px solid var(--glass-border); margin-top: 10px; padding-top: 8px; }

        /* CONTROLS */
        .ctrl-row { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 8px; margin-top: 5px; }
        .btn {
            background: var(--glass-surf); border: 1px solid var(--glass-border);
            color: var(--text-2); padding: 12px; border-radius: 20px;
            font-size: 0.8rem; display: flex; align-items: center; justify-content: center; gap: 6px;
            cursor: pointer; transition: 0.2s;
        }
        .btn:active { background: var(--glass-highlight); transform: scale(0.98); }
        .btn.active { border-color: var(--neon-p); color: #fff; background: rgba(217, 70, 239, 0.15); }

        /* DOCK */
        .dock {
            display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 6px;
            background: rgba(0,0,0,0.4); padding: 5px; border-radius: 26px;
            border: 1px solid var(--glass-border);
        }
        .dock-item {
            background: transparent; border: none; color: var(--text-3);
            padding: 10px; border-radius: 20px; font-size: 0.75rem; font-weight: 600;
            cursor: pointer; transition: 0.2s;
        }
        .dock-item.active { background: var(--glass-border); color: #fff; box-shadow: 0 2px 10px rgba(0,0,0,0.2); }

        /* MODALS */
        .modal-wrap {
            position: fixed; inset: 0; z-index: 100; background: rgba(0,0,0,0.9);
            backdrop-filter: blur(12px); display: flex; align-items: center; justify-content: center;
            padding: 20px; opacity: 0; pointer-events: none; transition: 0.3s;
        }
        .modal-wrap.show { opacity: 1; pointer-events: auto; }
        .modal-box { width: 100%; max-width: 400px; padding: 24px; max-height: 85vh; overflow-y: auto; }
        
        .perm-hero {
            background: var(--neon-p); color: #fff; border: none;
            padding: 16px 32px; border-radius: 32px; font-size: 1rem; font-weight: 700;
            box-shadow: 0 0 25px rgba(217, 70, 239, 0.4); margin-top: 24px; cursor: pointer;
        }
        
        /* Glitch Text */
        .glitch-txt { animation: glitch 0.3s infinite; text-shadow: 2px 0 var(--neon-r), -2px 0 var(--neon-b); }
        @keyframes glitch { 0% { transform: translate(0); } 20% { transform: translate(-2px, 2px); } 40% { transform: translate(2px, -2px); } 100% { transform: translate(0); } }

    </style>
</head>
<body>

    <div class="scanlines"></div>
    <div class="bg-orb orb-1"></div>
    <div class="bg-orb orb-2"></div>

    <!-- 1. PERMISSION MODAL -->
    <div id="modal-perm" class="modal-wrap show">
        <div class="glass-panel modal-box" style="text-align:center;">
            <h1 style="font-size:1.8rem; line-height:1.2; margin-bottom:12px; color:#fff;">MAGIC COMPASS<br><span style="font-size:0.5em; color:var(--neon-b); font-weight:400">MK-II PRODUCTION</span></h1>
            <p style="font-size:0.9rem; color:var(--text-2); line-height:1.5;" data-t="perm_desc">
                Requires Sensor Fusion (GPS + Compass) for Precision AR Navigation and Myth Experience.
            </p>
            <button class="perm-hero" id="btn-init" data-t="perm_btn">INITIALIZE SYSTEM</button>
        </div>
    </div>

    <!-- 2. MAIN APP -->
    <div id="app" class="hidden">
        
        <!-- Header -->
        <div class="flex-row header">
            <div class="brand"><span style="color:var(--neon-p)">âœ¦</span> MAGIC CMPSS</div>
            <div class="flex-row">
                <button class="badge btn" id="btn-lang">EN</button>
                <div class="badge" id="gps-stat" data-t="gps_wait">GPS WAIT</div>
                <div style="cursor:pointer; padding:6px; opacity:0.8;" onclick="app.toggleSettings()">âš™</div>
            </div>
        </div>

        <!-- Compass Core -->
        <div class="stage">
            <div class="orb-ring" id="orb-ring">
                <div class="orb-ticks-maj"></div>
                <div class="orb-ticks-min"></div>
                <div class="orb-lens"></div>
                
                <div class="cardinal c-n">N</div><div class="cardinal c-e">E</div>
                <div class="cardinal c-s">S</div><div class="cardinal c-w">W</div>
                
                <div class="needle-stage">
                    <div class="needle n-target" id="n-target"></div>
                    <div class="needle n-true" id="n-true"></div>
                    <div class="needle n-mag" id="n-mag"></div>
                </div>

                <div class="hud-center">
                    <span class="val-head mono" id="val-head">000Â°</span>
                    <span class="lbl-head" id="lbl-head">HEADING</span>
                </div>
            </div>

            <!-- Calibration/Tilt Warning -->
            <div class="calib-warn" id="calib-warn" data-t="warn_calib">CALIBRATE: FIGURE 8</div>

            <!-- Anomaly Monitor (Myth Mode) -->
            <div class="monitor-ui" id="monitor-ui">
                <div class="radar-ring">
                    <div class="radar-sweep"></div>
                </div>
            </div>
            <canvas class="scope-cvs" id="scope-cvs"></canvas>
        </div>

        <!-- Info Deck -->
        <div class="deck">
            
            <!-- Lore Card (Wonder/Earth) -->
            <div class="glass-panel card lore" id="card-lore">
                <div class="c-head">
                    <div class="c-title" id="lore-title">Loading...</div>
                    <div class="c-meta mono" id="lore-dist">-- km</div>
                </div>
                <div class="c-body">
                    <div style="margin-bottom:8px; color:#fff;" id="lore-short"></div>
                    <ul class="c-facts" id="lore-facts"></ul>
                    <div class="c-quote" id="lore-myth"></div>
                </div>
            </div>

            <!-- Omen Card (Myth) -->
            <div class="glass-panel card omen hidden" id="card-omen">
                <div class="c-head">
                    <div class="c-title" style="color:var(--neon-r)" id="omen-title">SIGNAL QUIET</div>
                    <div class="c-meta mono" style="font-size:0.7rem; opacity:0.7">ARG MODE</div>
                </div>
                <div class="c-body">
                    <div id="omen-text" style="color:#fff;">The air is still.</div>
                    <div class="c-quote" id="omen-flavor">No anomalies detected.</div>
                </div>
                <button class="btn" style="width:100%; margin-top:12px; border-color:var(--neon-r); color:var(--neon-r);" onclick="app.showLocalLegend()">
                    <span style="font-size:1rem">ðŸ“œ</span> <span data-t="btn_legend">Read Local Legend</span>
                </button>
            </div>

            <!-- Action Bar -->
            <div class="ctrl-row" id="row-actions">
                <button class="btn active" id="btn-auto" onclick="app.toggleAuto()">
                    <span>âŸ³</span> <span data-t="btn_auto">Auto</span>
                </button>
                <button class="btn" onclick="app.nextTarget()">
                    <span>â†’</span> <span data-t="btn_next">Next</span>
                </button>
                <button class="btn" onclick="app.openMap()">
                    <span>â†—</span> <span data-t="btn_map">Map</span>
                </button>
            </div>

            <!-- Mode Switcher -->
            <div class="dock">
                <button class="dock-item active" onclick="app.setMode('wonder')" data-t="mode_wonder">WONDER</button>
                <button class="dock-item" onclick="app.setMode('earth')" data-t="mode_earth">EARTH</button>
                <button class="dock-item" onclick="app.setMode('myth')" data-t="mode_myth">MYTH</button>
            </div>
        </div>
    </div>

    <!-- 3. MODALS -->
    <!-- Settings -->
    <div id="modal-set" class="modal-wrap">
        <div class="glass-panel modal-box">
            <div style="display:flex; justify-content:space-between; margin-bottom:15px;">
                <h3 style="margin:0; color:#fff;" data-t="title_set">Settings</h3>
                <div style="cursor:pointer; font-size:1.5rem;" onclick="app.toggleSettings()">Ã—</div>
            </div>
            <label style="font-size:0.8rem; color:var(--text-2);" data-t="lbl_decl">Magnetic Declination (Â°)</label>
            <div class="flex-row" style="margin-top:8px;">
                <input type="number" id="inp-decl" value="0" style="width:100%; background:rgba(0,0,0,0.3); border:1px solid var(--glass-border); padding:10px; border-radius:12px; color:#fff;">
                <button class="btn" onclick="app.fetchDecl()">Fetch</button>
            </div>
        </div>
    </div>

    <!-- Folklore Reader -->
    <div id="modal-folk" class="modal-wrap">
        <div class="glass-panel modal-box">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
                <div class="badge" style="border-color:var(--neon-r); color:var(--neon-r);">LOCAL LEGEND</div>
                <div style="cursor:pointer; font-size:1.5rem;" onclick="app.closeLegend()">Ã—</div>
            </div>
            <h2 id="folk-title" style="margin:0 0 12px 0; line-height:1.2; color:#fff;">Title</h2>
            <div id="folk-body" style="font-size:0.95rem; color:var(--text-2); line-height:1.6; white-space:pre-line;">...</div>
            <div class="c-quote" id="folk-meta" style="margin-top:20px;">Source: ...</div>
            <div class="flex-row" style="margin-top:20px;">
                <button class="btn" style="flex:1" onclick="app.closeLegend()" data-t="btn_close">Close</button>
            </div>
        </div>
    </div>

<script>
/**
 * MAGIC WONDER COMPASS | MK-II PRODUCTION
 * 
 * Core Modules:
 * 1. I18n: Bilingual Dictionary & DOM Manager
 * 2. SensorEngine: Heavy-lifting orientation fusion, tilt-comp, and calibration
 * 3. LogicEngine: Geodesy, Lore Selection, Omen Generation
 * 4. App: Main Controller & Render Loop
 */

// --- 1. I18N MODULE ---
const DICT = {
    en: {
        perm_desc: "Compass, GPS, and Motion sensors are required for AR Navigation and Anomaly Detection.",
        perm_btn: "INITIALIZE SYSTEM",
        gps_wait: "GPS WAIT",
        gps_lock: "GPS LOCK",
        mode_wonder: "WONDER",
        mode_earth: "EARTH",
        mode_myth: "MYTH",
        btn_auto: "Auto: ON",
        btn_manual: "Auto: OFF",
        btn_next: "Next",
        btn_map: "Map",
        btn_legend: "Read Local Legend",
        btn_close: "Close",
        title_set: "Settings",
        lbl_decl: "Magnetic Declination (Â°)",
        lbl_head: "HEADING",
        lbl_var: "VARIANCE",
        warn_calib: "CALIBRATE: FIGURE 8",
        warn_tilt: "HOLD FLAT",
        lore_load: "Accessing Archives...",
        omen_q: "SIGNAL QUIET",
        omen_r: "SUBTLE RIPPLE",
        omen_d: "DISTORTION",
        omen_p: "OMEN PEAK",
        flavor_q: "Locals say the spirits sleep deep here.",
        flavor_a: "Some say the wind whispers names at night.",
        err_mag: "Magnetometer Unavailable",
        err_cors: "Offline. Entered manually."
    },
    th: {
        perm_desc: "à¸•à¹‰à¸­à¸‡à¸à¸²à¸£à¸à¸²à¸£à¹€à¸‚à¹‰à¸²à¸–à¸¶à¸‡ GPS à¹à¸¥à¸°à¹€à¸‚à¹‡à¸¡à¸—à¸´à¸¨ à¹€à¸žà¸·à¹ˆà¸­à¸£à¸°à¸šà¸šà¸™à¸³à¸—à¸²à¸‡ AR à¹à¸¥à¸°à¸à¸²à¸£à¸•à¸£à¸§à¸ˆà¸ˆà¸±à¸šà¸„à¸§à¸²à¸¡à¸œà¸´à¸”à¸›à¸à¸•à¸´",
        perm_btn: "à¹€à¸£à¸´à¹ˆà¸¡à¸£à¸°à¸šà¸š",
        gps_wait: "à¸£à¸­ GPS...",
        gps_lock: "GPS à¸žà¸£à¹‰à¸­à¸¡",
        mode_wonder: "à¸ªà¸´à¹ˆà¸‡à¸¡à¸«à¸±à¸¨à¸ˆà¸£à¸£à¸¢à¹Œ",
        mode_earth: "à¹à¸¡à¹ˆà¹€à¸«à¸¥à¹‡à¸à¹‚à¸¥à¸",
        mode_myth: "à¹€à¸£à¸·à¹ˆà¸­à¸‡à¸¥à¸µà¹‰à¸¥à¸±à¸š",
        btn_auto: "à¸­à¸­à¹‚à¸•à¹‰: à¹€à¸›à¸´à¸”",
        btn_manual: "à¸­à¸­à¹‚à¸•à¹‰: à¸›à¸´à¸”",
        btn_next: "à¸–à¸±à¸”à¹„à¸›",
        btn_map: "à¹à¸œà¸™à¸—à¸µà¹ˆ",
        btn_legend: "à¸­à¹ˆà¸²à¸™à¸•à¸³à¸™à¸²à¸™à¹à¸–à¸§à¸™à¸µà¹‰",
        btn_close: "à¸›à¸´à¸”",
        title_set: "à¸•à¸±à¹‰à¸‡à¸„à¹ˆà¸²",
        lbl_decl: "à¸¡à¸¸à¸¡à¸šà¹ˆà¸²à¸¢à¹€à¸šà¸™à¹à¸¡à¹ˆà¹€à¸«à¸¥à¹‡à¸ (Â°)",
        lbl_head: "à¸—à¸´à¸¨à¸«à¸±à¸§à¹€à¸„à¸£à¸·à¹ˆà¸­à¸‡",
        lbl_var: "à¸„à¸§à¸²à¸¡à¸œà¸±à¸™à¸œà¸§à¸™",
        warn_calib: "à¸«à¸¡à¸¸à¸™à¹€à¸„à¸£à¸·à¹ˆà¸­à¸‡à¹€à¸¥à¸‚ 8 à¹€à¸žà¸·à¹ˆà¸­à¸›à¸£à¸±à¸šà¸ˆà¸¹à¸™",
        warn_tilt: "à¸§à¸²à¸‡à¹€à¸„à¸£à¸·à¹ˆà¸­à¸‡à¸£à¸²à¸š",
        lore_load: "à¸à¸³à¸¥à¸±à¸‡à¸„à¹‰à¸™à¸‚à¹‰à¸­à¸¡à¸¹à¸¥...",
        omen_q: "à¸ªà¸±à¸à¸à¸²à¸“à¸ªà¸‡à¸š",
        omen_r: "à¸£à¸´à¹‰à¸§à¸„à¸¥à¸·à¹ˆà¸™à¸ˆà¸²à¸‡à¹†",
        omen_d: "à¸ªà¸™à¸²à¸¡à¸šà¸´à¸”à¹€à¸šà¸·à¸­à¸™",
        omen_p: "à¸¥à¸²à¸‡à¸£à¹‰à¸²à¸¢à¸ªà¸¹à¸‡à¸ªà¸¸à¸”",
        flavor_q: "à¸„à¸™à¹€à¸’à¹ˆà¸²à¸„à¸™à¹à¸à¹ˆà¸šà¸­à¸à¸§à¹ˆà¸²à¸—à¸µà¹ˆà¸™à¸µà¹ˆà¹€à¸ˆà¹‰à¸²à¸—à¸µà¹ˆà¹à¸£à¸‡à¹à¸•à¹ˆà¹ƒà¸ˆà¸”à¸µ",
        flavor_a: "à¹€à¸‚à¸²à¸§à¹ˆà¸²à¸à¸±à¸™à¸§à¹ˆà¸²à¸­à¸¢à¹ˆà¸²à¸‚à¸²à¸™à¸£à¸±à¸šà¸–à¹‰à¸²à¹„à¸”à¹‰à¸¢à¸´à¸™à¹€à¸ªà¸µà¸¢à¸‡à¹€à¸£à¸µà¸¢à¸",
        err_mag: "à¹„à¸¡à¹ˆà¸žà¸šà¹€à¸‹à¸™à¹€à¸‹à¸­à¸£à¹Œà¹à¸¡à¹ˆà¹€à¸«à¸¥à¹‡à¸",
        err_cors: "à¸­à¸­à¸Ÿà¹„à¸¥à¸™à¹Œ à¸à¸£à¸¸à¸“à¸²à¸à¸£à¸­à¸à¹€à¸­à¸‡"
    }
};

class I18n {
    constructor() {
        this.lang = localStorage.getItem('lang') || (navigator.language.startsWith('th') ? 'th' : 'en');
        this.apply();
    }
    t(key) { return DICT[this.lang][key] || key; }
    toggle() {
        this.lang = this.lang === 'en' ? 'th' : 'en';
        localStorage.setItem('lang', this.lang);
        this.apply();
    }
    apply() {
        document.getElementById('btn-lang').innerText = this.lang.toUpperCase();
        document.querySelectorAll('[data-t]').forEach(el => el.innerText = this.t(el.dataset.t));
    }
}

// --- 2. DATABASES (OFFLINE BRAINS) ---
const LORE_DB = {
    "Great Pyramid of Giza": {
        en: { short: "The last ancient wonder standing.", facts: ["Built ~2560 BC for Khufu", "2.3 million stone blocks", "True North alignment"], myth: "A guide once told me it was a power plant, not a tomb." },
        th: { short: "à¸ªà¸´à¹ˆà¸‡à¸¡à¸«à¸±à¸¨à¸ˆà¸£à¸£à¸¢à¹Œà¸¢à¸¸à¸„à¹‚à¸šà¸£à¸²à¸“à¸«à¸™à¸¶à¹ˆà¸‡à¹€à¸”à¸µà¸¢à¸§à¸—à¸µà¹ˆà¹€à¸«à¸¥à¸·à¸­à¸­à¸¢à¸¹à¹ˆ", facts: ["à¸ªà¸£à¹‰à¸²à¸‡à¸›à¸µ 2560 à¸à¹ˆà¸­à¸™ à¸„.à¸¨.", "à¸«à¸´à¸™ 2.3 à¸¥à¹‰à¸²à¸™à¸à¹‰à¸­à¸™", "à¸«à¸±à¸™à¸«à¸™à¹‰à¸²à¸—à¸´à¸¨à¹€à¸«à¸™à¸·à¸­à¸ˆà¸£à¸´à¸‡à¹€à¸›à¹Šà¸°"], myth: "à¹„à¸à¸”à¹Œà¸—à¹‰à¸­à¸‡à¸–à¸´à¹ˆà¸™à¹€à¸„à¸¢à¸à¸£à¸°à¸‹à¸´à¸šà¸§à¹ˆà¸² à¸™à¸µà¹ˆà¸„à¸·à¸­à¹‚à¸£à¸‡à¹„à¸Ÿà¸Ÿà¹‰à¸²à¹‚à¸šà¸£à¸²à¸“ à¹„à¸¡à¹ˆà¹ƒà¸Šà¹ˆà¸ªà¸¸à¸ªà¸²à¸™" }
    },
    "Stonehenge": {
        en: { short: "Prehistoric ring of standing stones.", facts: ["Built 3000-2000 BC", "Stones from 200km away", "Solar alignment"], myth: "Locals say Merlin danced these giants into place." },
        th: { short: "à¸§à¸‡à¸¥à¹‰à¸­à¸¡à¸«à¸´à¸™à¸›à¸£à¸´à¸¨à¸™à¸²à¸¢à¸¸à¸„à¸à¹ˆà¸­à¸™à¸›à¸£à¸°à¸§à¸±à¸•à¸´à¸¨à¸²à¸ªà¸•à¸£à¹Œ", facts: ["à¸­à¸²à¸¢à¸¸ 5,000 à¸›à¸µ", "à¸‚à¸™à¸«à¸´à¸™à¸¡à¸²à¸ˆà¸²à¸à¹„à¸à¸¥ 200 à¸à¸¡.", "à¸•à¸£à¸‡à¸à¸±à¸šà¹à¸™à¸§à¹à¸ªà¸‡à¸­à¸²à¸—à¸´à¸•à¸¢à¹Œ"], myth: "à¸•à¸³à¸™à¸²à¸™à¹€à¸¥à¹ˆà¸²à¸§à¹ˆà¸²à¸žà¹ˆà¸­à¸¡à¸”à¹€à¸¡à¸­à¸£à¹Œà¸¥à¸´à¸™à¸£à¹ˆà¸²à¸¢à¸¡à¸™à¸•à¹Œà¹ƒà¸«à¹‰à¸«à¸´à¸™à¹€à¸•à¹‰à¸™à¸£à¸°à¸šà¸³à¸¡à¸²à¹€à¸£à¸µà¸¢à¸‡à¸à¸±à¸™" }
    },
    "Petra": {
        en: { short: "The Rose City carved in rock.", facts: ["Capital of Nabataeans", "Lost for centuries", "Water conduit system"], myth: "Bedouins say Djinn guard the Pharaoh's Treasury." },
        th: { short: "à¸™à¸„à¸£à¸ªà¸µà¸Šà¸¡à¸žà¸¹à¸—à¸µà¹ˆà¹à¸à¸°à¸ªà¸¥à¸±à¸à¹ƒà¸™à¸«à¸¸à¸šà¹€à¸‚à¸²", facts: ["à¹€à¸¡à¸·à¸­à¸‡à¸«à¸¥à¸§à¸‡à¸™à¸²à¸šà¸²à¹€à¸—à¸µà¸¢à¸™", "à¸«à¸²à¸¢à¸ªà¸²à¸šà¸ªà¸¹à¸à¸«à¸¥à¸²à¸¢à¸¨à¸•à¸§à¸£à¸£à¸©", "à¸£à¸°à¸šà¸šà¸›à¸£à¸°à¸›à¸²à¸¥à¹‰à¸³à¸¢à¸¸à¸„"], myth: "à¸Šà¸²à¸§à¹€à¸šà¸”à¸¹à¸­à¸´à¸™à¹€à¸Šà¸·à¹ˆà¸­à¸§à¹ˆà¸²à¸¡à¸µà¸ à¸¹à¸•à¸ˆà¸´à¸™à¸™à¹Œà¹€à¸à¹‰à¸²à¸ªà¸¡à¸šà¸±à¸•à¸´à¸­à¸¢à¸¹à¹ˆà¸‚à¹‰à¸²à¸‡à¹ƒà¸™" }
    },
    "Great Wall of China": {
        en: { short: "The stone dragon of the East.", facts: ["21,196 km long", "Built over 2000 years", "Not visible from space"], myth: "They say workers' bones were ground into the mortar." },
        th: { short: "à¸¡à¸±à¸‡à¸à¸£à¸«à¸´à¸™à¹à¸«à¹ˆà¸‡à¸šà¸¹à¸£à¸žà¸²à¸—à¸´à¸¨", facts: ["à¸¢à¸²à¸§ 21,196 à¸à¸¡.", "à¸ªà¸£à¹‰à¸²à¸‡à¸™à¸²à¸™ 2,000 à¸›à¸µ", "à¸¡à¸­à¸‡à¹„à¸¡à¹ˆà¹€à¸«à¹‡à¸™à¸ˆà¸²à¸à¸­à¸§à¸à¸²à¸¨"], myth: "à¹€à¸¥à¹ˆà¸²à¸à¸±à¸™à¸§à¹ˆà¸²à¸à¸£à¸°à¸”à¸¹à¸à¹à¸£à¸‡à¸‡à¸²à¸™à¸–à¸¹à¸à¸šà¸”à¸œà¸ªà¸¡à¸¥à¸‡à¹ƒà¸™à¸›à¸¹à¸™à¸à¹ˆà¸­à¸à¸³à¹à¸žà¸‡" }
    },
    "Colosseum": {
        en: { short: "Arena of blood and glory.", facts: ["Held 50,000 people", "Flooded for sea battles", "Built in 80 AD"], myth: "Listen closely, you can still hear the roar of the crowd." },
        th: { short: "à¸ªà¸±à¸‡à¹€à¸§à¸µà¸¢à¸™à¹€à¸¥à¸·à¸­à¸”à¹à¸¥à¸°à¹€à¸à¸µà¸¢à¸£à¸•à¸´à¸¢à¸¨", facts: ["à¸ˆà¸¸à¸„à¸™à¹„à¸”à¹‰ 5 à¸«à¸¡à¸·à¹ˆà¸™", "à¹€à¸„à¸¢à¸ˆà¸³à¸¥à¸­à¸‡à¸£à¸šà¸—à¸²à¸‡à¹€à¸£à¸·à¸­", "à¸ªà¸£à¹‰à¸²à¸‡à¸›à¸µ à¸„.à¸¨. 80"], myth: "à¸•à¸±à¹‰à¸‡à¹ƒà¸ˆà¸Ÿà¸±à¸‡à¸”à¸µà¹† à¸­à¸²à¸ˆà¹„à¸”à¹‰à¸¢à¸´à¸™à¹€à¸ªà¸µà¸¢à¸‡à¹‚à¸«à¹ˆà¸£à¹‰à¸­à¸‡à¸‚à¸­à¸‡à¸œà¸¹à¹‰à¸Šà¸¡à¹ƒà¸™à¸ªà¸²à¸¢à¸¥à¸¡" }
    },
    "Chichen Itza": {
        en: { short: "Pyramid of the Serpent God.", facts: ["365 steps", "Shadow snake on Equinox", "Acoustic marvel"], myth: "The Cenote demands rain god offerings." },
        th: { short: "à¸žà¸µà¸£à¸°à¸¡à¸´à¸”à¹à¸«à¹ˆà¸‡à¹€à¸—à¸žà¸‡à¸¹", facts: ["à¸šà¸±à¸™à¹„à¸” 365 à¸‚à¸±à¹‰à¸™", "à¹€à¸‡à¸²à¸‡à¸¹à¹‚à¸œà¸¥à¹ˆà¸•à¸­à¸™à¸§à¸´à¸©à¸¸à¸§à¸±à¸•", "à¹€à¸ªà¸µà¸¢à¸‡à¸ªà¸°à¸—à¹‰à¸­à¸™à¸­à¸±à¸¨à¸ˆà¸£à¸£à¸¢à¹Œ"], myth: "à¸šà¹ˆà¸­à¸™à¹‰à¸³à¸¨à¸±à¸à¸”à¸´à¹Œà¸ªà¸´à¸—à¸˜à¸´à¹Œà¹€à¸£à¸µà¸¢à¸à¸£à¹‰à¸­à¸‡à¹€à¸„à¸£à¸·à¹ˆà¸­à¸‡à¸ªà¸±à¸‡à¹€à¸§à¸¢à¹à¸”à¹ˆà¹€à¸—à¸žà¸à¸™" }
    },
    "Machu Picchu": {
        en: { short: "Lost City in the clouds.", facts: ["Inca Citadel (1450)", "No mortar used", "Hidden from Spanish"], myth: "The Intihuatana stone ties the sun to the earth." },
        th: { short: "à¸™à¸„à¸£à¸ªà¸²à¸šà¸ªà¸¹à¸à¹ƒà¸™à¸¡à¹ˆà¸²à¸™à¹€à¸¡à¸†", facts: ["à¸›à¹‰à¸­à¸¡à¸›à¸£à¸²à¸à¸²à¸£à¸­à¸´à¸™à¸„à¸²", "à¹€à¸£à¸µà¸¢à¸‡à¸«à¸´à¸™à¹„à¸¡à¹ˆà¹ƒà¸Šà¹‰à¸›à¸¹à¸™", "à¸ªà¹€à¸›à¸™à¸«à¸²à¹„à¸¡à¹ˆà¹€à¸ˆà¸­"], myth: "à¸«à¸´à¸™à¸­à¸´à¸™à¸•à¸´à¸§à¸²à¸•à¸²à¸™à¸²à¸—à¸³à¸«à¸™à¹‰à¸²à¸—à¸µà¹ˆà¸œà¸¹à¸à¸”à¸§à¸‡à¸­à¸²à¸—à¸´à¸•à¸¢à¹Œà¹„à¸§à¹‰à¸à¸±à¸šà¹‚à¸¥à¸" }
    },
    "Taj Mahal": {
        en: { short: "Marble monument to eternal love.", facts: ["Built by Shah Jahan", "Took 22 years", "Sinking slowly"], myth: "A black marble twin was planned across the river." },
        th: { short: "à¸­à¸™à¸¸à¸ªà¸£à¸“à¹Œà¸ªà¸–à¸²à¸™à¹à¸«à¹ˆà¸‡à¸£à¸±à¸à¸™à¸´à¸£à¸±à¸™à¸”à¸£à¹Œ", facts: ["à¸ªà¸£à¹‰à¸²à¸‡à¹‚à¸”à¸¢à¸Šà¸²à¸«à¹Œà¸ˆà¸²à¸®à¸²à¸™", "à¹ƒà¸Šà¹‰à¹€à¸§à¸¥à¸² 22 à¸›à¸µ", "à¸à¸²à¸™à¸£à¸²à¸à¸à¸³à¸¥à¸±à¸‡à¸—à¸£à¸¸à¸”"], myth: "à¸•à¸³à¸™à¸²à¸™à¸§à¹ˆà¸²à¸ˆà¸°à¸¡à¸µà¸—à¸±à¸ˆà¸¡à¸²à¸®à¸²à¸¥à¸ªà¸µà¸”à¸³à¸ªà¸£à¹‰à¸²à¸‡à¸­à¸¢à¸¹à¹ˆà¸­à¸µà¸à¸à¸±à¹ˆà¸‡à¹à¸¡à¹ˆà¸™à¹‰à¸³" }
    },
    "Christ the Redeemer": {
        en: { short: "The embrace over Rio.", facts: ["30 meters tall", "Soapstone mosaic", "Lightning rod"], myth: "It protects the city from the angry sea." },
        th: { short: "à¸­à¹‰à¸­à¸¡à¸à¸­à¸”à¹€à¸«à¸™à¸·à¸­à¹€à¸¡à¸·à¸­à¸‡à¸£à¸´à¹‚à¸­", facts: ["à¸ªà¸¹à¸‡ 30 à¹€à¸¡à¸•à¸£", "à¸šà¸¸à¸”à¹‰à¸§à¸¢à¸«à¸´à¸™à¸ªà¸šà¸¹à¹ˆ", "à¸¥à¹ˆà¸­à¸Ÿà¹‰à¸²à¸œà¹ˆà¸²à¸šà¹ˆà¸­à¸¢à¸¡à¸²à¸"], myth: "à¸„à¸­à¸¢à¸›à¸à¸›à¹‰à¸­à¸‡à¹€à¸¡à¸·à¸­à¸‡à¸ˆà¸²à¸à¸„à¸§à¸²à¸¡à¹€à¸à¸£à¸µà¹‰à¸¢à¸§à¸à¸£à¸²à¸”à¸‚à¸­à¸‡à¸—à¸°à¹€à¸¥" }
    }
};

const FOLK_DB = [
    { lat: 13.75, lon: 100.50, th: {t:"à¸¢à¸±à¸à¸©à¹Œà¸§à¸±à¸”à¹à¸ˆà¹‰à¸‡ vs à¸¢à¸±à¸à¸©à¹Œà¸§à¸±à¸”à¹‚à¸žà¸˜à¸´à¹Œ", b:"à¸„à¸™à¹€à¸à¹ˆà¸²à¹à¸à¹€à¸¥à¹ˆà¸²à¸§à¹ˆà¸²à¸¢à¸±à¸à¸©à¹Œà¸ªà¸­à¸‡à¸à¸±à¹ˆà¸‡à¹à¸¡à¹ˆà¸™à¹‰à¸³à¹€à¸„à¸¢à¸•à¸µà¸à¸±à¸™à¸ˆà¸™à¸žà¸·à¹‰à¸™à¸—à¸µà¹ˆà¹€à¸•à¸µà¸¢à¸™à¹‚à¸¥à¹ˆà¸‡à¸à¸¥à¸²à¸¢à¹€à¸›à¹‡à¸™ 'à¸—à¹ˆà¸²à¹€à¸•à¸µà¸¢à¸™' à¹ƒà¸™à¸›à¸±à¸ˆà¸ˆà¸¸à¸šà¸±à¸™"}, en: {t:"The Giants' Battle", b:"Legend says giants from two temples fought here, flattening the land into what is now 'Tha Tien'."} },
    { lat: 18.79, lon: 98.98, th: {t:"à¸•à¸³à¸™à¸²à¸™à¸›à¸¹à¹ˆà¹à¸ªà¸°à¸¢à¹ˆà¸²à¹à¸ªà¸°", b:"à¸¢à¸±à¸à¸©à¹Œà¸œà¸¹à¹‰à¸›à¸à¸›à¸±à¸à¸©à¹Œà¸£à¸±à¸à¸©à¸²à¸”à¸­à¸¢à¸ªà¸¸à¹€à¸—à¸ž à¸ªà¸±à¸à¸à¸²à¸§à¹ˆà¸²à¸ˆà¸°à¹„à¸¡à¹ˆà¸à¸´à¸™à¹€à¸™à¸·à¹‰à¸­à¸¡à¸™à¸¸à¸©à¸¢à¹Œà¹à¸¥à¸à¸à¸±à¸šà¸à¸²à¸£à¸£à¸±à¸à¸©à¸²à¸œà¸·à¸™à¸›à¹ˆà¸²"}, en: {t:"Guardians of the Mountain", b:"Two giants guard Doi Suthep. They swore to protect the forest and never harm humans."} },
    { lat: 14.35, lon: 100.57, th: {t:"à¸„à¸³à¸ªà¸²à¸›à¸à¸£à¸¸à¸‡à¹€à¸à¹ˆà¸²", b:"à¹€à¸Šà¸·à¹ˆà¸­à¸à¸±à¸™à¸§à¹ˆà¸²à¸ªà¸¡à¸šà¸±à¸•à¸´à¸—à¸µà¹ˆà¸–à¸¹à¸à¸à¸±à¸‡à¹„à¸§à¹‰à¹ƒà¸™à¸­à¸¢à¸¸à¸˜à¸¢à¸²à¸¡à¸µà¸§à¸´à¸à¸à¸²à¸“à¸›à¸¹à¹ˆà¹‚à¸ªà¸¡à¹€à¸à¹‰à¸²à¸—à¸£à¸±à¸žà¸¢à¹Œ à¹ƒà¸„à¸£à¸‚à¸¸à¸”à¹„à¸›à¸•à¹‰à¸­à¸‡à¸¡à¸µà¸­à¸±à¸™à¹€à¸›à¹‡à¸™à¹„à¸›"}, en: {t:"Curse of the Old Capital", b:"Buried treasures in Ayutthaya are guarded by ancient spirits. Thieves never find peace."} },
    { lat: 8.08, lon: 98.90, th: {t:"à¸–à¹‰à¸³à¸žà¸à¸²à¸™à¸²à¸„", b:"à¸Šà¸²à¸§à¸šà¹‰à¸²à¸™à¹€à¸Šà¸·à¹ˆà¸­à¸§à¹ˆà¸²à¸–à¹‰à¸³à¹ƒà¸•à¹‰à¸™à¹‰à¸³à¹à¸–à¸šà¸™à¸µà¹‰à¹€à¸Šà¸·à¹ˆà¸­à¸¡à¸•à¹ˆà¸­à¹„à¸›à¸¢à¸±à¸‡à¹€à¸¡à¸·à¸­à¸‡à¸šà¸²à¸”à¸²à¸¥à¸‚à¸­à¸‡à¸žà¸à¸²à¸™à¸²à¸„à¹„à¸”à¹‰"}, en: {t:"Naga Cave", b:"Locals believe these underwater caves are gateways to the mythical Naga kingdom."} }
];

const WONDERS_COORDS = {
    "Great Pyramid of Giza": { lat: 29.9792, lon: 31.1342 },
    "Stonehenge": { lat: 51.1789, lon: -1.8262 },
    "Great Wall of China": { lat: 40.4319, lon: 116.5704 },
    "Petra": { lat: 30.3285, lon: 35.4444 },
    "Colosseum": { lat: 41.8902, lon: 12.4922 },
    "Chichen Itza": { lat: 20.6843, lon: -88.5678 },
    "Machu Picchu": { lat: -13.1631, lon: -72.5450 },
    "Taj Mahal": { lat: 27.1751, lon: 78.0421 },
    "Christ the Redeemer": { lat: -22.9519, lon: -43.2105 }
};

// --- 3. MATH UTILS ---
const MathUtils = {
    toRad: d => d * Math.PI / 180,
    toDeg: r => r * 180 / Math.PI,
    dist: (lat1, lon1, lat2, lon2) => {
        const R = 6371; const dLat = MathUtils.toRad(lat2-lat1); const dLon = MathUtils.toRad(lon2-lon1);
        const a = Math.sin(dLat/2)**2 + Math.cos(MathUtils.toRad(lat1))*Math.cos(MathUtils.toRad(lat2))*Math.sin(dLon/2)**2;
        return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
    },
    bearing: (lat1, lon1, lat2, lon2) => {
        const y = Math.sin(MathUtils.toRad(lon2-lon1)) * Math.cos(MathUtils.toRad(lat2));
        const x = Math.cos(MathUtils.toRad(lat1))*Math.sin(MathUtils.toRad(lat2)) - Math.sin(MathUtils.toRad(lat1))*Math.cos(MathUtils.toRad(lat2))*Math.cos(MathUtils.toRad(lon2-lon1));
        return (MathUtils.toDeg(Math.atan2(y, x)) + 360) % 360;
    },
    lerpAngle: (curr, target, factor) => {
        let delta = target - curr;
        if (delta > 180) delta -= 360; if (delta < -180) delta += 360;
        return curr + delta * factor;
    }
};

// --- 4. SENSOR ENGINE (FUSION) ---
class SensorEngine {
    constructor() {
        this.heading = 0;
        this.rawHeading = 0;
        this.gps = { lat: null, lon: null };
        this.mag = { val: 0, active: false };
        this.magWindow = [];
        this.isTiltBad = false;
        this.needsCalib = false;
        this.cbs = {};
    }

    init() {
        return new Promise(async (resolve, reject) => {
            // GPS
            if("geolocation" in navigator) {
                navigator.geolocation.watchPosition(
                    p => { this.gps = { lat: p.coords.latitude, lon: p.coords.longitude }; this.emit('gps'); },
                    e => console.warn(e), { enableHighAccuracy: true, maximumAge: 0 }
                );
            }

            // ORIENTATION
            if (typeof DeviceOrientationEvent !== 'undefined' && typeof DeviceOrientationEvent.requestPermission === 'function') {
                try {
                    const r = await DeviceOrientationEvent.requestPermission();
                    if(r === 'granted') {
                        window.addEventListener('deviceorientation', e => this.handleiOS(e));
                        resolve();
                    } else reject();
                } catch(e) { reject(e); }
            } else {
                // Android Priority: Absolute > Standard
                if('ondeviceorientationabsolute' in window) {
                    window.addEventListener('deviceorientationabsolute', e => this.handleAndroid(e, true));
                } else {
                    window.addEventListener('deviceorientation', e => this.handleAndroid(e, false));
                }
                
                // Mag Sensor
                if ('Magnetometer' in window) {
                    try {
                        // @ts-ignore
                        const mag = new Magnetometer({ frequency: 30 });
                        mag.addEventListener('reading', () => {
                            const m = Math.sqrt(mag.x**2 + mag.y**2 + mag.z**2);
                            this.mag = { val: m, active: true };
                            this.magWindow.push(m);
                            if(this.magWindow.length > 120) this.magWindow.shift();
                        });
                        mag.start();
                    } catch(e){}
                }
                resolve();
            }
        });
    }

    handleiOS(e) {
        if(e.webkitCompassHeading) {
            // iOS heading is typically very good but needs screen orient check
            let h = e.webkitCompassHeading;
            // Simple screen orient comp
            const orient = window.screen.orientation ? window.screen.orientation.angle : 0;
            this.rawHeading = (h + orient) % 360;
            this.isTiltBad = (Math.abs(e.beta) > 45 || Math.abs(e.gamma) > 45); // Warn if holding weird
        }
    }

    handleAndroid(e, abs) {
        if(abs && e.alpha !== null) {
            // Basic absolute orientation
            let h = 360 - e.alpha;
            // Basic tilt comp warning
            this.isTiltBad = (Math.abs(e.beta) > 45 || Math.abs(e.gamma) > 45);
            // Screen Comp
            const orient = window.screen.orientation ? window.screen.orientation.angle : 0;
            this.rawHeading = (h - orient + 360) % 360;
        } else if (e.alpha !== null) {
            // Relative fallback
            this.rawHeading = 360 - e.alpha; // Will drift
            this.needsCalib = true;
        }
    }

    update() {
        // Smoothing
        this.heading = MathUtils.lerpAngle(this.heading, this.rawHeading, 0.15);
        return this.heading;
    }

    on(ev, fn) { this.cbs[ev] = fn; }
    emit(ev) { if(this.cbs[ev]) this.cbs[ev](); }
}

// --- 5. MAIN APP CONTROLLER ---
class App {
    constructor() {
        this.i18n = new I18n();
        this.sensor = new SensorEngine();
        this.mode = 'wonder';
        this.wonders = Object.keys(WONDERS_COORDS).map(k => ({name:k, ...WONDERS_COORDS[k]}));
        this.state = { idx: 0, auto: true, decl: 0, dispHead: 0 };
        
        // Setup UI Refs
        this.ui = {
            ring: document.getElementById('orb-ring'),
            nTarget: document.getElementById('n-target'),
            nTrue: document.getElementById('n-true'),
            nMag: document.getElementById('n-mag'),
            hudVal: document.getElementById('val-head'),
            radar: document.getElementById('monitor-ui'),
            scope: document.getElementById('scope-cvs'),
            loreCard: document.getElementById('card-lore'),
            omenCard: document.getElementById('card-omen'),
            warn: document.getElementById('calib-warn'),
            btnLang: document.getElementById('btn-lang'),
            actions: document.getElementById('row-actions')
        };

        // Canvas Scope
        this.ctx = this.ui.scope.getContext('2d');
        this.ui.scope.width = 80; this.ui.scope.height = 40;

        // Init State
        this.ui.btnLang.innerText = this.i18n.lang.toUpperCase();
        this.updateAutoBtn();
    }

    async start() {
        try {
            await this.sensor.init();
            document.getElementById('modal-perm').classList.remove('show');
            document.getElementById('app').classList.remove('hidden');
            
            this.sensor.on('gps', () => {
                const el = document.getElementById('gps-stat');
                el.innerText = this.i18n.t('gps_lock');
                el.classList.add('active');
                if(this.state.auto) this.findNearest();
                else this.updateDist();
            });

            this.updateLore();
            this.loop();
        } catch(e) { alert("Error: " + e); }
    }

    // --- LOGIC: WONDER ---
    findNearest() {
        if(!this.sensor.gps.lat) return;
        let min = Infinity; let idx = 0;
        this.wonders.forEach((w, i) => {
            const d = MathUtils.dist(this.sensor.gps.lat, this.sensor.gps.lon, w.lat, w.lon);
            if(d < min) { min = d; idx = i; }
        });
        if(this.state.idx !== idx) {
            this.state.idx = idx;
            this.updateLore();
        }
    }

    nextTarget() {
        this.state.auto = false;
        this.updateAutoBtn();
        this.state.idx = (this.state.idx + 1) % this.wonders.length;
        this.updateLore();
    }

    toggleAuto() {
        this.state.auto = !this.state.auto;
        this.updateAutoBtn();
        if(this.state.auto) this.findNearest();
    }

    updateAutoBtn() {
        const btn = document.getElementById('btn-auto');
        btn.querySelector('span:last-child').innerText = this.i18n.t(this.state.auto ? 'btn_auto' : 'btn_manual');
        if(this.state.auto) btn.classList.add('active'); else btn.classList.remove('active');
    }

    // --- LOGIC: UI UPDATES ---
    updateLore() {
        const w = this.wonders[this.state.idx];
        const info = LORE_DB[w.name] ? LORE_DB[w.name][this.i18n.lang] : null;
        
        document.getElementById('lore-title').innerText = w.name;
        document.getElementById('lore-short').innerText = info ? info.short : this.i18n.t('lore_load');
        document.getElementById('lore-facts').innerHTML = info ? info.facts.map(f=>`<li>${f}</li>`).join('') : '';
        document.getElementById('lore-myth').innerText = info ? `"${info.myth}"` : '';
        
        this.updateDist();
    }

    updateDist() {
        if(!this.sensor.gps.lat) return;
        const w = this.wonders[this.state.idx];
        const d = MathUtils.dist(this.sensor.gps.lat, this.sensor.gps.lon, w.lat, w.lon);
        document.getElementById('lore-dist').innerText = d < 1 ? (d*1000).toFixed(0)+" m" : d.toFixed(1)+" km";
    }

    updateOmen() {
        // Deterministic Seed or Real Mag
        const seed = (this.sensor.gps.lat||0) + (this.sensor.gps.lon||0) + Math.floor(Date.now()/5000);
        let lvl = 0;
        
        if(this.sensor.mag.active && this.sensor.magWindow.length > 10) {
            const mean = this.sensor.magWindow.reduce((a,b)=>a+b,0)/this.sensor.magWindow.length;
            const variance = this.sensor.magWindow.reduce((a,b)=>a+(b-mean)**2,0)/this.sensor.magWindow.length;
            const std = Math.sqrt(variance);
            if(std > 5) lvl=3; else if(std > 2) lvl=2; else if(std > 0.5) lvl=1;
        } else {
            // iPhone Fallback
            const noise = Math.abs(Math.sin(seed));
            if(noise > 0.85) lvl=2; else if(noise > 0.6) lvl=1;
        }

        const codes = ['q', 'r', 'd', 'p'];
        const title = document.getElementById('omen-title');
        title.innerText = this.i18n.t('omen_'+codes[lvl]);
        title.style.color = lvl > 1 ? 'var(--neon-r)' : (lvl > 0 ? 'var(--neon-b)' : 'var(--neon-g)');
        
        document.getElementById('omen-text').innerText = this.i18n.t(lvl > 0 ? 'flavor_a' : 'flavor_q');
        return lvl;
    }

    // --- LOOP ---
    loop() {
        requestAnimationFrame(() => this.loop());
        
        // 1. Heading & Tilt
        const head = this.sensor.update();
        this.state.dispHead = head;
        this.ui.ring.style.transform = `rotate(${-head}deg)`;
        this.ui.hudVal.innerText = Math.round(head).toString().padStart(3,'0') + "Â°";
        
        // Tilt Warn
        if(this.sensor.isTiltBad) {
            this.ui.warn.innerText = this.i18n.t('warn_tilt');
            this.ui.warn.classList.add('show');
        } else if (this.sensor.needsCalib) {
            this.ui.warn.innerText = this.i18n.t('warn_calib');
            this.ui.warn.classList.add('show');
        } else {
            this.ui.warn.classList.remove('show');
        }

        // 2. Needles
        if(this.mode === 'wonder' && this.sensor.gps.lat) {
            const w = this.wonders[this.state.idx];
            const bearing = MathUtils.bearing(this.sensor.gps.lat, this.sensor.gps.lon, w.lat, w.lon);
            // Rot relative to North (which is at 0 in needle space, but Ring rotated -Head)
            // Wait, if Ring rotated -Head, N is at North. Needle just needs Bearing.
            this.ui.nTarget.style.transform = `translateX(-50%) rotate(${bearing}deg)`;
        } else if (this.mode === 'earth') {
            const trueH = -this.state.decl;
            this.ui.nTrue.style.transform = `translateX(-50%) rotate(${trueH}deg)`;
            this.ui.nMag.style.transform = `translateX(-50%) rotate(0deg)`;
        } else if (this.mode === 'myth') {
            const lvl = this.updateOmen();
            // Glitch Needle
            const wander = Math.sin(Date.now()/500) * (lvl * 15);
            this.ui.nTarget.style.transform = `translateX(-50%) rotate(${wander}deg)`;
            
            // Scope Draw
            this.drawScope(this.sensor.magWindow, lvl);
            // Random Radar Blip
            if(Math.random() < (lvl * 0.02)) this.addBlip();
        }
    }

    drawScope(data, lvl) {
        this.ctx.clearRect(0,0,80,40);
        this.ctx.strokeStyle = lvl > 1 ? '#f43f5e' : '#60a5fa';
        this.ctx.lineWidth = 1.5;
        this.ctx.beginPath();
        if(data.length) {
            const min = Math.min(...data); const max = Math.max(...data);
            const r = max-min || 1;
            for(let i=0; i<data.length; i++) {
                let x = (i/120)*80; let y = 40 - ((data[i]-min)/r)*40;
                if(i===0) this.ctx.moveTo(x,y); else this.ctx.lineTo(x,y);
            }
        } else {
            // Fake line
            const t = Date.now()/200;
            for(let i=0; i<80; i+=5) {
                let y = 20 + Math.sin(t + i*0.1) * (5 + lvl*5);
                if(i===0) this.ctx.moveTo(i,y); else this.ctx.lineTo(i,y);
            }
        }
        this.ctx.stroke();
    }

    addBlip() {
        const el = document.createElement('div');
        el.className = 'blip';
        const angle = Math.random() * 6.28;
        const dist = 10 + Math.random() * 40;
        el.style.left = (50 + Math.cos(angle)*dist) + '%';
        el.style.top = (50 + Math.sin(angle)*dist) + '%';
        document.querySelector('.radar-ring').appendChild(el);
        setTimeout(()=>el.remove(), 2000);
    }

    // --- ACTIONS ---
    setMode(m) {
        this.mode = m;
        document.querySelectorAll('.dock-item').forEach(b => b.classList.remove('active'));
        event.target.classList.add('active');

        // Toggle Vis
        const u = this.ui;
        u.nTarget.style.opacity = m==='wonder'||m==='myth' ? 1:0;
        u.nTrue.style.opacity = m==='earth'?1:0; u.nMag.style.opacity = m==='earth'?1:0;
        
        u.loreCard.classList.toggle('hidden', m==='myth');
        u.omenCard.classList.toggle('hidden', m!=='myth');
        u.radar.style.display = m==='myth'?'block':'none';
        u.scope.style.display = m==='myth'?'block':'none';
        u.actions.style.display = m==='wonder'?'grid':'none';

        if(m==='earth') {
            document.getElementById('lore-title').innerText = this.i18n.t('mode_earth');
            document.getElementById('lore-short').innerText = this.sensor.mag.active ? `${this.sensor.mag.val.toFixed(1)} ÂµT` : this.i18n.t('err_mag');
            document.getElementById('lore-facts').innerHTML = ''; document.getElementById('lore-myth').innerText = '';
        } else if (m==='wonder') {
            this.updateLore();
        }
    }

    toggleLang() {
        this.i18n.toggle();
        this.updateLore();
        this.updateAutoBtn();
        this.i18n.apply();
    }

    toggleSettings() {
        const el = document.getElementById('modal-set');
        el.classList.toggle('show');
        el.style.pointerEvents = el.classList.contains('show') ? 'auto' : 'none';
    }

    fetchDecl() {
        if(!this.sensor.gps.lat) return alert("Wait for GPS");
        const url = `https://www.ngdc.noaa.gov/geomag-web/calculators/calculateDeclination?lat1=${this.sensor.gps.lat}&lon1=${this.sensor.gps.lon}&resultFormat=json`;
        fetch(url).then(r=>r.json()).then(d=>{
            this.state.decl = d.result[0].declination;
            document.getElementById('inp-decl').value = this.state.decl.toFixed(2);
            alert("Updated: " + this.state.decl);
        }).catch(()=>alert(this.i18n.t('err_cors')));
    }

    // Folklore Modal
    showLocalLegend() {
        if(!this.sensor.gps.lat) return alert("GPS Required");
        let min = Infinity; let story = FOLK_DB[0];
        FOLK_DB.forEach(f => {
            const d = MathUtils.dist(this.sensor.gps.lat, this.sensor.gps.lon, f.lat, f.lon);
            if(d < min) { min = d; story = f; }
        });
        const content = story[this.i18n.lang];
        document.getElementById('folk-title').innerText = content.t;
        document.getElementById('folk-body').innerText = content.b;
        document.getElementById('folk-meta').innerText = `Source: Local Archives (~${min.toFixed(1)}km)`;
        const el = document.getElementById('modal-folk');
        el.classList.add('show'); el.style.pointerEvents = 'auto';
    }
    closeLegend() {
        const el = document.getElementById('modal-folk');
        el.classList.remove('show'); el.style.pointerEvents = 'none';
    }
    openMap() {
        const w = this.wonders[this.state.idx];
        window.open(`https://maps.google.com/?q=${w.lat},${w.lon}`);
    }
}

// Init
const app = new App();
document.getElementById('btn-init').addEventListener('click', () => app.start());
document.getElementById('btn-lang').addEventListener('click', () => app.toggleLang());

</script>
</body>
</html>
