<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>AI Mobile Spectrometer Console</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    :root {
      --bg: #050711;
      --panel: rgba(10, 16, 40, 0.9);
      --accent: #39f5ff;
      --accent2: #ff4fbf;
      --text: #f5f7ff;
      --muted: #7a87b8;
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "SF Pro Text", sans-serif;
    }

    body {
      background: radial-gradient(circle at top, #10152f 0%, #050711 55%, #000000 100%);
      color: var(--text);
      min-height: 100vh;
      display: flex;
      align-items: stretch;
      justify-content: center;
      padding: 12px;
    }

    .shell {
      width: 100%;
      max-width: 1100px;
      background: linear-gradient(135deg, rgba(120, 180, 255, 0.08), rgba(255, 80, 180, 0.08));
      border-radius: 24px;
      padding: 1px;
      box-shadow: 0 0 40px rgba(0, 0, 0, 0.8);
    }

    .inner {
      background: radial-gradient(circle at top left, rgba(85, 160, 255, 0.12), rgba(0, 0, 0, 0.96));
      border-radius: 23px;
      padding: 16px;
      display: grid;
      grid-template-columns: minmax(0, 1.1fr) minmax(0, 1.1fr) minmax(0, 0.9fr);
      gap: 12px;
    }

    @media (max-width: 900px) {
      .inner {
        grid-template-columns: minmax(0, 1fr);
      }
    }

    header {
      grid-column: 1/-1;
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 8px;
      gap: 12px;
    }

    h1 {
      font-size: 18px;
      letter-spacing: 0.18em;
      text-transform: uppercase;
      color: #f9fbff;
    }

    .subtitle {
      font-size: 11px;
      color: var(--muted);
      margin-top: 2px;
    }

    .status-bar {
      display: flex;
      gap: 8px;
      align-items: center;
      font-size: 11px;
    }

    .pill {
      padding: 4px 10px;
      border-radius: 999px;
      background: rgba(12, 228, 255, 0.08);
      border: 1px solid rgba(112, 220, 255, 0.4);
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .pill-dot {
      width: 7px;
      height: 7px;
      border-radius: 50%;
      background: #39ff9f;
      box-shadow: 0 0 8px #39ff9f;
    }

    .clock {
      font-family: "SF Mono", ui-monospace, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      padding: 4px 8px;
      border-radius: 8px;
      border: 1px solid rgba(140, 160, 220, 0.5);
      background: radial-gradient(circle at top, rgba(112, 210, 255, 0.2), rgba(3, 7, 25, 0.9));
    }

    .panel {
      background: var(--panel);
      border-radius: 18px;
      padding: 10px;
      border: 1px solid rgba(120, 170, 255, 0.35);
      box-shadow: 0 0 0 1px rgba(0, 0, 0, 0.6) inset;
      position: relative;
      overflow: hidden;
    }

    .panel::before {
      content: "";
      position: absolute;
      inset: -40%;
      background: radial-gradient(circle at top left, rgba(80, 200, 255, 0.12), transparent 50%);
      opacity: 0.7;
      pointer-events: none;
    }

    .panel-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 6px;
      position: relative;
      z-index: 1;
    }

    .panel-title {
      font-size: 12px;
      text-transform: uppercase;
      letter-spacing: 0.17em;
      color: #9fb4ff;
    }

    .badge {
      font-size: 9px;
      text-transform: uppercase;
      padding: 2px 8px;
      border-radius: 999px;
      border: 1px solid rgba(180, 205, 255, 0.55);
      background: rgba(10, 20, 60, 0.8);
      color: var(--muted);
    }

    .panel-body {
      position: relative;
      z-index: 1;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    video, canvas {
      width: 100%;
      border-radius: 12px;
      background: #000;
      display: block;
    }

    .controls {
      display: flex;
      flex-direction: column;
      gap: 6px;
      font-size: 11px;
    }

    .controls-row {
      display: flex;
      gap: 6px;
      flex-wrap: wrap;
    }

    button {
      background: radial-gradient(circle at top, #39f5ff, #2288ff);
      border: none;
      padding: 6px 12px;
      border-radius: 999px;
      color: #000;
      font-size: 11px;
      font-weight: 600;
      cursor: pointer;
      box-shadow: 0 0 12px rgba(56, 214, 255, 0.7);
      transition: transform 0.08s ease, box-shadow 0.08s ease, filter 0.08s ease;
      white-space: nowrap;
    }

    button.secondary {
      background: rgba(18, 28, 68, 1);
      color: var(--muted);
      border: 1px solid rgba(130, 160, 240, 0.7);
      box-shadow: none;
    }

    button:active {
      transform: scale(0.96);
      box-shadow: 0 0 6px rgba(56, 214, 255, 0.4);
      filter: brightness(0.95);
    }

    .slider-group {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
    }

    .slider-group label {
      font-size: 11px;
      color: var(--muted);
    }

    input[type="range"] {
      flex: 1;
    }

    .value-chip {
      font-size: 10px;
      padding: 2px 6px;
      border-radius: 999px;
      background: rgba(18, 30, 70, 0.95);
      border: 1px solid rgba(120, 160, 255, 0.7);
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
    }

    .stat-grid {
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 6px;
    }

    .stat {
      background: rgba(7, 12, 38, 0.95);
      border-radius: 10px;
      padding: 6px;
      border: 1px solid rgba(90, 130, 230, 0.65);
      font-size: 10px;
    }

    .stat-label {
      color: var(--muted);
      margin-bottom: 2px;
    }

    .stat-value {
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      font-size: 11px;
      color: #e5efff;
    }

    .log {
      max-height: 220px;
      overflow: auto;
      padding-right: 4px;
      font-size: 10px;
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
    }

    .log-entry {
      margin-bottom: 4px;
      color: #bac6ff;
      border-left: 2px solid rgba(110, 160, 255, 0.7);
      padding-left: 6px;
    }

    .log-entry span.time {
      color: #7f96ff;
      margin-right: 4px;
    }

    .spectrum-legend {
      display: flex;
      justify-content: space-between;
      font-size: 9px;
      color: var(--muted);
      margin-top: -4px;
    }

    .chip-inline {
      font-size: 9px;
      padding: 2px 6px;
      border-radius: 999px;
      background: rgba(60, 20, 80, 0.9);
      border: 1px solid rgba(255, 120, 220, 0.8);
      color: #ffcfff;
    }
  </style>
</head>
<body>
  <div class="shell">
    <div class="inner">
      <header>
        <div>
          <h1>AI MOBILE SPECTROMETER</h1>
          <div class="subtitle">Field-grade pseudo-spectral analyzer using phone camera + real-time statistics</div>
        </div>
        <div class="status-bar">
          <div class="pill">
            <div class="pill-dot" id="status-dot"></div>
            <span id="status-text">IDLE</span>
          </div>
          <div class="clock" id="clock">--:--:--</div>
        </div>
      </header>

      <!-- Left: Camera & Controls -->
      <section class="panel">
        <div class="panel-header">
          <div class="panel-title">Capture & Control</div>
          <div class="badge">CAMERA / ROI</div>
        </div>
        <div class="panel-body">
          <video id="video" autoplay playsinline muted></video>
          <canvas id="roiCanvas" style="display:none;"></canvas>

          <div class="controls">
            <div class="controls-row">
              <button id="btnStart">Start Camera</button>
              <button id="btnSample" class="secondary">Sample Frame</button>
            </div>
            <div class="slider-group">
              <label for="roiSize">ROI size</label>
              <input type="range" id="roiSize" min="10" max="60" value="30">
              <span class="value-chip" id="roiSizeVal">30%</span>
            </div>
            <div class="slider-group">
              <label for="smoothFactor">Smoothing</label>
              <input type="range" id="smoothFactor" min="0" max="0.9" step="0.05" value="0.5">
              <span class="value-chip" id="smoothVal">0.50</span>
            </div>
          </div>
        </div>
      </section>

      <!-- Middle: Spectrum Visualizer -->
      <section class="panel">
        <div class="panel-header">
          <div class="panel-title">Pseudo-Spectrum</div>
          <div class="badge chip-inline">R/G/B channel intensity</div>
        </div>
        <div class="panel-body">
          <canvas id="spectrumCanvas" height="200"></canvas>
          <div class="spectrum-legend">
            <span>Left: Dark / low intensity</span>
            <span>Right: Bright / high intensity</span>
          </div>

          <div class="stat-grid">
            <div class="stat">
              <div class="stat-label">Mean RGB</div>
              <div class="stat-value" id="meanRgb">R: -, G: -, B: -</div>
            </div>
            <div class="stat">
              <div class="stat-label">Normalized ratios</div>
              <div class="stat-value" id="ratios">r: -, g: -, b: -</div>
            </div>
            <div class="stat">
              <div class="stat-label">Last sample size</div>
              <div class="stat-value" id="sampleSize">- pixels</div>
            </div>
            <div class="stat">
              <div class="stat-label">AI model</div>
              <div class="stat-value">not attached (placeholder)</div>
            </div>
          </div>
        </div>
      </section>

      <!-- Right: Log & Meta -->
      <section class="panel">
        <div class="panel-header">
          <div class="panel-title">Acquisition Log</div>
          <div class="badge">EXPERIMENT TRACE</div>
        </div>
        <div class="panel-body">
          <div class="stat" style="margin-bottom:6px;">
            <div class="stat-label">Experiment notes</div>
            <div class="stat-value" id="noteHint">
              Align the sample in the center of the frame, keep lighting stable, and press <strong>Sample Frame</strong> repeatedly to build a spectral profile.
            </div>
          </div>
          <div class="log" id="log"></div>
        </div>
      </section>
    </div>
  </div>

  <script>
    "use strict";

    /**
     * AI Mobile Spectrometer Prototype
     *
     * This prototype does:
     * - Uses the phone camera to capture frames.
     * - Extracts a central Region Of Interest (ROI).
     * - Computes per-channel (R, G, B) means and a simple 1D "pseudo-spectrum"
     *   by averaging along a strip of pixels.
     * - Visualizes those values as line plots on a canvas.
     *
     * The idea is to provide a physically grounded data stream that can later be
     * fed into a proper ML model (e.g. via TF.js or backend API) to classify
     * materials / chemical color reactions based on the spectral-like response.
     *
     * It is NOT a true spectrometer (no diffraction grating, no narrow bands),
     * but rather uses broadband camera channels and spatial averaging to be as
     * close as possible given only the mobile sensor.
     */

    const video = document.getElementById("video");
    const roiCanvas = document.getElementById("roiCanvas");
    const spectrumCanvas = document.getElementById("spectrumCanvas");
    const logEl = document.getElementById("log");
    const statusDot = document.getElementById("status-dot");
    const statusText = document.getElementById("status-text");

    const roiSizeSlider = document.getElementById("roiSize");
    const roiSizeVal = document.getElementById("roiSizeVal");
    const smoothSlider = document.getElementById("smoothFactor");
    const smoothVal = document.getElementById("smoothVal");

    const meanRgbEl = document.getElementById("meanRgb");
    const ratiosEl = document.getElementById("ratios");
    const sampleSizeEl = document.getElementById("sampleSize");

    let stream = null;
    let lastSpectrum = null;

    function setStatus(state) {
      if (state === "IDLE") {
        statusDot.style.background = "#39ff9f";
        statusDot.style.boxShadow = "0 0 8px #39ff9f";
        statusText.textContent = "IDLE";
      } else if (state === "CAPTURING") {
        statusDot.style.background = "#39f5ff";
        statusDot.style.boxShadow = "0 0 8px #39f5ff";
        statusText.textContent = "CAPTURING";
      } else if (state === "ERROR") {
        statusDot.style.background = "#ff4f7b";
        statusDot.style.boxShadow = "0 0 10px #ff4f7b";
        statusText.textContent = "ERROR";
      }
    }

    function log(message) {
      const now = new Date();
      const t = now.toTimeString().slice(0, 8);
      const div = document.createElement("div");
      div.className = "log-entry";
      div.innerHTML = '<span class="time">[' + t + ']</span>' + message;
      logEl.prepend(div);
    }

    async function startCamera() {
      try {
        if (stream) return;
        stream = await navigator.mediaDevices.getUserMedia({
          video: { facingMode: "environment" },
          audio: false
        });
        video.srcObject = stream;
        setStatus("CAPTURING");
        log("Camera started with environment-facing mode.");
      } catch (err) {
        console.error(err);
        setStatus("ERROR");
        log("ERROR: Unable to access camera. " + err.message);
      }
    }

    function sampleFrame() {
      if (!video.videoWidth || !video.videoHeight) {
        log("Sampling skipped: video not ready.");
        return;
      }
      const vw = video.videoWidth;
      const vh = video.videoHeight;

      roiCanvas.width = vw;
      roiCanvas.height = vh;
      const ctx = roiCanvas.getContext("2d");
      ctx.drawImage(video, 0, 0, vw, vh);

      const roiPercent = parseInt(roiSizeSlider.value, 10) / 100;
      const roiW = vw * roiPercent;
      const roiH = vh * roiPercent;
      const roiX = (vw - roiW) / 2;
      const roiY = (vh - roiH) / 2;

      const imageData = ctx.getImageData(roiX, roiY, roiW, roiH);
      const data = imageData.data;
      const totalPixels = roiW * roiH;

      let sumR = 0, sumG = 0, sumB = 0;

      // We also build a 1D pseudo-spectrum by sampling a horizontal strip
      // across the ROI and averaging RGB per x-position.
      const stripY = Math.floor(roiH / 2);
      const spectrumLength = 64;
      const stepX = roiW / spectrumLength;
      const pseudoSpectrum = {
        r: new Array(spectrumLength).fill(0),
        g: new Array(spectrumLength).fill(0),
        b: new Array(spectrumLength).fill(0)
      };
      const pseudoCounts = new Array(spectrumLength).fill(0);

      for (let y = 0; y < roiH; y++) {
        for (let x = 0; x < roiW; x++) {
          const idx = (y * roiW + x) * 4;
          const r = data[idx];
          const g = data[idx + 1];
          const b = data[idx + 2];

          sumR += r;
          sumG += g;
          sumB += b;

          if (y === stripY) {
            const bin = Math.min(spectrumLength - 1, Math.floor(x / stepX));
            pseudoSpectrum.r[bin] += r;
            pseudoSpectrum.g[bin] += g;
            pseudoSpectrum.b[bin] += b;
            pseudoCounts[bin] += 1;
          }
        }
      }

      for (let i = 0; i < spectrumLength; i++) {
        const c = pseudoCounts[i] || 1;
        pseudoSpectrum.r[i] /= c;
        pseudoSpectrum.g[i] /= c;
        pseudoSpectrum.b[i] /= c;
      }

      const meanR = sumR / totalPixels;
      const meanG = sumG / totalPixels;
      const meanB = sumB / totalPixels;

      const total = meanR + meanG + meanB || 1;
      const nr = meanR / total;
      const ng = meanG / total;
      const nb = meanB / total;

      meanRgbEl.textContent = `R: ${meanR.toFixed(1)}, G: ${meanG.toFixed(1)}, B: ${meanB.toFixed(1)}`;
      ratiosEl.textContent = `r: ${nr.toFixed(3)}, g: ${ng.toFixed(3)}, b: ${nb.toFixed(3)}`;
      sampleSizeEl.textContent = totalPixels + " pixels";

      const smoothFactor = parseFloat(smoothSlider.value);
      if (!lastSpectrum) {
        lastSpectrum = pseudoSpectrum;
      } else {
        for (let i = 0; i < spectrumLength; i++) {
          lastSpectrum.r[i] = lastSpectrum.r[i] * smoothFactor + pseudoSpectrum.r[i] * (1 - smoothFactor);
          lastSpectrum.g[i] = lastSpectrum.g[i] * smoothFactor + pseudoSpectrum.g[i] * (1 - smoothFactor);
          lastSpectrum.b[i] = lastSpectrum.b[i] * smoothFactor + pseudoSpectrum.b[i] * (1 - smoothFactor);
        }
      }

      drawSpectrum(lastSpectrum);
      log(`Sampled frame. ROI ~${(roiPercent * 100).toFixed(0)}%, mean RGB = (${meanR.toFixed(1)}, ${meanG.toFixed(1)}, ${meanB.toFixed(1)}).`);
    }

    function drawSpectrum(spec) {
      const ctx = spectrumCanvas.getContext("2d");
      const w = spectrumCanvas.width;
      const h = spectrumCanvas.height;
      ctx.clearRect(0, 0, w, h);

      if (!spec) return;
      const n = spec.r.length;
      const maxVal = 255;

      ctx.save();
      ctx.fillStyle = "rgba(3, 5, 20, 0.95)";
      ctx.fillRect(0, 0, w, h);

      ctx.strokeStyle = "rgba(80, 100, 200, 0.6)";
      ctx.lineWidth = 1;
      ctx.beginPath();
      for (let i = 0; i <= 4; i++) {
        const y = (h / 4) * i;
        ctx.moveTo(0, y);
        ctx.lineTo(w, y);
      }
      ctx.stroke();

      const drawLine = (values, color) => {
        ctx.strokeStyle = color;
        ctx.lineWidth = 2;
        ctx.beginPath();
        for (let i = 0; i < n; i++) {
          const x = (i / (n - 1)) * (w - 10) + 5;
          const v = values[i] / maxVal;
          const y = h - v * (h - 10) - 5;
          if (i === 0) ctx.moveTo(x, y);
          else ctx.lineTo(x, y);
        }
        ctx.stroke();
      };

      drawLine(spec.r, "rgba(255, 90, 120, 0.95)");
      drawLine(spec.g, "rgba(120, 255, 140, 0.95)");
      drawLine(spec.b, "rgba(90, 170, 255, 0.95)");

      ctx.restore();
    }

    document.getElementById("btnStart").addEventListener("click", startCamera);
    document.getElementById("btnSample").addEventListener("click", sampleFrame);

    roiSizeSlider.addEventListener("input", () => {
      roiSizeVal.textContent = roiSizeSlider.value + "%";
    });

    smoothSlider.addEventListener("input", () => {
      smoothVal.textContent = parseFloat(smoothSlider.value).toFixed(2);
    });

    function updateClock() {
      const now = new Date();
      document.getElementById("clock").textContent = now.toTimeString().slice(0, 8) + " UTCâ‰ˆ";
      requestAnimationFrame(updateClock);
    }
    updateClock();

    log("Ready. Press 'Start Camera' to begin acquisition.");
  </script>
</body>
</html>
