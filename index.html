<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>OMEGA: SENTINEL SYSTEM</title>
    
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/coco-ssd"></script>

    <style>
        /* --- VISUAL LANGUAGE: SCI-FI MILITARY --- */
        :root {
            --primary: #00ff41;      /* Matrix Green */
            --hostile: #ff0000;      /* Kill Red */
            --neutral: #ffcc00;      /* Warning Yellow */
            --bg: #000000;
            --glass: rgba(0, 20, 0, 0.85);
        }

        * { box-sizing: border-box; user-select: none; -webkit-touch-callout: none; }
        
        body {
            margin: 0; overflow: hidden; background: var(--bg);
            font-family: 'Consolas', 'Courier New', monospace;
            color: var(--primary); width: 100vw; height: 100vh;
        }

        /* --- LAYERS --- */
        #viewport { position: relative; width: 100%; height: 100%; }
        
        #cam-feed {
            position: absolute; width: 100%; height: 100%; object-fit: cover;
            z-index: 0; filter: brightness(0.7) contrast(1.2) grayscale(0.4) sepia(0.2);
        }
        
        #hud-canvas { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 10; }

        #ui-layer {
            position: absolute; inset: 0; z-index: 20; pointer-events: none;
            display: flex; flex-direction: column; justify-content: space-between;
            padding: max(15px, env(safe-area-inset-top));
        }

        /* --- WIDGETS --- */
        .panel {
            background: var(--glass); border-left: 3px solid var(--primary);
            padding: 5px 10px; margin: 5px; backdrop-filter: blur(4px);
            font-size: 12px; text-shadow: 0 0 5px var(--primary); width: fit-content;
            pointer-events: auto;
        }
        
        .btn {
            background: rgba(0,30,0,0.9); border: 1px solid var(--primary);
            color: var(--primary); padding: 10px 20px; font-weight: bold;
            cursor: pointer; text-transform: uppercase; font-family: inherit;
            transition: 0.2s; pointer-events: auto;
        }
        .btn:active, .btn.active { background: var(--primary); color: #000; box-shadow: 0 0 15px var(--primary); }

        /* --- RADAR --- */
        #radar {
            position: absolute; bottom: 20px; right: 20px;
            width: 130px; height: 130px; border-radius: 50%;
            background: rgba(0, 15, 0, 0.9); border: 2px solid var(--primary);
            box-shadow: 0 0 20px rgba(0, 255, 65, 0.15); overflow: hidden; pointer-events: auto;
        }
        #radar::after {
            content: ''; position: absolute; inset: 0; border-radius: 50%;
            background: conic-gradient(transparent 270deg, rgba(0,255,65,0.4) 360deg);
            animation: scan 2s linear infinite;
        }
        @keyframes scan { to { transform: rotate(360deg); } }
        
        .blip {
            position: absolute; width: 6px; height: 6px; border-radius: 50%;
            transform: translate(-50%, -50%); box-shadow: 0 0 4px currentColor;
            transition: all 0.3s ease-out;
        }

        /* --- BOOT SCREEN --- */
        #boot {
            position: fixed; inset: 0; background: #000; z-index: 9999;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            color: var(--primary);
        }
        .log-box {
            font-size: 10px; opacity: 0.8; margin-bottom: 20px; height: 120px; 
            width: 300px; overflow: hidden; border: 1px solid #333; padding: 10px; text-align: left;
        }
        .typing { border-right: 2px solid var(--primary); animation: blink 0.7s infinite; }
        @keyframes blink { 50% { border-color: transparent; } }

    </style>
</head>
<body>

    <div id="boot">
        <h1 style="font-size: 48px; margin: 0; letter-spacing: 8px;">OMEGA</h1>
        <p style="opacity:0.6; letter-spacing: 2px;">AI SENTINEL KERNEL v3.0</p>
        <div class="log-box" id="sys-log"></div>
        <button class="btn" id="btn-start" style="font-size: 16px; padding: 15px 40px;">INITIALIZE SYSTEM</button>
    </div>

    <div id="viewport">
        <video id="cam-feed" autoplay playsinline muted></video>
        <canvas id="hud-canvas"></canvas>

        <div id="ui-layer">
            <div style="display: flex; justify-content: space-between;">
                <div>
                    <div class="panel">CPU: <span id="cpu">0</span>ms | FPS: <span id="fps">0</span></div>
                    <div class="panel" id="voice-status">MIC: OFF</div>
                </div>
                <div style="text-align: right;">
                    <div class="panel">
                        P: <span id="pitch">0</span>° R: <span id="roll">0</span>°
                    </div>
                    <button class="btn" id="btn-link" style="font-size:10px; margin-top:5px;">CONNECT BODY</button>
                </div>
            </div>

            <div style="align-self: center; margin-top: 20px;">
                <div class="panel" id="target-alert" style="color: var(--neutral);">SCANNING...</div>
            </div>

            <div id="radar">
                <div style="position:absolute; top:50%; width:100%; height:1px; background:rgba(0,255,65,0.3);"></div>
                <div style="position:absolute; left:50%; width:1px; height:100%; background:rgba(0,255,65,0.3);"></div>
                <div id="radar-content"></div>
            </div>
        </div>
    </div>

<script>
/**
 * OMEGA OS - ULTIMATE MERGED EDITION
 * Includes: Vision (COCO-SSD), Avionics (Gyro), Radar, Bluetooth, Voice AI
 */

// --- CONFIGURATION ---
const CONFIG = {
    CONFIDENCE: 0.6,
    UUID_SVC: "6E400001-B5A3-F393-E0A9-E50E24DCCA9E", // Nordic UART UUID
    UUID_TX:  "6E400002-B5A3-F393-E0A9-E50E24DCCA9E",
    COLORS: { SAFE: '#00ff41', HOSTILE: '#ff0000', NEUTRAL: '#ffcc00' }
};

// --- UTILITIES ---
const Logger = {
    el: document.getElementById('sys-log'),
    log(msg) {
        this.el.innerHTML += `> ${msg}<br>`;
        this.el.scrollTop = this.el.scrollHeight;
        console.log(`[SYS] ${msg}`);
    }
};

// --- MODULE: VOICE AI (SPEECH SYNTHESIS & RECOGNITION) ---
const VoiceCore = {
    synth: window.speechSynthesis,
    rec: null,
    isActive: false,

    init() {
        if ('webkitSpeechRecognition' in window) {
            this.rec = new webkitSpeechRecognition();
            this.rec.continuous = true;
            this.rec.lang = 'en-US';
            this.rec.interimResults = false;

            this.rec.onresult = (event) => {
                const txt = event.results[event.results.length - 1][0].transcript.toLowerCase().trim();
                Logger.log(`VOICE CMD: "${txt}"`);
                this.processCommand(txt);
            };

            this.rec.start();
            this.isActive = true;
            document.getElementById('voice-status').innerText = "MIC: LISTENING";
            document.getElementById('voice-status').style.color = CONFIG.COLORS.SAFE;
            this.speak("Voice systems online.");
        } else {
            Logger.log("VOICE RECOGNITION NOT SUPPORTED");
        }
    },

    speak(text) {
        if (this.synth.speaking) return;
        const utter = new SpeechSynthesisUtterance(text);
        utter.rate = 1.2; utter.pitch = 0.8; // Robotic Tone
        this.synth.speak(utter);
    },

    processCommand(cmd) {
        if (cmd.includes('connect')) NeuroLink.connect();
        else if (cmd.includes('status')) this.speak("All systems nominal. Battery at 100 percent.");
        else if (cmd.includes('scan')) this.speak("Scanning sector.");
        else if (cmd.includes('stop')) this.speak("Holding position.");
    }
};

// --- MODULE: BLUETOOTH (NEURO-LINK) ---
const NeuroLink = {
    device: null, char: null,
    async connect() {
        try {
            VoiceCore.speak("Searching for body chassis.");
            this.device = await navigator.bluetooth.requestDevice({
                filters: [{ name: 'OMEGA-BODY' }],
                optionalServices: [CONFIG.UUID_SVC]
            });
            const server = await this.device.gatt.connect();
            const svc = await server.getPrimaryService(CONFIG.UUID_SVC);
            this.char = await svc.getCharacteristic(CONFIG.UUID_TX);
            
            document.getElementById('btn-link').classList.add('active');
            document.getElementById('btn-link').innerText = "LINK ESTABLISHED";
            VoiceCore.speak("Neural link established.");
        } catch (e) {
            Logger.log("BT ERROR: " + e);
            VoiceCore.speak("Connection failed.");
        }
    },
    send(x, y) {
        if (!this.char) return;
        // Convert -1..1 to 0..180 degrees
        const ax = Math.floor(((x + 1) / 2) * 180);
        const ay = Math.floor(((y + 1) / 2) * 180);
        const data = new TextEncoder().encode(`${ax},${ay}\n`);
        this.char.writeValue(data).catch(e => {});
    }
};

// --- MODULE: AVIONICS ---
const Avionics = {
    pitch: 0, roll: 0,
    init() {
        window.addEventListener('deviceorientation', e => {
            this.pitch = e.beta || 0; this.roll = e.gamma || 0;
        });
    }
};

// --- MODULE: VISUAL RENDERER ---
const Renderer = {
    canvas: document.getElementById('hud-canvas'),
    ctx: document.getElementById('hud-canvas').getContext('2d'),
    radar: document.getElementById('radar-content'),
    
    resize() {
        this.canvas.width = window.innerWidth;
        this.canvas.height = window.innerHeight;
    },
    
    clear() {
        this.ctx.clearRect(0, 0, this.canvas.width, this.canvas.height);
        this.radar.innerHTML = '';
    },
    
    drawHorizon(p, r) {
        const ctx = this.ctx; const w = this.canvas.width; const h = this.canvas.height;
        ctx.save();
        ctx.translate(w/2, h/2); ctx.rotate(r * Math.PI / 180); ctx.translate(0, p * 4);
        
        ctx.strokeStyle = 'rgba(0,255,65,0.4)'; ctx.lineWidth = 1;
        ctx.beginPath(); ctx.moveTo(-w, 0); ctx.lineTo(w, 0); ctx.stroke();
        
        // Pitch Ladder
        for(let i=-3; i<=3; i++) {
            if(i===0) continue;
            let y = i * 40;
            ctx.beginPath(); ctx.moveTo(-40, y); ctx.lineTo(40, y); ctx.stroke();
            ctx.fillStyle = CONFIG.COLORS.SAFE; ctx.font = "10px monospace"; ctx.fillText(i*10, 45, y+3);
        }
        ctx.restore();
    },

    drawHUD(target) {
        const [x, y, w, h] = target.bbox;
        const isHostile = target.class === 'person';
        const color = isHostile ? CONFIG.COLORS.HOSTILE : CONFIG.COLORS.SAFE;
        
        // Draw Box
        this.ctx.strokeStyle = color; this.ctx.lineWidth = 2;
        this.ctx.strokeRect(x, y, w, h);
        
        // Label
        this.ctx.fillStyle = color; this.ctx.font = "bold 12px Courier New";
        this.ctx.fillText(`${target.class.toUpperCase()} [${Math.round(target.score*100)}%]`, x, y-10);

        // Radar Blip
        const blip = document.createElement('div');
        blip.className = 'blip'; blip.style.backgroundColor = color;
        
        // Radar Math
        const cx = x + w/2;
        const mapX = ((cx / window.innerWidth) * 2 - 1) * 55; // Scale to radar width
        const dist = (1 - (h / window.innerHeight)) * 55;     // Scale to radar height
        
        // Polar Projection approximation
        blip.style.left = `${65 + mapX}px`;
        blip.style.top = `${65 - (55 - dist)}px`; // Invert Y
        this.radar.appendChild(blip);

        return { cx: (cx/window.innerWidth)*2-1, cy: ((y+h/2)/window.innerHeight)*2-1, isHostile };
    }
};

// --- CORE KERNEL ---
const Kernel = {
    video: document.getElementById('cam-feed'),
    model: null,
    isRunning: false,
    lastTalkTime: 0,

    async boot() {
        try {
            Logger.log("INITIALIZING HARDWARE...");
            
            // 1. Permissions
            if (typeof DeviceOrientationEvent.requestPermission === 'function') {
                await DeviceOrientationEvent.requestPermission();
            }
            Avionics.init();

            // 2. Camera
            const stream = await navigator.mediaDevices.getUserMedia({ 
                video: { facingMode: 'environment' }, audio: false 
            });
            this.video.srcObject = stream;
            Logger.log("OPTICAL SENSORS: ONLINE");

            // 3. AI
            Logger.log("LOADING NEURAL NETWORK...");
            this.model = await cocoSsd.load({ base: 'lite_mobilenet_v2' });
            Logger.log("NEURAL NETWORK: ONLINE");

            // 4. Voice
            VoiceCore.init();

            // Start Loop
            document.getElementById('boot').style.display = 'none';
            this.isRunning = true;
            Renderer.resize();
            this.loop();

        } catch (e) {
            Logger.log("CRITICAL FAILURE: " + e);
            alert("Error: " + e);
        }
    },

    async loop() {
        if (!this.isRunning) return;
        requestAnimationFrame(() => this.loop());
        
        const start = performance.now();

        // Render
        Renderer.clear();
        Renderer.drawHorizon(Avionics.pitch, Avionics.roll);

        // Inference
        if (this.video.readyState === 4) {
            const preds = await this.model.detect(this.video, 10, CONFIG.CONFIDENCE);
            
            let primaryTarget = null;
            const uiAlert = document.getElementById('target-alert');

            if (preds.length > 0) {
                preds.forEach(p => {
                    const info = Renderer.drawHUD(p);
                    if (info.isHostile) primaryTarget = info;
                });
            }

            // Logic Logic
            if (primaryTarget) {
                uiAlert.innerText = "TARGET LOCKED";
                uiAlert.style.color = CONFIG.COLORS.HOSTILE;
                uiAlert.style.borderColor = CONFIG.COLORS.HOSTILE;
                
                // Auto-Aim (Bluetooth) - Invert X for Servo
                NeuroLink.send(-primaryTarget.cx, primaryTarget.cy);

                // Voice Feedback (Cooldown 5s)
                if (Date.now() - this.lastTalkTime > 5000) {
                    VoiceCore.speak("Target locked.");
                    this.lastTalkTime = Date.now();
                }
            } else {
                uiAlert.innerText = "SCANNING SECTOR";
                uiAlert.style.color = CONFIG.COLORS.NEUTRAL;
                uiAlert.style.borderColor = CONFIG.COLORS.SAFE;
            }
        }

        // Stats
        const delta = performance.now() - start;
        document.getElementById('cpu').innerText = delta.toFixed(0);
        document.getElementById('fps').innerText = (1000/Math.max(1, delta)).toFixed(0);
        document.getElementById('pitch').innerText = Avionics.pitch.toFixed(0);
        document.getElementById('roll').innerText = Avionics.roll.toFixed(0);
    }
};

// --- EVENTS ---
window.addEventListener('resize', () => Renderer.resize());
document.getElementById('btn-start').addEventListener('click', () => Kernel.boot());
document.getElementById('btn-link').addEventListener('click', () => NeuroLink.connect());

</script>
</body>
</html>
