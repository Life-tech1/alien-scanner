<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>OMEGA: ULTIMATE HYBRID SYSTEM</title>
    
    <!-- AI & Core Libraries -->
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/coco-ssd"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/face-landmarks-detection"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/howler/2.2.3/howler.min.js"></script>

    <style>
        /* --- V2 STYLE SYSTEM (Cyberpunk Aesthetics) --- */
        :root {
            --primary: #0affc2;
            --secondary: #008f7a;
            --accent: #00d2ff;
            --alert: #ff2a6d;
            --warn: #ffae00;
            --bg-dark: #050505;
            --glass: rgba(5, 15, 10, 0.85);
            --neon-glow: 0 0 10px var(--primary);
            --scan-line: rgba(0, 255, 194, 0.1);
            --font-main: 'Segoe UI', 'Courier New', sans-serif;
        }

        * { box-sizing: border-box; user-select: none; -webkit-touch-callout: none; }
        
        body {
            margin: 0; overflow: hidden; background: var(--bg-dark);
            font-family: var(--font-main); color: var(--primary);
            width: 100vw; height: 100vh;
        }

        /* CRT & Glitch Effects */
        .scanlines {
            position: fixed; inset: 0; z-index: 900; pointer-events: none;
            background: linear-gradient(to bottom, rgba(255,255,255,0), rgba(255,255,255,0) 50%, rgba(0,0,0,0.2) 50%, rgba(0,0,0,0.2));
            background-size: 100% 4px;
            animation: scanlineMove 10s linear infinite;
            opacity: 0.4;
        }
        
        .vignette {
            position: fixed; inset: 0; z-index: 901; pointer-events: none;
            background: radial-gradient(circle, rgba(0,0,0,0) 60%, rgba(0,0,0,0.9) 100%);
        }

        @keyframes scanlineMove { 0% { background-position: 0 0; } 100% { background-position: 0 100%; } }

        /* Layers */
        #viewport { position: relative; width: 100%; height: 100%; }
        
        #camera-feed {
            position: absolute; width: 100%; height: 100%; object-fit: cover;
            filter: contrast(1.2) brightness(0.9) saturate(1.1);
            z-index: 0;
        }
        
        #hud-canvas { position: absolute; inset: 0; z-index: 10; pointer-events: none; }
        #visualization-3d { position: absolute; inset: 0; z-index: 5; pointer-events: none; opacity: 0.6; }
        
        #ui-layer {
            position: absolute; inset: 0; z-index: 20; pointer-events: none;
            display: flex; flex-direction: column; justify-content: space-between;
            padding: 16px;
        }

        /* V2 Style Panels with V1 Data */
        .hud-panel {
            background: linear-gradient(135deg, rgba(0,20,10,0.8) 0%, rgba(0,0,0,0.6) 100%);
            border: 1px solid var(--secondary);
            border-left: 3px solid var(--primary);
            padding: 12px; margin: 5px;
            backdrop-filter: blur(5px);
            box-shadow: 0 0 15px rgba(10, 255, 194, 0.1);
            width: fit-content; pointer-events: auto;
            transition: all 0.3s;
        }
        
        .panel-title {
            font-size: 10px; font-weight: 800; color: var(--accent);
            letter-spacing: 2px; margin-bottom: 5px; text-transform: uppercase;
        }

        .hud-text { font-size: 12px; margin-bottom: 3px; font-family: 'Courier New', monospace; opacity: 0.9; }
        .hud-value { font-weight: bold; color: #fff; text-shadow: 0 0 5px var(--primary); margin-left: 5px; }

        /* V1 Radar with V2 Styling */
        #radar-container {
            position: absolute; bottom: 80px; right: 20px;
            width: 150px; height: 150px;
            border-radius: 50%;
            background: rgba(0, 15, 10, 0.8);
            border: 2px solid var(--secondary);
            box-shadow: 0 0 20px rgba(0, 255, 194, 0.2);
            overflow: hidden; z-index: 30; pointer-events: auto;
        }
        #radar-container::after {
            content: ''; position: absolute; inset: 0;
            background: conic-gradient(from 0deg, transparent 0deg, rgba(0,255,194,0.4) 360deg);
            border-radius: 50%; animation: radar-scan 2s linear infinite;
        }
        .radar-blip { position: absolute; border-radius: 50%; transform: translate(-50%, -50%); box-shadow: 0 0 5px currentColor; z-index: 2; }
        @keyframes radar-scan { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* V1 Control Panel with V2 Style */
        #control-panel {
            position: absolute; top: 60px; left: 20px;
            background: rgba(5, 10, 10, 0.95);
            border: 1px solid var(--accent);
            padding: 15px; border-radius: 5px;
            z-index: 40; pointer-events: auto; display: none;
            box-shadow: 0 0 20px rgba(0, 210, 255, 0.2);
            min-width: 260px;
        }
        
        .control-btn {
            background: rgba(0, 255, 194, 0.05); border: 1px solid var(--secondary);
            color: var(--primary); padding: 6px 10px; margin: 3px;
            font-size: 10px; cursor: pointer; text-transform: uppercase;
            transition: 0.2s;
        }
        .control-btn:hover { background: var(--secondary); color: #000; }
        .control-btn.active { background: var(--primary); color: #000; box-shadow: 0 0 10px var(--primary); }

        #toggle-controls {
            position: absolute; top: 20px; left: 20px; z-index: 35; pointer-events: auto;
            background: rgba(0,0,0,0.8); border: 1px solid var(--primary); color: var(--primary);
            padding: 8px 16px; cursor: pointer; font-weight: bold;
        }

        /* System Status Bar */
        #system-status {
            position: absolute; bottom: 0; left: 0; width: 100%;
            background: rgba(0,0,0,0.9); border-top: 1px solid var(--secondary);
            padding: 5px 15px; display: flex; gap: 15px; font-size: 10px; z-index: 25;
        }
        .status-led { width: 8px; height: 8px; border-radius: 50%; background: #333; display: inline-block; margin-right: 5px; }
        .status-led.ok { background: var(--primary); box-shadow: 0 0 8px var(--primary); }
        .status-led.busy { background: var(--warn); animation: pulse 1s infinite; }
        
        /* Tactical Log (New from V2) */
        #tactical-log {
            position: absolute; bottom: 80px; left: 20px;
            width: 250px; height: 120px; overflow: hidden;
            font-family: monospace; font-size: 10px; color: var(--accent);
            text-shadow: 0 0 2px var(--accent); pointer-events: none;
            mask-image: linear-gradient(to bottom, transparent, black 10%);
        }

        /* Boot Screen */
        #boot-overlay {
            position: fixed; inset: 0; background: #020202; z-index: 9999;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
        }
        .boot-title { font-size: 40px; font-weight: 900; color: var(--primary); text-shadow: 0 0 20px var(--primary); letter-spacing: 5px; }
        
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.5; } }
    </style>
</head>
<body>

    <div class="scanlines"></div>
    <div class="vignette"></div>

    <div id="viewport">
        <video id="camera-feed" autoplay playsinline muted></video>
        <canvas id="hud-canvas"></canvas>
        <div id="visualization-3d"></div> <!-- V1 3D System -->
        
        <div id="ui-layer">
            <!-- Top HUD -->
            <div style="display:flex; justify-content:space-between; width:100%;">
                <div class="hud-panel">
                    <div class="panel-title">SYSTEM METRICS</div>
                    <div class="hud-text">CPU: <span id="val-cpu" class="hud-value">0</span> ms</div>
                    <div class="hud-text">FPS: <span id="val-fps" class="hud-value">0</span></div>
                    <div class="hud-text">OBJ: <span id="val-objects" class="hud-value">0</span></div>
                    <div class="hud-text">FACES: <span id="val-faces" class="hud-value">0</span></div>
                </div>
                
                <div class="hud-panel">
                    <div class="panel-title">AVIONICS</div>
                    <div class="hud-text">HDG: <span id="val-heading" class="hud-value">0°</span></div>
                    <div class="hud-text">PITCH: <span id="val-pitch" class="hud-value">0°</span></div>
                    <div class="hud-text">THREAT: <span id="val-threat" class="hud-value" style="color:var(--alert)">LOW</span></div>
                </div>
            </div>

            <!-- Target Info (V1 Logic) -->
            <div class="hud-panel" style="position: absolute; top: 50%; right: 20px; transform: translateY(-50%);">
                <div class="panel-title">PRIMARY TARGET</div>
                <div class="hud-text">TYPE: <span id="target-type" class="hud-value">--</span></div>
                <div class="hud-text">DIST: <span id="target-dist" class="hud-value">--</span></div>
                <div class="hud-text">CONF: <span id="target-conf" class="hud-value">--</span></div>
                <div class="hud-text">ACT: <span id="target-action" class="hud-value">--</span></div>
            </div>

            <!-- Radar & Logs -->
            <div id="radar-container"></div>
            <div id="tactical-log">
                <div>SYSTEM INITIATED...</div>
                <div>WAITING FOR INPUT...</div>
            </div>
        </div>

        <!-- Controls (V1 Logic) -->
        <button id="toggle-controls">CONTROLS</button>
        <div id="control-panel">
            <div class="panel-title">COMMAND CENTER</div>
            <div style="margin-top:10px">
                <div class="hud-text">VISUALS</div>
                <button class="control-btn active" id="btn-hud">HUD</button>
                <button class="control-btn" id="btn-lidar">LIDAR</button>
                <button class="control-btn" id="btn-3d">3D VIZ</button>
                <button class="control-btn" id="btn-face">FACE MESH</button>
            </div>
            <div style="margin-top:10px">
                <div class="hud-text">SYSTEM</div>
                <button class="control-btn" id="btn-voice">VOICE</button>
                <button class="control-btn" id="btn-record">RECORD</button>
                <button class="control-btn" id="btn-threat">THREAT SCAN</button>
            </div>
        </div>

        <!-- Footer Status -->
        <div id="system-status">
            <div><span class="status-led ok" id="led-cam"></span>CAM</div>
            <div><span class="status-led" id="led-ai"></span>AI CORE</div>
            <div><span class="status-led" id="led-face"></span>BIOMETRICS</div>
            <div><span class="status-led" id="led-voice"></span>VOICE</div>
            <div><span class="status-led" id="led-rec"></span>REC</div>
            <div style="margin-left:auto; color:var(--secondary)">OMEGA ULTIMATE v3.0</div>
        </div>
    </div>

    <!-- Boot Screen -->
    <div id="boot-overlay">
        <div class="boot-title">OMEGA</div>
        <div style="font-family:monospace; color:var(--secondary); margin-top:10px;">ULTIMATE HYBRID SYSTEM</div>
        <div id="boot-log" style="font-family:monospace; font-size:12px; margin-top:30px; color:#666;">
            Initializing...
        </div>
        <button id="btn-init" style="margin-top:40px; padding:15px 40px; background:var(--primary); border:none; font-weight:bold; cursor:pointer; display:none;">ENGAGE</button>
    </div>

<script>
/**
 * OMEGA ULTIMATE: Merging V1 Logic with V2 Graphics
 */

// --- CONFIGURATION ---
const CONFIG = {
    AI: { 
        OBJ_THRESHOLD: 0.6, 
        FACE_ENABLED: true 
    },
    PHYSICS: {
        FOV: 65,
        MAX_RANGE: 50
    },
    COLORS: {
        PRIMARY: '#0affc2',
        SECONDARY: '#008f7a',
        ALERT: '#ff2a6d'
    }
};

// --- CORE UTILS (V1) ---
const Utils = {
    distance: (x1, y1, x2, y2) => Math.sqrt((x2 - x1) ** 2 + (y2 - y1) ** 2),
    playSound: (type) => {
        // Placeholder sounds using Howler
        if(type === 'boot') new Howl({src: ['data:audio/wav;base64,UklGRigAAABXQVZFZm10IBAAAAABAAEARKwAAIhYAQACABAAZGF0YQQAAAAAAA=='], volume: 0.5}).play(); // Silent placeholder
        if(type === 'alert') new Howl({src: ['data:audio/wav;base64,UklGRigAAABXQVZFZm10IBAAAAABAAEARKwAAIhYAQACABAAZGF0YQQAAAAAAA=='], volume: 0.5}).play();
    },
    log: (msg) => {
        const log = document.getElementById('tactical-log');
        const div = document.createElement('div');
        div.textContent = `> ${msg}`;
        log.prepend(div);
        if(log.children.length > 6) log.lastChild.remove();
    }
};

// --- VOICE SYSTEM (V1 Logic) ---
class VoiceSystem {
    constructor() {
        this.recognition = null;
        this.isListening = false;
        if ('webkitSpeechRecognition' in window) {
            this.recognition = new webkitSpeechRecognition();
            this.recognition.continuous = false;
            this.recognition.lang = 'en-US';
            this.recognition.onresult = (e) => this.process(e.results[0][0].transcript);
        }
    }
    
    toggle() {
        if(!this.recognition) return alert("Voice not supported");
        if(this.isListening) { this.recognition.stop(); this.isListening = false; }
        else { this.recognition.start(); this.isListening = true; Utils.log("VOICE LISTENING..."); }
        document.getElementById('led-voice').className = this.isListening ? "status-led ok" : "status-led";
        document.getElementById('btn-voice').classList.toggle('active', this.isListening);
    }

    process(cmd) {
        cmd = cmd.toLowerCase();
        Utils.log(`VOICE: "${cmd}"`);
        if(cmd.includes('record')) OMEGA.recorder.toggle();
        if(cmd.includes('target')) Utils.log("TARGET LOCKED");
        if(cmd.includes('status')) Utils.log("SYSTEM OPTIMAL");
        this.isListening = false;
        document.getElementById('led-voice').className = "status-led";
        document.getElementById('btn-voice').classList.remove('active');
    }
}

// --- MISSION RECORDER (V1 Logic) ---
class MissionRecorder {
    constructor() {
        this.recording = false;
        this.data = [];
    }
    toggle() {
        this.recording = !this.recording;
        document.getElementById('led-rec').className = this.recording ? "status-led busy" : "status-led";
        document.getElementById('btn-record').classList.toggle('active', this.recording);
        Utils.log(this.recording ? "RECORDING STARTED" : "RECORDING SAVED");
    }
    push(frameData) {
        if(this.recording) this.data.push(frameData);
    }
}

// --- VISION ENGINE (Hybrid V1 + V2) ---
class VisionEngine {
    constructor() {
        this.models = { object: null, face: null };
        this.isReady = false;
    }

    async init() {
        const log = (m) => document.getElementById('boot-log').textContent = m;
        
        try {
            log("Loading COCO-SSD Neural Net...");
            this.models.object = await cocoSsd.load({ base: 'lite_mobilenet_v2' });
            
            log("Loading Biometric Mesh...");
            this.models.face = await faceLandmarksDetection.load(faceLandmarksDetection.SupportedPackages.mediapipeFacemesh);
            
            this.isReady = true;
            return true;
        } catch (e) {
            console.error(e);
            log("Error Loading Models");
            return false;
        }
    }

    async detect(video) {
        if (!this.isReady) return { objects: [], faces: [] };
        
        const [objects, faces] = await Promise.all([
            this.models.object.detect(video, 10, CONFIG.AI.OBJ_THRESHOLD),
            CONFIG.AI.FACE_ENABLED ? this.models.face.estimateFaces({ input: video }) : []
        ]);
        
        return { objects, faces };
    }
}

// --- RENDERER (Enhanced with V2 Graphics) ---
class HUDRenderer {
    constructor() {
        this.canvas = document.getElementById('hud-canvas');
        this.ctx = this.canvas.getContext('2d');
        this.resize();
        window.addEventListener('resize', () => this.resize());
        
        this.settings = {
            hud: true,
            lidar: false,
            faceMesh: true
        };
    }

    resize() {
        this.canvas.width = window.innerWidth;
        this.canvas.height = window.innerHeight;
    }

    render(video, data) {
        this.ctx.clearRect(0, 0, this.canvas.width, this.canvas.height);
        
        if (this.settings.lidar) this.drawLidar();
        if (this.settings.hud) this.drawObjects(data.objects);
        if (this.settings.faceMesh) this.drawFaces(data.faces);
    }

    drawObjects(objects) {
        const ctx = this.ctx;
        objects.forEach(obj => {
            const [x, y, w, h] = obj.bbox;
            const color = obj.class === 'person' ? CONFIG.COLORS.ALERT : CONFIG.COLORS.PRIMARY;
            
            // V2 Style Brackets
            ctx.strokeStyle = color;
            ctx.lineWidth = 2;
            ctx.shadowColor = color;
            ctx.shadowBlur = 10;
            
            const len = w * 0.2;
            ctx.beginPath();
            // Corners
            ctx.moveTo(x, y + len); ctx.lineTo(x, y); ctx.lineTo(x + len, y);
            ctx.moveTo(x + w - len, y); ctx.lineTo(x + w, y); ctx.lineTo(x + w, y + len);
            ctx.moveTo(x + w, y + h - len); ctx.lineTo(x + w, y + h); ctx.lineTo(x + w - len, y + h);
            ctx.moveTo(x, y + h - len); ctx.lineTo(x, y + h); ctx.lineTo(x + len, y + h);
            ctx.stroke();
            
            // Label
            ctx.fillStyle = color;
            ctx.font = "bold 12px Courier New";
            ctx.fillText(`${obj.class.toUpperCase()} ${Math.floor(obj.score*100)}%`, x, y - 10);
        });
    }

    drawFaces(faces) {
        if(!faces || faces.length === 0) return;
        const ctx = this.ctx;
        ctx.fillStyle = CONFIG.COLORS.ACCENT;
        
        faces.forEach(face => {
            // V2 Face Mesh Point Cloud
            face.scaledMesh.forEach((p, i) => {
                if (i % 5 === 0) ctx.fillRect(p[0], p[1], 1, 1);
            });
            
            // Draw ring around face
            const bb = face.boundingBox;
            const cx = bb.topLeft[0] + (bb.bottomRight[0] - bb.topLeft[0])/2;
            const cy = bb.topLeft[1] + (bb.bottomRight[1] - bb.topLeft[1])/2;
            const r = (bb.bottomRight[0] - bb.topLeft[0]) / 1.5;
            
            ctx.beginPath();
            ctx.strokeStyle = 'rgba(0, 210, 255, 0.3)';
            ctx.arc(cx, cy, r, 0, Math.PI * 2);
            ctx.stroke();
        });
    }

    drawLidar() {
        const ctx = this.ctx;
        const w = this.canvas.width;
        const h = this.canvas.height;
        const scanY = (Date.now() / 20) % h;
        
        ctx.strokeStyle = 'rgba(0, 255, 194, 0.5)';
        ctx.lineWidth = 2;
        ctx.beginPath();
        ctx.moveTo(0, scanY); ctx.lineTo(w, scanY);
        ctx.stroke();
    }
}

// --- RADAR SYSTEM (V1 Logic) ---
class RadarSystem {
    constructor() {
        this.el = document.getElementById('radar-container');
    }
    update(objects) {
        this.el.innerHTML = ''; // Clear
        objects.forEach(obj => {
            const blip = document.createElement('div');
            blip.className = 'radar-blip';
            // Mock position mapping
            const dx = (obj.bbox[0] / window.innerWidth - 0.5) * 140;
            const dy = (obj.bbox[1] / window.innerHeight - 0.5) * 140;
            
            blip.style.left = `${75 + dx}px`;
            blip.style.top = `${75 + dy}px`;
            blip.style.width = obj.class === 'person' ? '6px' : '4px';
            blip.style.height = blip.style.width;
            blip.style.backgroundColor = obj.class === 'person' ? CONFIG.COLORS.ALERT : CONFIG.COLORS.PRIMARY;
            this.el.appendChild(blip);
        });
    }
}

// --- OMEGA KERNEL (The Controller) ---
class OmegaKernel {
    constructor() {
        this.vision = new VisionEngine();
        this.renderer = new HUDRenderer();
        this.voice = new VoiceSystem();
        this.recorder = new MissionRecorder();
        this.radar = new RadarSystem();
        
        this.video = document.getElementById('camera-feed');
        this.stats = { fps: 0, lastTime: 0 };
        this.isRunning = false;
        
        this.setupUI();
    }

    setupUI() {
        document.getElementById('btn-init').addEventListener('click', () => this.start());
        document.getElementById('toggle-controls').addEventListener('click', () => {
            const p = document.getElementById('control-panel');
            p.style.display = p.style.display === 'block' ? 'none' : 'block';
        });
        
        // Connect Control Buttons to Settings
        const bind = (id, prop) => {
            document.getElementById(id).addEventListener('click', (e) => {
                this.renderer.settings[prop] = !this.renderer.settings[prop];
                e.target.classList.toggle('active');
            });
        };
        bind('btn-hud', 'hud');
        bind('btn-lidar', 'lidar');
        bind('btn-face', 'faceMesh');
        
        document.getElementById('btn-voice').addEventListener('click', () => this.voice.toggle());
        document.getElementById('btn-record').addEventListener('click', () => this.recorder.toggle());
    }

    async boot() {
        try {
            const stream = await navigator.mediaDevices.getUserMedia({ 
                video: { facingMode: 'environment', width: {ideal: 1280}, height: {ideal: 720} },
                audio: false 
            });
            this.video.srcObject = stream;
            
            await new Promise(r => this.video.onloadedmetadata = () => {
                this.video.play();
                r();
            });

            const aiReady = await this.vision.init();
            if(aiReady) {
                document.getElementById('boot-log').textContent = "SYSTEM READY";
                document.getElementById('btn-init').style.display = 'block';
                // Status LEDs
                document.getElementById('led-cam').classList.add('ok');
                document.getElementById('led-ai').classList.add('ok');
                document.getElementById('led-face').classList.add('ok');
            }
        } catch(e) {
            alert("Camera Error: " + e.message);
        }
    }

    start() {
        document.getElementById('boot-overlay').style.display = 'none';
        this.isRunning = true;
        Utils.playSound('boot');
        this.loop();
    }

    async loop() {
        if(!this.isRunning) return;

        // 1. Calc FPS
        const now = performance.now();
        const delta = now - this.stats.lastTime;
        this.stats.fps = Math.round(1000 / delta);
        this.stats.lastTime = now;

        // 2. AI Detection
        const data = await this.vision.detect(this.video);
        const cpuTime = Math.round(performance.now() - now);

        // 3. Render Graphics
        this.renderer.render(this.video, data);
        this.radar.update(data.objects);
        
        // 4. Recorder Logic
        this.recorder.push({ ts: now, data });

        // 5. Update UI Numbers
        this.updateStats(data, cpuTime);

        requestAnimationFrame(() => this.loop());
    }

    updateStats(data, cpuTime) {
        document.getElementById('val-cpu').textContent = cpuTime;
        document.getElementById('val-fps').textContent = this.stats.fps;
        document.getElementById('val-objects').textContent = data.objects.length;
        document.getElementById('val-faces').textContent = data.faces ? data.faces.length : 0;
        
        // Threat Analysis Logic (Simple V1 version)
        const persons = data.objects.filter(o => o.class === 'person');
        const threatVal = document.getElementById('val-threat');
        if (persons.length > 2) { threatVal.textContent = "HIGH"; threatVal.style.color = CONFIG.COLORS.ALERT; }
        else if (persons.length > 0) { threatVal.textContent = "MED"; threatVal.style.color = CONFIG.COLORS.WARN; }
        else { threatVal.textContent = "LOW"; threatVal.style.color = CONFIG.COLORS.PRIMARY; }

        // Update Target Panel
        if(data.objects.length > 0) {
            const t = data.objects[0]; // Primary target
            document.getElementById('target-type').textContent = t.class.toUpperCase();
            document.getElementById('target-conf').textContent = Math.floor(t.score*100) + '%';
            document.getElementById('target-action').textContent = "TRACKING";
        } else {
            document.getElementById('target-action').textContent = "SCANNING";
        }
    }
}

// --- INITIALIZE ---
const OMEGA = new OmegaKernel();
window.addEventListener('load', () => OMEGA.boot());

</script>
</body>
</html>
