<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>VANDENBERG | TELEMETRY LOGGER</title>
    <style>
        /* * ENGINEERING STANDARDS:
         * - High Contrast (White/Green on Black)
         * - Monospaced Font (Alignment)
         * - No Animations (Performance stability)
         */
        :root {
            --bg: #000000;
            --fg-primary: #00ff00; /* Normal State */
            --fg-warn: #ffff00;    /* Warning */
            --fg-err: #ff0000;     /* Critical */
            --fg-dim: #555555;
            --border: 1px solid #333;
            --font: 'Consolas', 'Monaco', 'Courier New', monospace;
        }

        * { box-sizing: border-box; }
        
        body {
            background: var(--bg); color: var(--fg-primary);
            font-family: var(--font); font-size: 12px;
            margin: 0; padding: 5px;
            width: 100vw; height: 100vh;
            overflow: hidden;
            display: grid;
            grid-template-rows: 30px 1fr 120px 40px;
            gap: 5px;
        }

        /* HEADER */
        header {
            display: flex; justify-content: space-between; align-items: center;
            border-bottom: var(--border); padding: 0 5px;
        }
        .sys-id { font-weight: bold; letter-spacing: 1px; }
        .clock { color: var(--fg-dim); }

        /* MAIN DATA GRID */
        main {
            display: grid;
            grid-template-columns: 1fr 1fr; /* 2 Columns */
            grid-template-rows: 1fr 1fr;    /* 2 Rows */
            gap: 5px;
        }

        .module {
            border: var(--border);
            padding: 5px;
            display: flex; flex-direction: column;
            overflow: hidden;
        }
        .module-head {
            background: #111; color: var(--fg-dim);
            padding: 2px 5px; margin: -5px -5px 5px -5px;
            border-bottom: var(--border); font-weight: bold;
            display: flex; justify-content: space-between;
        }

        /* DATA TABLES */
        table { width: 100%; border-collapse: collapse; }
        td { padding: 2px; vertical-align: top; }
        .label { color: #888; width: 80px; }
        .val { color: #fff; font-weight: bold; }
        .unit { color: #555; font-size: 10px; }

        /* LOG CONSOLE */
        #log-panel {
            border: var(--border);
            font-size: 10px; color: #aaa;
            overflow-y: auto; padding: 5px;
            background: #050505;
        }
        .log-line { border-bottom: 1px solid #111; display: flex; gap: 10px; }
        .ts { color: var(--fg-dim); width: 80px; }
        .msg-err { color: var(--fg-err); }
        .msg-info { color: var(--fg-primary); }

        /* CONTROLS */
        footer {
            display: flex; gap: 5px;
        }
        button {
            flex: 1; background: #111; border: 1px solid var(--fg-primary);
            color: var(--fg-primary); font-family: var(--font);
            cursor: pointer; text-transform: uppercase; font-weight: bold;
        }
        button:active { background: var(--fg-primary); color: #000; }
        button:disabled { border-color: #333; color: #333; cursor: not-allowed; }
        
        .recording { background: var(--fg-err); color: #fff; border-color: var(--fg-err); }

        /* VIDEO PREVIEW (Small, for verification only) */
        #cam-preview {
            width: 100%; height: 100px; object-fit: cover;
            border: 1px solid #333; margin-top: auto; opacity: 0.5;
        }
        
        /* Responsive */
        @media (min-width: 800px) {
            main { grid-template-columns: 1fr 1fr 1fr; grid-template-rows: 1fr; }
        }
    </style>
</head>
<body>

    <header>
        <div class="sys-id">VANDENBERG GSE <span style="font-size:10px; color:#555;">v3.1.0</span></div>
        <div class="clock" id="utc-clock">--:--:--Z</div>
    </header>

    <main>
        <div class="module">
            <div class="module-head"><span>IMU TELEMETRY</span><span id="st-imu">OFF</span></div>
            <table>
                <tr><td class="label">ACCEL X</td><td><span id="ax" class="val">0.000</span> <span class="unit">m/s²</span></td></tr>
                <tr><td class="label">ACCEL Y</td><td><span id="ay" class="val">0.000</span> <span class="unit">m/s²</span></td></tr>
                <tr><td class="label">ACCEL Z</td><td><span id="az" class="val">0.000</span> <span class="unit">m/s²</span></td></tr>
                <tr><td class="label">TOTAL G</td><td><span id="gt" class="val">0.000</span> <span class="unit">G</span></td></tr>
                <tr><td colspan="2" style="height:5px;"></td></tr>
                <tr><td class="label">GYRO α</td><td><span id="ra" class="val">0.0</span> <span class="unit">deg</span></td></tr>
                <tr><td class="label">GYRO β</td><td><span id="rb" class="val">0.0</span> <span class="unit">deg</span></td></tr>
                <tr><td class="label">GYRO γ</td><td><span id="rg" class="val">0.0</span> <span class="unit">deg</span></td></tr>
            </table>
        </div>

        <div class="module">
            <div class="module-head"><span>GPS FIX</span><span id="st-gps">NO LOCK</span></div>
            <table>
                <tr><td class="label">LATITUDE</td><td><span id="lat" class="val">--.------</span></td></tr>
                <tr><td class="label">LONGITUDE</td><td><span id="lon" class="val">--.------</span></td></tr>
                <tr><td class="label">ALTITUDE</td><td><span id="alt" class="val">--</span> <span class="unit">m</span></td></tr>
                <tr><td class="label">ACCURACY</td><td><span id="acc" class="val">--</span> <span class="unit">m</span></td></tr>
                <tr><td class="label">HEADING</td><td><span id="hdg" class="val">--</span> <span class="unit">deg</span></td></tr>
                <tr><td class="label">SPEED</td><td><span id="spd" class="val">--</span> <span class="unit">m/s</span></td></tr>
            </table>
        </div>

        <div class="module">
            <div class="module-head"><span>ENV SENSORS</span><span id="st-env">STBY</span></div>
            <table>
                <tr><td class="label">AUDIO RMS</td><td><span id="rms" class="val">-100.0</span> <span class="unit">dBFS</span></td></tr>
                <tr><td class="label">PEAK FREQ</td><td><span id="frq" class="val">0</span> <span class="unit">Hz</span></td></tr>
                <tr><td class="label">LUMINANCE</td><td><span id="lux" class="val">--</span> <span class="unit">est</span></td></tr>
            </table>
            <video id="cam-preview" playsinline muted autoplay></video>
        </div>
    </main>

    <div id="log-panel">
        <div class="log-line"><span class="ts">T+00.000</span><span class="msg-info">SYSTEM INITIALIZED. WAITING FOR COMMAND.</span></div>
    </div>

    <footer>
        <button id="btn-init" onclick="System.init()">INITIALIZE SENSORS</button>
        <button id="btn-rec" onclick="System.toggleRecord()" disabled>REC START</button>
        <button id="btn-exp" onclick="System.exportData()" disabled>DOWNLOAD .CSV</button>
    </footer>

    <script>
        "use strict";

        /**
         * SYSTEM ARCHITECTURE: VANDENBERG
         * Designed for robustness and raw data integrity.
         * No libraries. Pure JS.
         */

        const Config = {
            sampleRateMs: 100, // 10Hz Logging
            audioFftSize: 512
        };

        const State = {
            startTime: 0,
            recording: false,
            buffer: [], // Data Buffer
            frameCount: 0
        };

        // --- SENSOR MODULES ---
        
        const IMU = {
            active: false,
            data: { ax:0, ay:0, az:0, alpha:0, beta:0, gamma:0 },
            init: function() {
                if(window.DeviceMotionEvent) {
                    window.addEventListener('devicemotion', e => {
                        this.data.ax = e.accelerationIncludingGravity.x || 0;
                        this.data.ay = e.accelerationIncludingGravity.y || 0;
                        this.data.az = e.accelerationIncludingGravity.z || 0;
                    });
                    window.addEventListener('deviceorientation', e => {
                        this.data.alpha = e.alpha || 0;
                        this.data.beta = e.beta || 0;
                        this.data.gamma = e.gamma || 0;
                    });
                    this.active = true;
                    UI.setStatus('st-imu', 'ACTIVE', '#0f0');
                    Logger.log("IMU SENSORS ENGAGED", "INFO");
                } else {
                    Logger.log("IMU HARDWARE NOT FOUND", "ERR");
                }
            }
        };

        const GPS = {
            active: false,
            init: function() {
                if(navigator.geolocation) {
                    navigator.geolocation.watchPosition(
                        p => {
                            UI.updateGPS(p.coords);
                            this.active = true;
                            UI.setStatus('st-gps', 'LOCKED', '#0f0');
                        },
                        e => Logger.log("GPS ERROR: " + e.message, "ERR"),
                        { enableHighAccuracy: true }
                    );
                    Logger.log("GPS ACQUISITION STARTED", "INFO");
                }
            }
        };

        const AV = { // Audio/Video
            active: false,
            context: null,
            analyser: null,
            freqData: null,
            videoEl: document.getElementById('cam-preview'),
            canvas: document.createElement('canvas'),
            
            init: async function() {
                try {
                    const stream = await navigator.mediaDevices.getUserMedia({ 
                        audio: true, 
                        video: { facingMode: 'environment', width: 128 } // Low res for perf
                    });
                    
                    this.videoEl.srcObject = stream;
                    this.context = new (window.AudioContext || window.webkitAudioContext)();
                    const src = this.context.createMediaStreamSource(stream);
                    this.analyser = this.context.createAnalyser();
                    this.analyser.fftSize = Config.audioFftSize;
                    src.connect(this.analyser);
                    this.freqData = new Uint8Array(this.analyser.frequencyBinCount);
                    
                    this.canvas.width = 32; this.canvas.height = 32;
                    this.ctx = this.canvas.getContext('2d', {willReadFrequently: true});

                    this.active = true;
                    UI.setStatus('st-env', 'ACTIVE', '#0f0');
                    Logger.log("AV SENSORS ENGAGED", "INFO");
                    return true;
                } catch(e) {
                    Logger.log("AV INIT FAILED: " + e.message, "ERR");
                    return false;
                }
            },

            analyze: function() {
                if(!this.active) return { rms: 0, peak: 0, lux: 0 };

                // Audio
                this.analyser.getByteFrequencyData(this.freqData);
                let sum = 0, peakVal = 0, peakIdx = 0;
                for(let i=0; i<this.freqData.length; i++) {
                    sum += this.freqData[i];
                    if(this.freqData[i] > peakVal) { peakVal = this.freqData[i]; peakIdx = i; }
                }
                const rms = 20 * Math.log10((sum / this.freqData.length) / 255 || 0.0001);
                const nyquist = this.context.sampleRate / 2;
                const peakFreq = peakIdx * (nyquist / this.freqData.length);

                // Video (Luminance)
                this.ctx.drawImage(this.videoEl, 0, 0, 32, 32);
                const frame = this.ctx.getImageData(0,0,32,32).data;
                let lumSum = 0;
                for(let i=0; i<frame.length; i+=4) {
                    lumSum += (0.299*frame[i] + 0.587*frame[i+1] + 0.114*frame[i+2]);
                }
                const lux = Math.round(lumSum / (32*32));

                return { rms, peak: peakFreq, lux };
            }
        };

        // --- CORE SYSTEM ---

        const System = {
            init: async function() {
                document.getElementById('btn-init').disabled = true;
                IMU.init();
                GPS.init();
                await AV.init();
                
                document.getElementById('btn-rec').disabled = false;
                this.loop();
            },

            loop: function() {
                // Update Clock
                const now = new Date();
                document.getElementById('utc-clock').innerText = now.toISOString().split('T')[1].split('.')[0] + "Z";

                // Get Data
                const avData = AV.analyze();
                const gTotal = Math.sqrt(IMU.data.ax**2 + IMU.data.ay**2 + IMU.data.az**2) / 9.81;

                // Update UI
                UI.updateIMU(IMU.data, gTotal);
                UI.updateENV(avData);

                // Record
                if(State.recording) {
                    const timestamp = now.toISOString();
                    State.buffer.push([
                        timestamp,
                        IMU.data.ax.toFixed(4), IMU.data.ay.toFixed(4), IMU.data.az.toFixed(4),
                        IMU.data.alpha.toFixed(2), IMU.data.beta.toFixed(2), IMU.data.gamma.toFixed(2),
                        avData.rms.toFixed(2), avData.peak.toFixed(0), avData.lux
                    ]);
                }

                requestAnimationFrame(System.loop);
            },

            toggleRecord: function() {
                State.recording = !State.recording;
                const btn = document.getElementById('btn-rec');
                if(State.recording) {
                    btn.innerText = "STOP RECORDING";
                    btn.className = "recording";
                    State.buffer = [["TIMESTAMP_ISO", "ACC_X", "ACC_Y", "ACC_Z", "GYRO_A", "GYRO_B", "GYRO_G", "AUDIO_DB", "PEAK_HZ", "LUX_EST"]]; // Header
                    Logger.log("DATA LOGGING STARTED", "INFO");
                } else {
                    btn.innerText = "REC START";
                    btn.className = "";
                    document.getElementById('btn-exp').disabled = false;
                    Logger.log(`LOGGING STOPPED. ${State.buffer.length-1} SAMPLES CAPTURED.`, "INFO");
                }
            },

            exportData: function() {
                if(State.buffer.length < 2) return;
                let csvContent = "data:text/csv;charset=utf-8,";
                State.buffer.forEach(row => csvContent += row.join(",") + "\r\n");
                
                const encodedUri = encodeURI(csvContent);
                const link = document.createElement("a");
                link.setAttribute("href", encodedUri);
                link.setAttribute("download", `VANDENBERG_LOG_${Date.now()}.csv`);
                document.body.appendChild(link);
                link.click();
                link.remove();
                Logger.log("DATA EXPORTED TO CSV", "INFO");
            }
        };

        // --- UI & UTILS ---

        const UI = {
            setStatus: function(id, text, color) {
                const el = document.getElementById(id);
                el.innerText = text;
                el.style.color = color;
            },
            updateIMU: function(d, g) {
                document.getElementById('ax').innerText = d.ax.toFixed(3);
                document.getElementById('ay').innerText = d.ay.toFixed(3);
                document.getElementById('az').innerText = d.az.toFixed(3);
                document.getElementById('gt').innerText = g.toFixed(3);
                document.getElementById('ra').innerText = d.alpha.toFixed(1);
                document.getElementById('rb').innerText = d.beta.toFixed(1);
                document.getElementById('rg').innerText = d.gamma.toFixed(1);
            },
            updateGPS: function(c) {
                document.getElementById('lat').innerText = c.latitude.toFixed(6);
                document.getElementById('lon').innerText = c.longitude.toFixed(6);
                document.getElementById('alt').innerText = (c.altitude || 0).toFixed(1);
                document.getElementById('acc').innerText = c.accuracy.toFixed(1);
                document.getElementById('hdg').innerText = (c.heading || 0).toFixed(1);
                document.getElementById('spd').innerText = (c.speed || 0).toFixed(1);
            },
            updateENV: function(d) {
                document.getElementById('rms').innerText = d.rms.toFixed(1);
                document.getElementById('frq').innerText = d.peak.toFixed(0);
                document.getElementById('lux').innerText = d.lux;
            }
        };

        const Logger = {
            log: function(msg, type) {
                const p = document.getElementById('log-panel');
                const line = document.createElement('div');
                line.className = 'log-line';
                const ts = (performance.now() / 1000).toFixed(3);
                const cls = type === 'ERR' ? 'msg-err' : 'msg-info';
                line.innerHTML = `<span class="ts">T+${ts}</span><span class="${cls}">${msg}</span>`;
                p.prepend(line);
            }
        };

    </script>
</body>
</html>
