<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>MAGIC WONDER COMPASS | PRO</title>
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#0f0c29">

    <style>
        /* ------------------------------------------------------------------
           DESIGN SYSTEM: PURPLE NEON GLASSMORPHISM (iOS 14 Pro Optimized)
           ------------------------------------------------------------------ */
        :root {
            --bg-dark: #050508;
            --bg-gradient: linear-gradient(160deg, #0f0c29 0%, #302b63 50%, #24243e 100%);
            --glass-surf: rgba(255, 255, 255, 0.06);
            --glass-border: rgba(255, 255, 255, 0.12);
            --glass-highlight: rgba(255, 255, 255, 0.2);
            --blur-strength: 20px;
            
            --c-primary: #ffffff;
            --c-sec: #94a3b8;
            --c-neon-purple: #d946ef;
            --c-neon-blue: #60a5fa;
            --c-neon-red: #f43f5e;
            --c-warn: #fbbf24;

            --font-main: -apple-system, BlinkMacSystemFont, "SF Pro Display", "Inter", sans-serif;
            --font-mono: "SF Mono", "Menlo", monospace;
            
            --safe-top: env(safe-area-inset-top, 20px);
            --safe-bottom: env(safe-area-inset-bottom, 20px);
            
            --ease-elastic: cubic-bezier(0.175, 0.885, 0.32, 1.275);
            --ease-smooth: cubic-bezier(0.25, 0.46, 0.45, 0.94);
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; user-select: none; }

        body {
            margin: 0; padding: 0;
            background: var(--bg-dark);
            background-image: var(--bg-gradient);
            color: var(--c-primary);
            font-family: var(--font-main);
            height: 100vh; width: 100vw;
            overflow: hidden;
            display: flex; flex-direction: column;
        }

        /* BACKGROUND FX */
        .bg-orb {
            position: absolute; border-radius: 50%; filter: blur(80px); opacity: 0.4; z-index: 0;
            animation: float 10s infinite ease-in-out alternate;
        }
        .orb-1 { width: 300px; height: 300px; background: #7c3aed; top: -50px; left: -50px; }
        .orb-2 { width: 250px; height: 250px; background: #2563eb; bottom: 10%; right: -20px; animation-delay: -5s; }
        @keyframes float { 0% { transform: translate(0,0); } 100% { transform: translate(30px, 50px); } }

        /* UTILS */
        .hidden { display: none !important; }
        .flex-col { display: flex; flex-direction: column; }
        .flex-row { display: flex; align-items: center; }
        .flex-center { display: flex; align-items: center; justify-content: center; }
        .glass-card {
            background: var(--glass-surf);
            backdrop-filter: blur(var(--blur-strength));
            -webkit-backdrop-filter: blur(var(--blur-strength));
            border: 1px solid var(--glass-border);
            border-radius: 24px;
            box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.3);
        }
        .text-neon { color: var(--c-neon-purple); text-shadow: 0 0 10px rgba(217, 70, 239, 0.5); }
        .text-mono { font-family: var(--font-mono); letter-spacing: -0.5px; }

        /* --- UI LAYOUT --- */
        #app-container {
            position: relative; z-index: 10;
            flex: 1; display: flex; flex-direction: column;
            padding: var(--safe-top) 20px calc(var(--safe-bottom) + 10px) 20px;
            gap: 16px;
        }

        /* TOP BAR */
        .top-bar { justify-content: space-between; height: 50px; }
        .app-title { font-weight: 700; font-size: 1.1rem; letter-spacing: 0.5px; display: flex; align-items: center; gap: 8px; }
        .status-pill {
            font-size: 0.7rem; padding: 6px 12px; border-radius: 20px;
            background: rgba(0,0,0,0.3); border: 1px solid var(--glass-border);
            color: var(--c-sec); font-weight: 600;
        }
        .status-pill.active { color: var(--c-neon-blue); border-color: rgba(96, 165, 250, 0.3); }
        .settings-btn { font-size: 1.2rem; padding: 8px; cursor: pointer; opacity: 0.8; }

        /* COMPASS ORB (HERO) */
        .compass-stage {
            flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center;
            position: relative; min-height: 300px;
        }
        
        .orb-ring {
            width: 280px; height: 280px; border-radius: 50%;
            border: 1px solid rgba(255,255,255,0.1);
            position: relative;
            box-shadow: 0 0 40px rgba(139, 92, 246, 0.15);
            transition: transform 0.2s var(--ease-smooth);
        }
        
        /* Graduated ticks logic in CSS conic gradient for performance */
        .orb-ticks {
            position: absolute; inset: 0; border-radius: 50%;
            background: conic-gradient(
                from 0deg, 
                var(--glass-border) 0deg 1deg, transparent 1deg 29deg,
                var(--glass-border) 30deg 31deg, transparent 31deg 59deg,
                var(--glass-border) 60deg 61deg, transparent 61deg 89deg,
                rgba(255,255,255,0.5) 90deg 91deg, transparent 91deg 119deg, /* E */
                var(--glass-border) 120deg 121deg, transparent 121deg 149deg,
                var(--glass-border) 150deg 151deg, transparent 151deg 179deg,
                rgba(255,255,255,0.5) 180deg 181deg, transparent 181deg 209deg, /* S */
                var(--glass-border) 210deg 211deg, transparent 211deg 239deg,
                var(--glass-border) 240deg 241deg, transparent 241deg 269deg,
                rgba(255,255,255,0.5) 270deg 271deg, transparent 271deg 299deg, /* W */
                var(--glass-border) 300deg 301deg, transparent 301deg 329deg,
                var(--glass-border) 330deg 331deg, transparent 331deg 359deg,
                var(--c-neon-purple) 360deg
            );
            mask: radial-gradient(transparent 65%, black 66%);
            -webkit-mask: radial-gradient(transparent 65%, black 66%);
        }

        .cardinal { position: absolute; font-weight: 700; font-size: 0.9rem; color: var(--c-sec); }
        .c-n { top: 10px; left: 50%; transform: translateX(-50%); color: var(--c-neon-purple); }
        .c-e { right: 15px; top: 50%; transform: translateY(-50%); }
        .c-s { bottom: 10px; left: 50%; transform: translateX(-50%); }
        .c-w { left: 15px; top: 50%; transform: translateY(-50%); }

        /* NEEDLES */
        .needle-container { position: absolute; inset: 0; pointer-events: none; }
        .needle {
            position: absolute; top: 50%; left: 50%; width: 4px; height: 42%;
            transform-origin: bottom center; margin-left: -2px; margin-top: -42%;
            border-radius: 4px; transition: transform 0.5s var(--ease-elastic); will-change: transform;
        }
        .n-wonder { background: var(--c-neon-purple); box-shadow: 0 0 12px var(--c-neon-purple); z-index: 3; }
        .n-wonder::after { content: ''; position: absolute; top: -6px; left: -4px; border-bottom: 12px solid var(--c-neon-purple); border-left: 6px solid transparent; border-right: 6px solid transparent; }
        
        .n-north { background: var(--c-neon-blue); height: 45%; margin-top: -45%; z-index: 2; opacity: 0.8; }
        .n-mag { height: 35%; margin-top: -35%; border-left: 2px dashed var(--c-neon-red); width: 0; margin-left: -1px; z-index: 2; opacity: 0.6; }
        
        .center-data {
            position: absolute; text-align: center; top: 50%; left: 50%; transform: translate(-50%, -50%);
            display: flex; flex-direction: column;
        }
        .heading-val { font-size: 2.5rem; font-weight: 800; line-height: 1; }
        .heading-lbl { font-size: 0.7rem; color: var(--c-sec); letter-spacing: 2px; margin-top: 4px; }

        /* INFO CARD */
        .info-card {
            padding: 20px; display: flex; flex-direction: column; gap: 12px;
            position: relative; overflow: hidden;
        }
        .info-card::before { content: ''; position: absolute; top:0; left:0; width: 4px; height: 100%; background: var(--c-neon-purple); }
        
        .target-row { display: flex; justify-content: space-between; align-items: flex-end; }
        .target-name { font-size: 1.4rem; font-weight: 700; line-height: 1.1; color: #fff; max-width: 75%; }
        .target-tag { font-size: 0.7rem; background: rgba(217, 70, 239, 0.2); color: var(--c-neon-purple); padding: 4px 8px; border-radius: 6px; font-weight: 600; }
        
        .stats-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-top: 8px; }
        .stat-box { background: rgba(0,0,0,0.2); padding: 10px; border-radius: 12px; }
        .stat-lbl { font-size: 0.7rem; color: var(--c-sec); margin-bottom: 4px; }
        .stat-val { font-size: 1.1rem; font-weight: 600; font-family: var(--font-mono); }

        /* CONTROL BAR */
        .control-dock {
            display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px;
            padding: 4px; background: rgba(0,0,0,0.2); border-radius: 30px;
        }
        .mode-btn {
            background: transparent; border: none; color: var(--c-sec);
            padding: 12px; border-radius: 24px; font-size: 0.8rem; font-weight: 600;
            transition: all 0.2s; cursor: pointer;
        }
        .mode-btn.active { background: var(--glass-highlight); color: #fff; box-shadow: 0 2px 10px rgba(0,0,0,0.2); }

        /* ACTION BUTTONS (Auto, Next, Map) */
        .actions-row { display: flex; gap: 10px; margin-top: 4px; }
        .action-pill {
            flex: 1; background: rgba(255,255,255,0.05); border: 1px solid var(--glass-border);
            color: var(--c-sec); padding: 10px; border-radius: 16px; font-size: 0.75rem;
            display: flex; align-items: center; justify-content: center; gap: 6px; cursor: pointer;
            transition: background 0.2s;
        }
        .action-pill:active { background: rgba(255,255,255,0.15); }
        .icon-s { font-size: 1rem; }

        /* PERMISSION OVERLAY */
        #perm-overlay {
            position: fixed; inset: 0; z-index: 999;
            background: rgba(5, 5, 8, 0.9); backdrop-filter: blur(30px);
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            text-align: center; padding: 40px;
        }
        .btn-primary {
            background: var(--c-neon-purple); color: #fff; border: none;
            padding: 16px 40px; border-radius: 50px; font-size: 1rem; font-weight: 700;
            box-shadow: 0 0 20px rgba(217, 70, 239, 0.4); margin-top: 30px;
            cursor: pointer;
        }

        /* SCANLINE FX (Myth Mode) */
        .scanlines {
            position: fixed; inset: 0; pointer-events: none; z-index: 5; opacity: 0; transition: opacity 0.5s;
            background: repeating-linear-gradient(0deg, rgba(0,0,0,0) 0px, rgba(0,0,0,0) 1px, rgba(255,255,255,0.03) 2px, rgba(255,255,255,0.03) 3px);
        }
        .myth-active .scanlines { opacity: 1; }
        .myth-active .heading-val { text-shadow: 2px 0 var(--c-neon-red), -2px 0 cyan; }

        /* SETTINGS MODAL */
        #modal {
            position: fixed; inset: 0; z-index: 100; background: rgba(0,0,0,0.8);
            backdrop-filter: blur(10px); padding: 20px; display: flex; align-items: center; justify-content: center;
        }
        .modal-content { width: 100%; max-width: 400px; padding: 24px; position: relative; }
        .close-modal { position: absolute; top: 20px; right: 20px; font-size: 1.5rem; }
        .input-group { margin-bottom: 16px; }
        .input-group label { display: block; font-size: 0.8rem; color: var(--c-sec); margin-bottom: 6px; }
        .input-group input { width: 100%; background: rgba(255,255,255,0.1); border: 1px solid var(--glass-border); color: #fff; padding: 12px; border-radius: 12px; }

    </style>
</head>
<body>

    <!-- BACKGROUND -->
    <div class="bg-orb orb-1"></div>
    <div class="bg-orb orb-2"></div>
    <div class="scanlines"></div>

    <!-- PERMISSION SCREEN -->
    <div id="perm-overlay">
        <h1 style="font-size: 2rem; margin-bottom: 10px;">MAGIC<br>COMPASS</h1>
        <p style="color: var(--c-sec);">Precision Sensor Fusion<br>For iPhone 14 Pro & Modern Android</p>
        <button class="btn-primary" id="btn-start">INITIALIZE SENSORS</button>
        <p style="font-size: 0.7rem; color: #555; margin-top: 20px;">Requires Motion & GPS Permissions</p>
    </div>

    <!-- MAIN APP -->
    <div id="app-container" class="hidden">
        
        <!-- Top Bar -->
        <div class="flex-row top-bar">
            <div class="app-title">
                <span style="color:var(--c-neon-purple)">✦</span> WONDER CMPSS
            </div>
            <div class="flex-row" style="gap:8px">
                <div class="status-pill" id="pill-gps">GPS WAIT</div>
                <div class="settings-btn" onclick="app.toggleSettings()">⚙</div>
            </div>
        </div>

        <!-- Compass Core -->
        <div class="compass-stage">
            <div class="orb-ring" id="orb-ring">
                <div class="orb-ticks"></div>
                <div class="cardinal c-n">N</div>
                <div class="cardinal c-e">E</div>
                <div class="cardinal c-s">S</div>
                <div class="cardinal c-w">W</div>
                
                <!-- Needles -->
                <div class="needle-container">
                    <div class="needle n-wonder" id="ndl-target"></div>
                    <div class="needle n-north" id="ndl-true"></div>
                    <div class="needle n-mag" id="ndl-mag"></div>
                </div>

                <!-- Center Data -->
                <div class="center-data">
                    <span class="heading-val text-mono" id="val-heading">000°</span>
                    <span class="heading-lbl" id="lbl-sub">HEADING</span>
                </div>
            </div>
        </div>

        <!-- Info Dashboard -->
        <div class="info-card glass-card" id="info-panel">
            <div class="target-row">
                <div class="target-name" id="txt-name">Select Target</div>
                <div class="target-tag" id="txt-tag">SYSTEM</div>
            </div>
            
            <div class="stats-grid">
                <div class="stat-box">
                    <div class="stat-lbl">DISTANCE</div>
                    <div class="stat-val text-neon" id="val-dist">-- km</div>
                </div>
                <div class="stat-box">
                    <div class="stat-lbl" id="lbl-extra">BEARING</div>
                    <div class="stat-val" id="val-extra">--°</div>
                </div>
            </div>

            <!-- Sub Controls (Wonder Mode) -->
            <div class="actions-row" id="row-wonder-actions">
                <div class="action-pill" onclick="app.toggleAutoNearest()">
                    <span class="icon-s">⟳</span> <span id="txt-auto">Auto: ON</span>
                </div>
                <div class="action-pill" onclick="app.nextNearest()">
                    <span class="icon-s">→</span> Next
                </div>
                <div class="action-pill" onclick="app.openMap()">
                    <span class="icon-s">↗</span> Map
                </div>
            </div>

            <div id="myth-disclaimer" class="hidden" style="font-size: 0.6rem; color: var(--c-sec); margin-top: 10px; text-align: center;">
                ⚠️ MYTH MODE: Narrative purpose only. Sensor data creates procedural noise. Not a ghost detector.
            </div>
        </div>

        <!-- Bottom Mode Switcher -->
        <div style="margin-top: auto;">
            <div class="control-dock glass-card">
                <button class="mode-btn active" onclick="app.setMode('wonder')">WONDER</button>
                <button class="mode-btn" onclick="app.setMode('magnetic')">EARTH</button>
                <button class="mode-btn" onclick="app.setMode('myth')">MYTH</button>
            </div>
        </div>

    </div>

    <!-- SETTINGS MODAL -->
    <div id="modal" class="hidden">
        <div class="modal-content glass-card">
            <span class="close-modal" onclick="app.toggleSettings()">×</span>
            <h2 style="margin-top:0">Settings</h2>
            
            <div class="input-group">
                <label>Magnetic Declination (deg)</label>
                <div style="display:flex; gap:10px;">
                    <input type="number" id="inp-decl" value="0">
                    <button class="action-pill" style="flex:0 0 80px" onclick="app.fetchDeclination()">Fetch</button>
                </div>
                <small style="color:var(--c-sec); font-size:0.65rem;">Positive = East, Negative = West</small>
            </div>

            <div class="input-group">
                <label>Sound FX</label>
                <button class="action-pill" style="width:100%" onclick="app.toggleMute()" id="btn-mute">Sound: ON</button>
            </div>
        </div>
    </div>

<script>
/**
 * MAGIC WONDER COMPASS PRO
 * Architecture:
 * 1. MathUtils: Pure geometry functions.
 * 2. SensorEngine: Hardware abstraction (iOS/Android).
 * 3. LogicCore: Business logic (Nearest wonder, formatting).
 * 4. CompassApp: Main state & UI Controller.
 */

// --- 1. DATA ---
const WONDERS = [
    { name: "Great Pyramid", lat: 29.9792, lon: 31.1342, region: "Egypt (Ancient)" },
    { name: "Great Wall", lat: 40.4319, lon: 116.5704, region: "China (New7)" },
    { name: "Petra", lat: 30.3285, lon: 35.4444, region: "Jordan (New7)" },
    { name: "Colosseum", lat: 41.8902, lon: 12.4922, region: "Italy (New7)" },
    { name: "Chichen Itza", lat: 20.6843, lon: -88.5678, region: "Mexico (New7)" },
    { name: "Machu Picchu", lat: -13.1631, lon: -72.5450, region: "Peru (New7)" },
    { name: "Taj Mahal", lat: 27.1751, lon: 78.0421, region: "India (New7)" },
    { name: "Christ Redeemer", lat: -22.9519, lon: -43.2105, region: "Brazil (New7)" },
    { name: "Stonehenge", lat: 51.1789, lon: -1.8262, region: "UK (Ancient)" },
    { name: "Bermuda Triangle", lat: 25.0, lon: -71.0, region: "Atlantic (Myth)" }
];

// --- 2. MATH UTILS ---
const MathUtils = {
    toRad: (d) => d * Math.PI / 180,
    toDeg: (r) => r * 180 / Math.PI,
    
    // Great-Circle Distance (Haversine)
    getDistance: (lat1, lon1, lat2, lon2) => {
        const R = 6371; 
        const dLat = MathUtils.toRad(lat2 - lat1);
        const dLon = MathUtils.toRad(lon2 - lon1);
        const a = Math.sin(dLat/2)**2 + Math.cos(MathUtils.toRad(lat1)) * Math.cos(MathUtils.toRad(lat2)) * Math.sin(dLon/2)**2;
        return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
    },

    // Initial Bearing (0-360)
    getBearing: (lat1, lon1, lat2, lon2) => {
        const y = Math.sin(MathUtils.toRad(lon2 - lon1)) * Math.cos(MathUtils.toRad(lat2));
        const x = Math.cos(MathUtils.toRad(lat1)) * Math.sin(MathUtils.toRad(lat2)) -
                Math.sin(MathUtils.toRad(lat1)) * Math.cos(MathUtils.toRad(lat2)) * Math.cos(MathUtils.toRad(lon2 - lon1));
        const b = MathUtils.toDeg(Math.atan2(y, x));
        return (b + 360) % 360;
    },

    // Shortest angle interpolation
    lerpAngle: (a, b, t) => {
        let delta = b - a;
        if (delta > 180) delta -= 360;
        if (delta < -180) delta += 360;
        return a + delta * t;
    }
};

// --- 3. SENSOR ENGINE ---
class SensorEngine {
    constructor() {
        this.heading = 0; // 0 = Mag North
        this.gps = { lat: null, lon: null, acc: 0 };
        this.mag = { x: 0, y: 0, z: 0, strength: 0, available: false };
        this.callbacks = {};
    }

    init() {
        return new Promise(async (resolve, reject) => {
            // 1. GPS
            if ("geolocation" in navigator) {
                navigator.geolocation.watchPosition(
                    pos => {
                        this.gps = { lat: pos.coords.latitude, lon: pos.coords.longitude, acc: pos.coords.accuracy };
                        this.emit('gps', this.gps);
                    },
                    err => console.warn('GPS Err', err),
                    { enableHighAccuracy: true, maximumAge: 0 }
                );
            }

            // 2. ORIENTATION (iOS 13+ needs permission)
            if (typeof DeviceOrientationEvent !== 'undefined' && typeof DeviceOrientationEvent.requestPermission === 'function') {
                try {
                    const response = await DeviceOrientationEvent.requestPermission();
                    if (response === 'granted') {
                        window.addEventListener('deviceorientation', e => this.handleOrientation(e));
                        resolve(true);
                    } else {
                        reject('Permission denied');
                    }
                } catch (e) { reject(e); }
            } else {
                // Android / Old iOS
                window.addEventListener('deviceorientationabsolute', e => this.handleOrientation(e, true));
                window.addEventListener('deviceorientation', e => this.handleOrientation(e, false));
                
                // 3. MAGNETOMETER (Android Generic Sensor API)
                // @ts-ignore
                if ('Magnetometer' in window) {
                    try {
                        // @ts-ignore
                        const mag = new Magnetometer({ frequency: 60 });
                        mag.addEventListener('reading', () => {
                            this.mag.available = true;
                            this.mag.x = mag.x; this.mag.y = mag.y; this.mag.z = mag.z;
                            this.mag.strength = Math.sqrt(mag.x**2 + mag.y**2 + mag.z**2);
                        });
                        mag.start();
                    } catch(e) { console.log('Mag API not supported'); }
                }
                resolve(true);
            }
        });
    }

    handleOrientation(e, absolute) {
        // iOS Priority
        if (e.webkitCompassHeading) {
            this.heading = e.webkitCompassHeading;
        } else if (e.alpha !== null) {
            // Android standard (simplified, assumes standard portrait use)
            this.heading = 360 - e.alpha; 
        }
    }

    on(event, fn) { this.callbacks[event] = fn; }
    emit(event, data) { if(this.callbacks[event]) this.callbacks[event](data); }
}

// --- 4. MAIN APP LOGIC ---
class CompassApp {
    constructor() {
        this.sensor = new SensorEngine();
        this.mode = 'wonder'; // wonder | magnetic | myth
        this.state = {
            targetIndex: 0, // Index in filtered array
            sortedWonders: [...WONDERS], // Will be sorted by dist
            autoNearest: true,
            declination: parseFloat(localStorage.getItem('declination') || '0'),
            muted: false,
            mythSeed: 0,
            displayHeading: 0
        };

        // UI Refs
        this.ui = {
            ring: document.getElementById('orb-ring'),
            needles: {
                target: document.getElementById('ndl-target'),
                true: document.getElementById('ndl-true'),
                mag: document.getElementById('ndl-mag')
            },
            text: {
                heading: document.getElementById('val-heading'),
                name: document.getElementById('txt-name'),
                tag: document.getElementById('txt-tag'),
                dist: document.getElementById('val-dist'),
                extraLbl: document.getElementById('lbl-extra'),
                extraVal: document.getElementById('val-extra'),
                gps: document.getElementById('pill-gps'),
                auto: document.getElementById('txt-auto')
            },
            actions: document.getElementById('row-wonder-actions')
        };
    }

    async start() {
        try {
            await this.sensor.init();
            document.getElementById('perm-overlay').classList.add('hidden');
            document.getElementById('app-container').classList.remove('hidden');
            
            this.sensor.on('gps', () => {
                this.ui.text.gps.innerText = "GPS LOCKED";
                this.ui.text.gps.classList.add('active');
                this.updateDistances();
            });

            this.loop();
        } catch (e) {
            alert("Sensors required! " + e);
        }
    }

    updateDistances() {
        if (!this.sensor.gps.lat) return;
        
        // Calculate distances and sort
        this.state.sortedWonders = WONDERS.map(w => {
            const d = MathUtils.getDistance(this.sensor.gps.lat, this.sensor.gps.lon, w.lat, w.lon);
            return { ...w, distance: d };
        }).sort((a, b) => a.distance - b.distance);

        // If auto, snap to nearest (index 0)
        if (this.state.autoNearest) {
            this.state.targetIndex = 0;
        }
    }

    setMode(mode) {
        this.mode = mode;
        document.querySelectorAll('.mode-btn').forEach(b => b.classList.remove('active'));
        event.target.classList.add('active');

        // Reset UI visibility
        Object.values(this.ui.needles).forEach(n => n.style.display = 'none');
        document.body.classList.remove('myth-active');
        document.getElementById('myth-disclaimer').classList.add('hidden');
        this.ui.actions.classList.add('hidden');
        this.ui.text.tag.style.display = 'block';

        if (mode === 'wonder') {
            this.ui.needles.target.style.display = 'block';
            this.ui.actions.classList.remove('hidden');
            this.ui.text.extraLbl.innerText = "BEARING";
        } else if (mode === 'magnetic') {
            this.ui.needles.true.style.display = 'block';
            this.ui.needles.mag.style.display = 'block';
            this.ui.text.name.innerText = "Magnetic Field";
            this.ui.text.tag.innerText = "EARTH";
            this.ui.text.dist.innerText = this.state.declination.toFixed(1) + "°";
            this.ui.text.extraLbl.innerText = "INTENSITY";
        } else if (mode === 'myth') {
            document.body.classList.add('myth-active');
            document.getElementById('myth-disclaimer').classList.remove('hidden');
            this.ui.needles.target.style.display = 'block'; // Reuse purple needle as "Sensor"
            this.ui.text.name.innerText = "Anomaly Scan";
            this.ui.text.tag.innerText = "SEARCHING";
            this.ui.text.extraLbl.innerText = "VARIANCE";
        }
    }

    // Wonder Actions
    toggleAutoNearest() {
        this.state.autoNearest = !this.state.autoNearest;
        this.ui.text.auto.innerText = this.state.autoNearest ? "Auto: ON" : "Auto: OFF";
        if(this.state.autoNearest) this.updateDistances();
    }

    nextNearest() {
        this.state.autoNearest = false;
        this.ui.text.auto.innerText = "Auto: OFF";
        this.state.targetIndex = (this.state.targetIndex + 1) % this.state.sortedWonders.length;
    }

    openMap() {
        const t = this.state.sortedWonders[this.state.targetIndex];
        if(t) window.open(`https://maps.google.com/?q=${t.lat},${t.lon}`);
    }

    // Magnetic Logic
    fetchDeclination() {
        if(!this.sensor.gps.lat) return alert("Need GPS first");
        const url = `https://www.ngdc.noaa.gov/geomag-web/calculators/calculateDeclination?lat1=${this.sensor.gps.lat}&lon1=${this.sensor.gps.lon}&resultFormat=json`;
        fetch(url)
            .then(r => r.json())
            .then(d => {
                const val = d.result[0].declination;
                this.state.declination = val;
                document.getElementById('inp-decl').value = val.toFixed(2);
                localStorage.setItem('declination', val);
                alert("Declination Updated: " + val.toFixed(2));
            })
            .catch(() => alert("Offline. Enter manually."));
    }

    toggleSettings() {
        document.getElementById('modal').classList.toggle('hidden');
    }
    
    toggleMute() {
        this.state.muted = !this.state.muted;
        document.getElementById('btn-mute').innerText = this.state.muted ? "Sound: OFF" : "Sound: ON";
    }

    // --- RENDER LOOP ---
    loop() {
        requestAnimationFrame(() => this.loop());

        // 1. Heading Smoothing
        const rawHeading = this.sensor.heading || 0;
        this.state.displayHeading = MathUtils.lerpAngle(this.state.displayHeading, rawHeading, 0.15);
        
        // Rotate Ring: The ring rotates -heading so "N" points North on screen
        this.ui.ring.style.transform = `rotate(${-this.state.displayHeading}deg)`;
        this.ui.text.heading.innerText = Math.round(this.state.displayHeading).toString().padStart(3,'0') + "°";

        // 2. Mode Render
        if (this.mode === 'wonder') {
            const t = this.state.sortedWonders[this.state.targetIndex];
            if (!t) return;

            // Update Text
            this.ui.text.name.innerText = t.name;
            this.ui.text.tag.innerText = t.region.toUpperCase();
            this.ui.text.dist.innerText = (t.distance || 0).toFixed(1) + " km";
            
            if (this.sensor.gps.lat) {
                const bearing = MathUtils.getBearing(this.sensor.gps.lat, this.sensor.gps.lon, t.lat, t.lon);
                this.ui.text.extraVal.innerText = Math.round(bearing) + "°";
                // Rotate needle relative to Ring (Ring is World Frame). Needle points to Bearing.
                this.ui.needles.target.style.transform = `translateX(-50%) rotate(${bearing}deg)`;
            }

        } else if (this.mode === 'magnetic') {
            // True North Needle: Offset by -Declination from Mag North (0 on ring)
            // If Dec is East (+), True North is -Dec degrees relative to Mag
            const trueH = -this.state.declination;
            this.ui.needles.true.style.transform = `translateX(-50%) rotate(${trueH}deg)`;
            // Mag Needle always points to 0 (N on ring)
            this.ui.needles.mag.style.transform = `translateX(-50%) rotate(0deg)`;

            this.ui.text.extraVal.innerText = this.sensor.mag.available ? 
                this.sensor.mag.strength.toFixed(1) + " µT" : "N/A";

        } else if (this.mode === 'myth') {
            // Procedural Noise or Real Variance
            const time = Date.now() / 1000;
            let noise = 0;
            
            if (this.sensor.mag.available) {
                // Real mag variance visualizer
                noise = (this.sensor.mag.strength % 50) * 7.2; // arbitrary map
                this.ui.text.extraVal.innerText = (this.sensor.mag.strength % 10).toFixed(2) + " Δ";
            } else {
                // Deterministic "Ghost" based on Location + Time
                const locSeed = this.sensor.gps.lat ? (this.sensor.gps.lat + this.sensor.gps.lon) : 0;
                noise = Math.sin(time * 0.5 + locSeed) * 180 + Math.cos(time * 2) * 30;
                this.ui.text.extraVal.innerText = (Math.abs(Math.sin(time))*100).toFixed(0) + "%";
            }
            
            // Glitch Text effect
            if (Math.random() > 0.92) this.ui.text.dist.innerText = "E̶R̶R̶O̶R̶";
            else this.ui.text.dist.innerText = "SCANNING";

            this.ui.needles.target.style.transform = `translateX(-50%) rotate(${noise}deg)`;
        }
    }
}

// Init
const app = new CompassApp();
document.getElementById('btn-start').addEventListener('click', () => app.start());

</script>
</body>
</html>
