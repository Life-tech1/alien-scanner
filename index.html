<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>AURA | Intelligent Weather</title>
    
    <!-- Fonts: Kanit (Thai) & Outfit (Numbers/Eng) -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@200;300;400;500;600&family=Outfit:wght@200;400;600;700&display=swap" rel="stylesheet">
    
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>

    <style>
        :root {
            /* Palette: Premium Soft Tech */
            --bg-body: #F2F5F9; /* Cool Gray */
            --surface: #FFFFFF;
            --primary: #007AFF; /* Apple Blue */
            --primary-soft: rgba(0, 122, 255, 0.1);
            --text-main: #1D1D1F; /* Almost Black */
            --text-sec: #86868B;
            --accent-warm: #FF9500;
            --accent-danger: #FF3B30;
            --accent-success: #34C759;
            
            /* Shadows: Super Soft & Layered */
            --shadow-card: 0 8px 30px rgba(0,0,0,0.04), 0 4px 12px rgba(0,0,0,0.02);
            --shadow-float: 0 20px 40px rgba(0,0,0,0.08);
            
            /* Spacing & Radius */
            --radius-xl: 32px;
            --radius-l: 24px;
            --radius-m: 16px;
            --pad: 24px;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; -webkit-font-smoothing: antialiased; }
        
        body {
            background-color: var(--bg-body);
            font-family: 'Kanit', sans-serif;
            color: var(--text-main);
            height: 100vh;
            overflow-x: hidden;
            display: flex;
            justify-content: center;
        }

        /* --- Layout Container --- */
        .app-container {
            width: 100%;
            max-width: 1200px;
            padding: 40px var(--pad);
            display: grid;
            grid-template-columns: 380px 1fr;
            gap: 30px;
            opacity: 0;
            transform: translateY(20px);
            animation: fadeInApp 0.8s cubic-bezier(0.2, 0.8, 0.2, 1) forwards;
        }

        /* --- Left Column (Hero) --- */
        .col-main {
            display: flex;
            flex-direction: column;
            gap: 24px;
        }

        /* --- Right Column (Details) --- */
        .col-details {
            display: flex;
            flex-direction: column;
            gap: 24px;
        }

        /* --- Cards System --- */
        .card {
            background: var(--surface);
            border-radius: var(--radius-l);
            padding: var(--pad);
            box-shadow: var(--shadow-card);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            position: relative;
            overflow: hidden;
        }
        .card:hover {
            transform: translateY(-4px);
            box-shadow: var(--shadow-float);
        }

        /* --- Typography --- */
        h1, h2, h3 { font-weight: 500; }
        .num-font { font-family: 'Outfit', sans-serif; letter-spacing: -0.02em; }
        .label { font-size: 14px; color: var(--text-sec); font-weight: 300; text-transform: uppercase; letter-spacing: 0.05em; margin-bottom: 12px; display: flex; align-items: center; gap: 6px; }

        /* --- Header --- */
        header {
            grid-column: 1 / -1;
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        .brand { font-size: 24px; font-weight: 600; display: flex; align-items: center; gap: 8px; }
        .brand span { width: 8px; height: 8px; background: var(--primary); border-radius: 50%; display: inline-block; }
        .controls { display: flex; gap: 12px; }
        .btn-pill {
            background: #FFFFFF;
            border: 1px solid rgba(0,0,0,0.05);
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 14px;
            cursor: pointer;
            transition: 0.2s;
            display: flex; align-items: center; gap: 6px;
            color: var(--text-sec);
            box-shadow: 0 2px 4px rgba(0,0,0,0.02);
        }
        .btn-pill:hover, .btn-pill.active { background: var(--primary); color: white; border-color: var(--primary); }

        /* --- Hero Weather Card --- */
        .hero-card {
            background: linear-gradient(135deg, #FFFFFF 0%, #F5F7FA 100%);
            min-height: 400px;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
        }
        .loc-badge {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            background: rgba(0,0,0,0.03);
            padding: 6px 12px;
            border-radius: 12px;
            font-size: 14px;
            color: var(--text-sec);
        }
        .temp-hero {
            font-size: 110px;
            font-weight: 600;
            line-height: 1;
            background: linear-gradient(180deg, #1D1D1F 0%, #48484A 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin: 20px 0;
        }
        .condition-text { font-size: 24px; color: var(--text-sec); font-weight: 300; }
        
        /* --- AI Insight --- */
        .ai-box {
            background: var(--primary-soft);
            border-radius: var(--radius-m);
            padding: 16px;
            display: flex;
            gap: 12px;
            align-items: flex-start;
        }
        .ai-icon { font-size: 20px; }
        .ai-text { font-size: 15px; color: #004D9F; line-height: 1.5; font-weight: 400; }

        /* --- Chart Section --- */
        .chart-container {
            width: 100%;
            height: 180px;
            position: relative;
        }
        canvas { width: 100%; height: 100%; }

        /* --- Stats Grid --- */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 20px;
        }
        .stat-item {
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            padding: 30px 10px;
            text-align: center;
        }
        .stat-value { font-size: 28px; font-weight: 600; margin-top: 8px; }
        
        /* AQI Donut */
        .aqi-ring { position: relative; width: 100px; height: 100px; display: flex; justify-content: center; align-items: center; margin: 0 auto; }
        .aqi-svg { transform: rotate(-90deg); width: 100%; height: 100%; }
        .aqi-circle-bg { fill: none; stroke: #eee; stroke-width: 8; }
        .aqi-circle-val { fill: none; stroke: var(--accent-success); stroke-width: 8; stroke-dasharray: 251; stroke-dashoffset: 251; transition: stroke-dashoffset 1.5s ease; stroke-linecap: round; }
        .aqi-inner { position: absolute; font-size: 24px; font-weight: 600; }

        /* Compass */
        .compass { width: 80px; height: 80px; border: 2px solid #E5E5EA; border-radius: 50%; position: relative; margin: 0 auto 10px; }
        .compass-arrow {
            width: 4px; height: 30px; background: var(--primary);
            position: absolute; top: 10px; left: 50%; margin-left: -2px;
            transform-origin: 50% 30px; /* Pivot point */
            border-radius: 2px;
            transition: transform 1s cubic-bezier(0.34, 1.56, 0.64, 1);
        }
        .compass-arrow::after { content:''; position: absolute; top:-6px; left:-3px; border-left:5px solid transparent; border-right:5px solid transparent; border-bottom:8px solid var(--primary); }

        /* --- Radar --- */
        #map { width: 100%; height: 280px; border-radius: var(--radius-m); background: #f0f0f0; }
        .leaflet-pane { opacity: 0.9; } /* Soften map */

        /* --- 7 Day List --- */
        .day-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 0;
            border-bottom: 1px solid #F5F5F7;
        }
        .day-row:last-child { border: none; }
        .day-name { width: 60px; font-weight: 500; }
        .day-icon { font-size: 20px; width: 30px; text-align: center; }
        .day-bar-container { flex: 1; margin: 0 16px; height: 4px; background: #E5E5EA; border-radius: 2px; position: relative; overflow: hidden; }
        .day-bar-fill { height: 100%; background: linear-gradient(90deg, #8E2DE2, #4A00E0); border-radius: 2px; } /* Generic gradient, will be dynamic */
        .day-temps { width: 70px; text-align: right; font-size: 14px; font-feature-settings: "tnum"; }
        .min-t { color: var(--text-sec); margin-right: 4px; }

        /* --- Animations --- */
        @keyframes fadeInApp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }

        /* --- Responsive --- */
        @media (max-width: 900px) {
            .app-container { grid-template-columns: 1fr; max-width: 600px; }
            .col-main { order: 1; }
            .col-details { order: 2; }
            .hero-card { min-height: auto; }
        }
        
        /* Utility */
        .skeleton { background: #eee; border-radius: 4px; color: transparent; animation: pulse 1.5s infinite; }
        @keyframes pulse { 0% { opacity: 0.6; } 50% { opacity: 1; } 100% { opacity: 0.6; } }

    </style>
</head>
<body>

<div class="app-container">
    
    <!-- Header -->
    <header>
        <div class="brand"><span></span> AURA</div>
        <div class="controls">
            <button class="btn-pill active" id="btn-th">TH</button>
            <button class="btn-pill" id="btn-en">EN</button>
            <button class="btn-pill" id="btn-loc" style="width: 40px; justify-content:center;">üìç</button>
        </div>
    </header>

    <!-- LEFT COLUMN -->
    <div class="col-main">
        <!-- Hero Weather -->
        <section class="card hero-card">
            <div>
                <div class="loc-badge" id="location-name">Bangkok, Thailand</div>
                <div class="temp-hero num-font"><span id="current-temp">--</span>¬∞</div>
                <div class="condition-text" id="condition-text">Loading Data...</div>
                <div style="margin-top: 8px; font-size: 16px; color: var(--text-sec);">
                    H: <span id="max-temp" class="num-font">--</span>¬∞ 
                    L: <span id="min-temp" class="num-font">--</span>¬∞
                </div>
            </div>
            
            <!-- AI Insight -->
            <div class="ai-box">
                <div class="ai-icon">‚ú®</div>
                <div class="ai-text" id="ai-insight">
                    ‡∏£‡∏∞‡∏ö‡∏ö‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏™‡∏†‡∏≤‡∏û‡∏≠‡∏≤‡∏Å‡∏≤‡∏®‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡∏∏‡∏ì...
                </div>
            </div>
        </section>

        <!-- 48h Forecast Graph -->
        <section class="card">
            <div class="label">
                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 20v-6M6 20V10M18 20V4"/></svg>
                FORECAST (48H)
            </div>
            <div class="chart-container">
                <canvas id="tempChart"></canvas>
            </div>
        </section>
        
        <!-- Radar -->
        <section class="card" style="padding: 0;">
            <div id="map"></div>
            <div style="position:absolute; top:16px; left:16px; background:rgba(255,255,255,0.8); backdrop-filter:blur(4px); padding:4px 8px; border-radius:8px; font-size:10px; z-index:999;">PRECIPITATION RADAR</div>
        </section>
    </div>

    <!-- RIGHT COLUMN -->
    <div class="col-details">
        
        <!-- Stats Grid -->
        <section class="stats-grid">
            <!-- AQI -->
            <div class="card stat-item">
                <div class="label">AIR QUALITY</div>
                <div class="aqi-ring">
                    <svg class="aqi-svg" viewBox="0 0 100 100">
                        <circle class="aqi-circle-bg" cx="50" cy="50" r="40"></circle>
                        <circle class="aqi-circle-val" cx="50" cy="50" r="40" id="aqi-circle"></circle>
                    </svg>
                    <div class="aqi-inner num-font" id="aqi-val">--</div>
                </div>
                <div style="font-size:14px; margin-top:8px; color:var(--text-sec);" id="aqi-status">-</div>
            </div>
            
            <!-- Wind -->
            <div class="card stat-item">
                <div class="label">WIND</div>
                <div class="compass">
                    <div class="compass-arrow" id="wind-arrow"></div>
                    <div style="position:absolute; top:4px; left:0; width:100%; text-align:center; font-size:10px; color:#ccc;">N</div>
                </div>
                <div class="stat-value num-font"><span id="wind-speed">--</span> <span style="font-size:14px; color:var(--text-sec);">km/h</span></div>
            </div>

            <!-- UV & Humidity -->
            <div class="card stat-item" style="align-items: flex-start; text-align:left;">
                <div class="label">UV INDEX</div>
                <div class="stat-value num-font" id="uv-val">--</div>
                <div style="font-size:14px; color:var(--text-sec); margin-top:4px;" id="uv-status">Low</div>
            </div>
            <div class="card stat-item" style="align-items: flex-start; text-align:left;">
                <div class="label">HUMIDITY</div>
                <div class="stat-value num-font"><span id="humidity-val">--</span>%</div>
                <div style="font-size:14px; color:var(--text-sec); margin-top:4px;">Dew Point: <span id="dew-point">--</span>¬∞</div>
            </div>
        </section>

        <!-- 7-Day Forecast -->
        <section class="card">
            <div class="label">
                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>
                7-DAY FORECAST
            </div>
            <div id="daily-list" style="margin-top: 10px;">
                <!-- Injected via JS -->
            </div>
        </section>

    </div>
</div>

<!-- Scripts -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
    // --- Configuration ---
    const STATE = {
        lang: 'th', // 'th' or 'en'
        lat: 13.7563, // Bangkok default
        lon: 100.5018,
        data: null
    };

    const TEXT = {
        th: {
            loading: '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...',
            feelsLike: '‡∏£‡∏π‡πâ‡∏™‡∏∂‡∏Å‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô',
            forecast: '‡∏û‡∏¢‡∏≤‡∏Å‡∏£‡∏ì‡πå',
            days: ['‡∏≠‡∏≤.', '‡∏à.', '‡∏≠.', '‡∏û.', '‡∏û‡∏§.', '‡∏®.', '‡∏™.'],
            ai_hot: '‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡∏≠‡∏≤‡∏Å‡∏≤‡∏®‡∏£‡πâ‡∏≠‡∏ô‡∏à‡∏±‡∏î ‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡πÉ‡∏´‡πâ‡∏û‡∏Å‡∏ô‡πâ‡∏≥‡∏î‡∏∑‡πà‡∏°‡πÅ‡∏•‡∏∞‡∏´‡∏•‡∏µ‡∏Å‡πÄ‡∏•‡∏µ‡πà‡∏¢‡∏á‡πÅ‡∏î‡∏î‡∏ä‡πà‡∏ß‡∏á‡∏ö‡πà‡∏≤‡∏¢‡∏ô‡∏∞‡∏Ñ‡∏£‡∏±‡∏ö ‚òÄÔ∏è',
            ai_rain: '‡∏°‡∏µ‡πÇ‡∏≠‡∏Å‡∏≤‡∏™‡∏ù‡∏ô‡∏ï‡∏Å‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ ‡∏≠‡∏¢‡πà‡∏≤‡∏•‡∏∑‡∏°‡∏û‡∏Å‡∏£‡πà‡∏°‡∏Å‡πà‡∏≠‡∏ô‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏ö‡πâ‡∏≤‡∏ô‡∏ô‡∏∞‡∏Ñ‡∏£‡∏±‡∏ö ‚òîÔ∏è',
            ai_good: '‡∏™‡∏†‡∏≤‡∏û‡∏≠‡∏≤‡∏Å‡∏≤‡∏®‡∏î‡∏µ‡πÄ‡∏¢‡∏µ‡πà‡∏¢‡∏° ‡πÄ‡∏´‡∏°‡∏≤‡∏∞‡∏Å‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡∏Å‡∏•‡∏≤‡∏á‡πÅ‡∏à‡πâ‡∏á‡∏Ñ‡∏£‡∏±‡∏ö üèÉ',
            ai_pm: '‡∏Ñ‡πà‡∏≤‡∏ù‡∏∏‡πà‡∏ô PM2.5 ‡∏Ñ‡πà‡∏≠‡∏ô‡∏Ç‡πâ‡∏≤‡∏á‡∏™‡∏π‡∏á ‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡∏™‡∏ß‡∏°‡∏´‡∏ô‡πâ‡∏≤‡∏Å‡∏≤‡∏Å N95 ‡∏ô‡∏∞‡∏Ñ‡∏£‡∏±‡∏ö üò∑',
            uv: ['‡∏ï‡πà‡∏≥', '‡∏õ‡∏≤‡∏ô‡∏Å‡∏•‡∏≤‡∏á', '‡∏™‡∏π‡∏á', '‡∏™‡∏π‡∏á‡∏°‡∏≤‡∏Å', '‡∏≠‡∏±‡∏ô‡∏ï‡∏£‡∏≤‡∏¢']
        },
        en: {
            loading: 'Loading...',
            feelsLike: 'Feels Like',
            forecast: 'Forecast',
            days: ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'],
            ai_hot: 'It‚Äôs very hot today. Stay hydrated and avoid direct sunlight. ‚òÄÔ∏è',
            ai_rain: 'High chance of rain. Don‚Äôt forget your umbrella. ‚òîÔ∏è',
            ai_good: 'Perfect weather conditions for outdoor activities. üèÉ',
            ai_pm: 'Air quality is poor. Wearing a mask is recommended. üò∑',
            uv: ['Low', 'Moderate', 'High', 'Very High', 'Extreme']
        }
    };

    const WEATHER_CODES = {
        0: { th: '‡∏ó‡πâ‡∏≠‡∏á‡∏ü‡πâ‡∏≤‡πÅ‡∏à‡πà‡∏°‡πÉ‡∏™', en: 'Clear Sky', icon: '‚òÄÔ∏è' },
        1: { th: '‡∏°‡∏µ‡πÄ‡∏°‡∏Ü‡∏ö‡∏≤‡∏á‡∏™‡πà‡∏ß‡∏ô', en: 'Mainly Clear', icon: 'üå§' },
        2: { th: '‡∏°‡∏µ‡πÄ‡∏°‡∏Ü‡∏°‡∏≤‡∏Å', en: 'Partly Cloudy', icon: '‚õÖ' },
        3: { th: '‡∏°‡∏∑‡∏î‡∏Ñ‡∏£‡∏∂‡πâ‡∏°', en: 'Overcast', icon: '‚òÅÔ∏è' },
        45: { th: '‡∏°‡∏µ‡∏´‡∏°‡∏≠‡∏Å', en: 'Fog', icon: 'üå´' },
        51: { th: '‡∏ù‡∏ô‡∏õ‡∏£‡∏≠‡∏¢', en: 'Drizzle', icon: 'üå¶' },
        53: { th: '‡∏ù‡∏ô‡∏ï‡∏Å‡∏õ‡∏≤‡∏ô‡∏Å‡∏•‡∏≤‡∏á', en: 'Moderate Rain', icon: 'üåß' },
        61: { th: '‡∏ù‡∏ô‡∏ï‡∏Å', en: 'Rain', icon: 'üåß' },
        65: { th: '‡∏ù‡∏ô‡∏ï‡∏Å‡∏´‡∏ô‡∏±‡∏Å', en: 'Heavy Rain', icon: 'üåß' },
        80: { th: '‡∏ù‡∏ô‡∏ü‡πâ‡∏≤‡∏Ñ‡∏∞‡∏ô‡∏≠‡∏á', en: 'Showers', icon: 'üå¶' },
        95: { th: '‡∏û‡∏≤‡∏¢‡∏∏‡∏ù‡∏ô', en: 'Thunderstorm', icon: '‚õà' }
    };

    // --- Core Functions ---

    async function init() {
        initMap();
        await fetchData(STATE.lat, STATE.lon);
        setupEventListeners();
    }

    function setupEventListeners() {
        document.getElementById('btn-th').onclick = () => { setLang('th'); };
        document.getElementById('btn-en').onclick = () => { setLang('en'); };
        document.getElementById('btn-loc').onclick = () => {
            if(navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(pos => {
                    STATE.lat = pos.coords.latitude;
                    STATE.lon = pos.coords.longitude;
                    fetchData(STATE.lat, STATE.lon);
                });
            }
        };
    }

    function setLang(lang) {
        STATE.lang = lang;
        document.getElementById('btn-th').className = lang === 'th' ? 'btn-pill active' : 'btn-pill';
        document.getElementById('btn-en').className = lang === 'en' ? 'btn-pill active' : 'btn-pill';
        renderUI();
    }

    async function fetchData(lat, lon) {
        // UI Loading State
        document.getElementById('current-temp').classList.add('skeleton');
        
        try {
            // Parallel Fetch Weather & AQI
            const [weatherRes, aqiRes, geoRes] = await Promise.all([
                fetch(`https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&current=temperature_2m,relative_humidity_2m,weather_code,wind_speed_10m,wind_direction_10m&hourly=temperature_2m,precipitation_probability,weather_code&daily=weather_code,temperature_2m_max,temperature_2m_min,uv_index_max&timezone=auto`),
                fetch(`https://air-quality-api.open-meteo.com/v1/air-quality?latitude=${lat}&longitude=${lon}&current=us_aqi`),
                fetch(`https://api.bigdatacloud.net/data/reverse-geocode-client?latitude=${lat}&longitude=${lon}&localityLanguage=en`) // Using free reverse geo
            ]);

            const weather = await weatherRes.json();
            const aqi = await aqiRes.json();
            const geo = await geoRes.json();

            STATE.data = { weather, aqi, geo };
            renderUI();

            // Render Map Marker
            if(map) {
                map.setView([lat, lon], 10);
                L.marker([lat, lon]).addTo(map);
            }

        } catch (e) {
            console.error(e);
            alert("Error fetching data");
        }
    }

    function renderUI() {
        if(!STATE.data) return;
        const { weather, aqi, geo } = STATE.data;
        const t = TEXT[STATE.lang];
        const current = weather.current;
        const daily = weather.daily;

        // 1. Hero Section
        document.getElementById('current-temp').textContent = Math.round(current.temperature_2m);
        document.getElementById('current-temp').classList.remove('skeleton');
        
        const wCode = current.weather_code;
        const wInfo = WEATHER_CODES[wCode] || { th: '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏', en: 'Unknown', icon: '‚ùì' };
        document.getElementById('condition-text').textContent = STATE.lang === 'th' ? wInfo.th : wInfo.en;
        document.getElementById('location-name').textContent = `${geo.city || geo.locality}, ${geo.countryName}`;
        
        document.getElementById('max-temp').textContent = Math.round(daily.temperature_2m_max[0]);
        document.getElementById('min-temp').textContent = Math.round(daily.temperature_2m_min[0]);

        // 2. AI Insight Logic
        let aiText = "";
        const maxT = daily.temperature_2m_max[0];
        const rainProb = weather.hourly.precipitation_probability[new Date().getHours()] || 0;
        const aqiVal = aqi.current.us_aqi;

        if (aqiVal > 100) aiText = t.ai_pm;
        else if (rainProb > 60) aiText = t.ai_rain;
        else if (maxT > 35) aiText = t.ai_hot;
        else aiText = t.ai_good;
        
        document.getElementById('ai-insight').textContent = aiText;

        // 3. Stats
        // AQI
        document.getElementById('aqi-val').textContent = aqiVal;
        const circle = document.getElementById('aqi-circle');
        const circumference = 2 * Math.PI * 40; // r=40
        const offset = circumference - ((Math.min(aqiVal, 300) / 300) * circumference);
        circle.style.strokeDashoffset = offset;
        
        let aqiColor = '#34C759';
        let aqiStat = 'Good';
        if(aqiVal > 50) { aqiColor = '#FF9500'; aqiStat = 'Moderate'; }
        if(aqiVal > 100) { aqiColor = '#FF3B30'; aqiStat = 'Unhealthy'; }
        circle.style.stroke = aqiColor;
        document.getElementById('aqi-status').textContent = aqiStat;

        // Wind
        document.getElementById('wind-speed').textContent = current.wind_speed_10m;
        document.getElementById('wind-arrow').style.transform = `rotate(${current.wind_direction_10m}deg)`;

        // UV & Humidity
        const uv = daily.uv_index_max[0];
        document.getElementById('uv-val').textContent = uv;
        const uvLevel = Math.min(Math.floor(uv/3), 4);
        document.getElementById('uv-status').textContent = t.uv[uvLevel] || 'Low';
        
        document.getElementById('humidity-val').textContent = current.relative_humidity_2m;
        // Simple Dew Point calc approximation
        const T = current.temperature_2m;
        const RH = current.relative_humidity_2m;
        const dp = T - ((100 - RH)/5);
        document.getElementById('dew-point').textContent = Math.round(dp);

        // 4. Charts
        drawChart(weather.hourly);

        // 5. 7-Day List
        const listContainer = document.getElementById('daily-list');
        listContainer.innerHTML = '';
        
        // Calculate min/max range for bars
        const allMax = Math.max(...daily.temperature_2m_max);
        const allMin = Math.min(...daily.temperature_2m_min);
        const range = allMax - allMin + 5; // buffer

        for(let i=0; i<7; i++) {
            const date = new Date(daily.time[i]);
            const dName = t.days[date.getDay()];
            const code = daily.weather_code[i];
            const icon = (WEATHER_CODES[code] || WEATHER_CODES[0]).icon;
            const dMax = Math.round(daily.temperature_2m_max[i]);
            const dMin = Math.round(daily.temperature_2m_min[i]);

            // Bar math
            const leftPct = ((dMin - allMin) / range) * 100;
            const widthPct = ((dMax - dMin) / range) * 100;
            
            // Gradient based on temp
            let grad = 'linear-gradient(90deg, #4facfe 0%, #00f2fe 100%)';
            if (dMax > 32) grad = 'linear-gradient(90deg, #f6d365 0%, #fda085 100%)';

            const div = document.createElement('div');
            div.className = 'day-row';
            div.innerHTML = `
                <div class="day-name">${i===0 ? (STATE.lang==='th'?'‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ':'Today') : dName}</div>
                <div class="day-icon">${icon}</div>
                <div class="day-temps num-font"><span class="min-t">${dMin}¬∞</span> ${dMax}¬∞</div>
                <div class="day-bar-container">
                    <div class="day-bar-fill" style="margin-left:${leftPct}%; width:${widthPct}%; background:${grad}"></div>
                </div>
            `;
            listContainer.appendChild(div);
        }
    }

    // --- Canvas Chart (Bezier) ---
    function drawChart(hourly) {
        const canvas = document.getElementById('tempChart');
        const ctx = canvas.getContext('2d');
        const dpr = window.devicePixelRatio || 1;
        
        // Resize properly
        const rect = canvas.parentNode.getBoundingClientRect();
        canvas.width = rect.width * dpr;
        canvas.height = rect.height * dpr;
        ctx.scale(dpr, dpr);

        const data = hourly.temperature_2m.slice(0, 24); // Next 24h
        const w = rect.width;
        const h = rect.height;
        const padding = 20;

        // Scales
        const max = Math.max(...data) + 2;
        const min = Math.min(...data) - 2;
        const range = max - min;
        
        const getX = (i) => (i / (data.length - 1)) * (w - padding * 2) + padding;
        const getY = (val) => h - padding - ((val - min) / range) * (h - padding * 2);

        ctx.clearRect(0, 0, w, h);
        
        // Draw Curve
        ctx.beginPath();
        ctx.moveTo(getX(0), getY(data[0]));
        
        for (let i = 0; i < data.length - 1; i++) {
            const x_mid = (getX(i) + getX(i + 1)) / 2;
            const y_mid = (getY(data[i]) + getY(data[i + 1])) / 2;
            const cp_x1 = (x_mid + getX(i)) / 2;
            const cp_x2 = (x_mid + getX(i + 1)) / 2;
            ctx.quadraticCurveTo(getX(i), getY(data[i]), x_mid, y_mid); // Simple smooth
            ctx.quadraticCurveTo(getX(i+1), getY(data[i+1]), getX(i+1), getY(data[i+1])); // Force fit
        }
        
        // Stroke
        const gradient = ctx.createLinearGradient(0, 0, w, 0);
        gradient.addColorStop(0, '#007AFF');
        gradient.addColorStop(1, '#5AC8FA');
        ctx.strokeStyle = gradient;
        ctx.lineWidth = 3;
        ctx.lineCap = 'round';
        ctx.stroke();

        // Fill Area
        ctx.lineTo(getX(data.length - 1), h);
        ctx.lineTo(getX(0), h);
        ctx.fillStyle = 'rgba(0, 122, 255, 0.05)';
        ctx.fill();

        // Draw Points & Text
        ctx.fillStyle = '#1D1D1F';
        ctx.font = '600 12px Outfit';
        ctx.textAlign = 'center';
        
        for (let i = 0; i < data.length; i += 4) { // Every 4 hours
            const x = getX(i);
            const y = getY(data[i]);
            
            // Dot
            ctx.beginPath();
            ctx.arc(x, y, 4, 0, Math.PI * 2);
            ctx.fillStyle = '#fff';
            ctx.fill();
            ctx.strokeStyle = '#007AFF';
            ctx.lineWidth = 2;
            ctx.stroke();

            // Text
            ctx.fillStyle = '#86868B';
            ctx.fillText(Math.round(data[i]) + '¬∞', x, y - 10);
            
            // Time
            const time = new Date(hourly.time[i]).getHours();
            ctx.fillText(time + ':00', x, h - 5);
        }
    }

    // --- Radar Map ---
    let map;
    function initMap() {
        map = L.map('map', {
            zoomControl: false,
            attributionControl: false,
            dragging: false, // Static feel
            scrollWheelZoom: false
        }).setView([STATE.lat, STATE.lon], 6);

        // CartoDB Positron (Clean/Light)
        L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
            maxZoom: 19
        }).addTo(map);

        // RainViewer Radar Layer (Simple approach)
        // Usually requires fetching timestamps, simplified here for single file demo stability
        // Adding a simulated cloud layer for visual
    }

    // Start
    init();

    // Redraw chart on resize
    window.addEventListener('resize', () => {
        if(STATE.data) drawChart(STATE.data.weather.hourly);
    });

</script>
</body>
</html>
