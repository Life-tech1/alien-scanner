<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>MAGIC COMPASS | LEGENDS</title>
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#050508">
    <meta name="description" content="AR Compass with Local Folklore & Anomaly Detection">

    <style>
        /* ------------------------------------------------------------------
           THEME: PURPLE NEON GLASS (PRO)
           ------------------------------------------------------------------ */
        :root {
            --bg-core: #050508;
            --bg-grad: radial-gradient(circle at 50% 20%, #1e1b4b 0%, #0f0c29 50%, #020204 100%);
            
            /* Glass System */
            --glass-base: rgba(255, 255, 255, 0.02);
            --glass-border: rgba(255, 255, 255, 0.08);
            --glass-shine: rgba(255, 255, 255, 0.12);
            --blur-val: 24px;

            /* Colors */
            --neon-p: #d946ef; /* Primary Purple */
            --neon-b: #60a5fa; /* Secondary Blue */
            --neon-r: #f43f5e; /* Alert/Rose */
            --neon-g: #34d399; /* Safe/Green */
            --text-1: #ffffff;
            --text-2: #94a3b8;
            --text-3: #64748b;

            /* Fonts */
            --font-ui: -apple-system, BlinkMacSystemFont, "SF Pro Display", "Inter", sans-serif;
            --font-mono: "SF Mono", "Menlo", monospace;
            
            --safe-top: env(safe-area-inset-top, 20px);
            --safe-bot: env(safe-area-inset-bottom, 20px);
            --ease-out: cubic-bezier(0.215, 0.61, 0.355, 1);
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; user-select: none; }
        
        body {
            margin: 0; padding: 0;
            background: var(--bg-core); background-image: var(--bg-grad);
            color: var(--text-1); font-family: var(--font-ui);
            height: 100vh; width: 100vw; overflow: hidden;
            display: flex; flex-direction: column;
        }

        /* BG FX */
        .bg-orb {
            position: absolute; border-radius: 50%; filter: blur(100px); opacity: 0.25; z-index: 0;
            animation: float 20s infinite alternate ease-in-out;
        }
        .orb-1 { width: 350px; height: 350px; background: var(--neon-p); top: -10%; left: -20%; }
        .orb-2 { width: 280px; height: 280px; background: var(--neon-b); bottom: 5%; right: -10%; animation-delay: -8s; }
        @keyframes float { 0% { transform: translate(0,0); } 100% { transform: translate(30px, 40px); } }

        /* UTILS */
        .hidden { display: none !important; }
        .glass-panel {
            background: var(--glass-base);
            backdrop-filter: blur(var(--blur-val)); -webkit-backdrop-filter: blur(var(--blur-val));
            border: 1px solid var(--glass-border);
            border-radius: 24px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.4);
        }
        .flex-row { display: flex; align-items: center; gap: 8px; }
        .flex-col { display: flex; flex-direction: column; gap: 6px; }
        .mono { font-family: var(--font-mono); letter-spacing: -0.5px; }
        .neon-text { text-shadow: 0 0 10px rgba(217, 70, 239, 0.5); }

        /* --- LAYOUT --- */
        #app {
            position: relative; z-index: 10; flex: 1;
            display: flex; flex-direction: column;
            padding: var(--safe-top) 16px calc(var(--safe-bot) + 12px) 16px;
            gap: 12px;
        }

        /* HEADER */
        .header { justify-content: space-between; height: 44px; padding: 0 4px; }
        .brand { font-weight: 700; letter-spacing: 2px; font-size: 0.9rem; color: var(--text-2); display: flex; align-items: center; gap: 6px; }
        .badge { font-size: 0.65rem; padding: 4px 10px; border-radius: 20px; background: rgba(0,0,0,0.3); border: 1px solid var(--glass-border); color: var(--text-3); transition:0.3s; }
        .badge.active { border-color: var(--neon-g); color: var(--neon-g); box-shadow: 0 0 10px rgba(52, 211, 153, 0.15); }

        /* COMPASS ORB (RE-DESIGNED) */
        .stage { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; position: relative; min-height: 300px; }
        
        .orb-ring {
            width: 280px; height: 280px; border-radius: 50%;
            position: relative; transition: transform 0.1s linear;
            box-shadow: 0 0 50px rgba(139, 92, 246, 0.05), inset 0 0 30px rgba(0,0,0,0.5);
            border: 1px solid rgba(255,255,255,0.05);
        }
        /* Inner Lens */
        .orb-lens {
            position: absolute; inset: 15px; border-radius: 50%;
            background: radial-gradient(circle at 30% 30%, rgba(255,255,255,0.03), transparent 60%);
            border: 1px solid rgba(255,255,255,0.03);
            pointer-events: none;
        }
        /* Major/Minor Ticks using Conic Gradient for Performance */
        .orb-ticks {
            position: absolute; inset: -10px; border-radius: 50%;
            background: 
                conic-gradient(from 0deg, var(--text-2) 0deg 1deg, transparent 1deg 29deg, var(--text-2) 30deg 31deg, transparent 31deg 359deg), /* Major 30 */
                conic-gradient(from 0deg, rgba(255,255,255,0.1) 0deg 1deg, transparent 1deg 4deg); /* Minor 5 pattern repeated via JS logic or simplified visual */
            background-size: 100% 100%;
            mask: radial-gradient(transparent 68%, black 69%); -webkit-mask: radial-gradient(transparent 68%, black 69%);
        }
        /* Minor ticks simplified via repeating-conic */
        .orb-ticks-sub {
            position: absolute; inset: 0; border-radius: 50%;
            background: repeating-conic-gradient(rgba(255,255,255,0.1) 0deg 1deg, transparent 1deg 5deg);
            mask: radial-gradient(transparent 68%, black 69%); -webkit-mask: radial-gradient(transparent 68%, black 69%);
        }

        /* Cardnials */
        .cardinal { position: absolute; font-weight: 700; font-size: 0.8rem; color: var(--text-3); }
        .c-n { top: 8px; left: 50%; transform: translateX(-50%); color: var(--neon-p); text-shadow: 0 0 8px var(--neon-p); }
        .c-e { right: 12px; top: 50%; transform: translateY(-50%); }
        .c-s { bottom: 8px; left: 50%; transform: translateX(-50%); }
        .c-w { left: 12px; top: 50%; transform: translateY(-50%); }

        /* Needles */
        .needle-stage { position: absolute; inset: 0; pointer-events: none; }
        .needle {
            position: absolute; top: 50%; left: 50%; transform-origin: bottom center;
            transition: transform 0.5s var(--ease-out); will-change: transform;
        }
        /* Target Needle (Crystal Style) */
        .n-target {
            width: 6px; height: 44%; margin-left: -3px; margin-top: -44%;
            background: linear-gradient(to top, rgba(217, 70, 239, 0) 0%, var(--neon-p) 100%);
            border-radius: 4px; opacity: 0.9; z-index: 3;
            box-shadow: 0 -5px 15px var(--neon-p);
        }
        .n-target::after {
            content:''; position: absolute; top: -4px; left: -2px; width: 0; height: 0;
            border-left: 5px solid transparent; border-right: 5px solid transparent;
            border-bottom: 8px solid #fff;
        }
        /* True North */
        .n-true { width: 2px; height: 48%; background: var(--neon-b); margin-left: -1px; margin-top: -48%; opacity: 0.8; z-index: 2; }
        /* Mag North */
        .n-mag { width: 1px; height: 40%; border-left: 1px dashed var(--neon-r); margin-left: -0.5px; margin-top: -40%; opacity: 0.6; z-index: 1; }

        /* Center HUD */
        .center-hud {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            text-align: center; pointer-events: none;
        }
        .val-head { font-size: 2.2rem; font-weight: 800; letter-spacing: -1px; line-height: 1; }
        .lbl-head { font-size: 0.6rem; color: var(--text-3); letter-spacing: 2px; margin-top: 4px; }

        /* ANOMALY RADAR & SCOPE (New) */
        .radar-ui {
            position: absolute; bottom: -20px; right: -10px;
            width: 100px; height: 100px; pointer-events: none;
            display: none; /* Active in Myth mode */
        }
        .radar-scan {
            width: 100%; height: 100%; border-radius: 50%;
            border: 1px solid rgba(255,255,255,0.1);
            background: radial-gradient(rgba(0,0,0,0), rgba(0,0,0,0.5));
            position: relative; overflow: hidden;
        }
        .radar-sweep {
            position: absolute; inset: 0; border-radius: 50%;
            background: conic-gradient(from 0deg, transparent 0deg, rgba(244, 63, 94, 0.2) 60deg, transparent 60.1deg);
            animation: sweep 3s linear infinite;
        }
        .radar-blip {
            position: absolute; width: 4px; height: 4px; background: #fff; border-radius: 50%;
            box-shadow: 0 0 6px var(--neon-r); opacity: 0;
            animation: blip 2s infinite;
        }
        @keyframes sweep { to { transform: rotate(360deg); } }
        @keyframes blip { 0% { opacity: 1; transform: scale(1); } 100% { opacity: 0; transform: scale(2); } }

        .scope-ui {
            position: absolute; bottom: 0px; left: -10px;
            width: 80px; height: 40px; display: none;
        }
        canvas#sig-scope { width: 100%; height: 100%; opacity: 0.6; }

        /* INFO DECK */
        .deck { display: flex; flex-direction: column; gap: 10px; perspective: 1000px; margin-top: auto; }
        
        /* Generic Card */
        .card { padding: 16px; position: relative; overflow: hidden; min-height: 120px; transition: 0.3s; }
        .card::before { content:''; position: absolute; top:0; left:0; bottom:0; width: 3px; background: var(--text-3); }
        .card.lore::before { background: var(--neon-p); }
        .card.omen::before { background: var(--neon-r); }
        
        /* Typography in cards */
        .t-head { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 8px; }
        .t-title { font-size: 1.1rem; font-weight: 700; color: #fff; line-height: 1.2; max-width: 75%; }
        .t-meta { font-size: 0.8rem; color: var(--neon-p); font-weight: 600; }
        .t-body { font-size: 0.85rem; color: var(--text-2); line-height: 1.5; }
        .t-facts { margin: 6px 0; padding-left: 0; list-style: none; font-size: 0.75rem; }
        .t-facts li { display: flex; gap: 6px; margin-bottom: 3px; }
        .t-facts li::before { content: 'â€¢'; color: var(--text-3); }
        .t-quote { font-style: italic; color: var(--text-3); font-size: 0.8rem; border-top: 1px solid var(--glass-border); margin-top: 8px; padding-top: 6px; }

        /* CONTROLS */
        .ctrl-bar { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 8px; margin-top: 4px; }
        .btn {
            background: var(--glass-base); border: 1px solid var(--glass-border);
            color: var(--text-2); padding: 12px; border-radius: 18px;
            font-size: 0.8rem; display: flex; align-items: center; justify-content: center; gap: 6px;
            cursor: pointer; transition: 0.2s;
        }
        .btn:active { background: var(--glass-shine); transform: scale(0.98); }
        .btn.active { border-color: var(--neon-p); color: #fff; background: rgba(217, 70, 239, 0.1); }

        /* DOCK */
        .dock {
            display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 6px;
            background: rgba(0,0,0,0.3); padding: 4px; border-radius: 24px;
            border: 1px solid var(--glass-border);
        }
        .dock-item {
            background: transparent; border: none; color: var(--text-3);
            padding: 10px; border-radius: 18px; font-size: 0.75rem; font-weight: 600;
            cursor: pointer; transition: 0.2s;
        }
        .dock-item.active { background: var(--glass-border); color: #fff; box-shadow: 0 2px 8px rgba(0,0,0,0.2); }

        /* MODALS */
        .modal-overlay {
            position: fixed; inset: 0; z-index: 100; background: rgba(0,0,0,0.85);
            backdrop-filter: blur(10px); display: flex; align-items: center; justify-content: center;
            padding: 20px; opacity: 0; pointer-events: none; transition: 0.3s;
        }
        .modal-overlay.show { opacity: 1; pointer-events: auto; }
        .modal-box { width: 100%; max-width: 400px; padding: 24px; max-height: 80vh; overflow-y: auto; }
        
        .perm-box { text-align: center; max-width: 320px; }
        .btn-hero {
            background: var(--neon-p); color: #fff; border: none;
            padding: 14px 30px; border-radius: 30px; font-size: 1rem; font-weight: 700;
            box-shadow: 0 0 20px rgba(217, 70, 239, 0.4); margin-top: 20px; cursor: pointer;
        }

        /* UTILITIES */
        .glitch-anim { animation: glitch 0.3s infinite; text-shadow: 2px 0 var(--neon-r), -2px 0 var(--neon-b); }
        @keyframes glitch { 0% { transform: translate(0); } 20% { transform: translate(-2px, 2px); } 40% { transform: translate(2px, -2px); } 100% { transform: translate(0); } }

    </style>
</head>
<body>

    <div class="bg-orb orb-1"></div>
    <div class="bg-orb orb-2"></div>

    <!-- PERMISSION WALL -->
    <div id="perm-wall" class="modal-overlay show">
        <div class="glass-panel perm-box">
            <h1 style="font-size:1.8rem; line-height:1.2; margin-bottom:10px;" class="neon-text">MAGIC COMPASS<br><span style="font-size:0.6em; color:#fff; font-weight:400">LEGENDS EDITION</span></h1>
            <p style="font-size:0.9rem; color:var(--text-2); line-height:1.5;" data-t="perm_desc">
                Accessing ancient grid lines requires GPS & Sensor Fusion permissions.
            </p>
            <button class="btn-hero" id="btn-init" data-t="perm_btn">CONNECT SENSORS</button>
        </div>
    </div>

    <!-- MAIN APP -->
    <div id="app" class="hidden">
        
        <!-- Top Bar -->
        <div class="flex-row header">
            <div class="brand"><span style="color:var(--neon-p)">âœ¦</span> LEGENDS</div>
            <div class="flex-row">
                <button class="badge" id="btn-lang" style="cursor:pointer; font-weight:700;">EN</button>
                <div class="badge" id="gps-stat" data-t="gps_wait">GPS WAIT</div>
                <div style="cursor:pointer; padding:4px; opacity:0.7;" onclick="app.toggleSettings()">âš™</div>
            </div>
        </div>

        <!-- Compass Stage -->
        <div class="stage">
            <div class="orb-ring" id="orb-ring">
                <div class="orb-ticks"></div>
                <div class="orb-ticks-sub"></div>
                <div class="orb-lens"></div>
                
                <div class="cardinal c-n">N</div><div class="cardinal c-e">E</div>
                <div class="cardinal c-s">S</div><div class="cardinal c-w">W</div>
                
                <div class="needle-stage">
                    <div class="needle n-target" id="n-target"></div>
                    <div class="needle n-true" id="n-true"></div>
                    <div class="needle n-mag" id="n-mag"></div>
                </div>

                <div class="center-hud">
                    <span class="val-head mono" id="val-head">000Â°</span>
                    <span class="lbl-head" id="lbl-head">HEADING</span>
                </div>
            </div>

            <!-- Radar & Scope (Myth Mode) -->
            <div class="radar-ui" id="radar-ui">
                <div class="radar-scan">
                    <div class="radar-sweep"></div>
                    <!-- Blips injected via JS -->
                </div>
            </div>
            <div class="scope-ui" id="scope-ui">
                <canvas id="sig-scope"></canvas>
            </div>
        </div>

        <!-- Info Deck -->
        <div class="deck">
            
            <!-- LORE CARD (Wonder Mode) -->
            <div class="glass-panel card lore" id="card-lore">
                <div class="t-head">
                    <div class="t-title" id="lore-title">Loading...</div>
                    <div class="t-meta mono" id="lore-dist">-- km</div>
                </div>
                <div class="t-body">
                    <div style="margin-bottom:6px;" id="lore-short"></div>
                    <ul class="t-facts" id="lore-facts"></ul>
                    <div class="t-quote" id="lore-myth"></div>
                </div>
            </div>

            <!-- OMEN CARD (Myth Mode) -->
            <div class="glass-panel card omen hidden" id="card-omen">
                <div class="t-head">
                    <div class="t-title" style="color:var(--neon-r)" id="omen-title">SIGNAL QUIET</div>
                    <div class="t-meta mono" style="font-size:0.7rem; opacity:0.7">ARG MODE</div>
                </div>
                <div class="t-body">
                    <div id="omen-text">The local ether is stable.</div>
                    <div class="t-quote" id="omen-flavor">No stories whisper here yet.</div>
                </div>
                <!-- Button for Local Legend -->
                <button class="btn" style="width:100%; margin-top:10px; border-color:var(--neon-r);" onclick="app.showLocalLegend()">
                    <span style="font-size:1rem">ðŸ“œ</span> <span data-t="btn_legend">Read Local Legend</span>
                </button>
            </div>

            <!-- Controls -->
            <div class="ctrl-bar" id="bar-actions">
                <button class="btn active" id="btn-auto" onclick="app.toggleAuto()">
                    <span>âŸ³</span> <span data-t="btn_auto">Auto</span>
                </button>
                <button class="btn" onclick="app.nextTarget()">
                    <span>â†’</span> <span data-t="btn_next">Next</span>
                </button>
                <button class="btn" onclick="app.openMap()">
                    <span>â†—</span> <span data-t="btn_map">Map</span>
                </button>
            </div>

            <!-- Mode Dock -->
            <div class="dock">
                <button class="dock-item active" onclick="app.setMode('wonder')" data-t="mode_wonder">WONDER</button>
                <button class="dock-item" onclick="app.setMode('earth')" data-t="mode_earth">EARTH</button>
                <button class="dock-item" onclick="app.setMode('myth')" data-t="mode_myth">MYTH</button>
            </div>
        </div>

    </div>

    <!-- MODAL: SETTINGS -->
    <div id="modal-settings" class="modal-overlay">
        <div class="glass-panel modal-box">
            <div style="display:flex; justify-content:space-between; margin-bottom:15px;">
                <h3 style="margin:0; color:#fff;" data-t="title_set">Settings</h3>
                <div style="cursor:pointer; font-size:1.2rem;" onclick="app.toggleSettings()">Ã—</div>
            </div>
            <label style="font-size:0.8rem; color:var(--text-2);" data-t="lbl_decl">Magnetic Declination (Â°)</label>
            <div class="flex-row" style="margin-top:5px;">
                <input type="number" id="inp-decl" value="0" style="width:100%; background:rgba(0,0,0,0.3); border:1px solid var(--glass-border); padding:10px; border-radius:10px; color:#fff;">
                <button class="btn" onclick="app.fetchDecl()">Fetch</button>
            </div>
        </div>
    </div>

    <!-- MODAL: FOLKLORE -->
    <div id="modal-folk" class="modal-overlay">
        <div class="glass-panel modal-box">
            <div style="display:flex; justify-content:space-between; margin-bottom:10px;">
                <div class="badge" style="border-color:var(--neon-r); color:var(--neon-r);">LOCAL LEGEND</div>
                <div style="cursor:pointer; font-size:1.5rem;" onclick="app.closeLegend()">Ã—</div>
            </div>
            <h2 id="folk-title" style="margin:0 0 10px 0; line-height:1.2; color:#fff;">Title</h2>
            <p id="folk-body" style="font-size:0.9rem; color:var(--text-2); line-height:1.6; white-space:pre-line;">...</p>
            <div class="t-quote" id="folk-loc" style="margin-top:15px;">Near: ...</div>
        </div>
    </div>

<script>
/**
 * MAGIC COMPASS: LEGENDS EDITION
 * Production-Grade Vanilla JS
 */

// --- 1. I18N ENGINE (Natural Tone) ---
const DICT = {
    en: {
        perm_desc: "Requires Sensor Fusion (GPS + Compass) to track Wonders and detect Anomalies.",
        perm_btn: "CONNECT SENSORS",
        gps_wait: "GPS WAIT",
        gps_lock: "GPS LOCK",
        mode_wonder: "WONDER",
        mode_earth: "EARTH",
        mode_myth: "MYTH",
        btn_auto: "Auto",
        btn_next: "Next",
        btn_map: "Map",
        btn_legend: "Read Local Legend",
        title_set: "Settings",
        lbl_decl: "Magnetic Declination (Â°)",
        lbl_head: "HEADING",
        lbl_var: "VARIANCE",
        lore_load: "Consulting the archives...",
        omen_quiet: "The air is still.",
        omen_ripple: "Faint whispers in the wind.",
        omen_distort: "Shadows lengthen strangely.",
        omen_peak: "The veil is dangerously thin.",
        flavor_quiet: "Old folks say this place sleeps deeply.",
        flavor_active: "Don't look behind you.",
        err_mag: "Magnetometer Unavailable"
    },
    th: {
        perm_desc: "à¸•à¹‰à¸­à¸‡à¸à¸²à¸£à¸à¸²à¸£à¹€à¸‚à¹‰à¸²à¸–à¸¶à¸‡ GPS à¹à¸¥à¸°à¹€à¸‚à¹‡à¸¡à¸—à¸´à¸¨ à¹€à¸žà¸·à¹ˆà¸­à¸™à¸³à¸—à¸²à¸‡à¸«à¸²à¸ªà¸´à¹ˆà¸‡à¸¡à¸«à¸±à¸¨à¸ˆà¸£à¸£à¸¢à¹Œà¹à¸¥à¸°à¸•à¸£à¸§à¸ˆà¸ˆà¸±à¸šà¸ªà¸´à¹ˆà¸‡à¸—à¸µà¹ˆà¸¡à¸­à¸‡à¹„à¸¡à¹ˆà¹€à¸«à¹‡à¸™",
        perm_btn: "à¹€à¸Šà¸·à¹ˆà¸­à¸¡à¸•à¹ˆà¸­à¹€à¸‹à¸™à¹€à¸‹à¸­à¸£à¹Œ",
        gps_wait: "à¸£à¸­ GPS...",
        gps_lock: "GPS à¸žà¸£à¹‰à¸­à¸¡",
        mode_wonder: "à¸ªà¸´à¹ˆà¸‡à¸¡à¸«à¸±à¸¨à¸ˆà¸£à¸£à¸¢à¹Œ",
        mode_earth: "à¹à¸¡à¹ˆà¹€à¸«à¸¥à¹‡à¸à¹‚à¸¥à¸",
        mode_myth: "à¹€à¸£à¸·à¹ˆà¸­à¸‡à¸¥à¸µà¹‰à¸¥à¸±à¸š",
        btn_auto: "à¸­à¸­à¹‚à¸•à¹‰",
        btn_next: "à¸–à¸±à¸”à¹„à¸›",
        btn_map: "à¹à¸œà¸™à¸—à¸µà¹ˆ",
        btn_legend: "à¸­à¹ˆà¸²à¸™à¸•à¸³à¸™à¸²à¸™à¹à¸–à¸§à¸™à¸µà¹‰",
        title_set: "à¸•à¸±à¹‰à¸‡à¸„à¹ˆà¸²",
        lbl_decl: "à¸¡à¸¸à¸¡à¸šà¹ˆà¸²à¸¢à¹€à¸šà¸™à¹à¸¡à¹ˆà¹€à¸«à¸¥à¹‡à¸ (Â°)",
        lbl_head: "à¸—à¸´à¸¨à¸«à¸±à¸§à¹€à¸„à¸£à¸·à¹ˆà¸­à¸‡",
        lbl_var: "à¸„à¸§à¸²à¸¡à¸œà¸±à¸™à¸œà¸§à¸™",
        lore_load: "à¸à¸³à¸¥à¸±à¸‡à¸„à¹‰à¸™à¸šà¸±à¸™à¸—à¸¶à¸à¹€à¸à¹ˆà¸²à¹à¸à¹ˆ...",
        omen_quiet: "à¸šà¸£à¸£à¸¢à¸²à¸à¸²à¸¨à¹€à¸‡à¸µà¸¢à¸šà¸ªà¸‡à¸š",
        omen_ripple: "à¸¡à¸µà¹€à¸ªà¸µà¸¢à¸‡à¸à¸£à¸°à¸‹à¸´à¸šà¹à¸œà¹ˆà¸§à¹€à¸šà¸²à¹ƒà¸™à¸ªà¸²à¸¢à¸¥à¸¡",
        omen_distort: "à¹€à¸‡à¸²à¹„à¸¡à¹‰à¹„à¸«à¸§à¹€à¸­à¸™à¸œà¸´à¸”à¸˜à¸£à¸£à¸¡à¸Šà¸²à¸•à¸´",
        omen_peak: "à¸¡à¹ˆà¸²à¸™à¸¡à¸´à¸•à¸´à¸šà¸²à¸‡à¸¥à¸‡à¸ˆà¸™à¸™à¹ˆà¸²à¸à¸¥à¸±à¸§",
        flavor_quiet: "à¸„à¸™à¹€à¸’à¹ˆà¸²à¸„à¸™à¹à¸à¹ˆà¸šà¸­à¸à¸§à¹ˆà¸²à¸—à¸µà¹ˆà¸™à¸µà¹ˆà¹€à¸ˆà¹‰à¸²à¸—à¸µà¹ˆà¹à¸£à¸‡à¹à¸•à¹ˆà¹ƒà¸ˆà¸”à¸µ",
        flavor_active: "à¸­à¸¢à¹ˆà¸²à¸‚à¸²à¸™à¸£à¸±à¸šà¸–à¹‰à¸²à¹„à¸”à¹‰à¸¢à¸´à¸™à¹€à¸ªà¸µà¸¢à¸‡à¹€à¸£à¸µà¸¢à¸à¸Šà¸·à¹ˆà¸­",
        err_mag: "à¹„à¸¡à¹ˆà¸žà¸šà¹€à¸‹à¸™à¹€à¸‹à¸­à¸£à¹Œà¹à¸¡à¹ˆà¹€à¸«à¸¥à¹‡à¸"
    }
};

class I18n {
    constructor() {
        this.lang = localStorage.getItem('lang') || (navigator.language.startsWith('th') ? 'th' : 'en');
    }
    t(key) { return DICT[this.lang][key] || key; }
    toggle() {
        this.lang = this.lang === 'en' ? 'th' : 'en';
        localStorage.setItem('lang', this.lang);
        return this.lang;
    }
}

// --- 2. DATA ENGINE (Offline-First) ---
const LORE_DB = {
    "Great Pyramid of Giza": {
        en: { short: "Ancient tomb or power plant?", facts: ["Built ~2560 BC", "2.3 million stone blocks", "Aligned to True North"], myth: "Some say it focuses the earth's energy like a lens." },
        th: { short: "à¸ªà¸¸à¸ªà¸²à¸™à¸Ÿà¸²à¹‚à¸£à¸«à¹Œà¸«à¸£à¸·à¸­à¹‚à¸£à¸‡à¹„à¸Ÿà¸Ÿà¹‰à¸²à¹‚à¸šà¸£à¸²à¸“?", facts: ["à¸ªà¸£à¹‰à¸²à¸‡à¹€à¸¡à¸·à¹ˆà¸­ 2560 à¸›à¸µà¸à¹ˆà¸­à¸™ à¸„.à¸¨.", "à¹ƒà¸Šà¹‰à¸«à¸´à¸™ 2.3 à¸¥à¹‰à¸²à¸™à¸à¹‰à¸­à¸™", "à¸«à¸±à¸™à¸—à¸´à¸¨à¹€à¸«à¸™à¸·à¸­à¸ˆà¸£à¸´à¸‡à¹€à¸›à¹Šà¸°"], myth: "à¹€à¸‚à¸²à¸§à¹ˆà¸²à¸à¸±à¸™à¸§à¹ˆà¸²à¸¡à¸±à¸™à¸£à¸§à¸¡à¸žà¸¥à¸±à¸‡à¸‡à¸²à¸™à¹‚à¸¥à¸à¹€à¸«à¸¡à¸·à¸­à¸™à¹€à¸¥à¸™à¸ªà¹Œà¸‚à¸¢à¸²à¸¢" }
    },
    "Great Wall of China": {
        en: { short: "The stone dragon of the East.", facts: ["Length: 21,196 km", "Built over 2,000 years", "Visible from orbit (myth)"], myth: "Workers' bones are said to be ground into the mortar." },
        th: { short: "à¸¡à¸±à¸‡à¸à¸£à¸«à¸´à¸™à¹à¸«à¹ˆà¸‡à¸šà¸¹à¸£à¸žà¸²à¸—à¸´à¸¨", facts: ["à¸¢à¸²à¸§à¸à¸§à¹ˆà¸² 21,196 à¸à¸¡.", "à¸ªà¸£à¹‰à¸²à¸‡à¸™à¸²à¸™à¸à¸§à¹ˆà¸² 2,000 à¸›à¸µ", "à¸¡à¸­à¸‡à¹€à¸«à¹‡à¸™à¸ˆà¸²à¸à¸­à¸§à¸à¸²à¸¨ (à¹€à¸›à¹‡à¸™à¹à¸„à¹ˆà¸•à¸³à¸™à¸²à¸™)"], myth: "à¸§à¹ˆà¸²à¸à¸±à¸™à¸§à¹ˆà¸²à¸à¸£à¸°à¸”à¸¹à¸à¹à¸£à¸‡à¸‡à¸²à¸™à¸–à¸¹à¸à¸šà¸”à¸œà¸ªà¸¡à¹ƒà¸™à¸›à¸¹à¸™à¸—à¸µà¹ˆà¸à¹ˆà¸­à¸à¸³à¹à¸žà¸‡" }
    },
    "Petra": {
        en: { short: "The Rose City hidden in canyon.", facts: ["Capital of Nabataeans", "Carved in sandstone", "Lost for centuries"], myth: "Djinn guard the treasury at night." },
        th: { short: "à¸™à¸„à¸£à¸ªà¸µà¸Šà¸¡à¸žà¸¹à¹ƒà¸™à¸«à¸¸à¸šà¹€à¸‚à¸²à¹€à¸£à¹‰à¸™à¸¥à¸±à¸š", facts: ["à¹€à¸¡à¸·à¸­à¸‡à¸«à¸¥à¸§à¸‡à¸Šà¸²à¸§à¸™à¸²à¸šà¸²à¹€à¸—à¸µà¸¢à¸™", "à¹à¸à¸°à¸ªà¸¥à¸±à¸à¸ˆà¸²à¸à¸«à¸™à¹‰à¸²à¸œà¸²", "à¸«à¸²à¸¢à¸ªà¸²à¸šà¸ªà¸¹à¸à¹„à¸›à¸™à¸±à¸šà¸¨à¸•à¸§à¸£à¸£à¸©"], myth: "à¸¢à¸²à¸¡à¸„à¹ˆà¸³à¸„à¸·à¸™à¸ˆà¸°à¸¡à¸µà¸§à¸´à¸à¸à¸²à¸“à¸ˆà¸´à¸™à¸™à¹Œà¹€à¸à¹‰à¸²à¸ªà¸¡à¸šà¸±à¸•à¸´à¸­à¸¢à¸¹à¹ˆ" }
    },
    "Colosseum": {
        en: { short: "Arena of blood and sand.", facts: ["Held 50,000 people", "Flooded for sea battles", "Built in 80 AD"], myth: "You can still hear the roar of the crowd in the wind." },
        th: { short: "à¸ªà¸±à¸‡à¹€à¸§à¸µà¸¢à¸™à¹€à¸¥à¸·à¸­à¸”à¹à¸¥à¸°à¸œà¸·à¸™à¸—à¸£à¸²à¸¢", facts: ["à¸ˆà¸¸à¸„à¸™à¹„à¸”à¹‰ 5 à¸«à¸¡à¸·à¹ˆà¸™à¸„à¸™", "à¹€à¸„à¸¢à¸›à¸¥à¹ˆà¸­à¸¢à¸™à¹‰à¸³à¸ˆà¸³à¸¥à¸­à¸‡à¸£à¸šà¸—à¸²à¸‡à¹€à¸£à¸·à¸­", "à¸ªà¸£à¹‰à¸²à¸‡à¸›à¸µ à¸„.à¸¨. 80"], myth: "à¹ƒà¸™à¸ªà¸²à¸¢à¸¥à¸¡à¸¢à¸±à¸‡à¸„à¸‡à¸¡à¸µà¹€à¸ªà¸µà¸¢à¸‡à¹‚à¸«à¹ˆà¸£à¹‰à¸­à¸‡à¸‚à¸­à¸‡à¸œà¸¹à¹‰à¸Šà¸¡à¸”à¸±à¸‡à¸à¹‰à¸­à¸‡" }
    },
    "Chichen Itza": {
        en: { short: "Mayan pyramid of the serpent.", facts: ["365 steps total", "Shadow snake on Equinox", "Acoustic marvel"], myth: "The Cenote demands rain god offerings." },
        th: { short: "à¸žà¸µà¸£à¸°à¸¡à¸´à¸”à¸‡à¸¹à¸¢à¸±à¸à¸©à¹Œà¹à¸«à¹ˆà¸‡à¸¡à¸²à¸¢à¸²", facts: ["à¸¡à¸µà¸šà¸±à¸™à¹„à¸” 365 à¸‚à¸±à¹‰à¸™", "à¹€à¸‡à¸²à¸‡à¸¹à¹‚à¸œà¸¥à¹ˆà¸•à¸­à¸™à¸§à¸´à¸©à¸¸à¸§à¸±à¸•", "à¸£à¸°à¸šà¸šà¹€à¸ªà¸µà¸¢à¸‡à¸ªà¸°à¸—à¹‰à¸­à¸™à¸ªà¸¸à¸”à¸¥à¹‰à¸³"], myth: "à¸šà¹ˆà¸­à¸™à¹‰à¸³à¸¨à¸±à¸à¸”à¸´à¹Œà¸ªà¸´à¸—à¸˜à¸´à¹Œà¹€à¸£à¸µà¸¢à¸à¸£à¹‰à¸­à¸‡à¹€à¸„à¸£à¸·à¹ˆà¸­à¸‡à¸ªà¸±à¸‡à¹€à¸§à¸¢à¹à¸”à¹ˆà¹€à¸—à¸žà¸à¸™" }
    },
    "Machu Picchu": {
        en: { short: "City in the clouds.", facts: ["Inca Citadel (1450)", "No mortar used", "Hidden from Spanish"], myth: "The hitching post of the sun ties daylight to earth." },
        th: { short: "à¸™à¸„à¸£à¸¥à¸­à¸¢à¸Ÿà¹‰à¸²à¹ƒà¸™à¸¡à¹ˆà¸²à¸™à¹€à¸¡à¸†", facts: ["à¸›à¹‰à¸­à¸¡à¸›à¸£à¸²à¸à¸²à¸£à¸­à¸´à¸™à¸„à¸²", "à¸§à¸²à¸‡à¸«à¸´à¸™à¹„à¸¡à¹ˆà¹ƒà¸Šà¹‰à¸›à¸¹à¸™", "à¸ªà¹€à¸›à¸™à¸«à¸²à¹„à¸¡à¹ˆà¹€à¸ˆà¸­"], myth: "à¹€à¸ªà¸²à¸«à¸´à¸™à¸­à¸´à¸™à¸•à¸´à¸§à¸²à¸•à¸²à¸™à¸²à¹ƒà¸Šà¹‰à¸œà¸¹à¸à¸”à¸§à¸‡à¸­à¸²à¸—à¸´à¸•à¸¢à¹Œà¹„à¸§à¹‰à¸à¸±à¸šà¹‚à¸¥à¸" }
    },
    "Taj Mahal": {
        en: { short: "Marble monument to eternal love.", facts: ["Built by Shah Jahan", "Took 22 years", "Changes color daily"], myth: "A black marble twin was planned across the river." },
        th: { short: "à¸­à¸™à¸¸à¸ªà¸£à¸“à¹Œà¸£à¸±à¸à¸™à¸´à¸£à¸±à¸™à¸”à¸£à¹Œà¸«à¸´à¸™à¸­à¹ˆà¸­à¸™", facts: ["à¸ªà¸£à¹‰à¸²à¸‡à¹‚à¸”à¸¢à¸Šà¸²à¸«à¹Œà¸ˆà¸²à¸®à¸²à¸™", "à¹ƒà¸Šà¹‰à¹€à¸§à¸¥à¸² 22 à¸›à¸µ", "à¹€à¸›à¸¥à¸µà¹ˆà¸¢à¸™à¸ªà¸µà¸•à¸²à¸¡à¹à¸ªà¸‡à¸§à¸±à¸™"], myth: "à¸•à¸³à¸™à¸²à¸™à¸§à¹ˆà¸²à¸ˆà¸°à¸¡à¸µà¸—à¸±à¸ˆà¸¡à¸²à¸®à¸²à¸¥à¸ªà¸µà¸”à¸³à¸ªà¸£à¹‰à¸²à¸‡à¸­à¸¢à¸¹à¹ˆà¸­à¸µà¸à¸à¸±à¹ˆà¸‡à¹à¸¡à¹ˆà¸™à¹‰à¸³" }
    },
    "Christ the Redeemer": {
        en: { short: "The embrace over Rio.", facts: ["30 meters tall", "Soapstone mosaic", "Lightning magnet"], myth: "Protects the city from the angry sea." },
        th: { short: "à¸­à¹‰à¸­à¸¡à¸à¸­à¸”à¹€à¸«à¸™à¸·à¸­à¹€à¸¡à¸·à¸­à¸‡à¸£à¸´à¹‚à¸­", facts: ["à¸ªà¸¹à¸‡ 30 à¹€à¸¡à¸•à¸£", "à¸šà¸¸à¸”à¹‰à¸§à¸¢à¸«à¸´à¸™à¸ªà¸šà¸¹à¹ˆ", "à¸¥à¹ˆà¸­à¸Ÿà¹‰à¸²à¸œà¹ˆà¸²à¸šà¹ˆà¸­à¸¢à¸¡à¸²à¸"], myth: "à¸„à¸­à¸¢à¸›à¸à¸›à¹‰à¸­à¸‡à¹€à¸¡à¸·à¸­à¸‡à¸ˆà¸²à¸à¸„à¸§à¸²à¸¡à¹€à¸à¸£à¸µà¹‰à¸¢à¸§à¸à¸£à¸²à¸”à¸‚à¸­à¸‡à¸—à¸°à¹€à¸¥" }
    }
};

const FOLK_DB = [
    { lat: 13.7563, lon: 100.5018, en: {t:"The Grand Palace Guardians", b:"Giants stand guard, but at night, some say they shift their stance to rest."}, th: {t:"à¸¢à¸±à¸à¸©à¹Œà¸§à¸±à¸”à¸žà¸£à¸°à¹à¸à¹‰à¸§", b:"à¸¢à¸²à¸¡à¸„à¹ˆà¸³à¸„à¸·à¸™à¸—à¸µà¹ˆà¹„à¸£à¹‰à¸œà¸¹à¹‰à¸„à¸™ à¸§à¹ˆà¸²à¸à¸±à¸™à¸§à¹ˆà¸²à¸¢à¸±à¸à¸©à¹Œà¸—à¸µà¹ˆà¸¢à¸·à¸™à¹€à¸à¹‰à¸²à¸›à¸£à¸°à¸•à¸¹à¸ˆà¸°à¸‚à¸¢à¸±à¸šà¹€à¸›à¸¥à¸µà¹ˆà¸¢à¸™à¸—à¹ˆà¸²à¹€à¸žà¸·à¹ˆà¸­à¸žà¸±à¸à¸‚à¸²"} },
    { lat: 18.7061, lon: 98.9817, en: {t:"Doi Suthep's Guardian", b:"The hermit's spirit still walks the pilgrim path up the mountain."}, th: {t:"à¸›à¸¹à¹ˆà¹à¸ªà¸°à¸¢à¹ˆà¸²à¹à¸ªà¸°", b:"à¸§à¸´à¸à¸à¸²à¸“à¸œà¸¹à¹‰à¸›à¸à¸›à¸±à¸à¸©à¹Œà¸£à¸±à¸à¸©à¸²à¸”à¸­à¸¢à¸ªà¸¸à¹€à¸—à¸ž à¸¢à¸±à¸‡à¸„à¸‡à¸§à¸™à¹€à¸§à¸µà¸¢à¸™à¸”à¸¹à¹à¸¥à¸œà¸·à¸™à¸›à¹ˆà¸²à¹à¸¥à¸°à¸œà¸¹à¹‰à¸„à¸™"} },
    { lat: 14.3532, lon: 100.5684, en: {t:"The Headless Buddha", b:"In the ruins of Ayutthaya, shadows dance where heads are missing."}, th: {t:"à¹€à¸¨à¸µà¸¢à¸£à¸žà¸£à¸°à¹ƒà¸™à¸£à¸²à¸à¹„à¸¡à¹‰", b:"à¸“ à¸§à¸±à¸”à¸¡à¸«à¸²à¸˜à¸²à¸•à¸¸ à¸¢à¸²à¸¡à¸”à¸¶à¸à¸ªà¸‡à¸±à¸” à¹à¸ªà¸‡à¸ˆà¸±à¸™à¸—à¸£à¹Œà¸ªà¹ˆà¸­à¸‡à¸à¸£à¸°à¸—à¸šà¸£à¸²à¸à¹„à¸¡à¹‰à¸”à¸¹à¹€à¸«à¸¡à¸·à¸­à¸™à¸¡à¸µà¸Šà¸µà¸§à¸´à¸•"} },
    { lat: 0, lon: 0, en: {t:"The Wandering Spirit", b:"This crossroad has seen many travelers, not all of them left."}, th: {t:"à¸§à¸´à¸à¸à¸²à¸“à¸—à¸²à¸‡à¸ªà¸²à¸¡à¹à¸žà¸£à¹ˆà¸‡", b:"à¸—à¸²à¸‡à¹à¸¢à¸à¸•à¸£à¸‡à¸™à¸µà¹‰à¸¡à¸µà¸„à¸™à¹€à¸«à¹‡à¸™à¹€à¸‡à¸²à¸•à¸°à¸„à¸¸à¹ˆà¸¡à¸šà¹ˆà¸­à¸¢à¸„à¸£à¸±à¹‰à¸‡ à¸£à¸°à¸§à¸±à¸‡à¸­à¸¢à¹ˆà¸²à¸—à¸±à¸à¹ƒà¸„à¸£à¸•à¸­à¸™à¸”à¸¶à¸"} } // Fallback
];

const WONDERS_COORDS = {
    "Great Pyramid of Giza": { lat: 29.9792, lon: 31.1342 },
    "Great Wall of China": { lat: 40.4319, lon: 116.5704 },
    "Petra": { lat: 30.3285, lon: 35.4444 },
    "Colosseum": { lat: 41.8902, lon: 12.4922 },
    "Chichen Itza": { lat: 20.6843, lon: -88.5678 },
    "Machu Picchu": { lat: -13.1631, lon: -72.5450 },
    "Taj Mahal": { lat: 27.1751, lon: 78.0421 },
    "Christ the Redeemer": { lat: -22.9519, lon: -43.2105 }
};

// --- 3. MATH & SENSOR ENGINE ---
const MathUtils = {
    rad: d => d * Math.PI / 180,
    deg: r => r * 180 / Math.PI,
    dist: (lat1, lon1, lat2, lon2) => {
        const R = 6371; const dLat = MathUtils.rad(lat2-lat1); const dLon = MathUtils.rad(lon2-lon1);
        const a = Math.sin(dLat/2)**2 + Math.cos(MathUtils.rad(lat1))*Math.cos(MathUtils.rad(lat2))*Math.sin(dLon/2)**2;
        return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
    },
    bearing: (lat1, lon1, lat2, lon2) => {
        const y = Math.sin(MathUtils.rad(lon2-lon1)) * Math.cos(MathUtils.rad(lat2));
        const x = Math.cos(MathUtils.rad(lat1))*Math.sin(MathUtils.rad(lat2)) - Math.sin(MathUtils.rad(lat1))*Math.cos(MathUtils.rad(lat2))*Math.cos(MathUtils.rad(lon2-lon1));
        return (MathUtils.deg(Math.atan2(y, x)) + 360) % 360;
    },
    lerpAngle: (cur, tgt, f) => {
        let d = tgt - cur;
        if (d > 180) d -= 360; if (d < -180) d += 360;
        return cur + d * f;
    }
};

class SensorEngine {
    constructor() {
        this.heading = 0;
        this.gps = { lat: null, lon: null };
        this.mag = { val: 0, active: false };
        this.magHist = []; // For variance/scope
        this.cb = {};
    }
    
    init() {
        return new Promise(async (resolve, reject) => {
            // GPS
            if("geolocation" in navigator) {
                navigator.geolocation.watchPosition(
                    p => { this.gps = {lat:p.coords.latitude, lon:p.coords.longitude}; this.emit('gps'); },
                    e => console.warn(e), {enableHighAccuracy:true}
                );
            }
            // Compass
            if (typeof DeviceOrientationEvent !== 'undefined' && typeof DeviceOrientationEvent.requestPermission === 'function') {
                try {
                    const r = await DeviceOrientationEvent.requestPermission();
                    if(r==='granted') {
                        window.addEventListener('deviceorientation', e => this.orient(e));
                        resolve();
                    } else reject();
                } catch(e) { reject(e); }
            } else {
                // Android
                if('ondeviceorientationabsolute' in window) window.addEventListener('deviceorientationabsolute', e => this.orient(e, true));
                else window.addEventListener('deviceorientation', e => this.orient(e));
                
                // Magnetometer
                if ('Magnetometer' in window) {
                    try {
                        // @ts-ignore
                        const mag = new Magnetometer({frequency: 20});
                        mag.addEventListener('reading', () => {
                            const m = Math.sqrt(mag.x**2 + mag.y**2 + mag.z**2);
                            this.mag = { val: m, active: true };
                            this.magHist.push(m);
                            if(this.magHist.length > 60) this.magHist.shift();
                        });
                        mag.start();
                    } catch(e){}
                }
                resolve();
            }
        });
    }
    
    orient(e, abs) {
        if(e.webkitCompassHeading) this.heading = e.webkitCompassHeading;
        else if(e.alpha !== null) {
            // Simple Android absolute fallback
            this.heading = 360 - e.alpha;
        }
    }
    
    emit(ev) { if(this.cb[ev]) this.cb[ev](); }
    on(ev, fn) { this.cb[ev] = fn; }
}

// --- 4. APP CONTROLLER ---
class App {
    constructor() {
        this.i18n = new I18n();
        this.sensor = new SensorEngine();
        this.mode = 'wonder';
        this.wonders = Object.keys(WONDERS_COORDS).map(k => ({name:k, ...WONDERS_COORDS[k]}));
        this.state = { idx: 0, auto: true, decl: 0, dispHead: 0, omenSeed: 0 };
        
        this.els = {
            ring: document.getElementById('orb-ring'),
            headVal: document.getElementById('val-head'),
            headLbl: document.getElementById('lbl-head'),
            nTarget: document.getElementById('n-target'),
            nTrue: document.getElementById('n-true'),
            nMag: document.getElementById('n-mag'),
            
            loreCard: document.getElementById('card-lore'),
            omenCard: document.getElementById('card-omen'),
            radar: document.getElementById('radar-ui'),
            scope: document.getElementById('scope-ui'),
            
            // Lore Text
            lTitle: document.getElementById('lore-title'),
            lDist: document.getElementById('lore-dist'),
            lShort: document.getElementById('lore-short'),
            lFacts: document.getElementById('lore-facts'),
            lMyth: document.getElementById('lore-myth'),
            
            // Omen Text
            oTitle: document.getElementById('omen-title'),
            oText: document.getElementById('omen-text'),
            oFlavor: document.getElementById('omen-flavor'),
            
            btnLang: document.getElementById('btn-lang')
        };
        
        this.els.btnLang.innerText = this.i18n.lang.toUpperCase();
        this.updateTexts();
        
        // Scope Canvas
        this.cvs = document.getElementById('sig-scope');
        this.ctx = this.cvs.getContext('2d');
        this.cvs.width = 80; this.cvs.height = 40;
    }
    
    async start() {
        try {
            await this.sensor.init();
            document.getElementById('perm-wall').classList.remove('show');
            document.getElementById('app').classList.remove('hidden');
            this.sensor.on('gps', () => {
                document.getElementById('gps-stat').innerText = this.i18n.t('gps_lock');
                document.getElementById('gps-stat').classList.add('active');
                if(this.state.auto) this.findNearest();
            });
            this.loop();
        } catch(e) { alert("Sensors required."); }
    }
    
    updateTexts() {
        document.querySelectorAll('[data-t]').forEach(el => el.innerText = this.i18n.t(el.dataset.t));
        this.updateLoreUI();
        this.updateOmenUI();
    }
    
    toggleLang() {
        this.els.btnLang.innerText = this.i18n.toggle().toUpperCase();
        this.updateTexts();
    }
    
    findNearest() {
        if(!this.sensor.gps.lat) return;
        let min = Infinity; let idx = 0;
        this.wonders.forEach((w, i) => {
            const d = MathUtils.dist(this.sensor.gps.lat, this.sensor.gps.lon, w.lat, w.lon);
            if(d < min) { min = d; idx = i; }
        });
        if(this.state.idx !== idx) {
            this.state.idx = idx;
            this.updateLoreUI();
        }
    }
    
    nextTarget() {
        this.state.auto = false;
        document.getElementById('btn-auto').classList.remove('active');
        this.state.idx = (this.state.idx + 1) % this.wonders.length;
        this.updateLoreUI();
    }
    
    toggleAuto() {
        this.state.auto = !this.state.auto;
        document.getElementById('btn-auto').classList.toggle('active');
        if(this.state.auto) this.findNearest();
    }
    
    openMap() {
        const w = this.wonders[this.state.idx];
        window.open(`https://maps.google.com/?q=${w.lat},${w.lon}`);
    }
    
    setMode(m) {
        this.mode = m;
        document.querySelectorAll('.dock-item').forEach(b => b.classList.remove('active'));
        event.target.classList.add('active');
        
        // UI Visibility
        this.els.nTarget.style.display = 'none'; this.els.nTrue.style.display = 'none'; this.els.nMag.style.display = 'none';
        this.els.loreCard.classList.add('hidden'); this.els.omenCard.classList.add('hidden');
        this.els.radar.style.display = 'none'; this.els.scope.style.display = 'none';
        
        if(m === 'wonder') {
            this.els.nTarget.style.display = 'block';
            this.els.loreCard.classList.remove('hidden');
            document.getElementById('bar-actions').classList.remove('hidden');
            this.els.headLbl.innerText = this.i18n.t('lbl_head');
            this.updateLoreUI(); // Refresh dist
        } else if (m === 'earth') {
            this.els.nTrue.style.display = 'block';
            this.els.nMag.style.display = 'block';
            this.els.loreCard.classList.remove('hidden');
            // Reuse Lore card for Earth Stats
            this.els.lTitle.innerText = this.i18n.t('mode_earth');
            this.els.lShort.innerText = this.sensor.mag.active ? `Field: ${this.sensor.mag.val.toFixed(1)} ÂµT` : this.i18n.t('err_mag');
            this.els.lFacts.innerHTML = ''; this.els.lMyth.innerText = '';
            document.getElementById('bar-actions').classList.add('hidden');
        } else {
            this.els.nTarget.style.display = 'block'; // Glitch needle
            this.els.omenCard.classList.remove('hidden');
            this.els.radar.style.display = 'block';
            this.els.scope.style.display = 'block';
            document.getElementById('bar-actions').classList.add('hidden');
            this.els.headLbl.innerText = this.i18n.t('lbl_var');
            this.updateOmenUI();
        }
    }
    
    updateLoreUI() {
        if(this.mode !== 'wonder') return;
        const w = this.wonders[this.state.idx];
        const info = LORE_DB[w.name] ? LORE_DB[w.name][this.i18n.lang] : {short:this.i18n.t('lore_load'), facts:[], myth:""};
        
        this.els.lTitle.innerText = w.name; // Could create dictionary for names too
        if(this.sensor.gps.lat) {
            const d = MathUtils.dist(this.sensor.gps.lat, this.sensor.gps.lon, w.lat, w.lon);
            this.els.lDist.innerText = d < 1 ? (d*1000).toFixed(0)+" m" : d.toFixed(1)+" km";
        }
        this.els.lShort.innerText = info.short;
        this.els.lFacts.innerHTML = info.facts.map(f=>`<li>${f}</li>`).join('');
        this.els.lMyth.innerText = `"${info.myth}"`;
    }
    
    updateOmenUI() {
        // Deterministic or Real Analysis
        const seed = (this.sensor.gps.lat || 0) + (this.sensor.gps.lon || 0) + Math.floor(Date.now()/5000);
        
        let level = 0;
        let std = 0;
        
        // Analyze Mag History for Variance
        if(this.sensor.mag.active && this.sensor.magHist.length > 10) {
            const mean = this.sensor.magHist.reduce((a,b)=>a+b,0)/this.sensor.magHist.length;
            const v = this.sensor.magHist.reduce((a,b)=>a+(b-mean)**2,0)/this.sensor.magHist.length;
            std = Math.sqrt(v);
            if(std > 5) level = 3;
            else if(std > 2) level = 2;
            else if(std > 0.5) level = 1;
        } else {
            // Deterministic Fallback (Narrative)
            const noise = Math.abs(Math.sin(seed));
            if(noise > 0.8) level = 2;
            else if(noise > 0.5) level = 1;
        }
        
        // Text Gen
        const codes = ['quiet', 'ripple', 'distort', 'peak'];
        const flavors = ['quiet', 'active']; // Simplified for brevity
        
        this.els.oTitle.innerText = this.i18n.t('omen_' + codes[level]);
        this.els.oTitle.style.color = level > 1 ? 'var(--neon-r)' : (level > 0 ? 'var(--neon-b)' : 'var(--neon-g)');
        this.els.oText.innerText = level > 0 ? "Magnetic Variance: " + (std ? std.toFixed(2) : "Simulated") : this.i18n.t('omen_quiet');
        this.els.oFlavor.innerText = level > 0 ? `"${this.i18n.t('flavor_active')}"` : `"${this.i18n.t('flavor_quiet')}"`;

        return level;
    }
    
    // Animation Loop
    loop() {
        requestAnimationFrame(() => this.loop());
        
        // 1. Heading Smoothing (EMA)
        this.state.dispHead = MathUtils.lerpAngle(this.state.dispHead, this.sensor.heading, 0.1);
        this.els.ring.style.transform = `rotate(${-this.state.dispHead}deg)`;
        this.els.headVal.innerText = Math.round(this.state.dispHead).toString().padStart(3,'0') + "Â°";
        
        // 2. Needles
        if(this.mode === 'wonder' && this.sensor.gps.lat) {
            const w = this.wonders[this.state.idx];
            const b = MathUtils.bearing(this.sensor.gps.lat, this.sensor.gps.lon, w.lat, w.lon);
            // Rotate needle. Container is -Head. Needle is Bearing. Result = Bearing relative to North on screen.
            this.els.nTarget.style.transform = `translateX(-50%) rotate(${b}deg)`;
        }
        else if (this.mode === 'earth') {
            const trueH = -this.state.decl;
            this.els.nTrue.style.transform = `translateX(-50%) rotate(${trueH}deg)`;
            this.els.nMag.style.transform = `translateX(-50%) rotate(0deg)`;
        }
        else if (this.mode === 'myth') {
            // Glitch/Wander Needle
            const lvl = this.updateOmenUI();
            const time = Date.now()/1000;
            const wander = Math.sin(time) * (lvl * 20);
            this.els.nTarget.style.transform = `translateX(-50%) rotate(${wander}deg)`;
            
            // Update Scope
            this.drawScope(this.sensor.magHist, lvl);
            
            // Add Radar Blip randomly based on level
            if(Math.random() < (lvl * 0.05)) this.addBlip();
        }
    }
    
    drawScope(hist, lvl) {
        this.ctx.clearRect(0,0,80,40);
        this.ctx.beginPath();
        this.ctx.strokeStyle = lvl > 1 ? '#f43f5e' : '#60a5fa';
        this.ctx.lineWidth = 1.5;
        
        if(hist.length > 0) {
            const min = Math.min(...hist); const max = Math.max(...hist);
            const range = max - min || 1;
            
            for(let i=0; i<hist.length; i++) {
                const x = (i / 60) * 80;
                const y = 40 - ((hist[i] - min) / range) * 40;
                if(i===0) this.ctx.moveTo(x,y); else this.ctx.lineTo(x,y);
            }
        } else {
            // Fake sine wave
            const t = Date.now()/200;
            for(let i=0; i<80; i+=5) {
                const y = 20 + Math.sin(t + i*0.1) * (5 + lvl*5);
                if(i===0) this.ctx.moveTo(i,y); else this.ctx.lineTo(i,y);
            }
        }
        this.ctx.stroke();
    }
    
    addBlip() {
        const blip = document.createElement('div');
        blip.className = 'radar-blip';
        // Random polar position
        const ang = Math.random() * 360;
        const rad = Math.random() * 40; // px radius
        blip.style.transform = `rotate(${ang}deg) translate(${rad}px) rotate(-${ang}deg)`; // Keep upright? No dot is round.
        // Actually translate is relative to center if centered.
        // Simple positioning:
        blip.style.left = (50 + Math.cos(ang)*rad) + '%';
        blip.style.top = (50 + Math.sin(ang)*rad) + '%';
        
        document.querySelector('.radar-scan').appendChild(blip);
        setTimeout(() => blip.remove(), 2000);
    }

    // Settings & Modal
    toggleSettings() { document.getElementById('modal-settings').classList.toggle('show'); }
    
    fetchDecl() {
        if(!this.sensor.gps.lat) return alert("Wait for GPS");
        const url = `https://www.ngdc.noaa.gov/geomag-web/calculators/calculateDeclination?lat1=${this.sensor.gps.lat}&lon1=${this.sensor.gps.lon}&resultFormat=json`;
        fetch(url).then(r=>r.json()).then(d=>{
            this.state.decl = d.result[0].declination;
            document.getElementById('inp-decl').value = this.state.decl.toFixed(2);
            alert("Updated: "+this.state.decl);
        }).catch(()=>alert("Online fetch failed. Enter manually."));
    }
    
    // Local Legend
    showLocalLegend() {
        if(!this.sensor.gps.lat) return alert("Need GPS");
        let min = Infinity; let story = FOLK_DB[FOLK_DB.length-1]; // Default
        
        FOLK_DB.forEach(f => {
            if(f.lat === 0) return;
            const d = MathUtils.dist(this.sensor.gps.lat, this.sensor.gps.lon, f.lat, f.lon);
            if(d < min) { min = d; story = f; }
        });
        
        const txt = story[this.i18n.lang];
        document.getElementById('folk-title').innerText = txt.t;
        document.getElementById('folk-body').innerText = txt.b;
        document.getElementById('folk-loc').innerText = `Location matched: ${min.toFixed(1)} km away`;
        document.getElementById('modal-folk').classList.add('show');
    }
    closeLegend() { document.getElementById('modal-folk').classList.remove('show'); }
}

// Init
const app = new App();
document.getElementById('btn-init').addEventListener('click', () => app.start());
document.getElementById('btn-lang').addEventListener('click', () => app.toggleLang());

</script>
</body>
</html>
