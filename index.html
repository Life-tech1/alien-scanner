<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>OMEGA v6.0: TACTICAL HUD</title>

    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/coco-ssd"></script>

    <style>
        /* --- VISUAL THEME: TACTICAL MILITARY --- */
        :root {
            --hud-safe: #00ff41;    /* Systems Normal */
            --hud-hostile: #ff0000; /* Threat Detected */
            --hud-neutral: #00ccff; /* Object */
            --hud-dim: rgba(0, 255, 65, 0.1);
            --bg: #000;
            --font: 'Consolas', 'Courier New', monospace;
        }

        * { box-sizing: border-box; user-select: none; -webkit-touch-callout: none; }
        
        body {
            margin: 0; overflow: hidden; background: var(--bg);
            font-family: var(--font); color: var(--hud-safe);
            width: 100vw; height: 100vh;
        }

        #viewport { position: relative; width: 100%; height: 100%; }

        /* CAMERA FEED (Raw & Gritty) */
        #camera-feed {
            position: absolute; inset: 0; width: 100%; height: 100%;
            object-fit: cover; z-index: 0;
            filter: contrast(1.2) brightness(0.8) grayscale(0.3) sepia(0.2);
        }

        /* HUD CANVAS (Sharp Vectors) */
        #hud-canvas { position: absolute; inset: 0; z-index: 10; }

        /* UI DOM ELEMENTS */
        #ui-layer {
            position: absolute; inset: 0; z-index: 20; pointer-events: none;
            display: flex; flex-direction: column; justify-content: space-between;
            padding: max(20px, env(safe-area-inset-top));
        }

        .panel {
            background: rgba(0, 10, 0, 0.8);
            border: 1px solid var(--hud-safe);
            border-left: 4px solid var(--hud-safe);
            padding: 8px 12px; margin-bottom: 10px;
            font-size: 10px; text-shadow: 0 0 2px var(--hud-safe);
            width: fit-content; pointer-events: auto;
            backdrop-filter: blur(2px);
        }

        /* STATUS BAR */
        #status-bar {
            align-self: center; text-align: center;
            border: 1px solid var(--hud-neutral); color: var(--hud-neutral);
            padding: 10px 30px; background: rgba(0, 20, 50, 0.8);
            transform: perspective(500px) rotateX(10deg);
        }
        #status-main { font-size: 16px; font-weight: 900; letter-spacing: 3px; }
        #status-sub { font-size: 10px; opacity: 0.8; }

        /* RADAR */
        #radar {
            position: absolute; bottom: 20px; right: 20px;
            width: 140px; height: 140px; border-radius: 50%;
            background: rgba(0, 15, 0, 0.9); border: 2px solid var(--hud-safe);
            overflow: hidden; z-index: 30; box-shadow: 0 0 15px rgba(0, 255, 65, 0.2);
        }
        #radar::after {
            content: ''; position: absolute; inset: 0; border-radius: 50%;
            background: conic-gradient(transparent 270deg, rgba(0,255,65,0.4) 360deg);
            animation: sweep 2s linear infinite;
        }
        @keyframes sweep { to { transform: rotate(360deg); } }
        
        .blip {
            position: absolute; width: 4px; height: 4px; border-radius: 50%;
            transform: translate(-50%, -50%); box-shadow: 0 0 4px currentColor;
        }

        /* BOOT SCREEN */
        #boot-screen {
            position: fixed; inset: 0; background: #000; z-index: 9999;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
        }
        .boot-log { font-size: 10px; opacity: 0.7; margin-top: 20px; height: 20px; }
        #btn-start {
            margin-top: 30px; padding: 15px 50px;
            background: transparent; border: 2px solid var(--hud-safe);
            color: var(--hud-safe); font-weight: bold; cursor: pointer;
            letter-spacing: 2px; transition: 0.2s;
        }
        #btn-start:hover { background: var(--hud-safe); color: #000; box-shadow: 0 0 20px var(--hud-safe); }

    </style>
</head>
<body>

    <div id="viewport">
        <video id="camera-feed" autoplay playsinline muted></video>
        <canvas id="hud-canvas"></canvas>

        <div id="ui-layer">
            <div>
                <div class="panel">
                    <div>CPU: <span id="ui-cpu">0</span>ms</div>
                    <div>FPS: <span id="ui-fps">0</span></div>
                    <div>MEM: <span id="ui-objs">0</span> ACTIVE</div>
                </div>
            </div>

            <div style="align-self: flex-end;">
                <div class="panel" style="text-align: right; border-left:none; border-right: 4px solid var(--hud-safe);">
                    <div>PITCH: <span id="ui-pitch">0</span>°</div>
                    <div>ROLL: <span id="ui-roll">0</span>°</div>
                    <div>LINK: <span id="ui-link">OFFLINE</span></div>
                </div>
            </div>

            <div id="status-bar">
                <div id="status-main">SYSTEM READY</div>
                <div id="status-sub">WAITING FOR TARGET</div>
            </div>

            <div id="radar">
                <div id="radar-blips"></div>
                <div style="position:absolute;top:50%;left:0;width:100%;height:1px;background:rgba(0,255,65,0.3);"></div>
                <div style="position:absolute;top:0;left:50%;width:1px;height:100%;background:rgba(0,255,65,0.3);"></div>
            </div>
        </div>
    </div>

    <div id="boot-screen">
        <div style="font-size:40px; font-weight:900; letter-spacing:5px;">OMEGA</div>
        <div style="opacity:0.6;">TACTICAL OS v6.0</div>
        <div class="boot-log" id="boot-log">Loading Neural Network...</div>
        <button id="btn-start" style="display:none;">INITIALIZE</button>
    </div>

<script>
/**
 * OMEGA v6.0: TACTICAL EDITION
 * Features: High-Precision IoU Tracking, Physics Calc, Voice AI, Bluetooth, 2D Tactical Renderer
 */

// --- CONFIG ---
const CONFIG = {
    AI: { CONFIDENCE: 0.55, IOU_THRESH: 0.3, MAX_LOST: 30, SMOOTH: 0.4 },
    PHYSICS: { FOV: 70, MAX_RANGE: 50 }, // Meters
    UUID: { SVC: "6E400001-B5A3-F393-E0A9-E50E24DCCA9E", CHR: "6E400002-B5A3-F393-E0A9-E50E24DCCA9E" },
    COLORS: { SAFE: '#00ff41', HOSTILE: '#ff0000', NEUTRAL: '#00ccff' }
};

// --- UTILS ---
const Utils = {
    lerp: (s, e, t) => s * (1 - t) + e * t,
    getIoU: (a, b) => { // Intersection over Union
        const x = Math.max(a[0], b[0]), y = Math.max(a[1], b[1]);
        const w = Math.min(a[0]+a[2], b[0]+b[2]) - x, h = Math.min(a[1]+a[3], b[1]+b[3]) - y;
        if (w < 0 || h < 0) return 0;
        const areaI = w * h, areaU = (a[2]*a[3]) + (b[2]*b[3]) - areaI;
        return areaI / areaU;
    }
};

// --- MODULE 1: VOICE ---
const Voice = {
    synth: window.speechSynthesis,
    speak(txt) {
        if(this.synth.speaking) return;
        const u = new SpeechSynthesisUtterance(txt);
        u.rate = 1.2; u.pitch = 1;
        this.synth.speak(u);
    },
    listen() {
        if(!('webkitSpeechRecognition' in window)) return;
        const r = new webkitSpeechRecognition();
        r.continuous = true; r.lang = 'en-US';
        r.onresult = e => {
            const t = e.results[e.results.length-1][0].transcript.toLowerCase();
            if(t.includes('connect')) Robot.connect();
            if(t.includes('status')) this.speak("Systems nominal.");
        };
        r.start();
    }
};

// --- MODULE 2: ROBOTICS (BLE) ---
const Robot = {
    char: null,
    async connect() {
        try {
            Voice.speak("Connecting to chassis.");
            const d = await navigator.bluetooth.requestDevice({
                filters: [{namePrefix:'OMEGA'}, {name:'OMEGA-BODY'}], optionalServices: [CONFIG.UUID.SVC]
            });
            const s = await (await d.gatt.connect()).getPrimaryService(CONFIG.UUID.SVC);
            this.char = await s.getCharacteristic(CONFIG.UUID.CHR);
            document.getElementById('ui-link').innerText = "ONLINE";
            document.getElementById('ui-link').style.color = CONFIG.COLORS.SAFE;
            Voice.speak("Connected.");
        } catch(e) { Voice.speak("Connection failed."); }
    },
    send(x, y) {
        if(!this.char) return;
        const p = Math.floor((x+1)/2 * 180), t = Math.floor((y+1)/2 * 180);
        this.char.writeValue(new TextEncoder().encode(`${p},${t}\n`)).catch(()=>{});
    }
};

// --- MODULE 3: THE BRAIN (TRACKER) ---
class Tracker {
    constructor() { this.tracks = []; }
    
    process(preds, w, h) {
        // 1. Predict
        this.tracks.forEach(t => { t.lost++; t.box[0]+=t.vel.x; t.box[1]+=t.vel.y; });
        
        // 2. Match (IoU)
        preds.forEach(p => {
            let match = null, maxIoU = 0;
            this.tracks.forEach(t => {
                const iou = Utils.getIoU(p.bbox, t.box);
                if(iou > maxIoU) { maxIoU = iou; match = t; }
            });
            
            if(match && maxIoU > CONFIG.AI.IOU_THRESH) {
                const a = CONFIG.AI.SMOOTH; // Smoothing factor
                match.vel = { x: p.bbox[0]-match.box[0], y: p.bbox[1]-match.box[1] };
                match.box = [
                    Utils.lerp(match.box[0], p.bbox[0], a), Utils.lerp(match.box[1], p.bbox[1], a),
                    Utils.lerp(match.box[2], p.bbox[2], a), Utils.lerp(match.box[3], p.bbox[3], a)
                ];
                match.lost = 0; match.score = p.score;
            } else {
                this.tracks.push({
                    id: Math.random().toString(36).substr(2,5),
                    cls: p.class, box: p.bbox, score: p.score,
                    vel: {x:0,y:0}, lost: 0, dist: 0, ang: 0
                });
            }
        });

        // 3. Prune & Calc Physics
        this.tracks = this.tracks.filter(t => t.lost < CONFIG.AI.MAX_LOST);
        this.tracks.forEach(t => {
            const cx = t.box[0] + t.box[2]/2;
            const nx = (cx/w)*2 - 1; // -1 to 1
            t.ang = nx * (CONFIG.PHYSICS.FOV/2);
            // Estimate depth: taller box = closer
            const nh = t.box[3]/h;
            t.dist = Math.min(CONFIG.PHYSICS.MAX_RANGE, 1.6 / nh); // 1.6m avg height logic
            
            t.nx = nx; t.ny = (t.box[1]+t.box[3]/2)/h*2 - 1; // For robotics
        });

        return this.tracks;
    }
}

// --- MODULE 4: RENDERER (TACTICAL HUD) ---
const HUD = {
    cvs: document.getElementById('hud-canvas'),
    ctx: document.getElementById('hud-canvas').getContext('2d'),
    
    resize() { this.cvs.width = window.innerWidth; this.cvs.height = window.innerHeight; },
    
    draw(tracks, pitch, roll) {
        const ctx = this.ctx; const w = this.cvs.width; const h = this.cvs.height;
        ctx.clearRect(0, 0, w, h);

        // 1. Horizon Line (Stabilized)
        ctx.save();
        ctx.translate(w/2, h/2); ctx.rotate(roll * Math.PI/180); ctx.translate(0, pitch*4);
        ctx.strokeStyle = 'rgba(0,255,65,0.3)'; ctx.lineWidth = 1;
        ctx.beginPath(); ctx.moveTo(-w, 0); ctx.lineTo(w, 0); ctx.stroke();
        // Pitch ladder
        for(let i=-2; i<=2; i++) {
            if(i===0) continue;
            let y=i*40; ctx.beginPath(); ctx.moveTo(-20, y); ctx.lineTo(20, y); ctx.stroke();
        }
        ctx.restore();

        // 2. Crosshair
        ctx.strokeStyle = CONFIG.COLORS.SAFE; ctx.lineWidth = 1;
        ctx.beginPath(); 
        ctx.moveTo(w/2-20, h/2); ctx.lineTo(w/2-5, h/2);
        ctx.moveTo(w/2+5, h/2); ctx.lineTo(w/2+20, h/2);
        ctx.moveTo(w/2, h/2-20); ctx.lineTo(w/2, h/2-5);
        ctx.moveTo(w/2, h/2+5); ctx.lineTo(w/2, h/2+20);
        ctx.stroke();

        // 3. Tracks
        tracks.forEach(t => {
            const [x, y, bw, bh] = t.box;
            const isHostile = t.cls === 'person';
            const color = isHostile ? CONFIG.COLORS.HOSTILE : CONFIG.COLORS.NEUTRAL;
            
            ctx.strokeStyle = color; ctx.lineWidth = 2; ctx.fillStyle = color;
            
            // Corners only (Tactical style)
            const L = 15;
            ctx.beginPath();
            ctx.moveTo(x, y+L); ctx.lineTo(x,y); ctx.lineTo(x+L, y); // TL
            ctx.moveTo(x+bw-L, y); ctx.lineTo(x+bw, y); ctx.lineTo(x+bw, y+L); // TR
            ctx.moveTo(x+bw, y+bh-L); ctx.lineTo(x+bw, y+bh); ctx.lineTo(x+bw-L, y+bh); // BR
            ctx.moveTo(x+L, y+bh); ctx.lineTo(x, y+bh); ctx.lineTo(x, y+bh-L); // BL
            ctx.stroke();

            // Label
            ctx.font = "bold 12px Consolas";
            ctx.fillText(`${t.cls.toUpperCase()} #${t.id}`, x+5, y-15);
            ctx.font = "10px Consolas";
            ctx.fillText(`DST: ${t.dist.toFixed(1)}m`, x+5, y-4);

            // Tracking Line to Center
            if(isHostile) {
                ctx.save();
                ctx.setLineDash([5, 5]); ctx.globalAlpha = 0.4; ctx.lineWidth = 1;
                ctx.beginPath(); ctx.moveTo(w/2, h/2); ctx.lineTo(x+bw/2, y+bh/2); ctx.stroke();
                ctx.restore();
            }
        });
    }
};

// --- KERNEL ---
const Kernel = {
    video: document.getElementById('camera-feed'),
    tracker: new Tracker(),
    avionics: { p: 0, r: 0 },
    model: null,
    run: false,

    async boot() {
        try {
            // Avionics
            window.addEventListener('deviceorientation', e => {
                this.avionics.p = Utils.lerp(this.avionics.p, e.beta||0, 0.1);
                this.avionics.r = Utils.lerp(this.avionics.r, e.gamma||0, 0.1);
                document.getElementById('ui-pitch').innerText = this.avionics.p.toFixed(0);
                document.getElementById('ui-roll').innerText = this.avionics.r.toFixed(0);
            });
            
            // Cam
            const stream = await navigator.mediaDevices.getUserMedia({video:{facingMode:'environment'}, audio:false});
            this.video.srcObject = stream;
            await new Promise(r => this.video.onloadedmetadata = r);
            
            // AI
            await tf.ready();
            this.model = await cocoSsd.load();
            
            // UI Ready
            document.getElementById('boot-log').innerText = "SYSTEM READY";
            document.getElementById('btn-start').style.display = 'block';
            document.getElementById('btn-start').onclick = () => {
                document.getElementById('boot-screen').style.display = 'none';
                this.run = true; Voice.listen(); HUD.resize(); this.loop();
            };
        } catch(e) { alert("Error: "+e); }
    },

    async loop() {
        if(!this.run) return;
        requestAnimationFrame(() => this.loop());
        const start = performance.now();

        HUD.draw(this.tracker.tracks, this.avionics.p, this.avionics.r);

        if(this.video.readyState === 4) {
            // Inference
            const preds = await this.model.detect(this.video, 10, CONFIG.AI.CONFIDENCE);
            const tracks = this.tracker.process(preds, this.video.videoWidth, this.video.videoHeight);
            
            // Logic
            this.updateUI(tracks);
            
            // Robot Link (Primary Target)
            const target = tracks.find(t => t.cls === 'person');
            if(target) Robot.send(target.nx, target.ny);
        }
        
        const dt = performance.now() - start;
        document.getElementById('ui-cpu').innerText = dt.toFixed(0);
        document.getElementById('ui-fps').innerText = (1000/dt).toFixed(0);
    }

    updateUI(tracks) {
        // Update Radar
        const rad = document.getElementById('radar-blips'); rad.innerHTML = '';
        tracks.forEach(t => {
            const el = document.createElement('div'); el.className = 'blip';
            // Polar to CSS
            const r = (t.dist / CONFIG.PHYSICS.MAX_RANGE) * 70;
            const a = (t.ang - 90) * Math.PI/180;
            el.style.left = (70 + r*Math.cos(a)) + 'px';
            el.style.top = (70 + r*Math.sin(a)) + 'px';
            el.style.color = t.cls === 'person' ? CONFIG.COLORS.HOSTILE : CONFIG.COLORS.NEUTRAL;
            rad.appendChild(el);
        });
        document.getElementById('ui-objs').innerText = tracks.length;

        // Status Bar
        const statMain = document.getElementById('status-main');
        const statSub = document.getElementById('status-sub');
        const target = tracks.find(t => t.cls === 'person');
        
        if(target) {
            statMain.innerText = "TARGET ACQUIRED";
            statMain.style.color = CONFIG.COLORS.HOSTILE;
            statSub.innerText = `LOCK: ${target.cls.toUpperCase()} | DIST: ${target.dist.toFixed(1)}M`;
            document.getElementById('status-bar').style.borderColor = CONFIG.COLORS.HOSTILE;
        } else {
            statMain.innerText = "SYSTEM ACTIVE";
            statMain.style.color = CONFIG.COLORS.NEUTRAL;
            statSub.innerText = "SCANNING SECTOR...";
            document.getElementById('status-bar').style.borderColor = CONFIG.COLORS.NEUTRAL;
        }
    }
};

Kernel.boot();
window.addEventListener('resize', ()=>HUD.resize());

</script>
</body>
</html>
