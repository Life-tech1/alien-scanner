<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>OMEGA: GEO-TACTICAL AR</title>
    
    <!-- AI & 3D Engine -->
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@3.11.0"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/coco-ssd@2.2.2"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>

    <style>
        :root { --p: #00ff9d; --s: #008f7a; --a: #ff2a6d; --bg: #000; --font: 'Courier New', monospace; }
        body { margin: 0; overflow: hidden; background: var(--bg); color: var(--p); font-family: var(--font); }
        
        /* FULLSCREEN LAYERS */
        #cam-feed { position: absolute; inset: 0; width: 100%; height: 100%; object-fit: cover; opacity: 0.7; z-index: 0; }
        #ar-world { position: absolute; inset: 0; z-index: 5; pointer-events: none; } /* REAL 3D WORLD */
        #hud { position: absolute; inset: 0; z-index: 10; pointer-events: none; } /* 2D OVERLAY */
        
        /* UI COMPONENTS */
        #ui-layer { position: absolute; inset: 0; z-index: 20; padding: 15px; display: flex; flex-direction: column; justify-content: space-between; pointer-events: none; }
        
        .panel { 
            background: rgba(0, 15, 10, 0.85); border: 1px solid var(--s); border-left: 3px solid var(--p);
            padding: 10px; backdrop-filter: blur(5px); width: fit-content; pointer-events: auto;
            margin-bottom: 5px;
        }
        .label { font-size: 10px; color: #00a8ff; font-weight: bold; }
        .val { font-size: 14px; color: #fff; font-weight: bold; text-shadow: 0 0 5px var(--p); }
        .val.alert { color: var(--a); text-shadow: 0 0 5px var(--a); }

        /* COMPASS STRIP */
        #compass-strip {
            position: absolute; top: 0; left: 0; width: 100%; height: 40px;
            background: linear-gradient(to bottom, rgba(0,0,0,0.9), transparent);
            overflow: hidden; border-bottom: 1px solid var(--p); display: flex; align-items: center; justify-content: center;
        }
        #compass-ticks {
            position: absolute; display: flex; transition: transform 0.1s; width: 2000px;
            font-weight: bold; font-size: 14px;
        }
        .tick { width: 50px; text-align: center; border-left: 1px solid rgba(0,255,157,0.3); height: 10px; margin-top: 5px; }
        .marker { position: absolute; top: 0; left: 50%; width: 2px; height: 40px; background: var(--a); transform: translateX(-50%); z-index: 30; }

        /* CONTROLS */
        #start-screen { position: fixed; inset: 0; background: #000; z-index: 9999; display: flex; flex-direction: column; align-items: center; justify-content: center; text-align: center; }
        button { padding: 15px 30px; background: var(--p); border: none; font-weight: bold; font-size: 16px; margin-top: 20px; cursor: pointer; border-radius: 5px; }
    </style>
</head>
<body>

    <video id="cam-feed" autoplay playsinline muted></video>
    <canvas id="ar-world"></canvas>
    <canvas id="hud"></canvas>

    <!-- COMPASS HUD -->
    <div id="compass-strip">
        <div id="compass-ticks">
            <!-- JS will fill this -->
        </div>
        <div class="marker"></div>
    </div>

    <div id="ui-layer">
        <!-- GPS DATA -->
        <div style="display:flex; justify-content:space-between;">
            <div class="panel">
                <div class="label">GEOLOCATION</div>
                <div>LAT: <span id="gps-lat" class="val">--.-----</span></div>
                <div>LON: <span id="gps-lon" class="val">--.-----</span></div>
                <div>ACC: <span id="gps-acc" class="val">--m</span></div>
            </div>
            <div class="panel">
                <div class="label">DYNAMICS</div>
                <div>SPD: <span id="gps-spd" class="val">0 km/h</span></div>
                <div>ALT: <span id="gps-alt" class="val">--m</span></div>
                <div>HDG: <span id="imu-hdg" class="val alert">--°</span></div>
            </div>
        </div>

        <!-- AI DATA -->
        <div class="panel" style="align-self: flex-end;">
            <div class="label">VISUAL SENSORS</div>
            <div>OBJ: <span id="ai-count" class="val">0</span></div>
            <div>FPS: <span id="sys-fps" class="val">0</span></div>
        </div>
    </div>

    <div id="start-screen">
        <h1 style="color:var(--p); text-shadow: 0 0 20px var(--p); font-size: 40px;">OMEGA</h1>
        <h3 style="color:#888;">GEO-TACTICAL SENSOR FUSION</h3>
        <p style="color:#666; font-size: 12px; max-width: 300px;">
            REQ: CAMERA, GPS, COMPASS (HTTPS ONLY)<br>
            iOS Users: Must allow Motion Sensors
        </p>
        <button id="btn-start">CALIBRATE & ENGAGE</button>
    </div>

<script>
/**
 * OMEGA: GEO-TACTICAL EDITION
 * Features: GPS Fusion, IMU Compass, True 3D World Anchor
 */

// --- CONFIG ---
const CFG = {
    AI_CONF: 0.6,
    FOV: 75,
    GRID_SIZE: 100 // meters
};

// --- MODULE 1: SENSOR FUSION (GPS + IMU) ---
class GeoSpatialSystem {
    constructor() {
        this.lat = 0; this.lon = 0; this.alt = 0;
        this.speed = 0; this.accuracy = 0;
        this.heading = 0; // True North
        this.pitch = 0;   // Tilt
        this.roll = 0;
        this.ready = false;
    }

    init(onReady) {
        // 1. GPS
        if('geolocation' in navigator) {
            navigator.geolocation.watchPosition(
                pos => {
                    this.lat = pos.coords.latitude;
                    this.lon = pos.coords.longitude;
                    this.alt = pos.coords.altitude || 0;
                    this.accuracy = pos.coords.accuracy;
                    this.speed = (pos.coords.speed || 0) * 3.6; // m/s to km/h
                    this.ready = true;
                    this.updateUI();
                },
                err => console.error("GPS Error", err),
                { enableHighAccuracy: true, maximumAge: 0 }
            );
        }

        // 2. IMU (Compass/Gyro)
        if (window.DeviceOrientationEvent && typeof DeviceOrientationEvent.requestPermission === 'function') {
            // iOS 13+
            DeviceOrientationEvent.requestPermission()
                .then(state => {
                    if (state === 'granted') this.listenIMU();
                    else alert("Compass Permission Denied");
                    onReady();
                })
                .catch(console.error);
        } else {
            // Android / Old iOS
            this.listenIMU();
            onReady();
        }
    }

    listenIMU() {
        window.addEventListener('deviceorientation', e => {
            // Alpha is compass (0-360), Beta is pitch (-180 to 180)
            // Note: Android uses absolute, iOS uses webkitCompassHeading
            let compass = e.webkitCompassHeading || Math.abs(e.alpha - 360);
            this.heading = compass;
            this.pitch = e.beta;
            this.roll = e.gamma;
            
            // Update Compass Strip UI
            const strip = document.getElementById('compass-ticks');
            // 5px per degree
            strip.style.transform = `translateX(-${this.heading * 5}px)`;
            
            document.getElementById('imu-hdg').innerText = Math.round(this.heading) + "°";
        }, true);
    }

    updateUI() {
        document.getElementById('gps-lat').innerText = this.lat.toFixed(5);
        document.getElementById('gps-lon').innerText = this.lon.toFixed(5);
        document.getElementById('gps-acc').innerText = Math.round(this.accuracy) + "m";
        document.getElementById('gps-spd').innerText = Math.round(this.speed) + " km/h";
        document.getElementById('gps-alt').innerText = Math.round(this.alt) + "m";
    }
}

// --- MODULE 2: TRUE AR WORLD (THREE.JS) ---
class ARWorld {
    constructor() {
        this.canvas = document.getElementById('ar-world');
        this.scene = new THREE.Scene();
        this.camera = new THREE.PerspectiveCamera(CFG.FOV, window.innerWidth/window.innerHeight, 0.1, 1000);
        this.renderer = new THREE.WebGLRenderer({canvas: this.canvas, alpha: true});
        this.renderer.setSize(window.innerWidth, window.innerHeight);
        
        this.createWorld();
    }

    createWorld() {
        // 1. Grid Floor (Infinite Plane Illusion)
        const grid = new THREE.GridHelper(CFG.GRID_SIZE, 20, 0x00ff9d, 0x003322);
        grid.position.y = -2; // Below eye level
        this.scene.add(grid);

        // 2. North Marker (Red line pointing North)
        const mat = new THREE.LineBasicMaterial({ color: 0xff0000, linewidth: 4 });
        const pts = [new THREE.Vector3(0, -2, 0), new THREE.Vector3(0, -2, -50)]; // -Z is North in 3D
        const geom = new THREE.BufferGeometry().setFromPoints(pts);
        const northLine = new THREE.Line(geom, mat);
        this.scene.add(northLine);

        // 3. Floating POIs (Fake Targets)
        // Add a "Target" 20 meters North
        const geoBox = new THREE.WireframeGeometry(new THREE.BoxGeometry(2, 4, 2));
        const matBox = new THREE.LineBasicMaterial({ color: 0xff2a6d });
        const target = new THREE.LineSegments(geoBox, matBox);
        target.position.set(0, 0, -20); // 20m North
        this.scene.add(target);
    }

    updateCamera(geo) {
        // Sync Virtual Camera with Real Phone Rotation
        // This makes the grid stick to the real world
        
        // Convert deg to rad
        const alpha = THREE.Math.degToRad(geo.heading);
        const beta = THREE.Math.degToRad(geo.pitch);
        const gamma = THREE.Math.degToRad(geo.roll);

        // Euler Order: ZXY is common for phone sensors but varies by device. 
        // Simplifying for stability: mainly Rotate Y (Heading) and X (Pitch)
        
        // Reset rotation
        this.camera.rotation.set(0, 0, 0);
        
        // Apply Compass (Y-axis rotation)
        // Note: 3D North is -Z. Compass 0 is North. 
        // We rotate the camera opposite to phone movement to keep world static, 
        // OR rotate the world. Here we rotate camera.
        
        const lookAngle = THREE.Math.degToRad(geo.heading);
        this.camera.rotation.y = -lookAngle; // Invert for camera
        
        // Apply Tilt (X-axis) - simple approximation
        const tilt = THREE.Math.degToRad(geo.pitch - 90); // Phone upright = 90
        this.camera.rotation.x = tilt;

        this.renderer.render(this.scene, this.camera);
    }

    resize() {
        this.renderer.setSize(window.innerWidth, window.innerHeight);
        this.camera.aspect = window.innerWidth / window.innerHeight;
        this.camera.updateProjectionMatrix();
    }
}

// --- MODULE 3: VISION AI (COCO-SSD) ---
class VisionAI {
    constructor() {
        this.model = null;
        this.canvas = document.getElementById('hud');
        this.ctx = this.canvas.getContext('2d');
        this.resize();
    }
    
    async load() {
        this.model = await cocoSsd.load({base: 'lite_mobilenet_v2'});
    }

    async scan(video) {
        if(!this.model) return;
        const detections = await this.model.detect(video, 10, CFG.AI_CONF);
        
        this.ctx.clearRect(0,0,this.canvas.width, this.canvas.height);
        const sx = this.canvas.width / video.videoWidth;
        const sy = this.canvas.height / video.videoHeight;

        detections.forEach(d => {
            const [x,y,w,h] = d.bbox;
            const color = d.class === 'person' ? '#ff2a6d' : '#00ff9d';
            
            // Draw Bracket
            this.ctx.strokeStyle = color; this.ctx.lineWidth = 2;
            this.ctx.strokeRect(x*sx, y*sy, w*sx, h*sy);
            
            // Draw Label
            this.ctx.fillStyle = color; this.ctx.font = "bold 12px monospace";
            this.ctx.fillText(d.class.toUpperCase(), x*sx, y*sy - 5);
        });

        document.getElementById('ai-count').innerText = detections.length;
    }

    resize() {
        this.canvas.width = window.innerWidth;
        this.canvas.height = window.innerHeight;
    }
}

// --- MAIN KERNEL ---
const GEO = new GeoSpatialSystem();
const AR = new ARWorld();
const AI = new VisionAI();

let isRunning = false;
let video = document.getElementById('cam-feed');

// Generate Compass UI
const strip = document.getElementById('compass-ticks');
let html = '';
// Create 3 loops of 0-360 for smooth scrolling
for(let i=0; i<3; i++) {
    for(let deg=0; deg<360; deg+=10) {
        let label = deg === 0 ? 'N' : deg === 90 ? 'E' : deg === 180 ? 'S' : deg === 270 ? 'W' : deg;
        html += `<div class="tick">${label}</div>`;
    }
}
strip.innerHTML = html;


async function startSystem() {
    const btn = document.getElementById('btn-start');
    btn.innerText = "INITIALIZING SENSORS...";
    
    // 1. Init GPS & IMU
    GEO.init(async () => {
        // 2. Start Camera
        try {
            const stream = await navigator.mediaDevices.getUserMedia({
                video: { facingMode: 'environment', width: {ideal: 1280} },
                audio: false
            });
            video.srcObject = stream;
            await new Promise(r => video.onloadedmetadata = () => { video.play(); r(); });
            
            // 3. Load AI
            btn.innerText = "LOADING NEURAL NET...";
            await AI.load();

            // 4. Engage
            document.getElementById('start-screen').style.display = 'none';
            isRunning = true;
            loop();
        } catch(e) {
            alert("Error: " + e.message);
        }
    });
}

function loop() {
    if(!isRunning) return;
    const now = performance.now();
    
    // Update AR World based on Sensors
    AR.updateCamera(GEO);
    
    // Run AI Scan
    AI.scan(video);
    
    requestAnimationFrame(loop);
}

window.onresize = () => { AR.resize(); AI.resize(); }
document.getElementById('btn-start').onclick = startSystem;

</script>
</body>
</html>
