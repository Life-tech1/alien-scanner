<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>AI TACTICAL VISION | OBJECT RECOGNITION</title>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/coco-ssd"></script>
    
    <style>
        :root {
            --hud-color: #00ff41;
            --hud-alert: #ff3333;
            --bg-dark: #000000;
            --font-tac: 'Courier New', Courier, monospace;
        }

        body {
            margin: 0; background: var(--bg-dark); overflow: hidden;
            font-family: var(--font-tac); color: var(--hud-color);
            width: 100vw; height: 100vh;
        }

        #video {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            object-fit: cover; z-index: 0;
        }

        #canvas {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            z-index: 1;
        }

        #ui {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            z-index: 2; pointer-events: none;
            display: flex; flex-direction: column; justify-content: space-between;
            padding: 15px;
        }

        .loading-overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: #000; z-index: 99;
            display: flex; flex-direction: column;
            align-items: center; justify-content: center;
            text-align: center;
        }

        .spinner {
            width: 50px; height: 50px;
            border: 5px solid #333; border-top: 5px solid var(--hud-color);
            border-radius: 50%; animation: spin 1s linear infinite;
            margin-bottom: 20px;
        }

        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        .btn {
            pointer-events: auto; background: transparent;
            border: 2px solid var(--hud-color); color: var(--hud-color);
            padding: 15px 30px; font-size: 1rem; font-family: var(--font-tac);
            cursor: pointer; text-transform: uppercase;
            margin-top: 20px;
        }
        .btn:hover { background: rgba(0, 255, 65, 0.2); }

        /* HUD Elements */
        .header {
            display: flex; justify-content: space-between;
            background: rgba(0, 20, 0, 0.8); padding: 10px;
            border-bottom: 2px solid var(--hud-color);
        }
        .footer {
            background: rgba(0, 20, 0, 0.8); padding: 10px;
            border-top: 2px solid var(--hud-color);
            font-size: 0.8rem;
        }
    </style>
</head>
<body>

    <div id="loading" class="loading-overlay">
        <div class="spinner"></div>
        <h2 style="margin:0;">INITIALIZING AI CORE...</h2>
        <p style="color:#888; font-size:0.8rem;">LOADING NEURAL NETWORK (COCO-SSD)</p>
        <button id="start-btn" class="btn" style="display:none;">ACTIVATE SYSTEM</button>
    </div>

    <video id="video" playsinline muted autoplay></video>
    <canvas id="canvas"></canvas>

    <div id="ui">
        <div class="header">
            <div>AI VISION SYSTEM <span style="font-size:0.7rem; color:#00ccff;">// ONLINE</span></div>
            <div id="obj-count">OBJECTS: 0</div>
        </div>
        <div class="footer">
            <div id="log">> WAITING FOR VIDEO FEED...</div>
        </div>
    </div>

    <script>
        let video = document.getElementById('video');
        let canvas = document.getElementById('canvas');
        let ctx = canvas.getContext('2d');
        let model = null;
        let isDetecting = false;

        // 1. LOAD AI MODEL
        async function loadModel() {
            try {
                model = await cocoSsd.load();
                document.querySelector('.spinner').style.display = 'none';
                document.querySelector('h2').innerText = "SYSTEM READY";
                document.querySelector('p').innerText = "NEURAL NETWORK LOADED";
                document.getElementById('start-btn').style.display = 'inline-block';
            } catch (err) {
                alert("Failed to load AI Model: " + err);
            }
        }
        loadModel();

        // 2. START CAMERA
        document.getElementById('start-btn').addEventListener('click', async () => {
            document.getElementById('loading').style.display = 'none';
            try {
                const stream = await navigator.mediaDevices.getUserMedia({
                    video: { facingMode: 'environment' },
                    audio: false
                });
                video.srcObject = stream;
                
                video.onloadedmetadata = () => {
                    video.play();
                    resize();
                    detectFrame();
                };
            } catch (err) {
                alert("Camera Error: " + err);
            }
        });

        function resize() {
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
        }
        window.addEventListener('resize', resize);

        // 3. AI DETECTION LOOP
        async function detectFrame() {
            if (!model) return;

            // Detect objects
            const predictions = await model.detect(video);
            
            // Clear canvas
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            // Draw HUD Grid (Static)
            drawGrid();

            // Draw Predictions
            if (predictions.length > 0) {
                document.getElementById('obj-count').innerText = `OBJECTS: ${predictions.length}`;
                document.getElementById('log').innerText = `> TRACKING: ${predictions[0].class.toUpperCase()} (${Math.round(predictions[0].score*100)}%)`;
                
                predictions.forEach(prediction => {
                    drawBoundingBox(prediction);
                });
            } else {
                document.getElementById('obj-count').innerText = "OBJECTS: 0";
                document.getElementById('log').innerText = "> SCANNING SECTOR...";
            }

            requestAnimationFrame(detectFrame);
        }

        function drawBoundingBox(prediction) {
            // Calculate scaling (video vs canvas)
            const videoRatio = video.videoWidth / video.videoHeight;
            const canvasRatio = canvas.width / canvas.height;
            
            // Simple scaling logic (assuming object-fit: cover behavior approximation)
            // Note: For perfect alignment in all aspect ratios, more complex math is needed.
            // This is a simplified version for "Tac-Vis" feel.
            
            const [x, y, width, height] = prediction.bbox;
            
            // Scale coordinates to canvas size
            const scaleX = canvas.width / video.videoWidth;
            const scaleY = canvas.height / video.videoHeight;
            
            // Use the larger scale to cover (simulating object-fit: cover)
            const scale = Math.max(scaleX, scaleY);
            
            // Center offsets
            const offsetX = (canvas.width - video.videoWidth * scale) / 2;
            const offsetY = (canvas.height - video.videoHeight * scale) / 2;

            const finalX = (x * scale) + offsetX;
            const finalY = (y * scale) + offsetY;
            const finalW = width * scale;
            const finalH = height * scale;

            // Draw Box
            ctx.strokeStyle = "#00ff41";
            ctx.lineWidth = 2;
            ctx.strokeRect(finalX, finalY, finalW, finalH);

            // Draw Label Background
            ctx.fillStyle = "rgba(0, 255, 65, 0.2)";
            ctx.fillRect(finalX, finalY, finalW, finalH);

            // Draw Text Label
            ctx.fillStyle = "#00ff41";
            ctx.fillRect(finalX, finalY - 20, finalW, 20);
            ctx.fillStyle = "#000";
            ctx.font = "bold 12px Courier New";
            ctx.fillText(
                `${prediction.class.toUpperCase()} [${Math.round(prediction.score * 100)}%]`,
                finalX + 5, finalY - 5
            );

            // Draw Corner Brackets (Tactical feel)
            ctx.strokeStyle = "#00ccff";
            ctx.lineWidth = 2;
            const bSize = 10;
            ctx.beginPath();
            ctx.moveTo(finalX, finalY + bSize); ctx.lineTo(finalX, finalY); ctx.lineTo(finalX + bSize, finalY); // TL
            ctx.stroke();
        }

        function drawGrid() {
            // Central Crosshair
            const cx = canvas.width / 2;
            const cy = canvas.height / 2;
            ctx.strokeStyle = "rgba(0, 255, 65, 0.3)";
            ctx.lineWidth = 1;
            
            ctx.beginPath();
            ctx.moveTo(cx - 20, cy); ctx.lineTo(cx + 20, cy);
            ctx.moveTo(cx, cy - 20); ctx.lineTo(cx, cy + 20);
            ctx.stroke();
        }
    </script>
</body>
</html>
