<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>WIND ROSE | WR</title>
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#000000">
    <meta name="description" content="Wind Rose: The Treasure Seekerâ€™s Compass">

    <style>
        /* ------------------------------------------------------------------
           CORE: RESET & SYSTEM
           ------------------------------------------------------------------ */
        :root {
            --bg-core: #000000;
            --bg-grad: radial-gradient(circle at 50% 30%, #1c1c2e 0%, #000000 80%);
            
            /* Glass System */
            --glass-surf: rgba(255, 255, 255, 0.06);
            --glass-border: rgba(255, 255, 255, 0.1);
            --blur-val: 24px;

            /* WR Palette */
            --wr-p: #d946ef; --wr-b: #60a5fa; --wr-y: #fbbf24; 
            --wr-r: #f43f5e; --wr-g: #34d399;
            
            --font-main: -apple-system, BlinkMacSystemFont, "SF Pro Display", "Inter", sans-serif;
            --font-mono: "SF Mono", "Menlo", monospace;

            --safe-top: env(safe-area-inset-top, 20px);
            --safe-bot: env(safe-area-inset-bottom, 20px);

            /* Fix missing vars */
            --text-2: #9ca3af;
            --ease-out: cubic-bezier(0.25, 1, 0.5, 1);
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

        html, body {
            margin: 0; padding: 0;
            background: var(--bg-core); background-image: var(--bg-grad);
            color: #fff; font-family: var(--font-main);
            height: 100%; width: 100%; overflow: hidden; 
            touch-action: none; overscroll-behavior: none;
            user-select: none; -webkit-user-select: none;
            display: flex; flex-direction: column;
        }

        /* ------------------------------------------------------------------
           A) APPLE-MINIMAL STARTUP OVERLAY
           ------------------------------------------------------------------ */
        #overlay {
            position: fixed; inset: 0; z-index: 999;
            background: #000; /* Pure black base */
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            transition: opacity 0.8s cubic-bezier(0.25, 1, 0.5, 1);
        }
        #overlay::after {
            content:''; position: absolute; inset: 0;
            background: radial-gradient(circle, rgba(255,255,255,0.05) 0%, transparent 60%);
            pointer-events: none;
        }
        #overlay.fade-out { opacity: 0; pointer-events: none; }

        /* The Core Brand Mark */
        .brand-core {
            position: relative; width: 120px; height: 120px;
            display: flex; align-items: center; justify-content: center;
            margin-bottom: 20px; pointer-events: none;
        }
        
        /* The "W" */
        .hero-w {
            font-family: var(--font-main); font-weight: 200; font-size: 4rem;
            color: #fff; letter-spacing: -2px; z-index: 2;
            opacity: 0; animation: fadeInLogo 1.5s ease-out forwards 0.2s;
        }

        /* The Minimal Spinner Ring */
        .loader-ring {
            position: absolute; inset: 0; border-radius: 50%;
            border: 1px solid rgba(255,255,255,0.1);
            border-top-color: #fff;
            animation: spin 1.5s linear infinite;
            opacity: 0; animation: spin 1.5s linear infinite, fadeIn 1s ease-out forwards;
        }

        /* Tap Hint Text */
        #tap-hint {
            font-family: var(--font-mono); font-size: 0.75rem; letter-spacing: 2px;
            color: rgba(255,255,255,0.7); text-transform: uppercase;
            opacity: 0; animation: fadeIn 1s ease-out forwards 0.5s, breathe 3s infinite ease-in-out;
            pointer-events: none;
        }

        /* Invisible Full-Screen Trigger Button */
        #btn-init {
            position: absolute; inset: 0; width: 100%; height: 100%;
            background: transparent; border: none; cursor: pointer;
            z-index: 1000; outline: none;
        }
        #btn-init:active { background: rgba(255,255,255,0.05); }

        /* Hidden Diagnostics (Must exist for JS) */
        .sys-hidden { display: none; }

        @keyframes spin { to { transform: rotate(360deg); } }
        @keyframes fadeInLogo { from { opacity: 0; transform: scale(0.9); } to { opacity: 1; transform: scale(1); } }
        @keyframes fadeIn { to { opacity: 1; } }
        @keyframes breathe { 0%, 100% { opacity: 0.5; } 50% { opacity: 0.9; } }

        /* ------------------------------------------------------------------
           B) ONBOARDING & MODALS
           ------------------------------------------------------------------ */
        .modal-wrap {
            position: fixed; inset: 0; z-index: 200; background: rgba(0,0,0,0.85);
            backdrop-filter: blur(16px); -webkit-backdrop-filter: blur(16px);
            display: flex; align-items: center; justify-content: center;
            padding: 24px; opacity: 0; pointer-events: none; transition: 0.4s var(--ease-out);
        }
        .modal-wrap.show { opacity: 1; pointer-events: auto; }

        .glass-modal {
            width: 100%; max-width: 380px; background: var(--glass-surf);
            border: 1px solid var(--glass-border); border-radius: 32px;
            padding: 32px 24px; text-align: center;
            box-shadow: 0 20px 50px rgba(0,0,0,0.6);
            transform: scale(0.95); transition: transform 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        .modal-wrap.show .glass-modal { transform: scale(1); }

        .ob-icon { font-size: 2.5rem; margin-bottom: 16px; display: block; text-shadow: 0 0 20px var(--wr-p); }
        .ob-title { font-size: 1.3rem; font-weight: 700; color: #fff; margin-bottom: 12px; line-height: 1.3; }
        .ob-body { font-size: 0.95rem; color: var(--text-2); line-height: 1.6; margin-bottom: 24px; white-space: pre-line; }
        .ob-note { font-size: 0.75rem; color: #666; border-top: 1px solid rgba(255,255,255,0.1); padding-top: 12px; margin-bottom: 24px; }
        
        .btn-action {
            background: #fff; color: #000; border: none;
            padding: 14px 32px; border-radius: 30px; font-size: 1rem; font-weight: 600;
            cursor: pointer; width: 100%; transition: transform 0.2s, opacity 0.2s;
        }
        .btn-action:active { transform: scale(0.97); opacity: 0.9; }

        /* Toast Hint */
        .hint-toast {
            position: fixed; bottom: 120px; left: 50%; transform: translateX(-50%) translateY(20px);
            background: rgba(20, 20, 30, 0.9); border: 1px solid var(--wr-p);
            color: #fff; padding: 10px 20px; border-radius: 30px; font-size: 0.85rem;
            opacity: 0; pointer-events: none; transition: 0.5s; z-index: 150;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5); display: flex; align-items: center; gap: 8px;
        }
        .hint-toast.show { opacity: 1; transform: translateX(-50%) translateY(0); }

        /* ------------------------------------------------------------------
           MAIN HUD (GLASS SCI-FI) - PRESENCE
           ------------------------------------------------------------------ */
        .scanlines {
            position: fixed; inset: 0; pointer-events: none; z-index: 10; 
            background: linear-gradient(to bottom, rgba(255,255,255,0), rgba(255,255,255,0) 50%, rgba(0,0,0,0.1) 50%, rgba(0,0,0,0.1));
            background-size: 100% 4px; opacity: 0; transition: opacity 2s;
        }
        
        #app {
            position: relative; z-index: 20; flex: 1;
            display: flex; flex-direction: column;
            padding: var(--safe-top) 16px calc(var(--safe-bot) + 12px) 16px;
            gap: 12px; opacity: 0; transition: opacity 1.5s ease;
        }
        #app.visible { opacity: 1; }
        body.active .scanlines { opacity: 0.15; }

        /* ... [Existing HUD Styles Preserved] ... */
        .glass-panel { background: var(--glass-surf); backdrop-filter: blur(var(--blur-val)); -webkit-backdrop-filter: blur(var(--blur-val)); border: 1px solid var(--glass-border); border-radius: 24px; box-shadow: 0 10px 30px rgba(0,0,0,0.5); }
        .header { display: flex; justify-content: space-between; align-items: center; height: 44px; }
        .brand { font-weight: 700; letter-spacing: 2px; font-size: 0.8rem; color: #aaa; }
        .badge { font-size: 0.65rem; padding: 4px 10px; border-radius: 12px; background: rgba(255,255,255,0.1); color: #888; }
        .badge.active { color: var(--wr-g); border: 1px solid var(--wr-g); background: rgba(52, 211, 153, 0.1); }
        .stage { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; position: relative; }
        .orb-ring { width: 280px; height: 280px; border-radius: 50%; position: relative; box-shadow: 0 0 60px rgba(217, 70, 239, 0.1), inset 0 0 40px rgba(0,0,0,0.8); border: 1px solid rgba(255,255,255,0.08); will-change: transform; }
        .ticks { position: absolute; inset: -10px; border-radius: 50%; background: repeating-conic-gradient(rgba(255,255,255,0.2) 0deg 1deg, transparent 1deg 10deg); mask: radial-gradient(transparent 65%, black 66%); -webkit-mask: radial-gradient(transparent 65%, black 66%); }
        .cardinals { position: absolute; inset: 10px; pointer-events: none; }
        .card { position: absolute; font-weight: 700; font-size: 0.8rem; color: #666; }
        .c-n { top: 0; left: 50%; transform: translateX(-50%); color: var(--wr-r); }
        .c-e { top: 50%; right: 0; transform: translateY(-50%); }
        .c-s { bottom: 0; left: 50%; transform: translateX(-50%); }
        .c-w { top: 50%; left: 0; transform: translateY(-50%); }
        .needle-layer { position: absolute; inset: 0; pointer-events: none; }
        .ndl { position: absolute; top: 50%; left: 50%; transform-origin: bottom center; transition: opacity 0.3s; will-change: transform; }
        .n-main { width: 6px; height: 42%; margin-left: -3px; margin-top: -42%; background: linear-gradient(to top, transparent, var(--wr-p)); border-radius: 4px; z-index: 3; box-shadow: 0 -5px 15px var(--wr-p); }
        .n-sun { width: 2px; height: 48%; margin-left: -1px; margin-top: -48%; background: var(--wr-y); z-index: 2; opacity: 0.8; box-shadow: 0 0 8px var(--wr-y); }
        .n-true { width: 2px; height: 48%; background: var(--wr-b); margin-left: -1px; margin-top: -48%; opacity: 0.8; }
        .hud-val { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); text-align: center; pointer-events: none; }
        .h-deg { font-size: 2.5rem; font-weight: 800; letter-spacing: -1px; line-height: 1; }
        .h-lbl { font-size: 0.6rem; color: #666; letter-spacing: 2px; margin-top: 4px; }
        .deck { display: flex; flex-direction: column; gap: 10px; margin-top: auto; perspective: 1000px; }
        .info-card { padding: 20px; min-height: 120px; position: relative; overflow: hidden; }
        .info-card::before { content:''; position: absolute; top:0; left:0; bottom:0; width: 3px; background: var(--wr-p); }
        .ic-head { display: flex; justify-content: space-between; align-items: baseline; margin-bottom: 8px; }
        .ic-title { font-size: 1.1rem; font-weight: 700; color: #fff; }
        .ic-meta { font-size: 0.8rem; font-family: var(--font-mono); color: var(--wr-p); }
        .ic-body { font-size: 0.85rem; color: #aaa; line-height: 1.5; }
        .ic-quote { font-style: italic; color: #666; margin-top: 8px; font-size: 0.8rem; border-top: 1px solid rgba(255,255,255,0.1); padding-top: 6px; }
        .radar-box { position: absolute; bottom: -20px; right: -20px; width: 140px; height: 140px; display: none; }
        .radar-sweep { width: 100%; height: 100%; border-radius: 50%; border: 1px solid rgba(255,255,255,0.1); background: conic-gradient(from 0deg, transparent 0deg, rgba(217, 70, 239, 0.2) 60deg, transparent 60.1deg); animation: sweep 3s linear infinite; }
        .blip { position: absolute; width: 5px; height: 5px; background: #fff; border-radius: 50%; box-shadow: 0 0 8px var(--wr-r); opacity: 0; animation: blip 2s ease-out; }
        .btn-row { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 8px; margin-top: 5px; }
        .btn { background: rgba(255,255,255,0.05); border: 1px solid var(--glass-border); color: #aaa; padding: 12px; border-radius: 16px; font-size: 0.8rem; display: flex; align-items: center; justify-content: center; gap: 6px; cursor: pointer; touch-action: manipulation; }
        .btn:active { background: rgba(255,255,255,0.15); transform: scale(0.98); }
        .btn.active { border-color: var(--wr-p); color: #fff; background: rgba(217, 70, 239, 0.1); }
        .dock { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 6px; background: rgba(0,0,0,0.6); padding: 5px; border-radius: 24px; border: 1px solid var(--glass-border); }
        .dock-item { background: transparent; border: none; color: #666; padding: 10px; border-radius: 20px; font-size: 0.7rem; font-weight: 700; cursor: pointer; touch-action: manipulation; }
        .dock-item.active { background: rgba(255,255,255,0.1); color: #fff; }
        .modal-box { width: 100%; max-width: 400px; padding: 24px; max-height: 80vh; overflow-y: auto; }
        .m-title { font-size: 1.2rem; font-weight: 700; color: #fff; margin-bottom: 12px; }
        .warn-toast { position: absolute; bottom: 25%; left: 50%; transform: translateX(-50%); background: rgba(244, 63, 94, 0.2); border: 1px solid var(--wr-r); color: var(--wr-r); padding: 6px 12px; border-radius: 20px; font-size: 0.7rem; pointer-events: none; opacity: 0; transition: opacity 0.3s; }
        .warn-toast.show { opacity: 1; animation: pulse 1s infinite; }
        @keyframes pulse { 50% { opacity: 0.5; } }

        /* --- WIKI LORE STYLES --- */
        #btn-lore {
            display: none; /* Auto-toggled by JS */
            margin-top: 12px; width: 100%;
            background: rgba(217, 70, 239, 0.1); border: 1px solid rgba(217, 70, 239, 0.3);
            color: var(--wr-p); font-size: 0.75rem; font-weight: 700;
            padding: 10px 0; border-radius: 16px; cursor: pointer;
            text-transform: uppercase; letter-spacing: 1px;
            transition: 0.3s ease;
        }
        #btn-lore:active { background: var(--wr-p); color: #000; }
        
        /* Wiki Modal */
        .lore-container { text-align: left; padding-bottom: 20px; }
        .lore-thumb {
            width: 100%; height: 160px; object-fit: cover; border-radius: 12px;
            margin-bottom: 16px; border: 1px solid rgba(255,255,255,0.1);
            display: none; /* Hidden by default */
        }
        .lore-thumb.active { display: block; }
        .lore-hero { font-size: 1.3rem; font-weight: 800; color: #fff; margin-bottom: 4px; letter-spacing: -0.5px; }
        .lore-p { color: #ccc; font-size: 0.95rem; line-height: 1.6; white-space: pre-line; margin-bottom: 16px; }
        
        .wiki-src { 
            display: block; font-size: 0.75rem; color: #666; margin-top: 10px; 
            text-decoration: none; border-top: 1px solid rgba(255,255,255,0.1); padding-top: 10px;
        }
        .wiki-src span { color: var(--wr-b); text-decoration: underline; }

        .lore-close-btn {
            width: 100%; padding: 14px; border-radius: 20px;
            background: rgba(255,255,255,0.1); border: none; color: #fff;
            font-weight: 600; cursor: pointer; margin-top: 12px;
        }
        
        /* Spinner for Wiki */
        .wiki-loader {
            display: none; justify-content: center; align-items: center; padding: 40px;
        }
        .wiki-loader.show { display: flex; }
        .wl-spin {
            width: 24px; height: 24px; border: 2px solid rgba(255,255,255,0.1);
            border-top-color: var(--wr-p); border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        /* --- STARS MODE PANEL --- */
        #stars-panel { display: none; } /* Default hidden, shown in Star mode */
        .star-monitor {
            width: 100%; height: 120px; background: rgba(0,0,0,0.3);
            border-radius: 12px; margin-bottom: 12px; position: relative;
            border: 1px solid rgba(255,255,255,0.05); display: flex; 
            align-items: center; justify-content: center; overflow: hidden;
        }
        .star-canvas { width: 100%; height: 100%; }
        .star-badge {
            font-size: 0.65rem; background: rgba(255,255,255,0.1); 
            padding: 4px 8px; border-radius: 4px; color: #aaa;
            display: inline-block; margin-top: 6px;
        }
        .star-badge.vis { color: var(--wr-g); border: 1px solid rgba(52, 211, 153, 0.3); }
        .star-badge.invis { color: var(--wr-r); border: 1px solid rgba(244, 63, 94, 0.3); }

        /* --- AI SCANNER UI PATCH --- */
        .ai-blink { animation: ai-blink 1.5s infinite; color: var(--wr-b); font-weight: 700; letter-spacing: 1px; }
        @keyframes ai-blink { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
        .ai-text { font-family: var(--font-mono); font-size: 0.75rem; color: var(--wr-p); text-transform: uppercase; margin-bottom: 6px; }

    </style>
</head>
<body>

    <div class="bg-orb orb-1"></div>
    <div class="bg-orb orb-2"></div>
    <div class="scanlines"></div>

    <!-- A) MINIMAL STARTUP OVERLAY -->
    <div id="overlay">
        <div class="brand-core">
            <div class="loader-ring"></div>
            <div class="hero-w">W</div>
        </div>
        
        <div id="tap-hint" data-t="tap_start">TAP TO START</div>

        <div class="sys-hidden">
            <span id="chk-gps"></span>
            <span id="chk-gyro"></span>
            <span id="chk-mag"></span>
        </div>

        <button id="btn-init"></button>
    </div>

    <!-- B) ONBOARDING MODAL -->
    <div id="modal-onboard" class="modal-wrap">
        <div class="glass-modal">
            <span class="ob-icon">ðŸ§­</span>
            <div class="ob-title" data-t="ob_title">Wind Rose</div>
            <div class="ob-body" data-t="ob_body">Loading...</div>
            <div class="ob-note" data-t="ob_note">...</div>
            <button class="btn-action" onclick="app.finishOnboarding()" data-t="ob_btn">Let's Go</button>
        </div>
    </div>

    <!-- MAIN HUD -->
    <div id="app">
        <div class="header">
            <div class="brand" id="sys-brand">WR // AI-SCANNER</div>
            <div class="flex-row">
                <div class="badge" onclick="app.toggleLang()" style="cursor:pointer" id="lbl-lang">EN</div>
                <div class="badge" id="gps-badge">GPS WAIT</div>
                <div style="cursor:pointer; opacity:0.7" onclick="app.toggleSettings()">âš™</div>
            </div>
        </div>

        <div class="stage">
            <div class="orb-ring" id="ring">
                <div class="ticks"></div>
                <div class="cardinals">
                    <div class="card c-n">N</div><div class="card c-e">E</div>
                    <div class="card c-s">S</div><div class="card c-w">W</div>
                </div>
                <div class="needle-layer">
                    <div class="ndl n-main" id="n-main"></div>
                    <div class="ndl n-sun" id="n-sun"></div>
                    <div class="ndl n-true" id="n-true"></div>
                </div>
                <div class="hud-val">
                    <div class="h-deg" id="val-head">000Â°</div>
                    <div class="h-lbl" id="lbl-sub">HEADING</div>
                </div>
            </div>
            <div class="warn-toast" id="warn-ui">CALIBRATE</div>
            <div class="radar-box" id="radar-ui"><div class="radar-sweep"></div></div>
        </div>

        <div class="deck">
            <!-- WONDER/GEO CARD -->
            <div class="glass-panel info-card" id="main-card">
                <div class="ic-head">
                    <div class="ic-title" id="c-title">SYSTEM READY</div>
                    <div class="ic-meta" id="c-dist">--</div>
                </div>
                <div class="ic-body">
                    <div id="c-body">Initialize AI Scanning...</div>
                    <ul class="c-facts" id="c-facts"></ul>
                    <div class="ic-quote" id="c-quote"></div>
                    <button id="btn-lore" onclick="app.openLore()" data-t="btn_read_lore">ðŸ“œ READ LEGEND</button>
                </div>
            </div>

            <!-- STARS CARD -->
            <div class="glass-panel info-card" id="stars-panel">
                <div class="ic-head">
                    <div class="ic-title" id="s-title">Orion</div>
                    <div class="ic-meta" id="s-azalt">AZ 000 | ALT 00</div>
                </div>
                <div class="star-monitor" id="star-monitor">
                    <canvas id="star-canvas" width="280" height="120"></canvas>
                </div>
                <div style="display:flex; justify-content:space-between; align-items:center;">
                    <div class="star-badge" id="s-vis">VISIBLE</div>
                    <button class="btn" style="padding:6px 12px; font-size:0.7rem;" onclick="app.nextStar()">NEXT &rarr;</button>
                </div>
                <button id="btn-star-lore" style="margin-top:12px; width:100%; background:rgba(96,165,250,0.1); border:1px solid rgba(96,165,250,0.3); color:var(--wr-b); border-radius:16px; padding:10px; cursor:pointer;" onclick="app.openStarLore()">âœ¨ STAR LORE</button>
            </div>

            <div class="btn-row" id="ctrls">
                <button class="btn active" id="btn-auto" onclick="app.toggleAuto()"><span>âŸ³</span> <span id="txt-auto">Auto</span></button>
                <button class="btn" onclick="app.nextTarget()"><span>â†’</span> <span id="txt-next">Next</span></button>
                <button class="btn" onclick="app.openMap()"><span>â†—</span> <span id="txt-map">Map</span></button>
            </div>

            <div class="dock">
                <button class="dock-item active" onclick="app.setMode('disc')" id="m-disc">DISCOVERY</button>
                <button class="dock-item" onclick="app.setMode('geo')" id="m-geo">GEOMAG</button>
                <button class="dock-item" onclick="app.setMode('whis')" id="m-whis" data-t="m_stars">STARS</button>
            </div>
        </div>
    </div>

    <!-- OTHER MODALS -->
    <div id="modal-set" class="modal-wrap">
        <div class="glass-panel modal-box">
            <div class="m-title">SETTINGS</div>
            <button class="btn" style="width:100%; margin-bottom:10px;" onclick="app.resetView()">RESET VIEW</button>
            <button class="btn" style="width:100%; margin-top:20px; border-color:var(--wr-r); color:var(--wr-r)" onclick="app.toggleSettings()">CLOSE</button>
        </div>
    </div>

    <!-- WIKI LORE MODAL -->
    <div id="modal-lore" class="modal-wrap">
        <div class="glass-panel modal-box" style="max-width:450px;">
            <div class="wiki-loader" id="l-spin"><div class="wl-spin"></div></div>
            <div class="lore-container" id="l-content" style="display:none">
                <img id="l-thumb" class="lore-thumb" alt="Wiki Thumb">
                <div class="lore-hero" id="l-title">Title</div>
                <div class="lore-p" id="l-text">...</div>
                <a href="#" target="_blank" class="wiki-src" id="l-src">Source: Wikipedia <span>(Read Full)</span></a>
            </div>
            <button class="lore-close-btn" onclick="app.closeLore()" data-t="btn_close">CLOSE</button>
        </div>
    </div>

    <!-- HINT TOAST -->
    <div class="hint-toast" id="hint-toast">
        <span>ðŸ‘»</span> <span data-t="hint_myth">Tap Myth for legends</span>
    </div>

<script>
/**
 * WIND ROSE (WR) | MK-III + ANCIENT WONDERS TRACKER
 */

/* --- 0. GESTURE CONTROL --- */
document.addEventListener('gesturestart', e => e.preventDefault());
let lastTouch = 0;
document.addEventListener('touchend', e => {
    const now = Date.now(); if (now - lastTouch <= 300) e.preventDefault(); lastTouch = now;
}, {passive: false});
document.body.addEventListener('touchmove', e => { if(e.scale !== 1) e.preventDefault(); }, {passive: false});

/* --- 1. I18N DICTIONARY --- */
const DICT = {
    en: {
        gps_wait:"GPS WAIT", gps_lock:"GPS LOCK",
        m_disc:"DISCOVERY", m_geo:"GEOMAG", m_stars:"STARS",
        t_auto:"Auto", t_man:"Manual", t_next:"Next", t_map:"Map",
        lore_load:"AI: Decrypting Data...",
        lbl_head:"HEADING", lbl_var:"VARIANCE",
        warn_cal:"CALIBRATE 8", warn_tilt:"HOLD FLAT",
        sun_track:"Sun Tracker Active",
        err_mag:"Mag Sensor Offline",
        star_track: "STAR COMPASS", star_sub: "TRACKING CONSTELLATIONS",
        star_vis: "VISIBLE", star_hid: "BELOW HORIZON",
        read_btn:"Tap to Read Legend",
        tap_start: "Tap to Start",
        ob_title: "Wind Rose â€” AI Compass",
        ob_body: "AI-Powered Compass.\nTracks the Seven Ancient Wonders.\nAlso tracks Stars & Magnetic North.",
        ob_note: "Move gently. Requires GPS.",
        ob_btn: "Initialize",
        hint_myth: "Tap 'STARS' to track constellations",
        btn_read_lore: "ðŸ“œ READ LORE",
        btn_close: "CLOSE",
        wiki_offline_lbl: "Offline Database",
        ai_scan: "AI SYSTEM: ANALYZING GEODATA...",
        ai_conn_lost: "CONNECTION LOST. SWITCHING TO OFFLINE DB.",
        ai_fetch: "AI: SCANNING SECTOR..."
    },
    th: {
        gps_wait:"à¸£à¸­ GPS...", gps_lock:"GPS à¸žà¸£à¹‰à¸­à¸¡",
        m_disc:"à¸„à¹‰à¸™à¸žà¸š", m_geo:"à¹à¸¡à¹ˆà¹€à¸«à¸¥à¹‡à¸", m_stars:"à¸”à¸§à¸‡à¸”à¸²à¸§",
        t_auto:"à¸­à¸­à¹‚à¸•à¹‰", t_man:"à¸—à¸³à¹€à¸­à¸‡", t_next:"à¸–à¸±à¸”à¹„à¸›", t_map:"à¹à¸œà¸™à¸—à¸µà¹ˆ",
        lore_load:"AI: à¸à¸³à¸¥à¸±à¸‡à¸–à¸­à¸”à¸£à¸«à¸±à¸ªà¸‚à¹‰à¸­à¸¡à¸¹à¸¥...",
        lbl_head:"à¸—à¸´à¸¨à¸«à¸±à¸§à¹€à¸„à¸£à¸·à¹ˆà¸­à¸‡", lbl_var:"à¸„à¸§à¸²à¸¡à¸œà¸±à¸™à¸œà¸§à¸™",
        warn_cal:"à¸«à¸¡à¸¸à¸™à¹€à¸¥à¸‚ 8", warn_tilt:"à¸§à¸²à¸‡à¹€à¸„à¸£à¸·à¹ˆà¸­à¸‡à¸£à¸²à¸š",
        sun_track:"à¸•à¸´à¸”à¸•à¸²à¸¡à¸”à¸§à¸‡à¸­à¸²à¸—à¸´à¸•à¸¢à¹Œ",
        err_mag:"à¹„à¸¡à¹ˆà¸žà¸šà¹€à¸‹à¸™à¹€à¸‹à¸­à¸£à¹Œ",
        star_track: "à¹€à¸‚à¹‡à¸¡à¸—à¸´à¸¨à¸”à¸§à¸‡à¸”à¸²à¸§", star_sub: "à¸•à¸´à¸”à¸•à¸²à¸¡à¸«à¸¡à¸¹à¹ˆà¸”à¸²à¸§",
        star_vis: "à¸¡à¸­à¸‡à¹€à¸«à¹‡à¸™à¹„à¸”à¹‰", star_hid: "à¹ƒà¸•à¹‰à¸‚à¸­à¸šà¸Ÿà¹‰à¸²",
        read_btn:"à¸­à¹ˆà¸²à¸™à¸•à¸³à¸™à¸²à¸™",
        tap_start: "à¹à¸•à¸°à¹€à¸žà¸·à¹ˆà¸­à¹€à¸£à¸´à¹ˆà¸¡",
        ob_title: "Wind Rose â€” à¹€à¸‚à¹‡à¸¡à¸—à¸´à¸¨ AI",
        ob_body: "à¹€à¸‚à¹‡à¸¡à¸—à¸´à¸¨à¸­à¸±à¸ˆà¸‰à¸£à¸´à¸¢à¸°\nà¸•à¸´à¸”à¸•à¸²à¸¡ 7 à¸ªà¸´à¹ˆà¸‡à¸¡à¸«à¸±à¸¨à¸ˆà¸£à¸£à¸¢à¹Œà¸¢à¸¸à¸„à¹‚à¸šà¸£à¸²à¸“\nà¸žà¸£à¹‰à¸­à¸¡à¹‚à¸«à¸¡à¸”à¸”à¸¹à¸”à¸²à¸§à¹à¸¥à¸°à¹à¸¡à¹ˆà¹€à¸«à¸¥à¹‡à¸à¹‚à¸¥à¸",
        ob_note: "à¹€à¸„à¸¥à¸·à¹ˆà¸­à¸™à¹„à¸«à¸§à¸Šà¹‰à¸²à¹† à¸•à¹‰à¸­à¸‡à¹ƒà¸Šà¹‰ GPS",
        ob_btn: "à¹€à¸£à¸´à¹ˆà¸¡à¸£à¸°à¸šà¸š",
        hint_myth: "à¹à¸•à¸° 'à¸”à¸§à¸‡à¸”à¸²à¸§' à¹€à¸žà¸·à¹ˆà¸­à¸”à¸¹à¸•à¸³à¹à¸«à¸™à¹ˆà¸‡à¸”à¸²à¸§",
        btn_read_lore: "ðŸ“œ à¸­à¹ˆà¸²à¸™à¹€à¸£à¸·à¹ˆà¸­à¸‡à¹€à¸¥à¹ˆà¸²",
        btn_close: "à¸›à¸´à¸”",
        wiki_offline_lbl: "à¸à¸²à¸™à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸­à¸­à¸Ÿà¹„à¸¥à¸™à¹Œ",
        ai_scan: "à¸£à¸°à¸šà¸š AI: à¸à¸³à¸¥à¸±à¸‡à¸§à¸´à¹€à¸„à¸£à¸²à¸°à¸«à¹Œà¸ à¸¹à¸¡à¸´à¸¨à¸²à¸ªà¸•à¸£à¹Œ...",
        ai_conn_lost: "à¸ªà¸±à¸à¸à¸²à¸“à¸‚à¸²à¸”à¸«à¸²à¸¢ à¹ƒà¸Šà¹‰à¸‡à¸²à¸™à¸à¸²à¸™à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸ªà¸³à¸£à¸­à¸‡",
        ai_fetch: "AI: à¸à¸³à¸¥à¸±à¸‡à¸ªà¹à¸à¸™à¸žà¸·à¹‰à¸™à¸—à¸µà¹ˆ..."
    }
};

class I18n {
    constructor() {
        this.lang = localStorage.getItem('WR_LANG') || 'en';
    }
    t(key) {
        return (DICT[this.lang] && DICT[this.lang][key]) || key;
    }
    apply() {
        document.querySelectorAll('[data-t]').forEach(el => {
            const k = el.getAttribute('data-t');
            const val = this.t(k);
            if (val) el.innerText = val;
        });
        const lbl = document.getElementById('lbl-lang');
        if (lbl) lbl.innerText = this.lang.toUpperCase();
        const gps = document.getElementById('gps-badge');
        if (gps) gps.innerText = this.t('gps_wait');
    }
    toggle() {
        this.lang = this.lang === 'en' ? 'th' : 'en';
        localStorage.setItem('WR_LANG', this.lang);
    }
}

/* --- 2. DATA (ANCIENT WONDERS & STARS) --- */
const OFFLINE_WONDERS = [
    {n:"Great Pyramid of Giza", lat:29.9792, lon:31.1342, desc:"The oldest of the Ancient Wonders, built as a tomb for Pharaoh Khufu."},
    {n:"Hanging Gardens of Babylon", lat:32.5355, lon:44.4275, desc:"A tiered garden engineering marvel, likely built by Nebuchadnezzar II."},
    {n:"Temple of Artemis at Ephesus", lat:37.9496, lon:27.3639, desc:"A grand Greek temple dedicated to the goddess Artemis, destroyed by arson."},
    {n:"Statue of Zeus at Olympia", lat:37.6378, lon:21.6300, desc:"A giant seated figure made of ivory and gold by the sculptor Phidias."},
    {n:"Mausoleum at Halicarnassus", lat:37.0379, lon:27.4241, desc:"A tomb built for Mausolus, blending Greek, Egyptian, and Lycian styles."},
    {n:"Colossus of Rhodes", lat:36.4510, lon:28.2258, desc:"A massive bronze statue of the sun god Helios standing over the harbor."},
    {n:"Lighthouse of Alexandria", lat:31.2139, lon:29.8856, desc:"A towering lighthouse on the island of Pharos, estimating over 100m tall."}
];

const WIKI_SLUGS = {
    "Great Pyramid of Giza": { en: "Great_Pyramid_of_Giza", th: "à¸¡à¸«à¸²à¸žà¸µà¸£à¸°à¸¡à¸´à¸”à¹à¸«à¹ˆà¸‡à¸à¸´à¸‹à¹ˆà¸²" },
    "Hanging Gardens of Babylon": { en: "Hanging_Gardens_of_Babylon", th: "à¸ªà¸§à¸™à¸¥à¸­à¸¢à¸šà¸²à¸šà¸´à¹‚à¸¥à¸™" },
    "Temple of Artemis at Ephesus": { en: "Temple_of_Artemis", th: "à¸§à¸´à¸«à¸²à¸£à¸­à¸²à¸£à¹Œà¸—à¸´à¸¡à¸´à¸ª" },
    "Statue of Zeus at Olympia": { en: "Statue_of_Zeus_at_Olympia", th: "à¹€à¸—à¸§à¸£à¸¹à¸›à¸‹à¸¹à¸ªà¸—à¸µà¹ˆà¹‚à¸­à¸¥à¸´à¸¡à¹€à¸›à¸µà¸¢" },
    "Mausoleum at Halicarnassus": { en: "Mausoleum_at_Halicarnassus", th: "à¸ªà¸¸à¸ªà¸²à¸™à¸¡à¸­à¸ªà¹‚à¸‹à¸¥à¸±à¸ª" },
    "Colossus of Rhodes": { en: "Colossus_of_Rhodes", th: "à¹€à¸—à¸§à¸£à¸¹à¸›à¹‚à¸„à¹‚à¸¥à¸ªà¸‹à¸±à¸ª" },
    "Lighthouse of Alexandria": { en: "Lighthouse_of_Alexandria", th: "à¸›à¸£à¸°à¸ à¸²à¸„à¸²à¸£à¸Ÿà¸²à¹‚à¸£à¸ªà¹à¸«à¹ˆà¸‡à¸­à¸°à¹€à¸¥à¹‡à¸à¸‹à¸²à¸™à¹€à¸”à¸£à¸µà¸¢" }
};

const STARS_DB = [
    { id: "orion", en: "Orion", th: "à¸à¸¥à¸¸à¹ˆà¸¡à¸”à¸²à¸§à¸™à¸²à¸¢à¸žà¸£à¸²à¸™", ra: 5.58, dec: 5.0, slug_en: "Orion_(constellation)", slug_th: "à¸à¸¥à¸¸à¹ˆà¸¡à¸”à¸²à¸§à¸™à¸²à¸¢à¸žà¸£à¸²à¸™", shape: [[0.2,0.2,0.4,0.4], [0.4,0.4,0.5,0.5], [0.5,0.5,0.6,0.6], [0.6,0.6,0.8,0.2], [0.2,0.8,0.4,0.6], [0.4,0.6,0.5,0.5], [0.5,0.5,0.6,0.4], [0.6,0.4,0.8,0.8], [0.45,0.45,0.55,0.55]] },
    { id: "ursa_major", en: "Ursa Major", th: "à¸à¸¥à¸¸à¹ˆà¸¡à¸”à¸²à¸§à¸«à¸¡à¸µà¹ƒà¸«à¸à¹ˆ", ra: 11.0, dec: 50.0, slug_en: "Ursa_Major", slug_th: "à¸à¸¥à¸¸à¹ˆà¸¡à¸”à¸²à¸§à¸«à¸¡à¸µà¹ƒà¸«à¸à¹ˆ", shape: [[0.1,0.3,0.3,0.3], [0.3,0.3,0.4,0.5], [0.4,0.5,0.6,0.6], [0.6,0.6,0.5,0.4], [0.5,0.4,0.3,0.3], [0.6,0.6,0.8,0.5], [0.8,0.5,0.9,0.7]] },
    { id: "cassiopeia", en: "Cassiopeia", th: "à¸à¸¥à¸¸à¹ˆà¸¡à¸”à¸²à¸§à¹à¸„à¸ªà¸‹à¸´à¹‚à¸­à¹€à¸›à¸µà¸¢", ra: 1.0, dec: 60.0, slug_en: "Cassiopeia_(constellation)", slug_th: "à¸à¸¥à¸¸à¹ˆà¸¡à¸”à¸²à¸§à¹à¸„à¸ªà¸‹à¸´à¹‚à¸­à¹€à¸›à¸µà¸¢", shape: [[0.1,0.2,0.3,0.8], [0.3,0.8,0.5,0.4], [0.5,0.4,0.7,0.7], [0.7,0.7,0.9,0.3]] },
    { id: "scorpius", en: "Scorpius", th: "à¸à¸¥à¸¸à¹ˆà¸¡à¸”à¸²à¸§à¹à¸¡à¸‡à¸›à¹ˆà¸­à¸‡", ra: 16.5, dec: -26.0, slug_en: "Scorpius", slug_th: "à¸à¸¥à¸¸à¹ˆà¸¡à¸”à¸²à¸§à¹à¸¡à¸‡à¸›à¹ˆà¸­à¸‡", shape: [[0.8,0.1,0.7,0.2], [0.7,0.2,0.6,0.3], [0.6,0.3,0.5,0.5], [0.5,0.5,0.4,0.7], [0.4,0.7,0.3,0.8], [0.3,0.8,0.2,0.7], [0.2,0.7,0.3,0.6]] },
    { id: "crux", en: "Crux", th: "à¸à¸¥à¸¸à¹ˆà¸¡à¸”à¸²à¸§à¸à¸²à¸‡à¹€à¸‚à¸™à¹ƒà¸•à¹‰", ra: 12.5, dec: -60.0, slug_en: "Crux", slug_th: "à¸à¸¥à¸¸à¹ˆà¸¡à¸”à¸²à¸§à¸à¸²à¸‡à¹€à¸‚à¸™à¹ƒà¸•à¹‰", shape: [[0.5,0.1,0.5,0.9], [0.2,0.4,0.8,0.5]] },
    { id: "pleiades", en: "Pleiades", th: "à¸à¸£à¸°à¸ˆà¸¸à¸à¸”à¸²à¸§à¸¥à¸¹à¸à¹„à¸à¹ˆ", ra: 3.8, dec: 24.0, slug_en: "Pleiades", slug_th: "à¸à¸£à¸°à¸ˆà¸¸à¸à¸”à¸²à¸§à¸¥à¸¹à¸à¹„à¸à¹ˆ", shape: [[0.3,0.4,0.4,0.3], [0.4,0.3,0.5,0.4], [0.5,0.4,0.4,0.5], [0.4,0.5,0.3,0.4], [0.5,0.4,0.7,0.5], [0.7,0.5,0.8,0.4]] }
];

/* --- 3. ASTRONOMY & MATH --- */
const Astro = {
    rad: d => d * Math.PI / 180,
    deg: r => r * 180 / Math.PI,
    lst: (lon) => {
        const now = new Date();
        const d = (now.getTime() - 946728000000) / 86400000; 
        const gmst = 18.697374558 + 24.06570982441908 * d;
        return (gmst + lon/15 + 2400) % 24;
    },
    calcPos: (lat, lon, ra, dec) => {
        const lst = Astro.lst(lon);
        const ha = (lst - ra) * 15; 
        const latR = Astro.rad(lat), decR = Astro.rad(dec), haR = Astro.rad(ha);
        const sinAlt = Math.sin(latR)*Math.sin(decR) + Math.cos(latR)*Math.cos(decR)*Math.cos(haR);
        const alt = Math.asin(sinAlt);
        const cosAz = (Math.sin(decR) - Math.sin(latR)*Math.sin(alt)) / (Math.cos(latR)*Math.cos(alt));
        let az = Astro.deg(Math.acos(cosAz));
        if (Math.sin(haR) > 0) az = 360 - az;
        return { az: az, alt: Astro.deg(alt) };
    }
};

const MathU = {
    rad: d => d * Math.PI / 180,
    deg: r => r * 180 / Math.PI,
    bearing: (lat1,l1,lat2,l2) => {
        const y=Math.sin(MathU.rad(l2-l1))*Math.cos(MathU.rad(lat2));
        const x=Math.cos(MathU.rad(lat1))*Math.sin(MathU.rad(lat2))-Math.sin(MathU.rad(lat1))*Math.cos(MathU.rad(lat2))*Math.cos(MathU.rad(l2-l1));
        return (MathU.deg(Math.atan2(y,x))+360)%360;
    },
    lerp: (c,t,f) => { let d=t-c; if(d>180)d-=360; if(d<-180)d+=360; return c+d*f; },
    dist: (lat1,l1,lat2,l2) => {
        const R=6371, dLa=MathU.rad(lat2-lat1), dLo=MathU.rad(l2-l1);
        const a=Math.sin(dLa/2)**2+Math.cos(MathU.rad(lat1))*Math.cos(MathU.rad(lat2))*Math.sin(dLo/2)**2;
        return R*2*Math.atan2(Math.sqrt(a),Math.sqrt(1-a));
    }
};

class Sensor {
    constructor() { this.head=0; this.raw=0; this.gps=null; this.tiltBad=false; this.cbs={}; }
    init() {
        return new Promise((resolve, reject) => {
            const timeout = setTimeout(() => {
                console.warn("Sensor init timed out, forcing start.");
                resolve();
            }, 2000);

            if(navigator.geolocation) {
                navigator.geolocation.watchPosition(
                    p => { this.gps=p.coords; this.emit('gps'); }, 
                    e => { console.log("GPS Error", e); }, 
                    {enableHighAccuracy:true}
                );
            }

            if (typeof DeviceOrientationEvent !== 'undefined' && typeof DeviceOrientationEvent.requestPermission === 'function') {
                DeviceOrientationEvent.requestPermission()
                    .then(response => {
                        if (response === 'granted') {
                            window.addEventListener('deviceorientation', e => this.iOS(e));
                        }
                        clearTimeout(timeout);
                        resolve();
                    })
                    .catch(console.error);
            } else {
                try {
                    const h = e => this.droid(e, e.absolute);
                    if ('ondeviceorientationabsolute' in window) {
                        window.addEventListener('deviceorientationabsolute', e => h(e, true));
                    } else {
                        window.addEventListener('deviceorientation', e => h(e, false));
                    }
                } catch (e) { console.error(e); }
                clearTimeout(timeout);
                resolve();
            }
        });
    }
    iOS(e) { if(e.webkitCompassHeading) { this.raw=(e.webkitCompassHeading+(window.screen.orientation?.angle||0))%360; this.tiltBad=Math.abs(e.beta)>50; } }
    droid(e, abs) { if(e.alpha!=null) { this.raw=(abs ? 360-e.alpha : 360-e.alpha)%360; this.tiltBad=Math.abs(e.beta)>50; } }
    update() { this.head = MathU.lerp(this.head, this.raw, 0.1); return this.head; }
    emit(e){if(this.cbs[e])this.cbs[e]();} on(e,f){this.cbs[e]=f;}
}

class App {
    constructor() {
        this.i18n = new I18n(); this.sensor = new Sensor();
        this.state = { idx:0, auto:true, heading:0, mode:'disc', starIdx:0, wondersList: OFFLINE_WONDERS, useOffline: true };
        this.els = {
            ring: document.getElementById('ring'), val: document.getElementById('val-head'),
            nMain: document.getElementById('n-main'), nSun: document.getElementById('n-sun'),
            radar: document.getElementById('radar-ui'), 
            mainCard: document.getElementById('main-card'),
            starsPanel: document.getElementById('stars-panel'),
            starCanvas: document.getElementById('star-canvas'),
            btnLore: document.getElementById('btn-lore')
        };
        this.i18n.apply();
        document.getElementById('btn-init').addEventListener('click', () => this.start());
    }

    async start() {
        try {
            document.getElementById('tap-hint').style.opacity = 0;
            await this.sensor.init();
            this.transitionToHUD();
            this.sensor.on('gps', () => {
                document.getElementById('gps-badge').innerText = this.i18n.t('gps_lock');
                document.getElementById('gps-badge').classList.add('active');
                if(this.state.auto && this.state.mode === 'disc') this.fetchGeo();
            });
            this.loop();
        } catch(e) { 
            console.error(e);
            alert("Sensors blocked, but starting anyway.");
            this.transitionToHUD(); 
        }
    }

    transitionToHUD() {
        const ov = document.getElementById('overlay');
        ov.classList.add('fade-out');
        setTimeout(() => {
            ov.style.display = 'none';
            document.getElementById('app').classList.add('visible');
            document.body.classList.add('active'); 
            this.checkFirstRun();
        }, 1000);
    }

    checkFirstRun() {
        if (!localStorage.getItem('WR_FIRST_RUN_DONE')) {
            setTimeout(() => { document.getElementById('modal-onboard').classList.add('show'); }, 500);
        }
    }

    finishOnboarding() {
        localStorage.setItem('WR_FIRST_RUN_DONE', 'true');
        document.getElementById('modal-onboard').classList.remove('show');
        setTimeout(() => { document.getElementById('hint-toast').classList.add('show'); setTimeout(()=>document.getElementById('hint-toast').classList.remove('show'),4000); }, 1000);
    }

    loop() {
        requestAnimationFrame(() => this.loop());
        const h = this.sensor.update();
        this.state.heading = h;
        this.els.ring.style.transform = `rotate(${-h}deg)`;
        this.els.val.innerText = Math.round(h).toString().padStart(3,'0') + "Â°";
        
        if(this.state.mode === 'disc' && this.sensor.gps && this.state.wondersList.length > 0) {
            const w = this.state.wondersList[this.state.idx];
            if(w) {
                const b = MathU.bearing(this.sensor.gps.latitude, this.sensor.gps.longitude, w.lat, w.lon);
                this.els.nMain.style.transform = `translateX(-50%) rotate(${b}deg)`;
            }
        } else if (this.state.mode === 'geo') {
            const now = new Date();
            const az = (now.getHours()-12)*15 + 180; 
            this.els.nSun.style.transform = `translateX(-50%) rotate(${az}deg)`;
        } else if (this.state.mode === 'whis' && this.sensor.gps) {
            const star = STARS_DB[this.state.starIdx];
            const pos = Astro.calcPos(this.sensor.gps.latitude, this.sensor.gps.longitude, star.ra, star.dec);
            this.els.nMain.style.transform = `translateX(-50%) rotate(${pos.az}deg)`;
            document.getElementById('s-azalt').innerText = `AZ ${Math.round(pos.az)}Â° | ALT ${Math.round(pos.alt)}Â°`;
            const badge = document.getElementById('s-vis');
            if(pos.alt > 0) { badge.innerText = this.i18n.t('star_vis'); badge.className = 'star-badge vis'; }
            else { badge.innerText = this.i18n.t('star_hid'); badge.className = 'star-badge invis'; }
        }
    }

    fetchGeo() {
        // Switch to Seven Wonders static list (Always "offline" mode logic)
        this.state.wondersList = OFFLINE_WONDERS;
        this.state.useOffline = true;

        if(!this.sensor.gps) {
            this.state.idx = 0;
            this.updCard();
            return;
        }

        const lat = this.sensor.gps.latitude;
        const lon = this.sensor.gps.longitude;
        let min = Infinity;
        let bestIdx = 0;

        // Find nearest Wonder
        this.state.wondersList.forEach((w, i) => {
            const d = MathU.dist(lat, lon, w.lat, w.lon);
            if(d < min) {
                min = d;
                bestIdx = i;
            }
        });

        this.state.idx = bestIdx;
        this.updCard();
    }
    
    updCard() {
        if(this.state.wondersList.length === 0) return;
        const w = this.state.wondersList[this.state.idx];
        
        document.getElementById('c-title').innerText = w.n;
        document.getElementById('c-body').innerText = w.desc;
        document.getElementById('c-quote').innerText = this.i18n.t('ai_scan'); 
        
        document.getElementById('c-facts').innerHTML = `<li>LAT: ${w.lat.toFixed(4)}</li><li>LON: ${w.lon.toFixed(4)}</li>`;
        document.getElementById('c-title').classList.remove('ai-blink');

        this.els.btnLore.style.display = this.state.mode === 'disc' ? 'block' : 'none';

        if(this.sensor.gps) {
            const d = MathU.dist(this.sensor.gps.latitude,this.sensor.gps.longitude,w.lat,w.lon);
            const brg = MathU.bearing(this.sensor.gps.latitude, this.sensor.gps.longitude, w.lat, w.lon);
            document.getElementById('c-dist').innerText = (d<1?(d*1000).toFixed(0)+"m":d.toFixed(1)+"km") + " | " + brg.toFixed(0) + "Â°";
        }
    }

    renderStatus(msg, blink) {
        document.getElementById('c-title').innerText = "SCANNING...";
        if(blink) document.getElementById('c-title').classList.add('ai-blink');
        document.getElementById('c-body').innerText = msg;
    }

    updateStarUI() {
        const star = STARS_DB[this.state.starIdx];
        document.getElementById('s-title').innerText = this.i18n.lang === 'th' ? star.th : star.en;
        this.drawStarShape(star.shape);
    }

    drawStarShape(lines) {
        const ctx = this.els.starCanvas.getContext('2d');
        const w = this.els.starCanvas.width;
        const h = this.els.starCanvas.height;
        ctx.clearRect(0,0,w,h);
        ctx.strokeStyle = '#60a5fa';
        ctx.fillStyle = '#fff';
        ctx.lineWidth = 2;
        ctx.beginPath();
        lines.forEach(l => {
            const x1 = l[0]*w, y1 = l[1]*h;
            const x2 = l[2]*w, y2 = l[3]*h;
            ctx.moveTo(x1, y1); ctx.lineTo(x2, y2);
            ctx.fillRect(x1-2, y1-2, 4, 4);
            ctx.fillRect(x2-2, y2-2, 4, 4);
        });
        ctx.stroke();
    }
    
    nextStar() {
        this.state.starIdx = (this.state.starIdx+1) % STARS_DB.length;
        this.updateStarUI();
    }

    toggleLang() { 
        this.i18n.toggle(); 
        this.i18n.apply(); 
        if(this.state.mode === 'disc') this.fetchGeo(); 
        if(this.state.mode === 'whis') this.updateStarUI();
    }

    setMode(m) {
        this.state.mode = m;
        document.querySelectorAll('.dock-item').forEach(b => b.classList.remove('active'));
        document.getElementById('m-'+m).classList.add('active');
        this.els.nMain.style.display = m=='geo'?'none':'block';
        this.els.nSun.style.display = m=='geo'?'block':'none';
        
        if(m === 'whis') {
            this.els.mainCard.style.display = 'none';
            this.els.starsPanel.style.display = 'block';
            this.els.radar.style.display = 'none'; 
            document.getElementById('c-title').innerText = this.i18n.t('star_track');
            this.updateStarUI();
        } else {
            this.els.mainCard.style.display = 'block';
            this.els.starsPanel.style.display = 'none';
            this.els.radar.style.display = 'none';
            if(m=='disc') {
                 this.updCard();
            } else { 
                document.getElementById('c-title').innerText="GEOMAG"; 
                document.getElementById('c-body').innerText=this.i18n.t('sun_track'); 
                this.els.btnLore.style.display = 'none';
                document.getElementById('c-facts').innerHTML = "";
            }
        }
    }

    toggleAuto() { this.state.auto = !this.state.auto; if(this.state.auto && this.state.mode === 'disc') this.fetchGeo(); }
    
    nextTarget() { 
        this.state.auto = false; 
        this.state.idx = (this.state.idx+1) % this.state.wondersList.length; 
        this.updCard(); 
    }
    
    toggleSettings() { document.getElementById('modal-set').classList.toggle('show'); }
    resetView() { document.body.style.zoom=1.0; window.scrollTo(0,0); this.toggleSettings(); }
    
    openMap() { 
        const w = this.state.wondersList[this.state.idx]; 
        window.open(`https://maps.google.com/?q=${w.lat},${w.lon}`); 
    }

    openLore() { this.openWiki(false); }
    openStarLore() { this.openWiki(true); }
    
    closeLore() {
        document.getElementById('modal-lore').classList.remove('show');
    }

    async openWiki(isStar) {
        document.getElementById('modal-lore').classList.add('show');
        const lang = this.i18n.lang;
        let slug, title, fallback;

        if(isStar) {
            const star = STARS_DB[this.state.starIdx];
            slug = lang === 'th' ? star.slug_th : star.slug_en;
            title = lang === 'th' ? star.th : star.en;
            fallback = "Offline star data unavailable.";
        } else {
            // Wonders logic (Always treated as 'offline' / static list)
            const w = this.state.wondersList[this.state.idx];
            slug = WIKI_SLUGS[w.n] ? WIKI_SLUGS[w.n][lang] : null;
            title = w.n;
            fallback = w.desc;
        }
        
        if(slug) {
            const cacheKey = `WR_WIKI_${lang}_${slug}`;
            this.renderWiki(null, true); 

            const cached = localStorage.getItem(cacheKey);
            if(cached) {
                this.renderWiki(JSON.parse(cached), false);
            } else {
                const success = await this.doFetch(slug, lang, cacheKey, true);
                if(!success) this.renderFallback(title, fallback);
            }
        } else {
            this.renderFallback(title, fallback);
        }
    }

    async doFetch(slug, lang, cacheKey, render) {
        try {
            const url = `https://${lang}.wikipedia.org/api/rest_v1/page/summary/${slug}`;
            const res = await fetch(url);
            if (!res.ok) throw new Error('Wiki Fail');
            const data = await res.json();
            localStorage.setItem(cacheKey, JSON.stringify(data));
            if(render) this.renderWiki(data, false);
            return true;
        } catch { return false; }
    }

    renderWiki(data, loading) {
        const uiLoader = document.getElementById('l-spin');
        const uiContent = document.getElementById('l-content');
        if(loading) {
            uiLoader.classList.add('show');
            uiContent.style.display = 'none';
        } else {
            uiLoader.classList.remove('show');
            uiContent.style.display = 'block';
            document.getElementById('l-title').innerText = data.title;
            document.getElementById('l-text').innerText = data.extract;
            const uiThumb = document.getElementById('l-thumb');
            if(data.thumbnail && data.thumbnail.source) {
                uiThumb.src = data.thumbnail.source;
                uiThumb.classList.add('active');
            } else uiThumb.classList.remove('active');
            
            const uiSrc = document.getElementById('l-src');
            if(data.content_urls) {
                uiSrc.href = data.content_urls.desktop.page;
                uiSrc.innerHTML = `Source: Wikipedia (${this.i18n.lang.toUpperCase()})`;
            } else {
                 uiSrc.innerHTML = "";
            }
        }
    }

    renderFallback(title, text) {
        document.getElementById('l-spin').classList.remove('show');
        document.getElementById('l-content').style.display = 'block';
        document.getElementById('l-thumb').classList.remove('active');
        document.getElementById('l-title').innerText = title;
        document.getElementById('l-text').innerText = text || '';
        document.getElementById('l-src').innerHTML = `<i>${this.i18n.t('wiki_offline_lbl')}</i>`;
        document.getElementById('l-src').href = "#";
    }
}

const app = new App();

</script>
</body>
</html>
