<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>MAGIC COMPASS | OMNI-LORE</title>
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#050508">

    <style>
        /* ------------------------------------------------------------------
           THEME: ECHOMIND PURPLE NEON GLASS
           ------------------------------------------------------------------ */
        :root {
            --bg-dark: #050508;
            --bg-grad: linear-gradient(170deg, #0a0a12 0%, #1a103c 40%, #2d1b4e 100%);
            
            /* Glass Surface */
            --glass-surf: rgba(255, 255, 255, 0.05);
            --glass-border: rgba(255, 255, 255, 0.1);
            --glass-shine: rgba(255, 255, 255, 0.15);
            --blur-px: 20px;

            /* Neon Accents */
            --neon-p: #d946ef; /* Purple */
            --neon-b: #60a5fa; /* Blue */
            --neon-r: #f43f5e; /* Red/Rose */
            --neon-g: #34d399; /* Green/Teal */
            --text-main: #f8fafc;
            --text-muted: #94a3b8;

            --font-ui: -apple-system, BlinkMacSystemFont, "SF Pro Display", "Inter", sans-serif;
            --font-mono: "SF Mono", "Menlo", monospace;
            
            --safe-top: env(safe-area-inset-top, 20px);
            --safe-bot: env(safe-area-inset-bottom, 20px);
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; user-select: none; }
        
        body {
            margin: 0; padding: 0;
            background: var(--bg-dark); background-image: var(--bg-grad);
            color: var(--text-main); font-family: var(--font-ui);
            height: 100vh; width: 100vw; overflow: hidden;
            display: flex; flex-direction: column;
        }

        /* BACKGROUND FX */
        .orb-bg {
            position: absolute; border-radius: 50%; filter: blur(90px); opacity: 0.3; z-index: 0;
            animation: drift 15s infinite alternate ease-in-out;
        }
        .orb-1 { width: 300px; height: 300px; background: var(--neon-p); top: -10%; left: -20%; }
        .orb-2 { width: 250px; height: 250px; background: var(--neon-b); bottom: 10%; right: -10%; animation-delay: -5s; }
        @keyframes drift { 0% { transform: translate(0,0); } 100% { transform: translate(20px, 40px); } }

        /* UTILS */
        .hidden { display: none !important; }
        .flex-col { display: flex; flex-direction: column; }
        .flex-row { display: flex; align-items: center; }
        .glass-panel {
            background: var(--glass-surf);
            backdrop-filter: blur(var(--blur-px)); -webkit-backdrop-filter: blur(var(--blur-px));
            border: 1px solid var(--glass-border);
            border-radius: 24px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.3);
        }
        .text-glow { text-shadow: 0 0 12px rgba(217, 70, 239, 0.4); }
        .mono { font-family: var(--font-mono); }

        /* --- LAYOUT --- */
        #app {
            position: relative; z-index: 10; flex: 1;
            display: flex; flex-direction: column;
            padding: var(--safe-top) 16px calc(var(--safe-bot) + 10px) 16px;
            gap: 12px;
        }

        /* HEADER */
        .header { justify-content: space-between; height: 44px; padding: 0 4px; }
        .brand { font-weight: 700; font-size: 1.1rem; letter-spacing: 1px; color: var(--text-main); }
        .status-badge {
            font-size: 0.65rem; padding: 4px 10px; border-radius: 20px;
            background: rgba(0,0,0,0.2); border: 1px solid var(--glass-border);
            color: var(--text-muted); font-weight: 600; transition: all 0.3s;
        }
        .status-badge.active { border-color: var(--neon-g); color: var(--neon-g); box-shadow: 0 0 8px rgba(52, 211, 153, 0.2); }

        /* COMPASS CORE */
        .compass-core {
            flex: 1; display: flex; flex-direction: column;
            align-items: center; justify-content: center;
            position: relative; min-height: 260px;
        }
        
        .ring {
            width: 260px; height: 260px; border-radius: 50%;
            border: 1px solid var(--glass-border); position: relative;
            box-shadow: 0 0 50px rgba(139, 92, 246, 0.1);
            transition: transform 0.1s linear;
        }
        /* Ticks via gradient */
        .ring::before {
            content: ''; position: absolute; inset: 0; border-radius: 50%;
            background: conic-gradient(
                var(--glass-border) 0deg 1deg, transparent 1deg 89deg,
                var(--glass-border) 90deg 91deg, transparent 91deg 179deg,
                var(--glass-border) 180deg 181deg, transparent 181deg 269deg,
                var(--glass-border) 270deg 271deg, transparent 271deg 359deg
            );
        }

        .cardinal { position: absolute; font-weight: 700; font-size: 0.8rem; color: var(--text-muted); }
        .c-n { top: 8px; left: 50%; transform: translateX(-50%); color: var(--neon-p); }
        .c-e { right: 12px; top: 50%; transform: translateY(-50%); }
        .c-s { bottom: 8px; left: 50%; transform: translateX(-50%); }
        .c-w { left: 12px; top: 50%; transform: translateY(-50%); }

        /* NEEDLES */
        .needle-wrap { position: absolute; inset: 0; pointer-events: none; }
        .needle {
            position: absolute; top: 50%; left: 50%;
            transform-origin: bottom center; transition: transform 0.6s cubic-bezier(0.2, 0.8, 0.2, 1);
        }
        
        /* Wonder Needle */
        .n-target { 
            width: 4px; height: 42%; background: var(--neon-p); 
            margin-left: -2px; margin-top: -42%; border-radius: 2px;
            box-shadow: 0 0 15px var(--neon-p); z-index: 3;
        }
        /* North Needle */
        .n-true { width: 2px; height: 46%; background: var(--neon-b); margin-left: -1px; margin-top: -46%; opacity: 0.8; z-index: 2; }
        .n-mag { width: 0; height: 38%; border-left: 1px dashed var(--neon-r); margin-left: 0; margin-top: -38%; opacity: 0.6; z-index: 1; }

        /* CENTER DATA */
        .center-hud {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            text-align: center; pointer-events: none;
        }
        .heading-num { font-size: 2.2rem; font-weight: 800; line-height: 1; letter-spacing: -1px; }
        .heading-lbl { font-size: 0.6rem; color: var(--text-muted); letter-spacing: 2px; margin-top: 4px; }

        /* CONTENT DECK (LORE / OMEN) */
        .deck {
            display: flex; flex-direction: column; gap: 10px;
            transition: opacity 0.3s;
        }

        /* INFO CARD */
        .info-card { padding: 16px; position: relative; overflow: hidden; min-height: 140px; }
        .info-card::after { content: ''; position: absolute; top:0; left:0; width: 3px; height: 100%; background: var(--neon-p); }
        
        .target-head { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 8px; }
        .t-name { font-size: 1.3rem; font-weight: 700; line-height: 1.1; color: #fff; max-width: 80%; }
        .t-dist { font-size: 0.9rem; color: var(--neon-p); font-family: var(--font-mono); font-weight: 600; }
        
        .lore-box { font-size: 0.8rem; color: var(--text-muted); line-height: 1.5; margin-top: 8px; }
        .lore-facts { list-style: none; padding: 0; margin: 8px 0 0 0; font-size: 0.75rem; }
        .lore-facts li { display: flex; gap: 6px; margin-bottom: 4px; }
        .lore-facts li::before { content: '•'; color: var(--neon-b); }
        .lore-myth { margin-top: 10px; padding-top: 8px; border-top: 1px solid var(--glass-border); font-style: italic; color: var(--neon-p); font-size: 0.75rem; opacity: 0.9; }

        /* OMEN CARD (Myth Mode) */
        .omen-card { 
            padding: 16px; border: 1px solid rgba(244, 63, 94, 0.3); 
            background: rgba(244, 63, 94, 0.05);
            display: none; /* Hidden by default */
        }
        .omen-lvl { font-size: 0.7rem; color: var(--neon-r); letter-spacing: 1px; font-weight: 700; margin-bottom: 4px; }
        .omen-text { font-size: 0.9rem; color: #fff; font-family: var(--font-mono); line-height: 1.4; }
        .omen-disclaimer { font-size: 0.6rem; color: var(--text-muted); margin-top: 8px; opacity: 0.6; text-align: right; }

        /* CONTROLS */
        .controls-row { display: flex; gap: 8px; margin-top: 4px; }
        .c-pill {
            flex: 1; background: var(--glass-surf); border: 1px solid var(--glass-border);
            color: var(--text-muted); padding: 10px; border-radius: 16px;
            font-size: 0.75rem; display: flex; align-items: center; justify-content: center; gap: 6px;
            cursor: pointer; transition: background 0.2s;
        }
        .c-pill:active { background: var(--glass-shine); }
        .icon { font-size: 0.9rem; }

        /* MODE BAR */
        .mode-dock {
            display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 8px;
            background: rgba(0,0,0,0.3); padding: 4px; border-radius: 20px;
            border: 1px solid var(--glass-border);
        }
        .mode-btn {
            background: transparent; border: none; color: var(--text-muted);
            padding: 10px; border-radius: 16px; font-size: 0.75rem; font-weight: 600;
            cursor: pointer; transition: all 0.2s;
        }
        .mode-btn.active { background: var(--glass-border); color: #fff; box-shadow: 0 2px 8px rgba(0,0,0,0.2); }

        /* PERMISSION OVERLAY */
        #perm-wall {
            position: fixed; inset: 0; z-index: 100;
            background: rgba(5, 5, 8, 0.95); backdrop-filter: blur(10px);
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            text-align: center; padding: 30px;
        }
        .btn-start {
            background: var(--neon-p); color: #fff; border: none;
            padding: 16px 40px; border-radius: 30px; font-size: 1rem; font-weight: 700;
            box-shadow: 0 0 25px rgba(217, 70, 239, 0.5); margin-top: 20px;
            cursor: pointer;
        }

        /* SETTINGS MODAL */
        #modal {
            position: fixed; inset: 0; z-index: 50; background: rgba(0,0,0,0.8);
            backdrop-filter: blur(5px); padding: 20px; 
            display: flex; align-items: center; justify-content: center;
        }
        .modal-box { width: 100%; max-width: 360px; padding: 20px; position: relative; }
        .close-x { position: absolute; top: 15px; right: 15px; font-size: 1.2rem; cursor: pointer; }
        input { background: rgba(0,0,0,0.3); border: 1px solid var(--glass-border); color: #fff; padding: 8px; border-radius: 8px; width: 100%; margin-top: 5px; }

        /* GLITCH FX */
        .glitch-mode .heading-num { animation: glitch 0.3s infinite; text-shadow: 2px 0 var(--neon-r), -2px 0 var(--neon-b); }
        @keyframes glitch { 0% { transform: translate(0); } 20% { transform: translate(-1px, 1px); } 40% { transform: translate(1px, -1px); } 100% { transform: translate(0); } }

    </style>
</head>
<body>

    <div class="orb-bg orb-1"></div>
    <div class="orb-bg orb-2"></div>

    <!-- PERMISSION WALL -->
    <div id="perm-wall">
        <h1 class="text-glow" style="font-size: 1.8rem; margin-bottom: 10px;">MAGIC COMPASS<br><span style="font-size:0.8em; color:var(--neon-b)">AI LORE EDITION</span></h1>
        <p style="color: var(--text-muted); max-width: 280px; font-size: 0.9rem;">
            Requires Sensor Fusion (GPS + Compass) to enable Augmented Reality Navigation & Myth Engine.
        </p>
        <button class="btn-start" id="btn-init">INITIALIZE SYSTEM</button>
    </div>

    <!-- MAIN APP -->
    <div id="app" class="hidden">
        
        <!-- Header -->
        <div class="flex-row header">
            <div class="brand"><span style="color:var(--neon-p)">✦</span> OMNI</div>
            <div class="flex-row" style="gap:8px">
                <div class="status-badge" id="gps-badge">GPS WAIT</div>
                <div style="cursor:pointer; padding:4px;" onclick="app.toggleSettings()">⚙</div>
            </div>
        </div>

        <!-- Compass -->
        <div class="compass-core">
            <div class="ring" id="ring">
                <div class="cardinal c-n">N</div><div class="cardinal c-e">E</div>
                <div class="cardinal c-s">S</div><div class="cardinal c-w">W</div>
                
                <div class="needle-wrap">
                    <div class="needle n-target" id="n-target"></div>
                    <div class="needle n-true" id="n-true"></div>
                    <div class="needle n-mag" id="n-mag"></div>
                </div>

                <div class="center-hud">
                    <span class="heading-num mono" id="val-head">000°</span>
                    <span class="heading-lbl" id="lbl-head">HEADING</span>
                </div>
            </div>
        </div>

        <!-- Info Deck -->
        <div class="deck">
            
            <!-- Wonder/Lore Card -->
            <div class="glass-panel info-card" id="card-lore">
                <div class="target-head">
                    <div class="t-name" id="txt-name">Loading...</div>
                    <div class="t-dist" id="txt-dist">-- km</div>
                </div>
                <div class="lore-box">
                    <div id="txt-short">...</div>
                    <ul class="lore-facts" id="list-facts"></ul>
                    <div class="lore-myth" id="txt-myth"></div>
                </div>
            </div>

            <!-- Omen Card (Myth Mode Only) -->
            <div class="glass-panel omen-card" id="card-omen">
                <div class="omen-lvl" id="omen-title">SIGNAL QUIET</div>
                <div class="omen-text" id="omen-body">Scanning local ether...</div>
                <div class="omen-disclaimer">MYTH MODE: ARG NARRATIVE ONLY</div>
            </div>

            <!-- Action Bar -->
            <div class="controls-row" id="action-bar">
                <div class="c-pill" onclick="app.toggleAuto()">
                    <span class="icon">⟳</span> <span id="lbl-auto">Auto: ON</span>
                </div>
                <div class="c-pill" onclick="app.nextTarget()">
                    <span class="icon">→</span> Next
                </div>
                <div class="c-pill" onclick="app.openMap()">
                    <span class="icon">↗</span> Map
                </div>
            </div>

        </div>

        <!-- Mode Switcher -->
        <div style="margin-top: auto;">
            <div class="mode-dock">
                <button class="mode-btn active" onclick="app.setMode('wonder')">WONDER</button>
                <button class="mode-btn" onclick="app.setMode('earth')">EARTH</button>
                <button class="mode-btn" onclick="app.setMode('myth')">MYTH</button>
            </div>
        </div>

    </div>

    <!-- SETTINGS MODAL -->
    <div id="modal" class="hidden">
        <div class="glass-panel modal-box">
            <div class="close-x" onclick="app.toggleSettings()">×</div>
            <h3 style="margin:0 0 10px 0">Settings</h3>
            <label style="font-size:0.8rem; color:var(--text-muted)">Magnetic Declination (°)</label>
            <div class="flex-row" style="gap:8px">
                <input type="number" id="inp-decl" value="0">
                <button class="c-pill" style="flex:0 0 auto" onclick="app.fetchDecl()">Fetch</button>
            </div>
            <div style="margin-top:20px">
                <button class="c-pill" style="width:100%" onclick="app.toggleMute()" id="btn-mute">Sound: ON</button>
            </div>
        </div>
    </div>

<script>
/**
 * MAGIC COMPASS: PRO AI-LORE EDITION
 * Single-file architecture for Production (iOS/Android)
 */

// --- 1. LORE DATABASE (Offline AI) ---
const LORE_DB = {
    "Great Pyramid of Giza": {
        short: "The last standing wonder of the ancient world.",
        facts: ["Built for Khufu (~2600 BC)", "2.3 million stone blocks", "Aligned to True North"],
        myth: "Whispers say it was a power plant for the gods, not a tomb."
    },
    "Great Wall of China": {
        short: "A dragon of stone winding through mountains.",
        facts: ["Length: 21,196 km", "Built over 2,000 years", "Sticky rice used in mortar"],
        myth: "They say the souls of fallen workers guide the wind along the wall."
    },
    "Petra": {
        short: "The Rose City, half as old as time.",
        facts: ["Capital of Nabataeans", "Carved into sandstone cliffs", "Lost to West until 1812"],
        myth: "Djinn are said to guard the Pharaoh's Treasury at night."
    },
    "Colosseum": {
        short: "The grandest amphitheater of the Roman Empire.",
        facts: ["Held 50,000 spectators", "Could be flooded for sea battles", "Built by Vespasian"],
        myth: "The sand still remembers the roar of the gladiators."
    },
    "Chichen Itza": {
        short: "The sacred city of the Itza Maya.",
        facts: ["El Castillo has 365 steps", "Shadow snake appears on Equinox", "Ball court acoustics"],
        myth: "The Cenote Sagrado demands offerings to the Rain God Chaac."
    },
    "Machu Picchu": {
        short: "The Lost City of the Incas in the clouds.",
        facts: ["Built for Pachacuti (1450)", "No mortar used (Ashlar)", "Hidden from Spanish"],
        myth: "The Intihuatana stone tethers the sun to the earth."
    },
    "Taj Mahal": {
        short: "An immense mausoleum of white marble.",
        facts: ["Built by Shah Jahan", "Took 22 years to build", "Changes color with sunlight"],
        myth: "Legend says the Black Taj was meant to mirror it across the river."
    },
    "Christ the Redeemer": {
        short: "A symbol of peace watching over Rio.",
        facts: ["30 meters tall", "Soapstone mosaic", "Struck by lightning often"],
        myth: "It embraces the city to protect it from the sea's fury."
    },
    "Stonehenge": {
        short: "A prehistoric ring of standing stones.",
        facts: ["Built ~2500 BC", "Stones form Wales (200km away)", "Solar alignment"],
        myth: "Merlin himself danced these stones into place."
    },
    "Bermuda Triangle": {
        short: "The devil's triangle of the Atlantic.",
        facts: ["Bound by Miami, Bermuda, Puerto Rico", "Heavy traffic zone", "Deep trenches"],
        myth: "Compass needles spin wildly here, pointing to other worlds."
    }
};

// --- 2. MATH UTILS ---
const MathUtils = {
    toRad: d => d * Math.PI / 180,
    toDeg: r => r * 180 / Math.PI,
    getDist: (lat1, lon1, lat2, lon2) => {
        const R = 6371; 
        const dLat = MathUtils.toRad(lat2-lat1);
        const dLon = MathUtils.toRad(lon2-lon1);
        const a = Math.sin(dLat/2)**2 + Math.cos(MathUtils.toRad(lat1))*Math.cos(MathUtils.toRad(lat2))*Math.sin(dLon/2)**2;
        return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
    },
    getBearing: (lat1, lon1, lat2, lon2) => {
        const y = Math.sin(MathUtils.toRad(lon2-lon1)) * Math.cos(MathUtils.toRad(lat2));
        const x = Math.cos(MathUtils.toRad(lat1))*Math.sin(MathUtils.toRad(lat2)) - Math.sin(MathUtils.toRad(lat1))*Math.cos(MathUtils.toRad(lat2))*Math.cos(MathUtils.toRad(lon2-lon1));
        return (MathUtils.toDeg(Math.atan2(y, x)) + 360) % 360;
    },
    lerpAngle: (a, b, t) => {
        let d = b - a;
        if (d > 180) d -= 360; if (d < -180) d += 360;
        return a + d * t;
    }
};

// --- 3. SENSOR ENGINE (Android Mag + iOS Logic) ---
class SensorEngine {
    constructor() {
        this.head = 0;
        this.gps = { lat: null, lon: null };
        this.magData = { x:0, y:0, z:0, val:0, active: false };
        this.magWindow = []; // Rolling window for ARG
        this.listeners = {};
    }

    init() {
        return new Promise(async (resolve, reject) => {
            // GPS
            if("geolocation" in navigator) {
                navigator.geolocation.watchPosition(
                    p => {
                        this.gps = { lat: p.coords.latitude, lon: p.coords.longitude };
                        this.emit('gps', this.gps);
                    },
                    e => console.warn(e), { enableHighAccuracy:true }
                );
            }

            // Compass & Motion
            if (typeof DeviceOrientationEvent !== 'undefined' && typeof DeviceOrientationEvent.requestPermission === 'function') {
                try {
                    const r = await DeviceOrientationEvent.requestPermission();
                    if(r==='granted') {
                        window.addEventListener('deviceorientation', e => this.handleOr(e));
                        resolve(true);
                    } else reject('Permission Denied');
                } catch(e) { reject(e); }
            } else {
                // Android / Standard
                window.addEventListener('deviceorientationabsolute', e => this.handleOr(e, true));
                window.addEventListener('deviceorientation', e => this.handleOr(e, false));
                
                // Android Generic Sensor (Magnetometer)
                if ('Magnetometer' in window) {
                    try {
                        // @ts-ignore
                        const mag = new Magnetometer({ frequency: 20 });
                        mag.addEventListener('reading', () => {
                            const m = Math.sqrt(mag.x**2 + mag.y**2 + mag.z**2);
                            this.magData = { x:mag.x, y:mag.y, z:mag.z, val:m, active:true };
                            this.pushMagHistory(m);
                        });
                        mag.start();
                    } catch(e) { console.log("Mag sensor error", e); }
                }
                resolve(true);
            }
        });
    }

    handleOr(e, abs) {
        if(e.webkitCompassHeading) this.head = e.webkitCompassHeading;
        else if(e.alpha !== null) this.head = 360 - e.alpha; 
    }

    pushMagHistory(val) {
        this.magWindow.push(val);
        if(this.magWindow.length > 60) this.magWindow.shift();
    }

    on(e, fn) { this.listeners[e] = fn; }
    emit(e, d) { if(this.listeners[e]) this.listeners[e](d); }
}

// --- 4. OMEN ENGINE (ARG Logic) ---
const OmenEngine = {
    analyze: (window) => {
        if(!window || window.length < 10) return 0;
        const mean = window.reduce((a,b)=>a+b,0)/window.length;
        const variance = window.reduce((a,b)=>a+(b-mean)**2,0)/window.length;
        return Math.sqrt(variance); // std dev
    },
    
    generate: (magActive, magWindow, seedInput) => {
        const timeBlock = Math.floor(Date.now() / 5000); // Change every 5s
        const seed = Math.sin(seedInput + timeBlock); // Deterministic
        
        let level = 0;
        let title = "SIGNAL QUIET";
        let text = "Ether is stable. No anomalies.";

        if (magActive) {
            // REAL SENSOR LOGIC
            const std = OmenEngine.analyze(magWindow);
            if (std > 15) { level = 3; title = "OMEN PEAK"; text = "HIGH MAGNETIC DISTORTION DETECTED."; }
            else if (std > 5) { level = 2; title = "RIPPLE"; text = "Field fluctuations exceed normal variance."; }
            else if (std > 1) { level = 1; title = "WHISPER"; text = "Subtle vibrations in the local field."; }
        } else {
            // IPHONE / FALLBACK LOGIC (Deterministic ARG)
            // Use the seed to fake a "wave"
            const wave = Math.abs(Math.sin(Date.now()/3000 + seedInput));
            if (wave > 0.9) { level=2; title="ECHO DETECTED"; text = "Simulated resonance high. The veil thins."; }
            else if (wave > 0.6) { level=1; title="STATIC"; text = "Background radiation pattern irregular."; }
        }

        // Flavor text
        if(level > 0) {
            const flavors = ["Something is watching.", "Ancient grid aligned.", "Frequency matches 432Hz.", "Deviation confirmed."];
            text += " " + flavors[Math.floor(Math.abs(seed * flavors.length))];
        }
        
        return { level, title, text };
    }
};

// --- 5. MAIN APP ---
class App {
    constructor() {
        this.sensor = new SensorEngine();
        this.mode = 'wonder';
        this.wonders = Object.keys(LORE_DB).map(k => {
            // Map back to WONDERS array logic
            const w = WONDERS_RAW.find(x => x.name === k);
            return { ...w, ...LORE_DB[k] };
        });
        
        this.state = {
            idx: 0,
            auto: true,
            decl: 0,
            mute: false,
            dispHead: 0
        };

        this.ui = {
            ring: document.getElementById('ring'),
            head: document.getElementById('val-head'),
            nTarget: document.getElementById('n-target'),
            nTrue: document.getElementById('n-true'),
            nMag: document.getElementById('n-mag'),
            
            // Lore UI
            cardLore: document.getElementById('card-lore'),
            txtName: document.getElementById('txt-name'),
            txtDist: document.getElementById('txt-dist'),
            txtShort: document.getElementById('txt-short'),
            listFacts: document.getElementById('list-facts'),
            txtMyth: document.getElementById('txt-myth'),
            
            // Omen UI
            cardOmen: document.getElementById('card-omen'),
            omenTitle: document.getElementById('omen-title'),
            omenBody: document.getElementById('omen-body'),
            
            actions: document.getElementById('action-bar'),
            gpsBad: document.getElementById('gps-badge'),
            lblAuto: document.getElementById('lbl-auto')
        };
    }

    async start() {
        try {
            await this.sensor.init();
            document.getElementById('perm-wall').classList.add('hidden');
            document.getElementById('app').classList.remove('hidden');
            
            this.sensor.on('gps', () => {
                this.ui.gpsBad.innerText = "GPS LOCKED";
                this.ui.gpsBad.classList.add('active');
                if(this.state.auto) this.findNearest();
                else this.updateDist();
            });

            this.updateLore();
            this.loop();
        } catch(e) { alert(e); }
    }

    findNearest() {
        if(!this.sensor.gps.lat) return;
        let min = Infinity; let idx = 0;
        this.wonders.forEach((w, i) => {
            const d = MathUtils.getDist(this.sensor.gps.lat, this.sensor.gps.lon, w.lat, w.lon);
            if(d < min) { min = d; idx = i; }
        });
        if(this.state.idx !== idx) {
            this.state.idx = idx;
            this.updateLore();
        }
    }

    updateDist() {
        if(!this.sensor.gps.lat) return;
        const w = this.wonders[this.state.idx];
        const d = MathUtils.getDist(this.sensor.gps.lat, this.sensor.gps.lon, w.lat, w.lon);
        this.ui.txtDist.innerText = d < 1 ? (d*1000).toFixed(0)+" m" : d.toFixed(1)+" km";
    }

    updateLore() {
        const w = this.wonders[this.state.idx];
        this.ui.txtName.innerText = w.name;
        this.ui.txtShort.innerText = w.short;
        this.ui.listFacts.innerHTML = w.facts.map(f => `<li>${f}</li>`).join('');
        this.ui.txtMyth.innerText = `"${w.myth}"`;
        this.updateDist();
    }

    loop() {
        requestAnimationFrame(() => this.loop());
        
        // Smoothing Heading
        this.state.dispHead = MathUtils.lerpAngle(this.state.dispHead, this.sensor.head, 0.15);
        this.ui.ring.style.transform = `rotate(${-this.state.dispHead}deg)`;
        this.ui.head.innerText = Math.round(this.state.dispHead).toString().padStart(3,'0') + "°";

        // Render Modes
        if(this.mode === 'wonder') {
            if(this.sensor.gps.lat) {
                const w = this.wonders[this.state.idx];
                const b = MathUtils.getBearing(this.sensor.gps.lat, this.sensor.gps.lon, w.lat, w.lon);
                this.ui.nTarget.style.transform = `translateX(-50%) rotate(${b}deg)`;
            }
        } 
        else if(this.mode === 'earth') {
            // True vs Mag
            const trueN = -this.state.decl;
            this.ui.nTrue.style.transform = `translateX(-50%) rotate(${trueN}deg)`;
            this.ui.nMag.style.transform = `translateX(-50%) rotate(0deg)`;
            this.ui.txtShort.innerText = `Mag Field: ${this.sensor.magData.active ? this.sensor.magData.val.toFixed(1) : 'N/A'} µT`;
        }
        else if(this.mode === 'myth') {
            // OMEN ARG
            const seed = (this.sensor.gps.lat || 0) + (this.sensor.gps.lon || 0);
            const omen = OmenEngine.generate(this.sensor.magData.active, this.sensor.magWindow, seed);
            
            // Throttle UI update (simple check every ~1s handled by text compare or time, but here we just update)
            this.ui.omenTitle.innerText = omen.title;
            this.ui.omenBody.innerText = omen.text;
            this.ui.omenTitle.style.color = omen.level > 1 ? 'var(--neon-r)' : 'var(--neon-g)';
            
            // Glitch needle
            const noise = (Math.sin(Date.now()/200) * 10) * omen.level;
            this.ui.nTarget.style.transform = `translateX(-50%) rotate(${noise}deg)`;
        }
    }

    // Actions
    setMode(m) {
        this.mode = m;
        document.querySelectorAll('.mode-btn').forEach(b => b.classList.remove('active'));
        event.target.classList.add('active');
        
        // Reset UI
        this.ui.nTarget.style.display = 'none'; this.ui.nTrue.style.display = 'none'; this.ui.nMag.style.display = 'none';
        this.ui.cardLore.style.display = 'none'; this.ui.cardOmen.style.display = 'none';
        this.ui.actions.style.display = 'none';
        document.body.classList.remove('glitch-mode');

        if(m === 'wonder') {
            this.ui.nTarget.style.display = 'block';
            this.ui.cardLore.style.display = 'block';
            this.ui.actions.style.display = 'flex';
            this.ui.txtDist.style.opacity = 1;
        } else if (m === 'earth') {
            this.ui.nTrue.style.display = 'block';
            this.ui.nMag.style.display = 'block';
            this.ui.cardLore.style.display = 'block';
            this.ui.txtName.innerText = "Magnetic Earth";
            this.ui.txtShort.innerText = "Analysis Mode";
            this.ui.listFacts.innerHTML = `<li>True North: Green</li><li>Mag North: Red (Dashed)</li><li>Declination: ${this.state.decl}°</li>`;
            this.ui.txtMyth.innerText = "";
            this.ui.txtDist.style.opacity = 0;
        } else {
            this.ui.nTarget.style.display = 'block';
            this.ui.cardOmen.style.display = 'block';
            document.body.classList.add('glitch-mode');
        }
    }

    toggleAuto() {
        this.state.auto = !this.state.auto;
        this.ui.lblAuto.innerText = this.state.auto ? "Auto: ON" : "Auto: OFF";
        if(this.state.auto) this.findNearest();
    }
    
    nextTarget() {
        this.state.auto = false;
        this.ui.lblAuto.innerText = "Auto: OFF";
        this.state.idx = (this.state.idx + 1) % this.wonders.length;
        this.updateLore();
    }

    openMap() {
        const w = this.wonders[this.state.idx];
        window.open(`https://maps.google.com/?q=${w.lat},${w.lon}`);
    }

    fetchDecl() {
        if(!this.sensor.gps.lat) return alert("Wait for GPS");
        const url = `https://www.ngdc.noaa.gov/geomag-web/calculators/calculateDeclination?lat1=${this.sensor.gps.lat}&lon1=${this.sensor.gps.lon}&resultFormat=json`;
        fetch(url).then(r=>r.json()).then(d=>{
            this.state.decl = d.result[0].declination;
            document.getElementById('inp-decl').value = this.state.decl.toFixed(2);
            alert("Updated: " + this.state.decl);
        }).catch(()=>alert("Offline mode. Enter manually."));
    }

    toggleSettings() {
        document.getElementById('modal').classList.toggle('hidden');
    }
    
    toggleMute() {
        this.state.mute = !this.state.mute;
        document.getElementById('btn-mute').innerText = this.state.mute ? "Sound: OFF" : "Sound: ON";
    }
}

// Raw coords for matching DB
const WONDERS_RAW = [
    { name: "Great Pyramid of Giza", lat: 29.9792, lon: 31.1342 },
    { name: "Great Wall of China", lat: 40.4319, lon: 116.5704 },
    { name: "Petra", lat: 30.3285, lon: 35.4444 },
    { name: "Colosseum", lat: 41.8902, lon: 12.4922 },
    { name: "Chichen Itza", lat: 20.6843, lon: -88.5678 },
    { name: "Machu Picchu", lat: -13.1631, lon: -72.5450 },
    { name: "Taj Mahal", lat: 27.1751, lon: 78.0421 },
    { name: "Christ the Redeemer", lat: -22.9519, lon: -43.2105 },
    { name: "Stonehenge", lat: 51.1789, lon: -1.8262 },
    { name: "Bermuda Triangle", lat: 25.0, lon: -71.0 }
];

const app = new App();
document.getElementById('btn-init').addEventListener('click', () => app.start());

</script>
</body>
</html>
