<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>OMEGA: MASTER CLASS (FULL AI)</title>
    
    <!-- LIBRARIES: โหลดสมองและเครื่องมือ -->
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@3.11.0"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/coco-ssd@2.2.2"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/howler/2.2.3/howler.min.js"></script>

    <style>
        /* --- STYLE SYSTEM: เหมือนตัว V2 สวยๆ --- */
        :root {
            --primary: #00ff9d; --secondary: #008f7a; --alert: #ff2a6d; 
            --bg: #050505; --glass: rgba(0, 20, 10, 0.85);
            --font: 'Segoe UI', system-ui, sans-serif;
        }
        body { margin: 0; overflow: hidden; background: var(--bg); color: var(--primary); font-family: var(--font); }
        
        #viewport { position: relative; width: 100vw; height: 100vh; }
        #camera-feed { position: absolute; width: 100%; height: 100%; object-fit: cover; opacity: 0.6; }
        #hud-canvas { position: absolute; inset: 0; z-index: 10; }
        #layer-3d { position: absolute; inset: 0; z-index: 5; pointer-events: none; opacity: 0.7; }
        
        /* UI LAYERS */
        #ui-layer { position: absolute; inset: 0; z-index: 20; padding: 20px; display: flex; flex-direction: column; justify-content: space-between; pointer-events: none; }
        
        .panel {
            background: var(--glass); border-left: 4px solid var(--primary);
            padding: 15px; margin: 5px; backdrop-filter: blur(10px);
            pointer-events: auto; width: fit-content; border-radius: 5px;
            box-shadow: 0 0 15px rgba(0, 255, 157, 0.2);
        }
        .panel-title { font-size: 10px; font-weight: bold; color: #00a8ff; letter-spacing: 2px; margin-bottom: 5px; }
        .data-row { font-family: monospace; font-size: 12px; margin-bottom: 2px; display: flex; justify-content: space-between; min-width: 150px; }
        .val { font-weight: bold; color: #fff; }

        /* RADAR */
        #radar-box {
            position: absolute; bottom: 20px; right: 20px; width: 150px; height: 150px;
            background: rgba(0,20,10,0.9); border-radius: 50%; border: 2px solid #00a8ff;
            overflow: hidden; pointer-events: auto; z-index: 30;
        }
        .blip { position: absolute; width: 6px; height: 6px; background: var(--alert); border-radius: 50%; transform: translate(-50%,-50%); box-shadow: 0 0 5px var(--alert); transition: all 0.2s; }

        /* BOOT SCREEN */
        #boot { position: fixed; inset: 0; background: #000; z-index: 9999; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        .btn { padding: 15px 40px; background: var(--primary); border: none; font-weight: bold; cursor: pointer; margin-top: 20px; border-radius: 30px; }
        
        /* CONTROL PANEL */
        #controls { display: none; position: absolute; top: 60px; left: 20px; background: rgba(0,0,0,0.9); padding: 10px; pointer-events: auto; z-index: 40; border: 1px solid var(--primary); }
        .ctrl-btn { background: #333; color: var(--primary); border: 1px solid var(--primary); padding: 5px 10px; margin: 2px; cursor: pointer; font-size: 10px; }
        .ctrl-btn:hover { background: var(--primary); color: #000; }
        .ctrl-btn.active { background: var(--primary); color: #000; }

        /* VOICE INDICATOR */
        #voice-ind { position: absolute; top: 20px; right: 20px; background: var(--alert); color: white; padding: 5px 10px; border-radius: 15px; font-size: 10px; display: none; animation: pulse 1s infinite; }
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.5; } }
    </style>
</head>
<body>

    <div id="viewport">
        <video id="camera-feed" autoplay playsinline muted></video>
        <canvas id="layer-3d"></canvas>
        <canvas id="hud-canvas"></canvas>
        
        <div id="ui-layer">
            <div style="display: flex; gap: 10px;">
                <div class="panel">
                    <div class="panel-title">SYSTEM STATUS</div>
                    <div class="data-row"><span>CPU:</span><span class="val" id="v-cpu">0ms</span></div>
                    <div class="data-row"><span>FPS:</span><span class="val" id="v-fps">0</span></div>
                    <div class="data-row"><span>TRACKS:</span><span class="val" id="v-tracks">0</span></div>
                </div>
                <div class="panel">
                    <div class="panel-title">PHYSICS</div>
                    <div class="data-row"><span>SPEED:</span><span class="val" id="v-spd">0 m/s</span></div>
                    <div class="data-row"><span>HDG:</span><span class="val" id="v-hdg">0°</span></div>
                </div>
            </div>

            <div class="panel" style="position: absolute; top: 50%; right: 20px; transform: translateY(-50%);">
                <div class="panel-title">TARGET LOCK</div>
                <div class="data-row"><span>TYPE:</span><span class="val" id="t-type">--</span></div>
                <div class="data-row"><span>DIST:</span><span class="val" id="t-dist">--</span></div>
                <div class="data-row"><span>THREAT:</span><span class="val" id="t-threat" style="color:var(--primary)">LOW</span></div>
            </div>

            <div id="radar-box">
                <!-- Blips go here -->
                <div style="position:absolute; inset:0; background: conic-gradient(transparent 270deg, #00a8ff); opacity: 0.3; animation: scan 3s linear infinite;"></div>
                <style>@keyframes scan{to{transform: rotate(360deg);}}</style>
            </div>
        </div>

        <div style="position: absolute; top: 20px; left: 20px; z-index: 50;">
            <button onclick="document.getElementById('controls').style.display = 'block'" style="background:black; color:var(--primary); border:1px solid var(--primary); padding:5px;">CONTROLS</button>
        </div>

        <div id="controls">
            <div class="panel-title">COMMAND CENTER</div>
            <button class="ctrl-btn" onclick="OMEGA.voice.toggle()">VOICE CMD</button>
            <button class="ctrl-btn" onclick="OMEGA.recorder.toggle()">RECORD MISSION</button>
            <button class="ctrl-btn" onclick="document.getElementById('controls').style.display='none'">CLOSE</button>
        </div>

        <div id="voice-ind">MIC ACTIVE</div>
    </div>

    <div id="boot">
        <h1 style="color:var(--primary); letter-spacing: 5px; text-shadow: 0 0 20px var(--primary);">OMEGA</h1>
        <div style="color: #666; font-family: monospace;">FULL KERNEL LOADING...</div>
        <button id="btn-init" class="btn" disabled>INITIALIZING...</button>
    </div>

<script>
/**
 * OMEGA: MASTER FILE
 * รวมระบบฟิสิกส์, การจำ ID, เสียง และ 3D ไว้ในไฟล์เดียว
 */

const CONFIG = {
    AI: { CONFIDENCE: 0.6, MAX_OBJ: 15 },
    PHYSICS: { FOV: 60, FOCAL_LEN: 800, PERSON_H: 1.7 },
    TRACKING: { MAX_LOST: 10, IOU_THRESH: 0.4 } // จำได้ 10 เฟรมแม้จะหลุดจอ
};

// --- 1. ระบบฟิสิกส์และการคำนวณ ---
const Physics = {
    iou: (b1, b2) => {
        const x1 = Math.max(b1[0], b2[0]), y1 = Math.max(b1[1], b2[1]);
        const x2 = Math.min(b1[0]+b1[2], b2[0]+b2[2]), y2 = Math.min(b1[1]+b1[3], b2[1]+b2[3]);
        const inter = Math.max(0, x2-x1) * Math.max(0, y2-y1);
        return inter / ((b1[2]*b1[3]) + (b2[2]*b2[3]) - inter);
    },
    getDist: (h) => (CONFIG.PHYSICS.PERSON_H * CONFIG.PHYSICS.FOCAL_LEN) / h,
    project3D: (x, y, d, w, h) => {
        // แปลงพิกัดหน้าจอเป็น 3D world (สำหรับการวางวัตถุใน 3D scene)
        const nx = (x - w/2) / (w/2), ny = -(y - h/2) / (h/2);
        const tan = Math.tan((CONFIG.PHYSICS.FOV/2) * Math.PI/180);
        return { x: nx * d * tan * (w/h), y: ny * d * tan, z: -d };
    }
};

// --- 2. ระบบติดตามวัตถุ (Tracking Memory) ---
class Tracker {
    constructor() {
        this.tracks = [];
        this.nextId = 1;
    }
    update(detections, w, h) {
        let newTracks = [];
        detections.forEach(det => {
            let best = null, maxIOU = 0;
            // หา object เดิมที่ตำแหน่งใกล้เคียงกัน
            this.tracks.forEach(t => {
                const val = Physics.iou(det.bbox, t.bbox);
                if(val > maxIOU) { maxIOU = val; best = t; }
            });

            const dist = Physics.getDist(det.bbox[3]);
            const cx = det.bbox[0] + det.bbox[2]/2;
            const cy = det.bbox[1] + det.bbox[3]/2;
            const world = Physics.project3D(cx, cy, dist, w, h);

            if(best && maxIOU > CONFIG.TRACKING.IOU_THRESH) {
                // เจอคนเดิม! อัปเดตข้อมูล
                best.bbox = det.bbox; best.score = det.score; best.lost = 0;
                best.dist = dist; best.world = world;
                // คำนวณความเร็ว (Velocity)
                best.vel = { x: world.x - (best.prev?.x||world.x), z: world.z - (best.prev?.z||world.z) };
                best.prev = world;
                newTracks.push(best);
            } else {
                // คนใหม่
                newTracks.push({
                    id: this.nextId++, bbox: det.bbox, class: det.class, score: det.score,
                    lost: 0, dist: dist, world: world, vel: {x:0, z:0}, prev: world
                });
            }
        });

        // เก็บคนที่หายไปชั่วคราวไว้ (เผื่อเดินผ่านเสา)
        this.tracks.forEach(t => {
            if(t.lost < CONFIG.TRACKING.MAX_LOST && !newTracks.find(nt => nt.id === t.id)) {
                t.lost++;
                newTracks.push(t);
            }
        });
        
        this.tracks = newTracks;
        return this.tracks;
    }
}

// --- 3. ระบบเสียง (Voice Command) ---
class VoiceSystem {
    constructor() {
        this.active = false;
        if('webkitSpeechRecognition' in window) {
            this.rec = new webkitSpeechRecognition();
            this.rec.continuous = false;
            this.rec.lang = 'en-US';
            this.rec.onresult = (e) => this.process(e.results[0][0].transcript);
            this.rec.onend = () => { if(this.active) this.rec.start(); };
        }
    }
    toggle() {
        this.active = !this.active;
        const ind = document.getElementById('voice-ind');
        if(this.active && this.rec) {
            this.rec.start();
            ind.style.display = 'block';
            alert("Voice: Say 'Target', 'Status', 'Record'");
        } else {
            if(this.rec) this.rec.stop();
            ind.style.display = 'none';
        }
    }
    process(cmd) {
        console.log("Voice:", cmd);
        cmd = cmd.toLowerCase();
        if(cmd.includes('target')) alert("TARGET LOCKED");
        if(cmd.includes('status')) alert(`System OK. ${OMEGA.tracker.tracks.length} Targets.`);
        if(cmd.includes('record')) OMEGA.recorder.toggle();
    }
}

// --- 4. ระบบอัดข้อมูล (Recorder) ---
class MissionRecorder {
    constructor() { this.rec = false; this.data = []; }
    toggle() {
        this.rec = !this.rec;
        alert(this.rec ? "Recording Started..." : "Recording Saved (Console)");
        if(!this.rec) console.log(JSON.stringify(this.data));
    }
    push(data) { if(this.rec) this.data.push({t: Date.now(), ...data}); }
}

// --- 5. ระบบ 3D Scene ---
class Scene3D {
    constructor() {
        this.scene = new THREE.Scene();
        this.camera = new THREE.PerspectiveCamera(75, window.innerWidth/window.innerHeight, 0.1, 1000);
        this.renderer = new THREE.WebGLRenderer({canvas: document.getElementById('layer-3d'), alpha:true});
        this.renderer.setSize(window.innerWidth, window.innerHeight);
        
        // Grid พื้น
        const grid = new THREE.GridHelper(100, 50, 0x00ff9d, 0x003311);
        grid.position.y = -2;
        this.scene.add(grid);
        
        this.meshes = new Map();
    }
    update(tracks) {
        // ลบอันเก่า
        const ids = tracks.map(t => t.id);
        for(let [id, m] of this.meshes) {
            if(!ids.includes(id)) { this.scene.remove(m); this.meshes.delete(id); }
        }
        // เพิ่ม/ขยับอันใหม่
        tracks.forEach(t => {
            if(!this.meshes.has(t.id)) {
                const geo = new THREE.WireframeGeometry(new THREE.BoxGeometry(1, 2, 1));
                const mat = new THREE.LineBasicMaterial({color: 0x00ff9d});
                const mesh = new THREE.LineSegments(geo, mat);
                this.scene.add(mesh);
                this.meshes.set(t.id, mesh);
            }
            const mesh = this.meshes.get(t.id);
            if(t.world) mesh.position.set(t.world.x, -1, t.world.z);
        });
        this.renderer.render(this.scene, this.camera);
    }
}

// --- MAIN KERNEL ---
class Kernel {
    constructor() {
        this.video = document.getElementById('camera-feed');
        this.canvas = document.getElementById('hud-canvas');
        this.ctx = this.canvas.getContext('2d');
        
        this.tracker = new Tracker();
        this.voice = new VoiceSystem();
        this.recorder = new MissionRecorder();
        this.scene3D = new Scene3D();
        
        this.isRunning = false;
        this.resize();
        window.onresize = () => this.resize();
    }

    resize() {
        this.canvas.width = window.innerWidth;
        this.canvas.height = window.innerHeight;
        this.scene3D.renderer.setSize(window.innerWidth, window.innerHeight);
        this.scene3D.camera.aspect = window.innerWidth / window.innerHeight;
        this.scene3D.camera.updateProjectionMatrix();
    }

    async boot() {
        try {
            this.model = await cocoSsd.load({base: 'lite_mobilenet_v2'});
            
            const stream = await navigator.mediaDevices.getUserMedia({
                video: { facingMode: 'environment', width: {ideal: 1280}, height: {ideal: 720} },
                audio: false
            });
            this.video.srcObject = stream;
            await new Promise(r => this.video.onloadedmetadata = () => { this.video.play(); r(); });

            document.getElementById('boot').style.display = 'none';
            this.isRunning = true;
            this.loop();
        } catch(e) {
            alert("Error: " + e.message);
        }
    }

    async loop() {
        if(!this.isRunning) return;
        const start = performance.now();

        // 1. Detect
        const detections = await this.model.detect(this.video, CONFIG.AI.MAX_OBJ, CONFIG.AI.CONFIDENCE);
        
        // 2. Logic & Tracking
        const tracks = this.tracker.update(detections, this.video.videoWidth, this.video.videoHeight);
        
        // 3. 3D Update
        this.scene3D.update(tracks);

        // 4. Draw HUD
        this.drawHUD(tracks);
        this.updateUI(tracks, start);
        
        // 5. Record
        this.recorder.push(tracks);

        requestAnimationFrame(() => this.loop());
    }

    drawHUD(tracks) {
        this.ctx.clearRect(0,0,this.canvas.width, this.canvas.height);
        const sx = this.canvas.width / this.video.videoWidth;
        const sy = this.canvas.height / this.video.videoHeight;

        tracks.forEach(t => {
            if(t.lost > 2) return;
            const x = t.bbox[0]*sx, y = t.bbox[1]*sy, w = t.bbox[2]*sx, h = t.bbox[3]*sy;
            const color = t.class === 'person' ? '#ff2a6d' : '#00ff9d';
            
            // Box
            this.ctx.strokeStyle = color; this.ctx.lineWidth = 2;
            this.ctx.strokeRect(x, y, w, h);
            
            // Info
            this.ctx.fillStyle = color; this.ctx.font = "bold 12px monospace";
            this.ctx.fillText(`ID:${t.id} ${t.class.toUpperCase()}`, x, y-20);
            this.ctx.fillText(`${t.dist.toFixed(1)}m`, x, y-8);
            
            // Velocity Vector (Smart Feature)
            if(Math.abs(t.vel.x) > 0.01) {
                this.ctx.beginPath();
                this.ctx.moveTo(x+w/2, y+h/2);
                this.ctx.lineTo(x+w/2 + t.vel.x*100, y+h/2); // Draw movement direction
                this.ctx.strokeStyle = 'yellow';
                this.ctx.stroke();
            }
        });
    }

    updateUI(tracks, start) {
        // FPS & CPU
        const ms = Math.round(performance.now() - start);
        document.getElementById('v-cpu').innerText = ms + 'ms';
        document.getElementById('v-fps').innerText = Math.round(1000/Math.max(1, ms));
        document.getElementById('v-tracks').innerText = tracks.length;

        // Target Info
        if(tracks.length > 0) {
            const t = tracks[0];
            document.getElementById('t-type').innerText = t.class.toUpperCase();
            document.getElementById('t-dist').innerText = t.dist.toFixed(1) + 'm';
            // Threat Logic
            const el = document.getElementById('t-threat');
            if(t.dist < 2 && t.class === 'person') {
                el.innerText = "CRITICAL"; el.style.color = "red";
            } else {
                el.innerText = "LOW"; el.style.color = "#00ff9d";
            }
        }

        // Radar
        const radar = document.getElementById('radar-box');
        const oldBlips = radar.getElementsByClassName('blip');
        while(oldBlips[0]) oldBlips[0].remove();
        
        tracks.forEach(t => {
            if(t.lost > 2) return;
            const blip = document.createElement('div');
            blip.className = 'blip';
            // Map 3D coordinate to 2D radar
            // World Z is depth (negative away from camera)
            const rx = 75 + (t.world.x * 4); // Scale factor
            const ry = 75 + (-t.world.z * 4);
            if(rx > 0 && rx < 150 && ry > 0 && ry < 150) {
                blip.style.left = rx + 'px'; blip.style.top = ry + 'px';
                if(t.class !== 'person') blip.style.background = '#00ff9d';
                radar.appendChild(blip);
            }
        });
    }
}

const OMEGA = new Kernel();
const btn = document.getElementById('btn-init');
btn.disabled = false;
btn.innerText = "INITIALIZE SYSTEM";
btn.onclick = () => {
    btn.innerText = "LOADING AI...";
    btn.disabled = true;
    OMEGA.boot();
};

</script>
</body>
</html>
