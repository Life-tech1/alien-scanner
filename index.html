<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>AURA v3 | Weather Intelligence</title>
    
    <!-- Fonts: Kanit (Thai) & Outfit (Eng) -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@200;300;400;500;600&family=Outfit:wght@200;300;400;500;700&display=swap" rel="stylesheet">
    
    <!-- Leaflet CSS (Map) -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
    
    <style>
        /* â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”
           ğŸ¨ VISION OS DESIGN SYSTEM
           â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€” */
        :root {
            --font-th: 'Kanit', sans-serif;
            --font-en: 'Outfit', sans-serif;
            
            /* Dynamic Palette (Updated via JS) */
            --bg-top: #0f172a;
            --bg-bot: #000000;
            --accent: #3b82f6;
            
            /* Glassmorphism */
            --glass-bg: rgba(255, 255, 255, 0.06);
            --glass-border: rgba(255, 255, 255, 0.12);
            --glass-shine: rgba(255, 255, 255, 0.03);
            --glass-blur: 24px;
            
            /* Semantic Colors */
            --safe: #34c759;
            --warn: #ff9f0a;
            --danger: #ff453a;
            --text-main: #ffffff;
            --text-muted: rgba(255, 255, 255, 0.6);
            
            /* Animation */
            --ease-apple: cubic-bezier(0.25, 1, 0.5, 1);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

        body {
            background: linear-gradient(180deg, var(--bg-top), var(--bg-bot));
            color: var(--text-main);
            font-family: var(--font-th);
            min-height: 100vh;
            overflow-x: hidden;
            transition: background 1.5s ease;
        }

        /* Canvas Layers */
        #sky-canvas, #stars-canvas {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            pointer-events: none; z-index: 0;
        }
        #sky-canvas { z-index: 1; } /* Rain/Snow */

        /* App Layout */
        .app {
            position: relative; z-index: 10;
            max-width: 1100px; margin: 0 auto;
            padding: 20px;
            display: flex; flex-direction: column; gap: 24px;
            opacity: 0; animation: fadeInfo 1s var(--ease-apple) forwards;
        }

        @keyframes fadeInfo { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }

        /* Header */
        header { display: flex; justify-content: space-between; align-items: center; padding: 10px 0; }
        .brand { font-family: var(--font-en); font-weight: 700; letter-spacing: 1px; font-size: 1.1rem; display: flex; align-items: center; gap: 8px; }
        .brand-dot { width: 8px; height: 8px; background: var(--accent); border-radius: 50%; box-shadow: 0 0 12px var(--accent); }
        .lang-switch { font-family: var(--font-en); font-weight: 600; cursor: pointer; opacity: 0.7; transition: 0.3s; }
        .lang-switch:hover { opacity: 1; }

        /* Hero Section */
        .hero { text-align: center; padding: 40px 0; position: relative; }
        .temp-huge {
            font-family: var(--font-en); font-size: clamp(80px, 12vw, 130px);
            font-weight: 200; line-height: 0.9; letter-spacing: -4px;
            background: linear-gradient(180deg, #fff, rgba(255,255,255,0.7));
            -webkit-background-clip: text; -webkit-text-fill-color: transparent;
            filter: drop-shadow(0 10px 20px rgba(0,0,0,0.2));
        }
        .condition { font-size: 1.5rem; font-weight: 400; opacity: 0.9; margin: 10px 0; }
        .hl-range { font-family: var(--font-en); font-size: 1.1rem; opacity: 0.6; }

        /* Glass Card System */
        .card {
            background: var(--glass-bg);
            border: 1px solid var(--glass-border);
            border-radius: 24px;
            padding: 20px;
            backdrop-filter: blur(var(--glass-blur));
            -webkit-backdrop-filter: blur(var(--glass-blur));
            box-shadow: 0 8px 32px rgba(0,0,0,0.2);
            transition: transform 0.4s var(--ease-apple), box-shadow 0.4s var(--ease-apple);
            position: relative; overflow: hidden;
        }
        .card:hover { transform: translateY(-4px); box-shadow: 0 12px 40px rgba(0,0,0,0.3); border-color: rgba(255,255,255,0.2); }
        .card::before {
            content: ''; position: absolute; inset: 0;
            background: linear-gradient(135deg, var(--glass-shine) 0%, transparent 100%);
            pointer-events: none;
        }

        .card-title {
            font-size: 0.85rem; text-transform: uppercase; letter-spacing: 1px;
            color: var(--text-muted); margin-bottom: 12px; display: flex; align-items: center; gap: 6px;
        }
        .card-title svg { width: 14px; height: 14px; opacity: 0.8; }

        /* AI Brain Box */
        .ai-brain {
            background: linear-gradient(135deg, rgba(59, 130, 246, 0.15), rgba(147, 51, 234, 0.05));
            border-color: rgba(59, 130, 246, 0.3);
            display: flex; gap: 16px; align-items: flex-start;
        }
        .ai-icon { font-size: 24px; animation: pulse 3s infinite; }
        .ai-content h3 { font-family: var(--font-en); font-size: 0.9rem; color: #60a5fa; margin-bottom: 6px; }
        .ai-text { font-size: 1rem; line-height: 1.6; font-weight: 300; }
        .ai-pill { 
            display: inline-block; background: rgba(255,255,255,0.1); padding: 4px 10px; border-radius: 20px; 
            font-size: 0.8rem; margin: 4px 4px 0 0; border: 1px solid rgba(255,255,255,0.1);
        }

        /* Bento Grid */
        .grid {
            display: grid; grid-template-columns: repeat(auto-fit, minmax(160px, 1fr)); gap: 16px;
        }
        .col-2 { grid-column: span 2; }
        .col-full { grid-column: 1 / -1; }
        @media (max-width: 768px) { .col-2 { grid-column: span 1; } }

        /* Monitors */
        .stat-val { font-family: var(--font-en); font-size: 2rem; font-weight: 600; }
        .stat-unit { font-size: 1rem; opacity: 0.6; font-weight: 400; }
        .stat-desc { font-size: 0.85rem; opacity: 0.7; margin-top: 4px; }

        /* Visualizers */
        .bar-container { height: 6px; background: rgba(255,255,255,0.1); border-radius: 4px; margin-top: 12px; overflow: hidden; }
        .bar-fill { height: 100%; transition: width 1s var(--ease-apple); }
        
        .aqi-donut { position: relative; width: 80px; height: 80px; margin: 0 auto; }
        .aqi-svg { transform: rotate(-90deg); width: 100%; height: 100%; }
        .aqi-circle { fill: none; stroke-width: 8; stroke-linecap: round; transition: stroke-dashoffset 1.5s var(--ease-apple); }

        .compass { width: 60px; height: 60px; border: 2px solid rgba(255,255,255,0.15); border-radius: 50%; position: relative; margin: 0 auto; }
        .compass-arrow { 
            width: 4px; height: 100%; background: linear-gradient(to bottom, var(--danger) 50%, transparent 50%); 
            position: absolute; left: 50%; transform: translateX(-50%); transition: transform 1s var(--ease-apple);
        }

        /* Radar Map */
        #map { width: 100%; height: 350px; border-radius: 20px; background: #000; z-index: 1; }
        .leaflet-control-attribution { display: none; }
        .radar-controls { position: absolute; bottom: 16px; left: 16px; z-index: 400; display: flex; gap: 8px; }
        .play-btn { background: rgba(0,0,0,0.6); color: #fff; border: 1px solid rgba(255,255,255,0.2); width: 32px; height: 32px; border-radius: 50%; cursor: pointer; display: flex; align-items: center; justify-content: center; backdrop-filter: blur(10px); }

        /* Forecast */
        .chart-container { height: 140px; width: 100%; position: relative; }
        .day-row { display: flex; justify-content: space-between; align-items: center; padding: 10px 0; border-bottom: 1px solid rgba(255,255,255,0.05); }
        .day-row:last-child { border: none; }
        .day-bar-track { flex: 1; margin: 0 16px; height: 4px; background: rgba(255,255,255,0.1); border-radius: 2px; position: relative; }
        .day-bar { position: absolute; height: 100%; border-radius: 2px; opacity: 0.8; }
        
        /* Loading */
        #loader {
            position: fixed; inset: 0; background: #000; z-index: 9999; 
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            transition: opacity 0.5s;
        }
        .pulse-logo { width: 60px; height: 60px; border-radius: 50%; background: var(--accent); box-shadow: 0 0 0 0 rgba(59, 130, 246, 0.7); animation: pulse-blue 2s infinite; }
        
        @keyframes pulse-blue {
            0% { transform: scale(0.95); box-shadow: 0 0 0 0 rgba(59, 130, 246, 0.7); }
            70% { transform: scale(1); box-shadow: 0 0 0 20px rgba(59, 130, 246, 0); }
            100% { transform: scale(0.95); box-shadow: 0 0 0 0 rgba(59, 130, 246, 0); }
        }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
    </style>
</head>
<body>

    <!-- Loading Screen -->
    <div id="loader">
        <div class="pulse-logo"></div>
        <div style="margin-top: 20px; font-family: 'Outfit'; letter-spacing: 2px; font-size: 14px; color: rgba(255,255,255,0.7);">AURA v3 SYSTEM</div>
    </div>

    <!-- Backgrounds -->
    <canvas id="stars-canvas"></canvas>
    <canvas id="sky-canvas"></canvas>

    <div class="app">
        <!-- Header -->
        <header>
            <div class="brand"><div class="brand-dot"></div> AURA v3</div>
            <div class="lang-switch" id="lang-btn">EN / TH</div>
        </header>

        <!-- Hero -->
        <section class="hero">
            <div class="location-badge" style="font-size: 0.9rem; color: var(--accent); margin-bottom: 8px;">
                <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"></path><circle cx="12" cy="10" r="3"></circle></svg>
                <span id="loc-name">Locating...</span>
            </div>
            <div class="temp-huge" id="curr-temp">--Â°</div>
            <div class="condition" id="curr-cond">Initializing Intelligence</div>
            <div class="hl-range">H: <span id="max-t">--</span>Â° L: <span id="min-t">--</span>Â°</div>
        </section>

        <!-- AI Brain -->
        <section class="card ai-brain col-full">
            <div class="ai-icon">ğŸ§ </div>
            <div class="ai-content">
                <h3>AURA INTELLIGENCE</h3>
                <div class="ai-text" id="ai-text">Analyzing atmospheric data...</div>
                <div id="ai-tags" style="margin-top: 10px;"></div>
            </div>
        </section>

        <!-- Monitor Grid -->
        <div class="grid">
            <!-- AQI -->
            <div class="card">
                <div class="card-title">Air Quality</div>
                <div class="aqi-donut">
                    <svg class="aqi-svg" viewBox="0 0 100 100">
                        <circle cx="50" cy="50" r="40" stroke="rgba(255,255,255,0.1)" stroke-width="8" fill="none"></circle>
                        <circle id="aqi-ring" class="aqi-circle" cx="50" cy="50" r="40" stroke-dasharray="251" stroke-dashoffset="251" stroke="#34c759"></circle>
                    </svg>
                    <div style="position: absolute; inset:0; display:flex; justify-content:center; align-items:center; font-family:'Outfit'; font-weight:700; font-size:1.4rem;" id="aqi-val">--</div>
                </div>
                <div class="stat-desc" style="text-align:center; margin-top:4px;" id="aqi-status">--</div>
            </div>

            <!-- UV -->
            <div class="card">
                <div class="card-title">UV Index</div>
                <div class="stat-val" id="uv-val">--</div>
                <div class="stat-desc" id="uv-burn">--</div>
                <div class="bar-container"><div class="bar-fill" id="uv-bar" style="width:0%; background: var(--safe);"></div></div>
            </div>

            <!-- Wind -->
            <div class="card">
                <div class="card-title">Wind Flow</div>
                <div class="compass">
                    <div class="compass-arrow" id="wind-arrow"></div>
                    <div style="position:absolute; top:2px; left:50%; transform:translateX(-50%); font-size:10px; color:#fff;">N</div>
                </div>
                <div style="text-align:center; margin-top:8px;">
                    <span class="stat-val" style="font-size:1.5rem;" id="wind-speed">--</span> <span class="stat-unit">km/h</span>
                </div>
            </div>

            <!-- Humidity & Dew -->
            <div class="card">
                <div class="card-title">Moisture</div>
                <div class="stat-val"><span id="humidity">--</span><span class="stat-unit">%</span></div>
                <div class="stat-desc">Dew Point: <span id="dew-point">--</span>Â°</div>
                <div class="stat-desc" id="mold-risk" style="color:var(--danger); display:none;">âš ï¸ Mold Risk</div>
            </div>

            <!-- Visibility -->
            <div class="card">
                <div class="card-title">Visibility</div>
                <div class="stat-val"><span id="vis-val">--</span><span class="stat-unit">km</span></div>
                <div class="stat-desc" id="vis-desc">Clear View</div>
            </div>

            <!-- Rain Probability -->
            <div class="card">
                <div class="card-title">Rain Chance</div>
                <div class="stat-val"><span id="rain-prob">--</span><span class="stat-unit">%</span></div>
                <div class="stat-desc">Next Hour</div>
                <div class="bar-container"><div class="bar-fill" id="rain-bar" style="width:0%; background: var(--accent);"></div></div>
            </div>
        </div>

        <!-- 48H Trend -->
        <section class="card col-full">
            <div class="card-title">48-Hour Trend</div>
            <div class="chart-container">
                <canvas id="tempChart"></canvas>
            </div>
        </section>

        <!-- Radar -->
        <section class="card col-full" style="padding:0; overflow:hidden;">
            <div id="map"></div>
            <div class="radar-controls">
                <div class="play-btn" id="radar-play">â–¶</div>
                <div style="font-size:12px; background:rgba(0,0,0,0.5); padding:4px 8px; border-radius:4px; backdrop-filter:blur(4px);">RADAR LIVE</div>
            </div>
        </section>

        <!-- 7 Day Forecast -->
        <section class="card col-full">
            <div class="card-title">7-Day Forecast</div>
            <div id="daily-list"></div>
        </section>

        <footer style="text-align:center; padding: 20px 0; color: var(--text-muted); font-size: 0.8rem;">
            AURA v3 â€¢ DeepMind Architecture â€¢ Apple Design System
        </footer>
    </div>

    <!-- Scripts -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <script>
        /**
         * â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”
         * AURA v3 CORE ENGINE
         * Single-file architecture: Logic, State, UI, Particle System combined.
         * â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”
         */

        const CONFIG = {
            lang: 'en', // 'en' or 'th'
            lat: 13.7563, // Default BKK
            lon: 100.5018,
            api: 'https://api.open-meteo.com/v1/forecast',
            aqi: 'https://air-quality-api.open-meteo.com/v1/air-quality',
            geo: 'https://api.bigdatacloud.net/data/reverse-geocode-client',
            radar: 'https://tile.cache.rainviewer.com'
        };

        const TEXT = {
            en: {
                locating: "Locating Satellites...",
                analyzing: "Analyzing atmospheric data...",
                aqi: { good: "Excellent", mod: "Moderate", poor: "Unhealthy", bad: "Hazardous" },
                uv: { low: "Low", mod: "Moderate", high: "High", ext: "Extreme" },
                burn: "Burn time: ",
                mins: " mins",
                ai: {
                    hot: "Extreme heat detected. Solar radiation is critical. Skin burn risk in <15 mins.",
                    rain: "Precipitation inbound within 60 minutes. Umbrella advised.",
                    storm: "Barometric pressure dropping. Storm cell approaching. Secure loose objects.",
                    good: "Optimal conditions. Perfect for outdoor activities.",
                    pm: "Air quality toxic. Mask (N95) highly recommended.",
                    flood: "Soil saturation high. Flood risk detected in low-lying areas.",
                    laundry: "Ideal for laundry drying.",
                    nolaundry: "Do not dry laundry outside.",
                    run: "Good for running.",
                    motor: "High crosswinds. Motorcycle risk elevated."
                },
                tags: ["Run", "Laundry", "Pet", "Drive", "AC"]
            },
            th: {
                locating: "à¸à¸³à¸¥à¸±à¸‡à¸£à¸°à¸šà¸¸à¸à¸´à¸à¸±à¸”...",
                analyzing: "à¸£à¸°à¸šà¸š AI à¸à¸³à¸¥à¸±à¸‡à¸§à¸´à¹€à¸„à¸£à¸²à¸°à¸«à¹Œà¸‚à¹‰à¸­à¸¡à¸¹à¸¥...",
                aqi: { good: "à¸­à¸²à¸à¸²à¸¨à¸”à¸µà¹€à¸¢à¸µà¹ˆà¸¢à¸¡", mod: "à¸›à¸²à¸™à¸à¸¥à¸²à¸‡", poor: "à¹€à¸£à¸´à¹ˆà¸¡à¸¡à¸µà¸œà¸¥à¸à¸£à¸°à¸—à¸š", bad: "à¸­à¸±à¸™à¸•à¸£à¸²à¸¢" },
                uv: { low: "à¸•à¹ˆà¸³", mod: "à¸›à¸²à¸™à¸à¸¥à¸²à¸‡", high: "à¸ªà¸¹à¸‡", ext: "à¸£à¸¸à¸™à¹à¸£à¸‡" },
                burn: "à¸œà¸´à¸§à¹„à¸«à¸¡à¹‰à¹ƒà¸™: ",
                mins: " à¸™à¸²à¸—à¸µ",
                ai: {
                    hot: "à¸­à¸²à¸à¸²à¸¨à¸£à¹‰à¸­à¸™à¸ˆà¸±à¸”! à¸£à¸±à¸‡à¸ªà¸µ UV à¸£à¸¸à¸™à¹à¸£à¸‡ à¹€à¸ªà¸µà¹ˆà¸¢à¸‡à¸œà¸´à¸§à¹„à¸«à¸¡à¹‰à¹ƒà¸™ 15 à¸™à¸²à¸—à¸µ à¸„à¸§à¸£à¸—à¸²à¸„à¸£à¸µà¸¡à¸à¸±à¸™à¹à¸”à¸”à¸—à¸±à¸™à¸—à¸µ",
                    rain: "à¸•à¸£à¸§à¸ˆà¸à¸šà¸à¸¥à¸¸à¹ˆà¸¡à¸à¸™à¸à¸³à¸¥à¸±à¸‡à¹€à¸„à¸¥à¸·à¹ˆà¸­à¸™à¸•à¸±à¸§à¹€à¸‚à¹‰à¸²à¸¡à¸²à¹ƒà¸™ 60 à¸™à¸²à¸—à¸µ à¸à¸à¸£à¹ˆà¸¡à¸”à¹‰à¸§à¸¢à¸™à¸°à¸„à¸£à¸±à¸š",
                    storm: "à¸„à¸§à¸²à¸¡à¸à¸”à¸­à¸²à¸à¸²à¸¨à¸•à¹ˆà¸³à¸œà¸´à¸”à¸›à¸à¸•à¸´ à¸à¸²à¸¢à¸¸à¸à¸³à¸¥à¸±à¸‡à¸à¹ˆà¸­à¸•à¸±à¸§ à¸£à¸°à¸§à¸±à¸‡à¸¥à¸¡à¸à¸£à¸°à¹‚à¸Šà¸à¹à¸£à¸‡",
                    good: "à¸ªà¸ à¸²à¸à¸­à¸²à¸à¸²à¸¨à¸”à¸µà¹€à¸¢à¸µà¹ˆà¸¢à¸¡ à¹€à¸«à¸¡à¸²à¸°à¸à¸±à¸šà¸à¸²à¸£à¸—à¸³à¸à¸´à¸ˆà¸à¸£à¸£à¸¡à¸à¸¥à¸²à¸‡à¹à¸ˆà¹‰à¸‡",
                    pm: "à¸„à¹ˆà¸²à¸à¸¸à¹ˆà¸™ PM2.5 à¸ªà¸¹à¸‡à¹€à¸à¸´à¸™à¸¡à¸²à¸•à¸£à¸à¸²à¸™ à¸„à¸§à¸£à¸ªà¸§à¸¡à¸«à¸™à¹‰à¸²à¸à¸²à¸ N95",
                    flood: "à¸„à¸§à¸²à¸¡à¸Šà¸·à¹‰à¸™à¹ƒà¸™à¸”à¸´à¸™à¸ªà¸¹à¸‡ à¸£à¸°à¸§à¸±à¸‡à¸™à¹‰à¸³à¸—à¹ˆà¸§à¸¡à¸‚à¸±à¸‡à¹ƒà¸™à¸à¸·à¹‰à¸™à¸—à¸µà¹ˆà¸•à¹ˆà¸³",
                    laundry: "à¸•à¸²à¸à¸œà¹‰à¸²à¹„à¸”à¹‰à¹à¸«à¹‰à¸‡à¹„à¸§",
                    nolaundry: "à¹„à¸¡à¹ˆà¸„à¸§à¸£à¸•à¸²à¸à¸œà¹‰à¸²",
                    run: "à¸§à¸´à¹ˆà¸‡à¹„à¸”à¹‰à¸­à¸²à¸à¸²à¸¨à¸”à¸µ",
                    motor: "à¸¥à¸¡à¹à¸£à¸‡! à¸‚à¸µà¹ˆà¸¡à¸­à¹€à¸•à¸­à¸£à¹Œà¹„à¸‹à¸„à¹Œà¸­à¸±à¸™à¸•à¸£à¸²à¸¢"
                },
                tags: ["à¸§à¸´à¹ˆà¸‡", "à¸‹à¸±à¸à¸œà¹‰à¸²", "à¸ªà¸±à¸•à¸§à¹Œà¹€à¸¥à¸µà¹‰à¸¢à¸‡", "à¸‚à¸±à¸šà¸‚à¸µà¹ˆ", "à¹à¸­à¸£à¹Œ"]
            }
        };

        // --- PARTICLE ENGINE (Canvas) ---
        const Visuals = {
            cvs: document.getElementById('sky-canvas'),
            ctx: null,
            w: 0, h: 0,
            particles: [],
            type: 'clear', // rain, snow, clear

            init() {
                this.ctx = this.cvs.getContext('2d');
                this.resize();
                window.addEventListener('resize', () => this.resize());
                this.loop();
            },
            resize() {
                this.w = this.cvs.width = window.innerWidth;
                this.h = this.cvs.height = window.innerHeight;
            },
            setWeather(code) {
                // WMO Codes
                if ([51,53,55,61,63,65,80,81,82].includes(code)) this.type = 'rain';
                else if ([71,73,75,77,85,86].includes(code)) this.type = 'snow';
                else this.type = 'clear';
                this.makeParticles();
            },
            makeParticles() {
                this.particles = [];
                const count = this.type === 'rain' ? 300 : (this.type === 'snow' ? 150 : 30);
                for(let i=0; i<count; i++) {
                    this.particles.push({
                        x: Math.random() * this.w,
                        y: Math.random() * this.h,
                        s: Math.random() * 4 + 2, // speed
                        l: Math.random() * 20 + 5, // length (rain)
                        o: Math.random() * 0.5 + 0.1 // opacity
                    });
                }
            },
            loop() {
                this.ctx.clearRect(0,0,this.w,this.h);
                if(this.type !== 'clear') {
                    this.ctx.strokeStyle = this.type === 'rain' ? 'rgba(174,194,224,0.5)' : 'rgba(255,255,255,0.8)';
                    this.ctx.fillStyle = 'rgba(255,255,255,0.8)';
                    this.ctx.lineWidth = 1;
                    
                    this.particles.forEach(p => {
                        p.y += p.s;
                        if(p.y > this.h) { p.y = -20; p.x = Math.random() * this.w; }
                        
                        this.ctx.beginPath();
                        if(this.type === 'rain') {
                            this.ctx.moveTo(p.x, p.y);
                            this.ctx.lineTo(p.x, p.y + p.l);
                            this.ctx.stroke();
                        } else {
                            this.ctx.arc(p.x, p.y, p.s/2, 0, Math.PI*2);
                            this.ctx.fill();
                        }
                    });
                }
                requestAnimationFrame(() => this.loop());
            }
        };

        // --- RADAR ENGINE (Leaflet + RainViewer) ---
        const Radar = {
            map: null,
            layer: null,
            frames: [],
            idx: 0,
            timer: null,
            
            init(lat, lon) {
                if(this.map) return;
                this.map = L.map('map', { 
                    zoomControl: false, attributionControl: false, 
                    scrollWheelZoom: false, dragging: false 
                }).setView([lat, lon], 7);
                
                // Dark Matter Base
                L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
                    maxZoom: 18
                }).addTo(this.map);
                
                // Marker
                const icon = L.divIcon({className:'x', html:`<div style="width:10px;height:10px;background:#3b82f6;border-radius:50%;border:2px solid white;box-shadow:0 0 10px #3b82f6"></div>`});
                L.marker([lat, lon], {icon}).addTo(this.map);
                
                this.load();
                
                document.getElementById('radar-play').onclick = () => this.toggle();
            },
            async load() {
                try {
                    const res = await fetch('https://api.rainviewer.com/public/weather-maps.json');
                    const meta = await res.json();
                    this.frames = meta.radar.past; // Use past frames for loop
                    this.showFrame(this.frames.length-1);
                } catch(e) {}
            },
            showFrame(i) {
                if(this.layer) this.map.removeLayer(this.layer);
                const frame = this.frames[i];
                this.layer = L.tileLayer(`${CONFIG.radar}/v2/radar/${frame.time}/256/{z}/{x}/{y}/2/1_1.png`, {
                    opacity: 0.7, zIndex: 10
                }).addTo(this.map);
            },
            toggle() {
                if(this.timer) {
                    clearInterval(this.timer);
                    this.timer = null;
                    document.getElementById('radar-play').innerText = 'â–¶';
                } else {
                    document.getElementById('radar-play').innerText = 'â¸';
                    this.timer = setInterval(() => {
                        this.idx = (this.idx + 1) % this.frames.length;
                        this.showFrame(this.idx);
                    }, 500);
                }
            }
        };

        // --- CHART ENGINE (Chart.js) ---
        let tempChart = null;
        function renderChart(hourly) {
            const ctx = document.getElementById('tempChart').getContext('2d');
            if(tempChart) tempChart.destroy();
            
            const data = hourly.temperature_2m.slice(0, 48); // 48h
            const labels = hourly.time.slice(0, 48).map(t => new Date(t).getHours());
            
            const gradient = ctx.createLinearGradient(0, 0, 0, 150);
            gradient.addColorStop(0, 'rgba(59, 130, 246, 0.5)');
            gradient.addColorStop(1, 'rgba(59, 130, 246, 0)');

            tempChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels,
                    datasets: [{
                        data,
                        borderColor: '#3b82f6',
                        backgroundColor: gradient,
                        borderWidth: 2,
                        fill: true,
                        tension: 0.4,
                        pointRadius: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: {
                        x: { display: false },
                        y: { display: false }
                    },
                    interaction: { mode: 'index', intersect: false }
                }
            });
        }

        // --- MAIN APP LOGIC ---
        const App = {
            data: null,
            
            init() {
                Visuals.init();
                
                // Event Listener
                document.getElementById('lang-btn').onclick = () => {
                    CONFIG.lang = CONFIG.lang === 'en' ? 'th' : 'en';
                    if(this.data) this.render(this.data);
                };

                // Geolocation
                if(navigator.geolocation) {
                    navigator.geolocation.getCurrentPosition(
                        pos => this.fetch(pos.coords.latitude, pos.coords.longitude),
                        () => this.fetch(CONFIG.lat, CONFIG.lon)
                    );
                } else {
                    this.fetch(CONFIG.lat, CONFIG.lon);
                }
            },

            async fetch(lat, lon) {
                try {
                    const [wRes, aRes, gRes] = await Promise.all([
                        fetch(`${CONFIG.api}?latitude=${lat}&longitude=${lon}&current=temperature_2m,relative_humidity_2m,weather_code,wind_speed_10m,wind_direction_10m,pressure_msl&hourly=temperature_2m,precipitation_probability,weather_code,visibility&daily=weather_code,temperature_2m_max,temperature_2m_min,uv_index_max&timezone=auto`),
                        fetch(`${CONFIG.aqi}?latitude=${lat}&longitude=${lon}&current=us_aqi`),
                        fetch(`${CONFIG.geo}?latitude=${lat}&longitude=${lon}&localityLanguage=en`)
                    ]);
                    
                    const weather = await wRes.json();
                    const aqi = await aRes.json();
                    const geo = await gRes.json();
                    
                    this.data = { weather, aqi, geo };
                    this.render({ weather, aqi, geo });
                    Radar.init(lat, lon);
                    
                    // Hide Loader
                    setTimeout(() => {
                        document.getElementById('loader').style.opacity = '0';
                        setTimeout(() => document.getElementById('loader').remove(), 500);
                    }, 1000);

                } catch(e) {
                    console.error("Critical Failure", e);
                }
            },

            render({ weather, aqi, geo }) {
                const cur = weather.current;
                const day = weather.daily;
                const t = TEXT[CONFIG.lang];

                // 1. Theme
                const isDay = new Date().getHours() > 6 && new Date().getHours() < 18;
                const root = document.documentElement.style;
                if(isDay) {
                    root.setProperty('--bg-top', '#3b82f6');
                    root.setProperty('--bg-bot', '#93c5fd');
                    if(cur.weather_code >= 95) { // Storm
                        root.setProperty('--bg-top', '#1e1b4b');
                        root.setProperty('--bg-bot', '#4c1d95');
                    }
                } else {
                    root.setProperty('--bg-top', '#0f172a');
                    root.setProperty('--bg-bot', '#000000');
                }
                Visuals.setWeather(cur.weather_code);

                // 2. Hero
                document.getElementById('loc-name').innerText = `${geo.locality}, ${geo.countryCode}`;
                document.getElementById('curr-temp').innerText = Math.round(cur.temperature_2m) + 'Â°';
                document.getElementById('curr-cond').innerText = this.getWmoDesc(cur.weather_code);
                document.getElementById('max-t').innerText = Math.round(day.temperature_2m_max[0]);
                document.getElementById('min-t').innerText = Math.round(day.temperature_2m_min[0]);

                // 3. AI Brain
                const ai = this.getAIInsight(weather, aqi.current.us_aqi);
                document.getElementById('ai-text').innerText = ai.msg;
                document.getElementById('ai-tags').innerHTML = ai.tags.map(tag => 
                    `<span class="ai-pill" style="border-color:${tag.ok?'#34c759':'#ff453a'}; color:${tag.ok?'#34c759':'#ff453a'}">${tag.name}</span>`
                ).join('');

                // 4. Monitors
                // AQI
                const aqVal = aqi.current.us_aqi;
                document.getElementById('aqi-val').innerText = aqVal;
                document.getElementById('aqi-status').innerText = this.getAqiStatus(aqVal);
                const offset = 251 - (Math.min(aqVal, 300)/300)*251;
                document.getElementById('aqi-ring').style.strokeDashoffset = offset;
                document.getElementById('aqi-ring').setAttribute('stroke', this.getColor(aqVal, 50, 100, 150));

                // UV
                const uv = day.uv_index_max[0];
                document.getElementById('uv-val').innerText = uv;
                document.getElementById('uv-bar').style.width = Math.min((uv/11)*100, 100) + '%';
                document.getElementById('uv-bar').style.background = this.getColor(uv, 2, 5, 8);
                // Burn time logic
                let burnTime = ">60";
                if(uv > 11) burnTime = "10";
                else if(uv > 8) burnTime = "20";
                else if(uv > 5) burnTime = "30";
                document.getElementById('uv-burn').innerText = `${t.burn}${burnTime}${t.mins}`;

                // Wind
                document.getElementById('wind-speed').innerText = Math.round(cur.wind_speed_10m);
                document.getElementById('wind-arrow').style.transform = `translateX(-50%) rotate(${cur.wind_direction_10m}deg)`;

                // Moisture
                document.getElementById('humidity').innerText = cur.relative_humidity_2m;
                const dp = cur.temperature_2m - ((100-cur.relative_humidity_2m)/5);
                document.getElementById('dew-point').innerText = Math.round(dp);
                if(cur.relative_humidity_2m > 70 && cur.temperature_2m > 25) {
                    document.getElementById('mold-risk').style.display = 'block';
                } else {
                    document.getElementById('mold-risk').style.display = 'none';
                }

                // Visibility
                const vis = weather.hourly.visibility[0] / 1000;
                document.getElementById('vis-val').innerText = vis.toFixed(1);

                // Rain Prob
                const rainP = weather.hourly.precipitation_probability[new Date().getHours()];
                document.getElementById('rain-prob').innerText = rainP;
                document.getElementById('rain-bar').style.width = rainP + '%';

                // 5. Forecast List
                const list = document.getElementById('daily-list');
                list.innerHTML = '';
                const rangeMax = Math.max(...day.temperature_2m_max);
                const rangeMin = Math.min(...day.temperature_2m_min);
                const spread = rangeMax - rangeMin + 5;

                for(let i=0; i<7; i++) {
                    const d = new Date(day.time[i]);
                    const name = d.toLocaleDateString(CONFIG.lang==='en'?'en-US':'th-TH', {weekday:'short'});
                    const max = Math.round(day.temperature_2m_max[i]);
                    const min = Math.round(day.temperature_2m_min[i]);
                    const icon = this.getIcon(day.weather_code[i]);
                    
                    const left = ((min - rangeMin) / spread) * 100;
                    const width = ((max - min) / spread) * 100;

                    const row = document.createElement('div');
                    row.className = 'day-row';
                    row.innerHTML = `
                        <div style="width:50px; font-weight:500;">${name}</div>
                        <div style="width:30px; text-align:center; font-size:1.2rem;">${icon}</div>
                        <div style="width:40px; text-align:right; font-family:'Outfit'; opacity:0.7">${min}Â°</div>
                        <div class="day-bar-track">
                            <div class="day-bar" style="left:${left}%; width:${width}%; background: linear-gradient(90deg, #3b82f6, #60a5fa);"></div>
                        </div>
                        <div style="width:40px; font-family:'Outfit'; font-weight:600;">${max}Â°</div>
                    `;
                    list.appendChild(row);
                }

                // 6. Chart
                renderChart(weather.hourly);
            },

            getAIInsight(w, aqi) {
                const t = TEXT[CONFIG.lang];
                const cur = w.current;
                const uv = w.daily.uv_index_max[0];
                const rain = w.hourly.precipitation_probability[new Date().getHours() + 1]; // Next hour
                
                let msg = t.ai.good;
                if(cur.weather_code >= 95) msg = t.ai.storm;
                else if(aqi > 150) msg = t.ai.pm;
                else if(rain > 60) msg = t.ai.rain;
                else if(uv > 9) msg = t.ai.hot;

                const tags = [];
                // Run
                tags.push({ name: t.tags[0], ok: (cur.temperature_2m < 32 && aqi < 100 && rain < 40) });
                // Laundry
                tags.push({ name: t.tags[1], ok: (rain < 20 && cur.relative_humidity_2m < 75) });
                // Motor
                tags.push({ name: t.tags[3], ok: (cur.wind_speed_10m < 30) });

                return { msg, tags };
            },

            getWmoDesc(code) {
                // Simplified mapping
                const map = {
                    0: 'Clear Sky', 1: 'Mainly Clear', 2: 'Partly Cloudy', 3: 'Overcast',
                    45: 'Fog', 51: 'Drizzle', 61: 'Rain', 65: 'Heavy Rain', 80: 'Showers', 95: 'Thunderstorm'
                };
                return map[code] || 'Unknown';
            },
            getIcon(code) {
                if(code <= 1) return 'â˜€ï¸';
                if(code <= 3) return 'â˜ï¸';
                if(code <= 50) return 'ğŸŒ«';
                if(code <= 67) return 'ğŸŒ§';
                if(code >= 95) return 'â›ˆ';
                return 'ğŸŒ¦';
            },
            getAqiStatus(val) {
                const t = TEXT[CONFIG.lang].aqi;
                if(val <= 50) return t.good;
                if(val <= 100) return t.mod;
                if(val <= 150) return t.poor;
                return t.bad;
            },
            getColor(val, low, mid, high) {
                if(val <= low) return '#34c759'; // Green
                if(val <= mid) return '#ff9f0a'; // Yellow/Orange
                if(val <= high) return '#ff453a'; // Red
                return '#bf5af2'; // Purple
            }
        };

        // Start
        window.addEventListener('DOMContentLoaded', () => App.init());

    </script>
</body>
</html>
