<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>OMEGA: LIFE MONITOR</title>
    <style>
        :root {
            --neon-blue: #00f3ff;
            --neon-red: #ff003c;
            --neon-gold: #ffd700;
            --glass-bg: rgba(10, 15, 20, 0.65);
            --glass-border: rgba(0, 243, 255, 0.2);
            --bg: #020202;
        }
        
        body {
            margin: 0; overflow: hidden; background-color: var(--bg);
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            color: var(--neon-blue);
            touch-action: none; user-select: none;
        }

        canvas { display: block; position: absolute; top: 0; left: 0; z-index: 0; }

        /* --- UI LAYER: APPLE-STYLE DASHBOARD --- */
        #ui-layer {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            pointer-events: none; z-index: 10;
            display: flex; flex-direction: column; justify-content: space-between;
            padding: 20px; box-sizing: border-box;
        }

        /* Header */
        .top-bar {
            display: flex; justify-content: space-between; align-items: flex-start;
        }
        .status-pill {
            background: var(--glass-bg);
            border: 1px solid var(--glass-border);
            padding: 5px 12px; border-radius: 20px;
            font-size: 11px; letter-spacing: 1px; backdrop-filter: blur(10px);
            display: flex; align-items: center; gap: 8px;
        }
        .status-dot { width: 8px; height: 8px; background: var(--neon-blue); border-radius: 50%; box-shadow: 0 0 5px var(--neon-blue); }
        .status-dot.recording { animation: blink 1s infinite; background: var(--neon-red); box-shadow: 0 0 5px var(--neon-red); }

        /* Central Dashboard */
        #dashboard-panel {
            pointer-events: auto;
            align-self: center;
            background: rgba(5, 5, 5, 0.8);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 24px;
            padding: 25px;
            width: 90%; max-width: 350px;
            text-align: center;
            box-shadow: 0 20px 50px rgba(0,0,0,0.5);
            transition: transform 0.3s ease;
        }

        .timer-display {
            font-variant-numeric: tabular-nums;
            font-size: 48px; font-weight: 200; color: #fff;
            margin: 10px 0; letter-spacing: -1px;
            text-shadow: 0 0 10px rgba(0, 243, 255, 0.3);
        }

        .sub-stat {
            display: flex; justify-content: space-between; margin-top: 15px;
            font-size: 12px; color: rgba(255,255,255,0.5);
        }
        .stat-val { color: var(--neon-blue); font-weight: bold; }

        /* Controls */
        .btn-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 20px; }
        
        button {
            background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1);
            color: white; padding: 12px; border-radius: 12px; font-size: 12px;
            cursor: pointer; transition: all 0.2s; text-transform: uppercase; letter-spacing: 1px;
        }
        button:active { transform: scale(0.96); }
        
        .btn-primary { background: var(--neon-blue); color: #000; font-weight: bold; box-shadow: 0 0 15px rgba(0, 243, 255, 0.3); border: none; }
        .btn-secondary { border-color: var(--neon-gold); color: var(--neon-gold); }
        .btn-danger { border-color: var(--neon-red); color: var(--neon-red); }

        /* Logs */
        #log-panel {
            font-family: 'Consolas', monospace; font-size: 10px;
            height: 80px; overflow-y: auto;
            background: linear-gradient(to bottom, transparent, #000);
            mask-image: linear-gradient(to bottom, black 50%, transparent 100%);
            opacity: 0.7; pointer-events: none;
        }
        .log-entry { margin-bottom: 4px; }
        .log-time { opacity: 0.5; margin-right: 5px; }

        /* Bars */
        .bar-wrap { width: 100%; height: 4px; background: #222; border-radius: 2px; margin-top: 5px; overflow: hidden; }
        .bar-fill { height: 100%; background: var(--neon-blue); width: 100%; transition: width 0.5s, background 0.5s; }

        /* Animations */
        @keyframes blink { 0%, 100% { opacity: 1; } 50% { opacity: 0.3; } }
        @keyframes scan { 0% { top: 0%; opacity:0; } 50% { opacity:1; } 100% { top: 100%; opacity:0; } }

        .scan-line {
            position: absolute; top:0; left:0; width:100%; height:2px;
            background: var(--neon-blue); opacity: 0.1;
            animation: scan 4s infinite linear; pointer-events: none;
        }
    </style>
</head>
<body>

    <canvas id="main-canvas"></canvas>
    <div class="scan-line"></div>

    <div id="ui-layer">
        
        <div class="top-bar">
            <div class="status-pill">
                <div id="pulse-dot" class="status-dot"></div>
                <span id="system-state">STANDBY</span>
            </div>
            <div class="status-pill" style="border-color:rgba(255,255,255,0.1); background:transparent;">
                <span id="clock-display">00:00</span>
            </div>
        </div>

        <div id="dashboard-panel">
            <div style="font-size: 10px; color: #888; letter-spacing: 2px; margin-bottom: 10px;">SESSION TIMER</div>
            <div class="timer-display" id="timer-display">00:00</div>
            
            <div style="text-align:left; margin-top:15px;">
                <div style="display:flex; justify-content:space-between; font-size:10px; color:#ccc;">
                    <span>DAILY INTEGRITY</span>
                    <span id="integrity-txt">100%</span>
                </div>
                <div class="bar-wrap"><div id="hp-bar" class="bar-fill"></div></div>
            </div>

            <div style="text-align:left; margin-top:8px;">
                <div style="display:flex; justify-content:space-between; font-size:10px; color:#ccc;">
                    <span>NOISE LEVEL</span>
                    <span id="noise-txt">0%</span>
                </div>
                <div class="bar-wrap" style="background:#111;"><div id="noise-bar" class="bar-fill" style="width:0%; background:var(--neon-red);"></div></div>
            </div>

            <div class="sub-stat">
                <span>LAST BREAK: <span id="break-stat" class="stat-val">0m ago</span></span>
                <span>ENV: <span id="env-stat" class="stat-val">STABLE</span></span>
            </div>

            <div class="btn-grid">
                <button id="btn-action" class="btn-primary" onclick="SYSTEM.toggleSession()">START FOCUS</button>
                <button id="btn-break" class="btn-secondary" onclick="SYSTEM.registerBreak()">TAKE BREAK</button>
            </div>
            <button onclick="LOGGER.export()" style="width:100%; margin-top:10px; background:transparent; color:#666; border:none;">â†“ EXPORT LOGS (CSV)</button>
        </div>

        <div id="log-panel"></div>
    </div>

    <script>
        /**
         * OMEGA: LIFE MONITOR
         * Architecture:
         * 1. SENSORS: Mic (Noise), Time (Sessions), Gyro (Visuals)
         * 2. LOGIC: Calculates integrity based on work/rest balance and environment.
         * 3. VISUALS: Data-driven particle swarm.
         */

        // --- CONFIG & STATE ---
        const STATE = {
            isFocusing: false,
            startTime: 0,
            elapsed: 0,
            lastBreak: Date.now(),
            integrity: 100, // Health
            noiseLevel: 0,
            fatigue: 0 // calculated from time since break
        };

        // --- 1. SENSOR MODULE (AUDIO) ---
        const SENSORS = {
            audioCtx: null,
            analyser: null,
            dataArray: null,
            isInit: false,

            async init() {
                if(this.isInit) return;
                try {
                    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                    this.audioCtx = new (window.AudioContext || window.webkitAudioContext)();
                    this.analyser = this.audioCtx.createAnalyser();
                    this.analyser.fftSize = 256;
                    const source = this.audioCtx.createMediaStreamSource(stream);
                    source.connect(this.analyser);
                    this.dataArray = new Uint8Array(this.analyser.frequencyBinCount);
                    this.isInit = true;
                    LOGGER.log("SENSORS ACTIVE: MIC ON");
                } catch(e) {
                    LOGGER.log("SENSOR ERROR: MIC BLOCKED");
                }
            },

            getNoiseLevel() {
                if(!this.isInit) return 0;
                this.analyser.getByteFrequencyData(this.dataArray);
                let sum = 0;
                for(let i=0; i<this.dataArray.length; i++) sum += this.dataArray[i];
                // Normalize to 0-100 scale roughly
                let avg = sum / this.dataArray.length;
                return Math.min(100, (avg / 128) * 100);
            }
        };

        // --- 2. VOICE MODULE ---
        const VOICE = {
            synth: window.speechSynthesis,
            speak(text) {
                const u = new SpeechSynthesisUtterance(text);
                u.rate = 1.1; u.pitch = 1.0;
                this.synth.speak(u);
            }
        };

        // --- 3. LOGGER MODULE ---
        const LOGGER = {
            logs: [],
            
            log(msg, type="INFO") {
                const ts = new Date().toLocaleTimeString([], {hour12:false});
                this.logs.push({ time: new Date().toISOString(), type, msg });
                
                // UI Update
                const panel = document.getElementById('log-panel');
                const div = document.createElement('div');
                div.className = 'log-entry';
                div.innerHTML = `<span class="log-time">[${ts}]</span> ${msg.toUpperCase()}`;
                div.style.color = type === "ALERT" ? "var(--neon-red)" : "var(--neon-blue)";
                panel.prepend(div);

                // Persist
                localStorage.setItem('OMEGA_LOGS', JSON.stringify(this.logs));
            },

            export() {
                let csv = "Timestamp,Type,Message\n";
                this.logs.forEach(l => { csv += `${l.time},${l.type},${l.msg}\n`; });
                const blob = new Blob([csv], { type: 'text/csv' });
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url; a.download = `omega_logs_${Date.now()}.csv`;
                a.click();
                VOICE.speak("Exporting data logs.");
            }
        };

        // --- 4. VISUAL ENGINE (SWARM) ---
        const VISUALS = {
            canvas: document.getElementById('main-canvas'),
            ctx: document.getElementById('main-canvas').getContext('2d'),
            particles: [],
            width: window.innerWidth,
            height: window.innerHeight,

            init() {
                this.resize();
                window.addEventListener('resize', () => this.resize());
                for(let i=0; i<150; i++) this.particles.push(new Particle(this.width, this.height));
                this.animate();
            },

            resize() {
                this.width = window.innerWidth;
                this.height = window.innerHeight;
                this.canvas.width = this.width;
                this.canvas.height = this.height;
            },

            animate() {
                // Clear with trail
                this.ctx.fillStyle = 'rgba(2, 2, 2, 0.2)';
                this.ctx.fillRect(0, 0, this.width, this.height);

                // Determine Swarm Mood
                let color = '#00f3ff'; // Default Blue (Focus)
                let speed = 1;
                
                // Logic mapping visuals to data
                if (STATE.noiseLevel > 40) {
                    color = '#ff003c'; // Red (Noise Stress)
                    speed = 3; 
                } else if (STATE.fatigue > 45) {
                    color = '#ffd700'; // Gold (Need Break)
                    speed = 0.5; // Sluggish
                }

                const target = { x: this.width/2, y: this.height/2 };

                this.ctx.globalCompositeOperation = 'screen';
                this.particles.forEach(p => {
                    p.update(target, speed, STATE.noiseLevel);
                    p.draw(this.ctx, color);
                });
                this.ctx.globalCompositeOperation = 'source-over';

                // Draw "Core Eye" representing Integrity
                const eyeSize = (STATE.integrity / 100) * 20 + (STATE.noiseLevel/2);
                this.ctx.fillStyle = '#fff';
                this.ctx.shadowBlur = 20;
                this.ctx.shadowColor = color;
                this.ctx.beginPath();
                this.ctx.arc(target.x, target.y, eyeSize, 0, Math.PI*2);
                this.ctx.fill();
                this.ctx.shadowBlur = 0;

                requestAnimationFrame(() => this.animate());
            }
        };

        class Particle {
            constructor(w, h) {
                this.x = Math.random() * w;
                this.y = Math.random() * h;
                this.vx = Math.random() - 0.5;
                this.vy = Math.random() - 0.5;
                this.history = [];
            }

            update(target, speedMult, noise) {
                // Orbit logic for Focus state
                const dx = target.x - this.x;
                const dy = target.y - this.y;
                const dist = Math.sqrt(dx*dx + dy*dy);
                
                if (noise > 40) {
                    // Chaos mode (Scatter)
                    this.vx += (Math.random()-0.5) * 2;
                    this.vy += (Math.random()-0.5) * 2;
                } else {
                    // Flow mode (Orbit)
                    this.vx += dx * 0.0001 * speedMult;
                    this.vy += dy * 0.0001 * speedMult;
                }

                this.x += this.vx * speedMult;
                this.y += this.vy * speedMult;
                
                // Friction
                this.vx *= 0.96; this.vy *= 0.96;

                // Trail
                this.history.push({x:this.x, y:this.y});
                if(this.history.length > 5) this.history.shift();
            }

            draw(ctx, color) {
                ctx.strokeStyle = color;
                ctx.lineWidth = 1.5;
                ctx.beginPath();
                if(this.history.length > 0) {
                    ctx.moveTo(this.history[0].x, this.history[0].y);
                    for(let i=1; i<this.history.length; i++) ctx.lineTo(this.history[i].x, this.history[i].y);
                }
                ctx.lineTo(this.x, this.y);
                ctx.stroke();
            }
        }

        // --- 5. SYSTEM CONTROLLER (THE BRAIN) ---
        const SYSTEM = {
            timerInterval: null,
            
            init() {
                VISUALS.init();
                // Initial Load from LocalStorage
                const saved = localStorage.getItem('OMEGA_DATA');
                if(saved) {
                    const d = JSON.parse(saved);
                    STATE.integrity = d.integrity || 100;
                }
                setInterval(() => this.monitorLoop(), 1000);
                LOGGER.log("SYSTEM ONLINE. READY.");
            },

            async toggleSession() {
                await SENSORS.init();
                STATE.isFocusing = !STATE.isFocusing;
                const btn = document.getElementById('btn-action');
                const dot = document.getElementById('pulse-dot');
                const sys = document.getElementById('system-state');

                if(STATE.isFocusing) {
                    STATE.startTime = Date.now() - STATE.elapsed; // Resume logic
                    this.timerInterval = setInterval(() => {
                        STATE.elapsed = Date.now() - STATE.startTime;
                        this.updateTimerUI();
                    }, 100); // Smooth timer
                    
                    btn.innerText = "PAUSE SESSION";
                    btn.classList.replace('btn-primary', 'btn-danger');
                    dot.classList.add('recording');
                    sys.innerText = "MONITORING";
                    sys.style.color = "var(--neon-red)";
                    VOICE.speak("Focus session started. entering flow state.");
                    LOGGER.log("SESSION STARTED", "ACTION");
                } else {
                    clearInterval(this.timerInterval);
                    btn.innerText = "RESUME FOCUS";
                    btn.classList.replace('btn-danger', 'btn-primary');
                    dot.classList.remove('recording');
                    sys.innerText = "PAUSED";
                    sys.style.color = "var(--neon-blue)";
                    VOICE.speak("Session paused.");
                    LOGGER.log(`SESSION PAUSED. DURATION: ${(STATE.elapsed/60000).toFixed(1)} MIN`, "ACTION");
                }
            },

            registerBreak() {
                STATE.lastBreak = Date.now();
                STATE.integrity = Math.min(100, STATE.integrity + 10); // Heal
                STATE.fatigue = 0;
                VOICE.speak("Break registered. Integrity restored.");
                LOGGER.log("BREAK TAKEN. FATIGUE RESET.", "ACTION");
                this.updateDOM();
            },

            monitorLoop() {
                // 1. Time Logic
                const now = new Date();
                document.getElementById('clock-display').innerText = now.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});
                
                // Time since last break (Minutes)
                const minsSinceBreak = Math.floor((Date.now() - STATE.lastBreak) / 60000);
                STATE.fatigue = minsSinceBreak;
                document.getElementById('break-stat').innerText = `${minsSinceBreak}m ago`;

                // 2. Environment Logic (Noise)
                STATE.noiseLevel = SENSORS.getNoiseLevel();
                document.getElementById('noise-bar').style.width = STATE.noiseLevel + "%";
                document.getElementById('noise-txt').innerText = Math.round(STATE.noiseLevel) + "%";

                // Alert if too loud
                if(STATE.noiseLevel > 60 && STATE.isFocusing) {
                    document.getElementById('env-stat').innerText = "NOISY";
                    document.getElementById('env-stat').style.color = "var(--neon-red)";
                    // Reduce integrity rapidly if working in noise
                    STATE.integrity -= 0.1; 
                } else {
                    document.getElementById('env-stat').innerText = "OPTIMAL";
                    document.getElementById('env-stat').style.color = "var(--neon-blue)";
                }

                // 3. Fatigue Logic
                if (minsSinceBreak > 45) {
                     document.getElementById('break-stat').style.color = "var(--neon-gold)";
                     if(minsSinceBreak % 5 === 0 && Math.random() < 0.1) VOICE.speak("You have been focusing too long. Take a break.");
                     STATE.integrity -= 0.05; // Slow decay
                } else {
                    document.getElementById('break-stat').style.color = "var(--neon-blue)";
                }

                // Clamp Integrity
                if(STATE.integrity < 0) STATE.integrity = 0;
                this.updateDOM();
                
                // Save State
                localStorage.setItem('OMEGA_DATA', JSON.stringify(STATE));
            },

            updateTimerUI() {
                const totalSeconds = Math.floor(STATE.elapsed / 1000);
                const m = Math.floor(totalSeconds / 60).toString().padStart(2, '0');
                const s = (totalSeconds % 60).toString().padStart(2, '0');
                document.getElementById('timer-display').innerText = `${m}:${s}`;
            },

            updateDOM() {
                // Integrity Bar
                const hpBar = document.getElementById('hp-bar');
                hpBar.style.width = STATE.integrity + "%";
                document.getElementById('integrity-txt').innerText = Math.round(STATE.integrity) + "%";
                
                if(STATE.integrity > 70) hpBar.style.background = "var(--neon-blue)";
                else if(STATE.integrity > 30) hpBar.style.background = "var(--neon-gold)";
                else hpBar.style.background = "var(--neon-red)";
            }
        };

        // Start
        window.onload = () => SYSTEM.init();

    </script>
</body>
</html>
