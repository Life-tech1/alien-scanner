<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>MOCHI ULTIMATE: AR PET</title>
    <link href="https://fonts.googleapis.com/css2?family=Fredoka+One&family=Nunito:wght@400;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #ff9a9e;
            --bg-gradient: linear-gradient(to top, #a18cd1 0%, #fbc2eb 100%);
            --ui-bg: rgba(255, 255, 255, 0.9);
        }

        body {
            margin: 0; overflow: hidden; background: #222;
            font-family: 'Nunito', sans-serif;
            touch-action: none; user-select: none;
        }

        /* LAYERS */
        #camera-feed {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            object-fit: cover; opacity: 1; z-index: 0;
        }
        
        #game-canvas {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            z-index: 1;
        }

        /* UI OVERLAY */
        #ui-layer {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            z-index: 10; pointer-events: none;
            display: flex; flex-direction: column; justify-content: space-between;
            padding: 15px;
        }

        /* TOP HUD */
        .hud-top {
            display: flex; justify-content: space-between; align-items: flex-start;
        }

        .stats-card {
            background: var(--ui-bg);
            border-radius: 20px; padding: 10px 15px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            backdrop-filter: blur(5px);
            width: 140px;
        }

        .stat-row { margin-bottom: 5px; }
        .stat-label { font-size: 10px; color: #888; font-weight: bold; display: flex; justify-content: space-between; }
        
        .progress-bar {
            height: 6px; background: #eee; border-radius: 3px; overflow: hidden; margin-top: 2px;
        }
        .progress-fill { height: 100%; width: 50%; transition: width 0.5s; }

        .level-badge {
            background: #fff; border-radius: 50%; width: 50px; height: 50px;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            box-shadow: 0 4px 10px rgba(0,0,0,0.2); border: 3px solid var(--primary);
        }
        .lvl-txt { font-size: 8px; color: #888; }
        .lvl-num { font-family: 'Fredoka One', cursive; font-size: 20px; color: var(--primary); line-height: 1; }

        /* BOTTOM ACTIONS */
        .action-bar {
            display: flex; justify-content: center; gap: 15px;
            pointer-events: auto; margin-bottom: 20px;
        }

        .btn-action {
            width: 60px; height: 60px; border-radius: 20px;
            border: none; background: #fff;
            font-size: 24px; cursor: pointer;
            box-shadow: 0 5px 0 #ddd;
            transition: transform 0.1s, box-shadow 0.1s;
            display: flex; align-items: center; justify-content: center;
        }
        .btn-action:active { transform: translateY(5px); box-shadow: 0 0 0 #ddd; }
        .btn-action.critical { animation: shake 0.5s infinite; border: 2px solid red; }

        @keyframes shake { 0%,100%{transform:translateX(0);} 25%{transform:translateX(-2px);} 75%{transform:translateX(2px);} }

        /* START SCREEN */
        #start-screen {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: linear-gradient(135deg, #ff9a9e 0%, #fecfef 99%);
            z-index: 100; display: flex; flex-direction: column; align-items: center; justify-content: center;
            color: #fff;
        }
        #btn-init {
            background: #fff; color: #ff9a9e; border: none; padding: 15px 50px;
            border-radius: 50px; font-size: 22px; font-family: 'Fredoka One';
            box-shadow: 0 10px 20px rgba(0,0,0,0.2); cursor: pointer;
        }

    </style>
</head>
<body>

    <video id="camera-feed" autoplay playsinline muted></video>
    <canvas id="game-canvas"></canvas>

    <div id="ui-layer">
        <div class="hud-top">
            <div class="level-badge">
                <span class="lvl-txt">LVL</span>
                <span class="lvl-num" id="disp-lvl">1</span>
            </div>
            <div class="stats-card">
                <div class="stat-row">
                    <div class="stat-label"><span>HUNGER</span><span id="txt-hunger">50%</span></div>
                    <div class="progress-bar"><div id="bar-hunger" class="progress-fill" style="background:#ff9a9e;"></div></div>
                </div>
                <div class="stat-row">
                    <div class="stat-label"><span>FUN</span><span id="txt-fun">50%</span></div>
                    <div class="progress-bar"><div id="bar-fun" class="progress-fill" style="background:#84fab0;"></div></div>
                </div>
                <div class="stat-row">
                    <div class="stat-label"><span>HYGIENE</span><span id="txt-hygiene">50%</span></div>
                    <div class="progress-bar"><div id="bar-hygiene" class="progress-fill" style="background:#a1c4fd;"></div></div>
                </div>
            </div>
        </div>

        <div class="action-bar">
            <button class="btn-action" id="btn-feed" onclick="Game.action('FEED')">üçñ</button>
            <button class="btn-action" id="btn-play" onclick="Game.action('PLAY')">üéæ</button>
            <button class="btn-action" id="btn-clean" onclick="Game.action('CLEAN')">üßº</button>
        </div>
    </div>

    <div id="start-screen">
        <h1 style="font-family: 'Fredoka One'; font-size: 3rem; margin-bottom: 10px;">MOCHI</h1>
        <p style="opacity: 0.8; margin-bottom: 30px;">Ultimate AR Companion</p>
        <button id="btn-init">START GAME</button>
    </div>

<script>
/**
 * PROJECT: MOCHI ULTIMATE
 * Features: Tamagotchi Systems, Save/Load, Speech Synthesis, Physics, Particle System
 */

// --- CONFIG ---
const CONFIG = {
    tickRate: 1000, // Logic update every 1s
    decay: {
        hunger: 1,
        fun: 0.5,
        hygiene: 0.2
    },
    colors: {
        body: '#ff9a9e',
        happy: '#ff9a9e',
        dirty: '#d4fc79',
        sick: '#a18cd1'
    }
};

// --- 1. GAME STATE & SAVE SYSTEM ---
const State = {
    stats: {
        hunger: 100, // 0-100 (0 = Starving)
        fun: 100,    // 0-100 (0 = Depressed)
        hygiene: 100,// 0-100 (0 = Filthy)
        xp: 0,
        level: 1
    },
    lastSave: Date.now(),

    init() {
        const saved = localStorage.getItem('MOCHI_V3_DATA');
        if (saved) {
            const data = JSON.parse(saved);
            this.stats = data.stats;
            // Calculate offline decay
            const elapsedSecs = (Date.now() - data.timestamp) / 1000;
            this.applyDecay(elapsedSecs * 0.1); // 10% decay rate when offline
        }
        this.save();
        setInterval(() => this.tick(), CONFIG.tickRate);
    },

    tick() {
        this.applyDecay(1);
        this.save();
        UI.update();
        
        // Random Events
        if (this.stats.hygiene < 50 && Math.random() < 0.1) World.spawnPoop();
    },

    applyDecay(multiplier) {
        this.stats.hunger = Math.max(0, this.stats.hunger - (CONFIG.decay.hunger * multiplier));
        this.stats.fun = Math.max(0, this.stats.fun - (CONFIG.decay.fun * multiplier));
        this.stats.hygiene = Math.max(0, this.stats.hygiene - (CONFIG.decay.hygiene * multiplier));
    },

    save() {
        const data = { stats: this.stats, timestamp: Date.now() };
        localStorage.setItem('MOCHI_V3_DATA', JSON.stringify(data));
    },

    addXp(amount) {
        this.stats.xp += amount;
        if (this.stats.xp > this.stats.level * 100) {
            this.stats.xp = 0;
            this.stats.level++;
            Voice.speak("Level Up! Yay!");
            Particles.explode(Mochi.x, Mochi.y, '‚≠ê');
        }
    }
};

// --- 2. VOICE SYSTEM (Cute Pitch) ---
const Voice = {
    synth: window.speechSynthesis,
    speak(text) {
        if (!this.synth) return;
        const u = new SpeechSynthesisUtterance(text);
        u.rate = 1.2; // Faster
        u.pitch = 1.5; // Higher pitch (Cute)
        
        // Find a "child" or "female" voice if possible
        const voices = this.synth.getVoices();
        const cuteVoice = voices.find(v => v.name.includes('Google US English') || v.name.includes('Samantha'));
        if(cuteVoice) u.voice = cuteVoice;
        
        this.synth.speak(u);
    }
};

// --- 3. PHYSICS & WORLD ---
const World = {
    canvas: document.getElementById('game-canvas'),
    ctx: null,
    items: [], // Food, Balls, Poop
    
    init() {
        this.ctx = this.canvas.getContext('2d');
        this.resize();
        window.addEventListener('resize', () => this.resize());
        
        // Interaction
        this.canvas.addEventListener('pointerdown', (e) => this.handleTouch(e));
    },

    resize() {
        this.canvas.width = window.innerWidth;
        this.canvas.height = window.innerHeight;
    },

    spawnItem(type) {
        const item = {
            type: type, // 'FOOD', 'BALL', 'POOP', 'BUBBLE'
            x: Math.random() * this.canvas.width,
            y: -50,
            vx: 0, vy: 5,
            size: 40,
            emoji: type === 'FOOD' ? 'üçñ' : (type === 'POOP' ? 'üí©' : 'üßº'),
            grounded: false
        };
        
        if (type === 'BALL') { item.emoji = 'üéæ'; item.vx = (Math.random()-0.5)*10; }
        
        this.items.push(item);
    },

    spawnPoop() {
        if (this.items.filter(i => i.type === 'POOP').length > 5) return; // Max poops
        this.items.push({
            type: 'POOP',
            x: Mochi.x + (Math.random()-0.5)*50,
            y: Mochi.y + 50,
            vx: 0, vy: 0,
            size: 30, emoji: 'üí©',
            grounded: true
        });
        Voice.speak("Oh no! Poopy!");
    },

    update() {
        // Items Physics
        this.items.forEach(item => {
            if (!item.grounded) {
                item.x += item.vx;
                item.y += item.vy;
                
                // Gravity / Bounce
                if (item.y > this.canvas.height - 100) {
                    item.y = this.canvas.height - 100;
                    item.vy *= -0.5;
                    item.vx *= 0.8;
                    if(Math.abs(item.vy) < 1) item.grounded = true;
                } else {
                    item.vy += 0.5; // Gravity
                }
            }

            // Mochi Interaction
            const dx = item.x - Mochi.x;
            const dy = item.y - Mochi.y;
            const dist = Math.sqrt(dx*dx + dy*dy);

            if (dist < Mochi.radius + item.size) {
                if (item.type === 'FOOD' && State.stats.hunger < 100) {
                    this.consume(item);
                } else if (item.type === 'BALL') {
                    item.vx += (item.x - Mochi.x) * 0.2;
                    item.vy -= 5;
                    item.grounded = false;
                    Mochi.jump();
                    State.stats.fun = Math.min(100, State.stats.fun + 2);
                }
            }
        });
    },

    consume(item) {
        this.items = this.items.filter(i => i !== item);
        State.stats.hunger = Math.min(100, State.stats.hunger + 20);
        State.addXp(10);
        Voice.speak("Yummy!");
        Particles.explode(Mochi.x, Mochi.y, '‚ú®');
        Mochi.squish();
    },

    cleanPoop(item) {
        this.items = this.items.filter(i => i !== item);
        State.stats.hygiene = Math.min(100, State.stats.hygiene + 20);
        Particles.explode(item.x, item.y, 'ü´ß');
    },

    handleTouch(e) {
        const x = e.clientX;
        const y = e.clientY;
        
        // Check Poops
        let clickedItem = false;
        this.items.forEach(item => {
            if (item.type === 'POOP') {
                const dx = x - item.x;
                const dy = y - item.y;
                if (Math.sqrt(dx*dx+dy*dy) < 50) {
                    this.cleanPoop(item);
                    clickedItem = true;
                }
            }
        });

        if (!clickedItem) {
            // Check Mochi
            const dx = x - Mochi.x;
            const dy = y - Mochi.y;
            if (Math.sqrt(dx*dx+dy*dy) < Mochi.radius) {
                Mochi.jump();
                Voice.speak("Hehe!");
                State.stats.fun += 5;
                Particles.explode(x, y, '‚ù§Ô∏è');
            } else {
                // Move Mochi
                Mochi.targetX = x;
                Mochi.targetY = y;
            }
        }
    },

    draw(ctx) {
        this.items.forEach(item => {
            ctx.font = `${item.size}px Arial`;
            ctx.fillText(item.emoji, item.x - item.size/2, item.y + item.size/2);
        });
    }
};

// --- 4. MOCHI CHARACTER ---
const Mochi = {
    x: window.innerWidth/2, y: window.innerHeight/2,
    targetX: window.innerWidth/2, targetY: window.innerHeight/2,
    vx: 0, vy: 0,
    radius: 60,
    squishX: 1, squishY: 1,
    blink: 0,
    
    update() {
        // AI Logic
        // Go to food if hungry
        const food = World.items.find(i => i.type === 'FOOD');
        if (food && State.stats.hunger < 90) {
            this.targetX = food.x;
            this.targetY = food.y;
        } else if (State.stats.fun < 30) {
             // Sad wandering
             if(Math.random() < 0.01) {
                 this.targetX = Math.random() * window.innerWidth;
                 this.targetY = window.innerHeight - 100;
             }
        }

        // Physics
        const dx = this.targetX - this.x;
        const dy = this.targetY - this.y;
        
        this.vx += dx * 0.005;
        this.vy += dy * 0.005;
        this.vx *= 0.9; this.vy *= 0.9; // Friction
        
        this.x += this.vx;
        this.y += this.vy;

        // Squish Animation
        const speed = Math.sqrt(this.vx*this.vx + this.vy*this.vy);
        this.squishX = 1 + (speed * 0.02) + Math.sin(Date.now()/100)*0.05;
        this.squishY = 1 - (speed * 0.02) - Math.sin(Date.now()/100)*0.05;

        // Blink
        if(Math.random() < 0.01) this.blink = 10;
        if(this.blink > 0) this.blink--;
    },

    jump() {
        this.vy = -15;
        this.squishY = 0.5;
        this.squishX = 1.5;
    },

    squish() {
        this.squishX = 1.4;
        this.squishY = 0.6;
    },

    draw(ctx) {
        ctx.save();
        ctx.translate(this.x, this.y);
        ctx.scale(this.squishX * (1 + State.stats.level * 0.05), this.squishY * (1 + State.stats.level * 0.05)); // Grow with level

        // Determine Color based on status
        let color = CONFIG.colors.body;
        if (State.stats.hygiene < 30) color = CONFIG.colors.dirty;
        if (State.stats.hunger < 20) color = '#eee'; // Pale
        
        // Body
        ctx.fillStyle = color;
        ctx.beginPath(); ctx.arc(0, 0, this.radius, 0, Math.PI*2); ctx.fill();
        
        // Glow
        ctx.fillStyle = 'rgba(255,255,255,0.4)';
        ctx.beginPath(); ctx.arc(-this.radius/3, -this.radius/3, this.radius/3, 0, Math.PI*2); ctx.fill();

        // Face
        this.drawFace(ctx);

        // Dirt particles if dirty
        if (State.stats.hygiene < 50) {
            ctx.fillStyle = '#556b2f';
            for(let i=0; i<3; i++) {
                ctx.beginPath(); ctx.arc(Math.sin(Date.now()/500 + i)*40, Math.cos(Date.now()/300 + i)*40, 5, 0, Math.PI*2); ctx.fill();
            }
        }

        ctx.restore();
    },

    drawFace(ctx) {
        ctx.fillStyle = '#333';
        // Eyes
        if (this.blink > 0) {
            ctx.beginPath(); ctx.moveTo(-20, -10); ctx.lineTo(-10, -10); ctx.stroke();
            ctx.beginPath(); ctx.moveTo(10, -10); ctx.lineTo(20, -10); ctx.stroke();
        } else {
            ctx.beginPath(); ctx.arc(-15, -10, 6, 0, Math.PI*2); ctx.fill();
            ctx.beginPath(); ctx.arc(15, -10, 6, 0, Math.PI*2); ctx.fill();
        }

        // Cheeks
        ctx.fillStyle = 'rgba(255, 0, 0, 0.2)';
        ctx.beginPath(); ctx.arc(-25, 5, 8, 0, Math.PI*2); ctx.fill();
        ctx.beginPath(); ctx.arc(25, 5, 8, 0, Math.PI*2); ctx.fill();

        // Mouth
        ctx.strokeStyle = '#333';
        ctx.lineWidth = 3;
        ctx.lineCap = 'round';
        ctx.beginPath();
        if (State.stats.fun < 30 || State.stats.hunger < 20) {
            ctx.arc(0, 15, 5, Math.PI, 0); // Sad mouth
        } else {
            ctx.arc(0, 10, 5, 0, Math.PI); // Smile
        }
        ctx.stroke();
    }
};

// --- 5. PARTICLES ---
const Particles = {
    list: [],
    explode(x, y, char) {
        for(let i=0; i<5; i++) {
            this.list.push({
                x, y, char,
                vx: (Math.random()-0.5)*5,
                vy: (Math.random()-0.5)*5 - 5,
                life: 1
            });
        }
    },
    updateAndDraw(ctx) {
        for(let i=this.list.length-1; i>=0; i--) {
            const p = this.list[i];
            p.x += p.vx; p.y += p.vy;
            p.life -= 0.02;
            ctx.globalAlpha = p.life;
            ctx.font = "20px Arial";
            ctx.fillText(p.char, p.x, p.y);
            if(p.life <= 0) this.list.splice(i, 1);
        }
        ctx.globalAlpha = 1;
    }
};

// --- 6. GAME LOOP ---
const Game = {
    action(type) {
        if (type === 'FEED') {
            World.spawnItem('FOOD');
        } else if (type === 'PLAY') {
            World.spawnItem('BALL');
            Voice.speak("Ball!");
        } else if (type === 'CLEAN') {
            // Clean all dirt
            if (State.stats.hygiene < 100) {
                State.stats.hygiene = 100;
                Particles.explode(Mochi.x, Mochi.y, 'üßº');
                Voice.speak("So fresh!");
            } else {
                Voice.speak("I am clean!");
            }
            // Remove all poops
            World.items = World.items.filter(i => i.type !== 'POOP');
        }
    },
    
    loop() {
        World.ctx.clearRect(0, 0, World.canvas.width, World.canvas.height);
        
        World.update();
        World.draw(World.ctx);
        
        Mochi.update();
        Mochi.draw(World.ctx);
        
        Particles.updateAndDraw(World.ctx);
        
        requestAnimationFrame(Game.loop);
    }
};

// --- 7. UI UPDATER ---
const UI = {
    update() {
        document.getElementById('bar-hunger').style.width = State.stats.hunger + "%";
        document.getElementById('bar-fun').style.width = State.stats.fun + "%";
        document.getElementById('bar-hygiene').style.width = State.stats.hygiene + "%";
        
        document.getElementById('txt-hunger').innerText = Math.floor(State.stats.hunger) + "%";
        document.getElementById('txt-fun').innerText = Math.floor(State.stats.fun) + "%";
        document.getElementById('txt-hygiene').innerText = Math.floor(State.stats.hygiene) + "%";
        
        document.getElementById('disp-lvl').innerText = State.stats.level;

        // Critical Warnings
        const btns = document.querySelectorAll('.btn-action');
        btns[0].classList.toggle('critical', State.stats.hunger < 30);
        btns[1].classList.toggle('critical', State.stats.fun < 30);
        btns[2].classList.toggle('critical', State.stats.hygiene < 30);
    }
};

// --- 8. START ---
document.getElementById('btn-init').addEventListener('click', async () => {
    document.getElementById('start-screen').style.display = 'none';
    
    // Camera Init
    try {
        const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } });
        document.getElementById('camera-feed').srcObject = stream;
    } catch(e) { console.log("No camera"); }

    World.init();
    State.init();
    Game.loop();
    
    Voice.speak("Hi! I am Mochi!");
});

</script>
</body>
</html>
